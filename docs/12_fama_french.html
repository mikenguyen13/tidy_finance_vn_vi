<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>11&nbsp; Fama-French Factors – Tidy Finance in Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./13_fama_macbeth.html" rel="next">
<link href="./09_univariate_portfolio_sort.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="11&nbsp; Fama-French Factors – Tidy Finance in Vietnam">
<meta property="og:description" content="">
<meta property="og:image" content="https://github.com/mikenguyen13/tidy_finance_vn/12_fama_french_files/figure-html/fig-cumulative-factors-output-1.png">
<meta property="og:site_name" content="Tidy Finance in Vietnam">
<meta property="og:image:alt" content="Line chart showing cumulative factor returns over time.">
<meta property="og:image:height" content="1132">
<meta property="og:image:width" content="2284">
<meta name="twitter:title" content="11&nbsp; Fama-French Factors – Tidy Finance in Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://github.com/mikenguyen13/tidy_finance_vn/12_fama_french_files/figure-html/fig-cumulative-factors-output-1.png">
<meta name="twitter:image:alt" content="Line chart showing cumulative factor returns over time.">
<meta name="twitter:image-height" content="1132">
<meta name="twitter:image-width" content="2284">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./12_fama_french.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Tidy Finance in Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">DataCore Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_fama_french.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#theoretical-background" id="toc-theoretical-background" class="nav-link active" data-scroll-target="#theoretical-background"><span class="header-section-number">11.1</span> Theoretical Background</a>
  <ul class="collapse">
  <li><a href="#the-evolution-from-capm-to-multi-factor-models" id="toc-the-evolution-from-capm-to-multi-factor-models" class="nav-link" data-scroll-target="#the-evolution-from-capm-to-multi-factor-models"><span class="header-section-number">11.1.1</span> The Evolution from CAPM to Multi-Factor Models</a></li>
  <li><a href="#the-five-factor-extension" id="toc-the-five-factor-extension" class="nav-link" data-scroll-target="#the-five-factor-extension"><span class="header-section-number">11.1.2</span> The Five-Factor Extension</a></li>
  <li><a href="#factor-construction-methodology" id="toc-factor-construction-methodology" class="nav-link" data-scroll-target="#factor-construction-methodology"><span class="header-section-number">11.1.3</span> Factor Construction Methodology</a></li>
  </ul></li>
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment"><span class="header-section-number">11.2</span> Setting Up the Environment</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">11.3</span> Data Preparation</a>
  <ul class="collapse">
  <li><a href="#loading-stock-returns" id="toc-loading-stock-returns" class="nav-link" data-scroll-target="#loading-stock-returns"><span class="header-section-number">11.3.1</span> Loading Stock Returns</a></li>
  <li><a href="#loading-company-fundamentals" id="toc-loading-company-fundamentals" class="nav-link" data-scroll-target="#loading-company-fundamentals"><span class="header-section-number">11.3.2</span> Loading Company Fundamentals</a></li>
  <li><a href="#constructing-sorting-variables" id="toc-constructing-sorting-variables" class="nav-link" data-scroll-target="#constructing-sorting-variables"><span class="header-section-number">11.3.3</span> Constructing Sorting Variables</a></li>
  <li><a href="#validating-sorting-variables" id="toc-validating-sorting-variables" class="nav-link" data-scroll-target="#validating-sorting-variables"><span class="header-section-number">11.3.4</span> Validating Sorting Variables</a></li>
  <li><a href="#handling-outliers" id="toc-handling-outliers" class="nav-link" data-scroll-target="#handling-outliers"><span class="header-section-number">11.3.5</span> Handling Outliers</a></li>
  </ul></li>
  <li><a href="#portfolio-assignment-functions" id="toc-portfolio-assignment-functions" class="nav-link" data-scroll-target="#portfolio-assignment-functions"><span class="header-section-number">11.4</span> Portfolio Assignment Functions</a>
  <ul class="collapse">
  <li><a href="#the-portfolio-assignment-function" id="toc-the-portfolio-assignment-function" class="nav-link" data-scroll-target="#the-portfolio-assignment-function"><span class="header-section-number">11.4.1</span> The Portfolio Assignment Function</a></li>
  <li><a href="#assigning-portfolios-for-three-factor-model" id="toc-assigning-portfolios-for-three-factor-model" class="nav-link" data-scroll-target="#assigning-portfolios-for-three-factor-model"><span class="header-section-number">11.4.2</span> Assigning Portfolios for Three-Factor Model</a></li>
  <li><a href="#validating-portfolio-assignments" id="toc-validating-portfolio-assignments" class="nav-link" data-scroll-target="#validating-portfolio-assignments"><span class="header-section-number">11.4.3</span> Validating Portfolio Assignments</a></li>
  </ul></li>
  <li><a href="#fama-french-three-factor-model-monthly" id="toc-fama-french-three-factor-model-monthly" class="nav-link" data-scroll-target="#fama-french-three-factor-model-monthly"><span class="header-section-number">11.5</span> Fama-French Three-Factor Model (Monthly)</a>
  <ul class="collapse">
  <li><a href="#merging-portfolios-with-returns" id="toc-merging-portfolios-with-returns" class="nav-link" data-scroll-target="#merging-portfolios-with-returns"><span class="header-section-number">11.5.1</span> Merging Portfolios with Returns</a></li>
  <li><a href="#computing-value-weighted-portfolio-returns" id="toc-computing-value-weighted-portfolio-returns" class="nav-link" data-scroll-target="#computing-value-weighted-portfolio-returns"><span class="header-section-number">11.5.2</span> Computing Value-Weighted Portfolio Returns</a></li>
  <li><a href="#constructing-smb-and-hml-factors" id="toc-constructing-smb-and-hml-factors" class="nav-link" data-scroll-target="#constructing-smb-and-hml-factors"><span class="header-section-number">11.5.3</span> Constructing SMB and HML Factors</a></li>
  <li><a href="#computing-the-market-factor" id="toc-computing-the-market-factor" class="nav-link" data-scroll-target="#computing-the-market-factor"><span class="header-section-number">11.5.4</span> Computing the Market Factor</a></li>
  <li><a href="#combining-three-factors" id="toc-combining-three-factors" class="nav-link" data-scroll-target="#combining-three-factors"><span class="header-section-number">11.5.5</span> Combining Three Factors</a></li>
  <li><a href="#saving-three-factor-data" id="toc-saving-three-factor-data" class="nav-link" data-scroll-target="#saving-three-factor-data"><span class="header-section-number">11.5.6</span> Saving Three-Factor Data</a></li>
  </ul></li>
  <li><a href="#fama-french-five-factor-model-monthly" id="toc-fama-french-five-factor-model-monthly" class="nav-link" data-scroll-target="#fama-french-five-factor-model-monthly"><span class="header-section-number">11.6</span> Fama-French Five-Factor Model (Monthly)</a>
  <ul class="collapse">
  <li><a href="#portfolio-assignments-with-dependent-sorts" id="toc-portfolio-assignments-with-dependent-sorts" class="nav-link" data-scroll-target="#portfolio-assignments-with-dependent-sorts"><span class="header-section-number">11.6.1</span> Portfolio Assignments with Dependent Sorts</a></li>
  <li><a href="#validating-five-factor-portfolios" id="toc-validating-five-factor-portfolios" class="nav-link" data-scroll-target="#validating-five-factor-portfolios"><span class="header-section-number">11.6.2</span> Validating Five-Factor Portfolios</a></li>
  <li><a href="#merging-and-computing-portfolio-returns" id="toc-merging-and-computing-portfolio-returns" class="nav-link" data-scroll-target="#merging-and-computing-portfolio-returns"><span class="header-section-number">11.6.3</span> Merging and Computing Portfolio Returns</a></li>
  <li><a href="#constructing-all-five-factors" id="toc-constructing-all-five-factors" class="nav-link" data-scroll-target="#constructing-all-five-factors"><span class="header-section-number">11.6.4</span> Constructing All Five Factors</a></li>
  <li><a href="#factor-correlations" id="toc-factor-correlations" class="nav-link" data-scroll-target="#factor-correlations"><span class="header-section-number">11.6.5</span> Factor Correlations</a></li>
  <li><a href="#saving-five-factor-data" id="toc-saving-five-factor-data" class="nav-link" data-scroll-target="#saving-five-factor-data"><span class="header-section-number">11.6.6</span> Saving Five-Factor Data</a></li>
  </ul></li>
  <li><a href="#daily-fama-french-factors" id="toc-daily-fama-french-factors" class="nav-link" data-scroll-target="#daily-fama-french-factors"><span class="header-section-number">11.7</span> Daily Fama-French Factors</a>
  <ul class="collapse">
  <li><a href="#motivation-for-daily-factors" id="toc-motivation-for-daily-factors" class="nav-link" data-scroll-target="#motivation-for-daily-factors"><span class="header-section-number">11.7.1</span> Motivation for Daily Factors</a></li>
  <li><a href="#loading-daily-returns" id="toc-loading-daily-returns" class="nav-link" data-scroll-target="#loading-daily-returns"><span class="header-section-number">11.7.2</span> Loading Daily Returns</a></li>
  <li><a href="#adding-market-cap-for-daily-weighting" id="toc-adding-market-cap-for-daily-weighting" class="nav-link" data-scroll-target="#adding-market-cap-for-daily-weighting"><span class="header-section-number">11.7.3</span> Adding Market Cap for Daily Weighting</a></li>
  <li><a href="#merging-daily-returns-with-portfolios" id="toc-merging-daily-returns-with-portfolios" class="nav-link" data-scroll-target="#merging-daily-returns-with-portfolios"><span class="header-section-number">11.7.4</span> Merging Daily Returns with Portfolios</a></li>
  <li><a href="#computing-daily-three-factors" id="toc-computing-daily-three-factors" class="nav-link" data-scroll-target="#computing-daily-three-factors"><span class="header-section-number">11.7.5</span> Computing Daily Three Factors</a></li>
  <li><a href="#computing-daily-market-factor" id="toc-computing-daily-market-factor" class="nav-link" data-scroll-target="#computing-daily-market-factor"><span class="header-section-number">11.7.6</span> Computing Daily Market Factor</a></li>
  <li><a href="#combining-daily-three-factors" id="toc-combining-daily-three-factors" class="nav-link" data-scroll-target="#combining-daily-three-factors"><span class="header-section-number">11.7.7</span> Combining Daily Three Factors</a></li>
  <li><a href="#computing-daily-five-factors" id="toc-computing-daily-five-factors" class="nav-link" data-scroll-target="#computing-daily-five-factors"><span class="header-section-number">11.7.8</span> Computing Daily Five Factors</a></li>
  <li><a href="#saving-daily-factors" id="toc-saving-daily-factors" class="nav-link" data-scroll-target="#saving-daily-factors"><span class="header-section-number">11.7.9</span> Saving Daily Factors</a></li>
  </ul></li>
  <li><a href="#factor-validation-and-diagnostics" id="toc-factor-validation-and-diagnostics" class="nav-link" data-scroll-target="#factor-validation-and-diagnostics"><span class="header-section-number">11.8</span> Factor Validation and Diagnostics</a>
  <ul class="collapse">
  <li><a href="#cumulative-factor-returns" id="toc-cumulative-factor-returns" class="nav-link" data-scroll-target="#cumulative-factor-returns"><span class="header-section-number">11.8.1</span> Cumulative Factor Returns</a></li>
  <li><a href="#average-factor-premiums" id="toc-average-factor-premiums" class="nav-link" data-scroll-target="#average-factor-premiums"><span class="header-section-number">11.8.2</span> Average Factor Premiums</a></li>
  <li><a href="#comparing-monthly-and-daily-factors" id="toc-comparing-monthly-and-daily-factors" class="nav-link" data-scroll-target="#comparing-monthly-and-daily-factors"><span class="header-section-number">11.8.3</span> Comparing Monthly and Daily Factors</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">11.9</span> Key Takeaways</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/12_fama_french.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This chapter provides a replication of the Fama-French factor portfolios for the Vietnamese stock market. The Fama-French factor models represent a cornerstone of empirical asset pricing, originating from the seminal work of <span class="citation" data-cites="Fama1992">Fama and French (<a href="references.html#ref-Fama1992" role="doc-biblioref">1992</a>)</span> and later extended in <span class="citation" data-cites="FamaFrench2015">Fama and French (<a href="references.html#ref-FamaFrench2015" role="doc-biblioref">2015</a>)</span>. These models have transformed how academics and practitioners understand the cross-section of expected stock returns, moving beyond the single-factor Capital Asset Pricing Model to incorporate multiple sources of systematic risk.</p>
<p>We construct both the three-factor and five-factor models at monthly and daily frequencies. The monthly factors serve as the foundation for most asset pricing tests and portfolio analyses, while the daily factors enable higher-frequency applications including short-horizon event studies, market microstructure research, and daily beta estimation. By constructing factors at both frequencies, we create a complete toolkit for empirical finance research in the Vietnamese market.</p>
<p>The chapter proceeds as follows. We first discuss the theoretical motivation for each factor and the economic intuition behind the Fama-French methodology. We then prepare the necessary data, merging stock returns with accounting characteristics. Next, we implement the portfolio sorting procedures that form the basis of factor construction, carefully following the original Fama-French protocols while adapting them for Vietnamese market characteristics. We construct the three-factor model (market, size, and value) before extending to the five-factor model (adding profitability and investment). Finally, we construct daily factors and validate our replicated factors through various diagnostic checks.</p>
<section id="theoretical-background" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="theoretical-background"><span class="header-section-number">11.1</span> Theoretical Background</h2>
<section id="the-evolution-from-capm-to-multi-factor-models" class="level3" data-number="11.1.1">
<h3 data-number="11.1.1" class="anchored" data-anchor-id="the-evolution-from-capm-to-multi-factor-models"><span class="header-section-number">11.1.1</span> The Evolution from CAPM to Multi-Factor Models</h3>
<p>The Capital Asset Pricing Model of <span class="citation" data-cites="Sharpe1964">Sharpe (<a href="references.html#ref-Sharpe1964" role="doc-biblioref">1964</a>)</span> posits that a single factor—the market portfolio—should explain all cross-sectional variation in expected returns. However, decades of empirical research have documented persistent patterns that CAPM cannot explain. <span class="citation" data-cites="Fama1992">Fama and French (<a href="references.html#ref-Fama1992" role="doc-biblioref">1992</a>)</span> demonstrated that two firm characteristics—size and book-to-market ratio—capture substantial variation in average returns that the market beta leaves unexplained.</p>
<p>Small firms tend to earn higher returns than large firms, a pattern known as the size effect. Similarly, firms with high book-to-market ratios (value stocks) tend to outperform firms with low book-to-market ratios (growth stocks), known as the value premium. The three-factor model formalizes these observations by constructing tradeable factor portfolios:</p>
<p><span id="eq-ff3"><span class="math display">\[
r_{i,t} - r_{f,t} = \alpha_i + \beta_i^{MKT}(r_{m,t} - r_{f,t}) + \beta_i^{SMB} \cdot SMB_t + \beta_i^{HML} \cdot HML_t + \varepsilon_{i,t}
\tag{11.1}\]</span></span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(r_{i,t} - r_{f,t}\)</span> is the excess return on asset <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(r_{m,t} - r_{f,t}\)</span> is the market excess return</li>
<li><span class="math inline">\(SMB_t\)</span> (Small Minus Big) is the size factor</li>
<li><span class="math inline">\(HML_t\)</span> (High Minus Low) is the value factor</li>
</ul>
</section>
<section id="the-five-factor-extension" class="level3" data-number="11.1.2">
<h3 data-number="11.1.2" class="anchored" data-anchor-id="the-five-factor-extension"><span class="header-section-number">11.1.2</span> The Five-Factor Extension</h3>
<p><span class="citation" data-cites="FamaFrench2015">Fama and French (<a href="references.html#ref-FamaFrench2015" role="doc-biblioref">2015</a>)</span> extended the model to include two additional factors motivated by the dividend discount model. Firms with higher profitability should have higher expected returns (all else equal), and firms with aggressive investment policies should have lower expected returns:</p>
<p><span id="eq-ff5"><span class="math display">\[
r_{i,t} - r_{f,t} = \alpha_i + \beta_i^{MKT}MKT_t + \beta_i^{SMB}SMB_t + \beta_i^{HML}HML_t + \beta_i^{RMW}RMW_t + \beta_i^{CMA}CMA_t + \varepsilon_{i,t}
\tag{11.2}\]</span></span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(RMW_t\)</span> (Robust Minus Weak) is the profitability factor</li>
<li><span class="math inline">\(CMA_t\)</span> (Conservative Minus Aggressive) is the investment factor</li>
</ul>
</section>
<section id="factor-construction-methodology" class="level3" data-number="11.1.3">
<h3 data-number="11.1.3" class="anchored" data-anchor-id="factor-construction-methodology"><span class="header-section-number">11.1.3</span> Factor Construction Methodology</h3>
<p>The Fama-French methodology constructs factors through double-sorted portfolios:</p>
<ol type="1">
<li><p><strong>Size sorts</strong>: Stocks are divided into Small and Big groups based on median market capitalization.</p></li>
<li><p><strong>Characteristic sorts</strong>: Within each size group, stocks are sorted into terciles based on book-to-market (for HML), operating profitability (for RMW), or investment (for CMA).</p></li>
<li><p><strong>Factor returns</strong>: Factors are computed as the difference between average returns of portfolios with high versus low characteristic values, averaging across size groups to neutralize size effects.</p></li>
<li><p><strong>Timing</strong>: Portfolios are formed at the end of June each year using accounting data from the prior fiscal year, ensuring all information was publicly available at formation.</p></li>
</ol>
</section>
</section>
<section id="setting-up-the-environment" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="setting-up-the-environment"><span class="header-section-number">11.2</span> Setting Up the Environment</h2>
<p>We load the required Python packages for data manipulation, statistical analysis, and visualization.</p>
<div id="bd15876e" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats.mstats <span class="im">import</span> winsorize</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We connect to our SQLite database containing the processed Vietnamese financial data.</p>
<div id="3e0cb73b" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="data-preparation" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">11.3</span> Data Preparation</h2>
<section id="loading-stock-returns" class="level3" data-number="11.3.1">
<h3 data-number="11.3.1" class="anchored" data-anchor-id="loading-stock-returns"><span class="header-section-number">11.3.1</span> Loading Stock Returns</h3>
<p>We load the monthly stock returns data, which includes excess returns, market capitalization, and the risk-free rate. These variables are essential for computing value-weighted portfolio returns and factor premiums.</p>
<div id="c7dd142c" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess, mktcap, mktcap_lag, risk_free</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly returns: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Monthly returns: 165,499 observations
Unique stocks: 1,457
Date range: 2010-02 to 2023-12</code></pre>
</div>
</div>
</section>
<section id="loading-company-fundamentals" class="level3" data-number="11.3.2">
<h3 data-number="11.3.2" class="anchored" data-anchor-id="loading-company-fundamentals"><span class="header-section-number">11.3.2</span> Loading Company Fundamentals</h3>
<p>We load the company fundamentals data containing book equity, operating profitability, and investment—the characteristics needed for constructing the Fama-French factors.</p>
<div id="2c4c4718" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, datadate, be, op, inv</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM comp_vn</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"datadate"</span>}</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fundamentals: </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss"> firm-year observations"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fundamentals: 18,108 firm-year observations
Unique firms: 1,496</code></pre>
</div>
</div>
</section>
<section id="constructing-sorting-variables" class="level3" data-number="11.3.3">
<h3 data-number="11.3.3" class="anchored" data-anchor-id="constructing-sorting-variables"><span class="header-section-number">11.3.3</span> Constructing Sorting Variables</h3>
<p>Following Fama-French conventions, we construct the sorting variables with careful attention to timing. The key principles are:</p>
<ol type="1">
<li><p><strong>Size (June Market Cap)</strong>: We use market capitalization at the end of June of year <span class="math inline">\(t\)</span> to sort stocks into size groups. This ensures we capture the firm’s size at the moment of portfolio formation.</p></li>
<li><p><strong>Book-to-Market Ratio</strong>: We use book equity from fiscal year <span class="math inline">\(t-1\)</span> divided by market equity at the end of December <span class="math inline">\(t-1\)</span>. This creates a six-month gap between the accounting data and portfolio formation, ensuring the information was publicly available.</p></li>
<li><p><strong>Portfolio Formation Date</strong>: Portfolios are formed on July 1st and held for twelve months until the following June.</p></li>
</ol>
<div id="4fae08df" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_sorting_variables(prices_monthly, comp_vn):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct sorting variables following Fama-French methodology.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_monthly : pd.DataFrame</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock returns with market cap</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">    comp_vn : pd.DataFrame</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Company fundamentals with book equity, profitability, investment</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Sorting variables aligned with July 1st formation dates</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Size: June market capitalization</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Portfolio formation is July 1st, so we use June market cap</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    size <span class="op">=</span> (prices_monthly</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"date.dt.month == 6"</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"mktcap"</span>]]</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"mktcap"</span>: <span class="st">"size"</span>})</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Size observations: </span><span class="sc">{</span><span class="bu">len</span>(size)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Market Equity: December market cap for B/M calculation</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># December t-1 market cap is used with fiscal year t-1 book equity</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is then used for July t portfolio formation</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    market_equity <span class="op">=</span> (prices_monthly</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"date.dt.month == 12"</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># December year t-1 maps to July year t formation</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">7</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"mktcap"</span>]]</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"mktcap"</span>: <span class="st">"me"</span>})</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Market equity observations: </span><span class="sc">{</span><span class="bu">len</span>(market_equity)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Book-to-Market and other characteristics</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fiscal year t-1 data is used for July t portfolio formation</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    book_to_market <span class="op">=</span> (comp_vn</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fiscal year-end + 6 months = July formation</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>                (x[<span class="st">"datadate"</span>].dt.year <span class="op">+</span> <span class="dv">1</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-07-01"</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        .merge(market_equity, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Scale book equity to match market equity units</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># BE is in VND, ME is in millions VND</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            bm<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"be"</span>] <span class="op">/</span> (x[<span class="st">"me"</span>] <span class="op">*</span> <span class="fl">1e9</span>)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"me"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]]</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Book-to-market observations: </span><span class="sc">{</span><span class="bu">len</span>(book_to_market)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Merge size with characteristics</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    sorting_variables <span class="op">=</span> (size</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        .merge(book_to_market, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        .drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>])</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sorting_variables</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>sorting_variables <span class="op">=</span> construct_sorting_variables(prices_monthly, comp_vn)</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final sorting variables: </span><span class="sc">{</span><span class="bu">len</span>(sorting_variables)<span class="sc">:,}</span><span class="ss"> stock-years"</span>)</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sorting date range: </span><span class="sc">{</span>sorting_variables[<span class="st">'sorting_date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>sorting_variables[<span class="st">'sorting_date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Size observations: 13,756
Market equity observations: 14,286
Book-to-market observations: 13,389

Final sorting variables: 12,046 stock-years
Sorting date range: 2011-07 to 2023-07</code></pre>
</div>
</div>
</section>
<section id="validating-sorting-variables" class="level3" data-number="11.3.4">
<h3 data-number="11.3.4" class="anchored" data-anchor-id="validating-sorting-variables"><span class="header-section-number">11.3.4</span> Validating Sorting Variables</h3>
<p>Before proceeding, we validate that our sorting variables have reasonable distributions. The book-to-market ratio should center around 1.0 for a typical market, though emerging markets may differ.</p>
<div id="640e0954" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sorting Variable Summary Statistics:"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[[<span class="st">"size"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for extreme values that might indicate data issues</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">B/M Median: </span><span class="sc">{</span>sorting_variables[<span class="st">'bm'</span>]<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"B/M 1st percentile: </span><span class="sc">{</span>sorting_variables[<span class="st">'bm'</span>]<span class="sc">.</span>quantile(<span class="fl">0.01</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"B/M 99th percentile: </span><span class="sc">{</span>sorting_variables[<span class="st">'bm'</span>]<span class="sc">.</span>quantile(<span class="fl">0.99</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sorting Variable Summary Statistics:
              size          bm          op         inv
count   12046.0000  12046.0000  12046.0000  12046.0000
mean     2225.5648      1.7033      0.1852      0.1322
std     14680.4225      3.8683      0.2782      2.5410
min         0.4864      0.0014     -0.7529     -0.9569
25%        62.7556      0.7595      0.0309     -0.0495
50%       182.6410      1.1849      0.1367      0.0342
75%       641.8896      1.8853      0.2952      0.1582
max    426020.9817    272.1893      1.4256    261.3355

B/M Median: 1.1849
B/M 1st percentile: 0.1710
B/M 99th percentile: 8.0262</code></pre>
</div>
</div>
</section>
<section id="handling-outliers" class="level3" data-number="11.3.5">
<h3 data-number="11.3.5" class="anchored" data-anchor-id="handling-outliers"><span class="header-section-number">11.3.5</span> Handling Outliers</h3>
<p>Extreme values in sorting characteristics can distort portfolio assignments and factor returns. We apply winsorization to limit the influence of outliers while preserving the general ranking of stocks.</p>
<div id="b2d2d1f0" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check BEFORE winsorization</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BEFORE Winsorization:"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[[<span class="st">"size"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply winsorization</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> winsorize_characteristics(df, columns, limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>)):</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply winsorization using pandas clip.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columns:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            lower <span class="op">=</span> df[col].quantile(limits[<span class="dv">0</span>])</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            upper <span class="op">=</span> df[col].quantile(limits[<span class="dv">1</span>])</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> df[col].clip(lower<span class="op">=</span>lower, upper<span class="op">=</span>upper)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: clipped to [</span><span class="sc">{</span>lower<span class="sc">:.4f}</span><span class="ss">, </span><span class="sc">{</span>upper<span class="sc">:.4f}</span><span class="ss">]"</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>sorting_variables <span class="op">=</span> winsorize_characteristics(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    sorting_variables,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>],  <span class="co"># Don't winsorize size</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Check AFTER winsorization</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">AFTER Winsorization:"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[[<span class="st">"size"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BEFORE Winsorization:
              size          bm          op         inv
count   12046.0000  12046.0000  12046.0000  12046.0000
mean     2225.5648      1.7033      0.1852      0.1322
std     14680.4225      3.8683      0.2782      2.5410
min         0.4864      0.0014     -0.7529     -0.9569
25%        62.7556      0.7595      0.0309     -0.0495
50%       182.6410      1.1849      0.1367      0.0342
75%       641.8896      1.8853      0.2952      0.1582
max    426020.9817    272.1893      1.4256    261.3355
  bm: clipped to [0.1710, 8.0262]
  op: clipped to [-0.7319, 1.2192]
  inv: clipped to [-0.3990, 1.5195]

AFTER Winsorization:
              size          bm          op         inv
count   12046.0000  12046.0000  12046.0000  12046.0000
mean     2225.5648      1.5544      0.1837      0.0894
std     14680.4225      1.2843      0.2705      0.2721
min         0.4864      0.1710     -0.7319     -0.3990
25%        62.7556      0.7595      0.0309     -0.0495
50%       182.6410      1.1849      0.1367      0.0342
75%       641.8896      1.8853      0.2952      0.1582
max    426020.9817      8.0262      1.2192      1.5195</code></pre>
</div>
</div>
</section>
</section>
<section id="portfolio-assignment-functions" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="portfolio-assignment-functions"><span class="header-section-number">11.4</span> Portfolio Assignment Functions</h2>
<section id="the-portfolio-assignment-function" class="level3" data-number="11.4.1">
<h3 data-number="11.4.1" class="anchored" data-anchor-id="the-portfolio-assignment-function"><span class="header-section-number">11.4.1</span> The Portfolio Assignment Function</h3>
<p>We create a flexible function for assigning stocks to portfolios based on quantile breakpoints. This function handles both independent sorts (where breakpoints are computed across all stocks) and dependent sorts (where breakpoints are computed within subgroups).</p>
<div id="bae0f5e6" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_portfolio(data, sorting_variable, percentiles):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign portfolios to a bin according to a sorting variable."""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the values</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    values <span class="op">=</span> data[sorting_variable].dropna()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(values) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series([np.nan] <span class="op">*</span> <span class="bu">len</span>(data), index<span class="op">=</span>data.index)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate breakpoints</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    breakpoints <span class="op">=</span> values.quantile(percentiles, interpolation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle duplicate breakpoints by using unique values</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    unique_breakpoints <span class="op">=</span> np.unique(breakpoints)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If all values are the same, assign all to portfolio 1</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(unique_breakpoints) <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series([<span class="dv">1</span>] <span class="op">*</span> <span class="bu">len</span>(data), index<span class="op">=</span>data.index)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set boundaries to -inf and +inf</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    unique_breakpoints.iloc[<span class="dv">0</span>] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    unique_breakpoints.iloc[unique_breakpoints.size<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> np.inf</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign to bins</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    assigned <span class="op">=</span> pd.cut(</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        data[sorting_variable],</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>unique_breakpoints,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>pd.Series(<span class="bu">range</span>(<span class="dv">1</span>, breakpoints.size)),</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        include_lowest<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        right<span class="op">=</span><span class="va">False</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> assigned</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="060a1ced" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the distribution of characteristics BEFORE portfolio assignment</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Operating Profitability Distribution:"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[<span class="st">"op"</span>].describe())</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Unique OP values: </span><span class="sc">{</span>sorting_variables[<span class="st">'op'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Investment Distribution:"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[<span class="st">"inv"</span>].describe())</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Unique INV values: </span><span class="sc">{</span>sorting_variables[<span class="st">'inv'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Check breakpoints for a specific date</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>test_date <span class="op">=</span> sorting_variables[<span class="st">"sorting_date"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> sorting_variables.query(<span class="st">"sorting_date == @test_date"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Breakpoints for </span><span class="sc">{</span>test_date<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"OP 30th percentile: </span><span class="sc">{</span>test_data[<span class="st">'op'</span>]<span class="sc">.</span>quantile(<span class="fl">0.3</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"OP 70th percentile: </span><span class="sc">{</span>test_data[<span class="st">'op'</span>]<span class="sc">.</span>quantile(<span class="fl">0.7</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"INV 30th percentile: </span><span class="sc">{</span>test_data[<span class="st">'inv'</span>]<span class="sc">.</span>quantile(<span class="fl">0.3</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"INV 70th percentile: </span><span class="sc">{</span>test_data[<span class="st">'inv'</span>]<span class="sc">.</span>quantile(<span class="fl">0.7</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Operating Profitability Distribution:
count    12046.000000
mean         0.183738
std          0.270509
min         -0.731888
25%          0.030913
50%          0.136675
75%          0.295185
max          1.219223
Name: op, dtype: float64

Unique OP values: 11804

Investment Distribution:
count    12046.000000
mean         0.089388
std          0.272147
min         -0.399042
25%         -0.049497
50%          0.034157
75%          0.158155
max          1.519474
Name: inv, dtype: float64

Unique INV values: 11805

Breakpoints for 2019-07-01 00:00:00:
OP 30th percentile: 0.0541
OP 70th percentile: 0.2566
INV 30th percentile: -0.0343
INV 70th percentile: 0.1116</code></pre>
</div>
</div>
</section>
<section id="assigning-portfolios-for-three-factor-model" class="level3" data-number="11.4.2">
<h3 data-number="11.4.2" class="anchored" data-anchor-id="assigning-portfolios-for-three-factor-model"><span class="header-section-number">11.4.2</span> Assigning Portfolios for Three-Factor Model</h3>
<p>For the three-factor model, we perform independent double sorts on size and book-to-market. Size is split at the median (2 groups), and book-to-market is split at the 30th and 70th percentiles (3 groups), creating 6 portfolios.</p>
<div id="01204476" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_ff3_portfolios(sorting_variables):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign portfolios for Fama-French three-factor model.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Independent 2x3 sort on size and book-to-market.</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> sorting_variables.copy()</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Independent size sort (median split)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_size"</span>] <span class="op">=</span> df.groupby(<span class="st">"sorting_date"</span>)[<span class="st">"size"</span>].transform(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Independent B/M sort (30/70 split)</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_bm"</span>] <span class="op">=</span> df.groupby(<span class="st">"sorting_date"</span>)[<span class="st">"bm"</span>].transform(</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign portfolios</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>portfolios_ff3 <span class="op">=</span> assign_ff3_portfolios(sorting_variables)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FF3 Book-to-Market by Portfolio (should be INCREASING):"</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3.groupby(<span class="st">"portfolio_bm"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"bm"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Three-Factor Portfolio Assignments:"</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]].head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>FF3 Book-to-Market by Portfolio (should be INCREASING):
portfolio_bm
1    0.5836
2    1.1891
3    2.4552
Name: bm, dtype: float64
Three-Factor Portfolio Assignments:
  symbol sorting_date portfolio_size portfolio_bm
0    A32   2019-07-01              1            2
1    A32   2020-07-01              1            2
2    A32   2021-07-01              1            2
3    A32   2022-07-01              1            3
4    A32   2023-07-01              1            2
5    AAA   2011-07-01              2            2
6    AAA   2012-07-01              2            3
7    AAA   2013-07-01              2            3
8    AAA   2014-07-01              2            2
9    AAA   2015-07-01              2            3</code></pre>
</div>
</div>
</section>
<section id="validating-portfolio-assignments" class="level3" data-number="11.4.3">
<h3 data-number="11.4.3" class="anchored" data-anchor-id="validating-portfolio-assignments"><span class="header-section-number">11.4.3</span> Validating Portfolio Assignments</h3>
<p>We verify that the portfolio assignments create the expected 2×3 grid with reasonable stock counts in each cell.</p>
<div id="b4d93818" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check portfolio distribution for most recent year</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>latest_date <span class="op">=</span> portfolios_ff3[<span class="st">"sorting_date"</span>].<span class="bu">max</span>()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>portfolio_counts <span class="op">=</span> (portfolios_ff3</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"sorting_date == @latest_date"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Portfolio Counts for </span><span class="sc">{</span>latest_date<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio_counts)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify characteristic monotonicity</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Book-to-Market by Portfolio (should be increasing):"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3.groupby(<span class="st">"portfolio_bm"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"bm"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Portfolio Counts for 2023-07:
portfolio_bm      1    2    3
portfolio_size               
1               113  271  263
2               275  246  125

Book-to-Market by Portfolio (should be increasing):
portfolio_bm
1    0.5836
2    1.1891
3    2.4552
Name: bm, dtype: float64</code></pre>
</div>
</div>
<p>We verify that for a single stock, the portfolio assignment remains constant between July of one year and June of the next.</p>
<div id="d6ffd4c0" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trace a single symbol (e.g., 'A32') across a formation window</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>persistence_check <span class="op">=</span> (portfolios_ff3</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"symbol == 'A32' &amp; sorting_date &gt;= '2022-01-01' &amp; sorting_date &lt;= '2023-12-31'"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"sorting_date"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">'symbol'</span>, <span class="st">'sorting_date'</span>, <span class="st">'portfolio_size'</span>, <span class="st">'portfolio_bm'</span>]]</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Temporal Persistence Check (Symbol A32):"</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(persistence_check.head(<span class="dv">15</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Temporal Persistence Check (Symbol A32):
  symbol sorting_date portfolio_size portfolio_bm
3    A32   2022-07-01              1            3
4    A32   2023-07-01              1            2</code></pre>
</div>
</div>
</section>
</section>
<section id="fama-french-three-factor-model-monthly" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="fama-french-three-factor-model-monthly"><span class="header-section-number">11.5</span> Fama-French Three-Factor Model (Monthly)</h2>
<section id="merging-portfolios-with-returns" class="level3" data-number="11.5.1">
<h3 data-number="11.5.1" class="anchored" data-anchor-id="merging-portfolios-with-returns"><span class="header-section-number">11.5.1</span> Merging Portfolios with Returns</h3>
<p>We merge the portfolio assignments with monthly returns. The key insight is that portfolios formed in July of year <span class="math inline">\(t\)</span> are held through June of year <span class="math inline">\(t+1\)</span>. We implement this by computing a <code>sorting_date</code> for each monthly return observation.</p>
<div id="faca7a8d" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_portfolios_with_returns(prices_monthly, portfolio_assignments):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge portfolio assignments with monthly returns.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Portfolios formed in July t are held through June t+1.</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_monthly : pd.DataFrame</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock returns</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolio_assignments : pd.DataFrame</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Portfolio assignments with sorting_date</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns merged with portfolio assignments</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    portfolios <span class="op">=</span> (prices_monthly</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Map each return month to its portfolio formation date</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>                np.where(</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>                    x[<span class="st">"date"</span>].dt.month <span class="op">&lt;=</span> <span class="dv">6</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>                    (x[<span class="st">"date"</span>].dt.year <span class="op">-</span> <span class="dv">1</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-07-01"</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>                    x[<span class="st">"date"</span>].dt.year.astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-07-01"</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        .merge(</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            portfolio_assignments,</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>],</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolios</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>portfolios_monthly_ff3 <span class="op">=</span> merge_portfolios_with_returns(</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    prices_monthly,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    portfolios_ff3[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]]</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_monthly_ff3)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Merged observations: 136,444</code></pre>
</div>
</div>
</section>
<section id="computing-value-weighted-portfolio-returns" class="level3" data-number="11.5.2">
<h3 data-number="11.5.2" class="anchored" data-anchor-id="computing-value-weighted-portfolio-returns"><span class="header-section-number">11.5.2</span> Computing Value-Weighted Portfolio Returns</h3>
<p>We compute value-weighted returns for each of the six portfolios. Value-weighting uses lagged market capitalization to avoid look-ahead bias.</p>
<div id="a16117a8" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_returns(data, grouping_vars):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute value-weighted portfolio returns.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns data with portfolio assignments and mktcap_lag</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    grouping_vars : list</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Variables defining portfolio groups</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Value-weighted returns for each portfolio-date</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> (data</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        .groupby(grouping_vars <span class="op">+</span> [<span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]),</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_stocks"</span>: <span class="bu">len</span>(x)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio_returns</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute portfolio returns</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>portfolio_returns_ff3 <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    portfolios_monthly_ff3,</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Portfolio Returns Summary:"</span>)</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio_returns_ff3.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Portfolio Returns Summary:
                             count    mean     std     min     25%     50%  \
portfolio_size portfolio_bm                                                  
1              1             150.0 -0.0052  0.0379 -0.1268 -0.0262 -0.0058   
               2             150.0 -0.0025  0.0414 -0.1080 -0.0236 -0.0053   
               3             150.0  0.0039  0.0601 -0.1612 -0.0269 -0.0004   
2              1             150.0 -0.0124  0.0594 -0.2222 -0.0449 -0.0107   
               2             150.0 -0.0021  0.0671 -0.1701 -0.0403 -0.0046   
               3             150.0  0.0024  0.0879 -0.2359 -0.0527 -0.0012   

                                75%     max  
portfolio_size portfolio_bm                  
1              1             0.0161  0.0849  
               2             0.0180  0.1195  
               3             0.0314  0.2015  
2              1             0.0210  0.1741  
               2             0.0317  0.1770  
               3             0.0437  0.2124  </code></pre>
</div>
</div>
</section>
<section id="constructing-smb-and-hml-factors" class="level3" data-number="11.5.3">
<h3 data-number="11.5.3" class="anchored" data-anchor-id="constructing-smb-and-hml-factors"><span class="header-section-number">11.5.3</span> Constructing SMB and HML Factors</h3>
<p>We now construct the SMB and HML factors from the portfolio returns.</p>
<p><strong>SMB (Small Minus Big)</strong>: Average return of three small portfolios minus average return of three big portfolios.</p>
<p><strong>HML (High Minus Low)</strong>: Average return of two high B/M portfolios minus average return of two low B/M portfolios.</p>
<div id="26ef92fc" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_ff3_factors(portfolio_returns):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct Fama-French three factors from portfolio returns.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolio_returns : pd.DataFrame</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Value-weighted returns for 2x3 portfolios</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly SMB and HML factors</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (portfolio_returns</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># SMB: Small minus Big (average across B/M groups)</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean()</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># HML: High minus Low B/M (average across size groups)</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean()</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>factors_smb_hml <span class="op">=</span> construct_ff3_factors(portfolio_returns_ff3)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SMB and HML Factors:"</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_smb_hml.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SMB and HML Factors:
        date       smb       hml
0 2011-07-31 -0.007768  0.002754
1 2011-08-31 -0.067309  0.011474
2 2011-09-30  0.014884  0.022854
3 2011-10-31 -0.003743  0.001631
4 2011-11-30  0.063234  0.009103
5 2011-12-31  0.014571  0.015280
6 2012-01-31 -0.026080  0.009672
7 2012-02-29 -0.035721  0.005474
8 2012-03-31 -0.002344  0.032477
9 2012-04-30 -0.033391  0.074191</code></pre>
</div>
</div>
</section>
<section id="computing-the-market-factor" class="level3" data-number="11.5.4">
<h3 data-number="11.5.4" class="anchored" data-anchor-id="computing-the-market-factor"><span class="header-section-number">11.5.4</span> Computing the Market Factor</h3>
<p>The market factor is the value-weighted return of all stocks minus the risk-free rate. We compute this independently from the sorted portfolios.</p>
<div id="cec0ce53" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_market_factor(prices_monthly):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute value-weighted market excess return.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_monthly : pd.DataFrame</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock returns with mktcap_lag</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly market excess return</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    market_factor <span class="op">=</span> (prices_monthly</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mkt_excess"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_stocks"</span>: <span class="bu">len</span>(x)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        }), include_groups<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> market_factor</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>market_factor <span class="op">=</span> compute_market_factor(prices_monthly)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Market Factor Summary:"</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(market_factor[<span class="st">"mkt_excess"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Market Factor Summary:
count    167.0000
mean      -0.0123
std        0.0595
min       -0.2149
25%       -0.0394
50%       -0.0106
75%        0.0200
max        0.1677
Name: mkt_excess, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="combining-three-factors" class="level3" data-number="11.5.5">
<h3 data-number="11.5.5" class="anchored" data-anchor-id="combining-three-factors"><span class="header-section-number">11.5.5</span> Combining Three Factors</h3>
<p>We combine SMB, HML, and the market factor into the complete three-factor dataset.</p>
<div id="3f6e1439" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> (factors_smb_hml</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add risk-free rate for completeness</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>rf_monthly <span class="op">=</span> (prices_monthly</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"risk_free"</span>]</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    .first()</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> factors_ff3_monthly.merge(rf_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-French Three Factors (Monthly):"</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_monthly.head(<span class="dv">10</span>))</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Factor Summary Statistics:"</span>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_monthly[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fama-French Three Factors (Monthly):
        date       smb       hml  mkt_excess  risk_free
0 2011-07-31 -0.007768  0.002754   -0.078748   0.003333
1 2011-08-31 -0.067309  0.011474    0.029906   0.003333
2 2011-09-30  0.014884  0.022854   -0.002173   0.003333
3 2011-10-31 -0.003743  0.001631   -0.014005   0.003333
4 2011-11-30  0.063234  0.009103   -0.179410   0.003333
5 2011-12-31  0.014571  0.015280   -0.094802   0.003333
6 2012-01-31 -0.026080  0.009672    0.081273   0.003333
7 2012-02-29 -0.035721  0.005474    0.069655   0.003333
8 2012-03-31 -0.002344  0.032477    0.029005   0.003333
9 2012-04-30 -0.033391  0.074191    0.048791   0.003333

Factor Summary Statistics:
       mkt_excess       smb       hml
count    150.0000  150.0000  150.0000
mean      -0.0101    0.0027    0.0120
std        0.0586    0.0420    0.0535
min       -0.2149   -0.1599   -0.1284
25%       -0.0380   -0.0175   -0.0160
50%       -0.0095    0.0070    0.0043
75%        0.0214    0.0261    0.0340
max        0.1677    0.1175    0.1618</code></pre>
</div>
</div>
</section>
<section id="saving-three-factor-data" class="level3" data-number="11.5.6">
<h3 data-number="11.5.6" class="anchored" data-anchor-id="saving-three-factor-data"><span class="header-section-number">11.5.6</span> Saving Three-Factor Data</h3>
<div id="5a9de573" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly.to_sql(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff3_monthly"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Three-factor monthly data saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Three-factor monthly data saved to database.</code></pre>
</div>
</div>
</section>
</section>
<section id="fama-french-five-factor-model-monthly" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="fama-french-five-factor-model-monthly"><span class="header-section-number">11.6</span> Fama-French Five-Factor Model (Monthly)</h2>
<section id="portfolio-assignments-with-dependent-sorts" class="level3" data-number="11.6.1">
<h3 data-number="11.6.1" class="anchored" data-anchor-id="portfolio-assignments-with-dependent-sorts"><span class="header-section-number">11.6.1</span> Portfolio Assignments with Dependent Sorts</h3>
<p>For the five-factor model, we use dependent sorts: size is sorted independently, but profitability and investment are sorted within size groups. This controls for the correlation between size and these characteristics.</p>
<div id="4a095f26" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_ff5_portfolios(sorting_variables):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign portfolios for Fama-French five-factor model.</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> sorting_variables.copy()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Independent size sort</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_size"</span>] <span class="op">=</span> df.groupby(<span class="st">"sorting_date"</span>)[<span class="st">"size"</span>].transform(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dependent sorts within size groups</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_bm"</span>] <span class="op">=</span> df.groupby([<span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>])[<span class="st">"bm"</span>].transform(</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_op"</span>] <span class="op">=</span> df.groupby([<span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>])[<span class="st">"op"</span>].transform(</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_inv"</span>] <span class="op">=</span> df.groupby([<span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>])[<span class="st">"inv"</span>].transform(</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Run</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>portfolios_ff5 <span class="op">=</span> assign_ff5_portfolios(sorting_variables)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="validating-five-factor-portfolios" class="level3" data-number="11.6.2">
<h3 data-number="11.6.2" class="anchored" data-anchor-id="validating-five-factor-portfolios"><span class="header-section-number">11.6.2</span> Validating Five-Factor Portfolios</h3>
<div id="b7bfa433" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check characteristic monotonicity for each dimension</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Profitability by Portfolio (should be increasing):"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff5.groupby(<span class="st">"portfolio_op"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"op"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Investment by Portfolio (should be increasing):"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff5.groupby(<span class="st">"portfolio_inv"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"inv"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check portfolio counts</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Stocks per Size/Profitability Bin:"</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff5.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_op"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check number of unique firms per year</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>(portfolios_ff5</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a> .groupby(<span class="st">"sorting_date"</span>)[<span class="st">"symbol"</span>]</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a> .nunique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Profitability by Portfolio (should be increasing):
portfolio_op
1   -0.0053
2    0.1366
3    0.4098
Name: op, dtype: float64

Investment by Portfolio (should be increasing):
portfolio_inv
1   -0.1012
2    0.0329
3    0.2568
Name: inv, dtype: float64

Stocks per Size/Profitability Bin:
portfolio_op       1     2     3
portfolio_size                  
1               1812  2403  1811
2               1811  2401  1808</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>sorting_date
2011-07-01     556
2012-07-01     632
2013-07-01     643
2014-07-01     650
2015-07-01     669
2016-07-01     737
2017-07-01     842
2018-07-01    1073
2019-07-01    1183
2020-07-01    1224
2021-07-01    1258
2022-07-01    1286
2023-07-01    1293
Name: symbol, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="merging-and-computing-portfolio-returns" class="level3" data-number="11.6.3">
<h3 data-number="11.6.3" class="anchored" data-anchor-id="merging-and-computing-portfolio-returns"><span class="header-section-number">11.6.3</span> Merging and Computing Portfolio Returns</h3>
<div id="8f84e01a" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with returns</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>portfolios_monthly_ff5 <span class="op">=</span> merge_portfolios_with_returns(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    prices_monthly,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    portfolios_ff5[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"portfolio_bm"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"portfolio_inv"</span>]]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Five-factor merged observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_monthly_ff5)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Five-factor merged observations: 136,444</code></pre>
</div>
</div>
</section>
<section id="constructing-all-five-factors" class="level3" data-number="11.6.4">
<h3 data-number="11.6.4" class="anchored" data-anchor-id="constructing-all-five-factors"><span class="header-section-number">11.6.4</span> Constructing All Five Factors</h3>
<p>We construct each factor from the appropriate portfolio sorts.</p>
<div id="a922235d" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_ff5_factors(portfolios_monthly):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct Fama-French five factors from portfolio data.</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolios_monthly : pd.DataFrame</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly returns with all portfolio assignments</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly five-factor returns</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HML: Value factor from B/M sorts</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    portfolios_bm <span class="op">=</span> (portfolios_monthly</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    factors_hml <span class="op">=</span> (portfolios_bm</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RMW: Profitability factor from OP sorts</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    portfolios_op <span class="op">=</span> (portfolios_monthly</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    factors_rmw <span class="op">=</span> (portfolios_op</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rmw"</span>: (x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CMA: Investment factor from INV sorts</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: CMA is Conservative minus Aggressive (low inv - high inv)</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>    portfolios_inv <span class="op">=</span> (portfolios_monthly</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_inv"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>    factors_cma <span class="op">=</span> (portfolios_inv</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cma"</span>: (x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SMB: Size factor (average across all characteristic portfolios)</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>    all_portfolios <span class="op">=</span> pd.concat([portfolios_bm, portfolios_op, portfolios_inv])</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>    factors_smb <span class="op">=</span> (all_portfolios</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all factors</span></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (factors_smb</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>        .merge(factors_hml, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>        .merge(factors_rmw, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>        .merge(factors_cma, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>factors_ff5 <span class="op">=</span> construct_ff5_factors(portfolios_monthly_ff5)</span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Add market factor</span></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>factors_ff5_monthly <span class="op">=</span> (factors_ff5</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>    .merge(rf_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-French Five Factors (Monthly):"</span>)</span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_monthly.head(<span class="dv">10</span>))</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Factor Summary Statistics:"</span>)</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_monthly[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fama-French Five Factors (Monthly):
        date       smb       hml       rmw       cma  mkt_excess  risk_free
0 2011-07-31 -0.015907 -0.002812  0.060525  0.045291   -0.078748   0.003333
1 2011-08-31 -0.061842  0.006189 -0.022700 -0.023177    0.029906   0.003333
2 2011-09-30  0.014387  0.024301 -0.006005  0.003588   -0.002173   0.003333
3 2011-10-31 -0.006958 -0.006940  0.026694  0.003649   -0.014005   0.003333
4 2011-11-30  0.074369  0.015617 -0.058766  0.044214   -0.179410   0.003333
5 2011-12-31  0.006687  0.022494  0.062655  0.052444   -0.094802   0.003333
6 2012-01-31 -0.016254  0.010513 -0.042191 -0.067170    0.081273   0.003333
7 2012-02-29 -0.026606  0.024465 -0.030849 -0.036383    0.069655   0.003333
8 2012-03-31  0.005096  0.050930 -0.018441  0.043488    0.029005   0.003333
9 2012-04-30  0.000712  0.058214 -0.061434  0.009233    0.048791   0.003333

Factor Summary Statistics:
       mkt_excess       smb       hml       rmw       cma
count    150.0000  150.0000  150.0000  150.0000  150.0000
mean      -0.0101    0.0077    0.0115   -0.0047    0.0083
std        0.0586    0.0419    0.0518    0.0477    0.0335
min       -0.2149   -0.1522   -0.1283   -0.2126   -0.0814
25%       -0.0380   -0.0137   -0.0126   -0.0308   -0.0131
50%       -0.0095    0.0104    0.0046    0.0010    0.0067
75%        0.0214    0.0316    0.0323    0.0178    0.0289
max        0.1677    0.1284    0.1510    0.1297    0.1331</code></pre>
</div>
</div>
</section>
<section id="factor-correlations" class="level3" data-number="11.6.5">
<h3 data-number="11.6.5" class="anchored" data-anchor-id="factor-correlations"><span class="header-section-number">11.6.5</span> Factor Correlations</h3>
<p>We examine correlations between factors, which should generally be low for the factors to capture distinct sources of risk.</p>
<div id="5f01c0da" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Factor Correlation Matrix:"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> factors_ff5_monthly[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]].corr()</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(correlation_matrix.<span class="bu">round</span>(<span class="dv">3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Factor Correlation Matrix:
            mkt_excess    smb    hml    rmw    cma
mkt_excess       1.000 -0.712  0.230 -0.006 -0.104
smb             -0.712  1.000  0.256 -0.373  0.246
hml              0.230  0.256  1.000 -0.694  0.479
rmw             -0.006 -0.373 -0.694  1.000 -0.352
cma             -0.104  0.246  0.479 -0.352  1.000</code></pre>
</div>
</div>
</section>
<section id="saving-five-factor-data" class="level3" data-number="11.6.6">
<h3 data-number="11.6.6" class="anchored" data-anchor-id="saving-five-factor-data"><span class="header-section-number">11.6.6</span> Saving Five-Factor Data</h3>
<div id="28d98fb8" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>factors_ff5_monthly.to_sql(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff5_monthly"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Five-factor monthly data saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Five-factor monthly data saved to database.</code></pre>
</div>
</div>
</section>
</section>
<section id="daily-fama-french-factors" class="level2" data-number="11.7">
<h2 data-number="11.7" class="anchored" data-anchor-id="daily-fama-french-factors"><span class="header-section-number">11.7</span> Daily Fama-French Factors</h2>
<section id="motivation-for-daily-factors" class="level3" data-number="11.7.1">
<h3 data-number="11.7.1" class="anchored" data-anchor-id="motivation-for-daily-factors"><span class="header-section-number">11.7.1</span> Motivation for Daily Factors</h3>
<p>Daily factors are essential for several applications:</p>
<ol type="1">
<li><strong>Daily beta estimation</strong>: CAPM regressions using daily data require daily market excess returns.</li>
<li><strong>Event studies</strong>: Measuring abnormal returns around corporate events requires daily factor adjustments.</li>
<li><strong>High-frequency research</strong>: Market microstructure studies need daily or intraday factor data.</li>
</ol>
<p>The construction methodology mirrors the monthly approach, but we compute portfolio returns at daily frequency while maintaining the same annual portfolio formation dates.</p>
</section>
<section id="loading-daily-returns" class="level3" data-number="11.7.2">
<h3 data-number="11.7.2" class="anchored" data-anchor-id="loading-daily-returns"><span class="header-section-number">11.7.2</span> Loading Daily Returns</h3>
<div id="9f12c711" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load daily price data</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_daily</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily returns: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="op">-%</span>d<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="op">-%</span>d<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily returns: 3,462,157 observations
Date range: 2010-01-05 to 2023-12-29</code></pre>
</div>
</div>
</section>
<section id="adding-market-cap-for-daily-weighting" class="level3" data-number="11.7.3">
<h3 data-number="11.7.3" class="anchored" data-anchor-id="adding-market-cap-for-daily-weighting"><span class="header-section-number">11.7.3</span> Adding Market Cap for Daily Weighting</h3>
<p>For value-weighted daily returns, we need market capitalization. We use the most recent monthly market cap as the weight for daily returns within that month.</p>
<div id="77014af6" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get monthly market cap to use as weights for daily returns</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>mktcap_monthly <span class="op">=</span> (prices_monthly</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"mktcap_lag"</span>]]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add year_month to daily data for merging</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> (prices_daily</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        mktcap_monthly[[<span class="st">"symbol"</span>, <span class="st">"year_month"</span>, <span class="st">"mktcap_lag"</span>]],</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year_month"</span>],</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily returns with weights: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily returns with weights: 3,443,815 observations</code></pre>
</div>
</div>
</section>
<section id="merging-daily-returns-with-portfolios" class="level3" data-number="11.7.4">
<h3 data-number="11.7.4" class="anchored" data-anchor-id="merging-daily-returns-with-portfolios"><span class="header-section-number">11.7.4</span> Merging Daily Returns with Portfolios</h3>
<p>We use the same portfolio assignments (formed annually in July) for daily returns.</p>
<div id="0a56493c" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Ensure portfolios_ff3 has correct format</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>portfolios_ff3_clean <span class="op">=</span> portfolios_ff3[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]].copy()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>portfolios_ff3_clean[<span class="st">"sorting_date"</span>] <span class="op">=</span> pd.to_datetime(portfolios_ff3_clean[<span class="st">"sorting_date"</span>])</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Portfolio sorting dates:"</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3_clean[<span class="st">"sorting_date"</span>].unique()[:<span class="dv">5</span>])</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create sorting_date for daily data</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>prices_daily_with_sort <span class="op">=</span> prices_daily.copy()</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>prices_daily_with_sort[<span class="st">"sorting_date"</span>] <span class="op">=</span> prices_daily_with_sort[<span class="st">"date"</span>].<span class="bu">apply</span>(</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: pd.Timestamp(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">.</span>year<span class="sc">}</span><span class="ss">-07-01"</span>) <span class="cf">if</span> x.month <span class="op">&gt;</span> <span class="dv">6</span> <span class="cf">else</span> pd.Timestamp(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">.</span>year <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">-07-01"</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily sorting dates:"</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_daily_with_sort[<span class="st">"sorting_date"</span>].unique()[:<span class="dv">5</span>])</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Merge</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>portfolios_daily_ff3 <span class="op">=</span> prices_daily_with_sort.merge(</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    portfolios_ff3_clean,</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>],</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Merged daily observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff3)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique dates: </span><span class="sc">{</span>portfolios_daily_ff3[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Verify portfolio distribution</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Portfolio distribution in daily data:"</span>)</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_daily_ff3.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Portfolio sorting dates:
&lt;DatetimeArray&gt;
['2019-07-01 00:00:00', '2020-07-01 00:00:00', '2021-07-01 00:00:00',
 '2022-07-01 00:00:00', '2023-07-01 00:00:00']
Length: 5, dtype: datetime64[us]

Daily sorting dates:
&lt;DatetimeArray&gt;
['2018-07-01 00:00:00', '2019-07-01 00:00:00', '2020-07-01 00:00:00',
 '2021-07-01 00:00:00', '2022-07-01 00:00:00']
Length: 5, dtype: datetime64[us]

Merged daily observations: 2,843,570
Unique dates: 3,126

Portfolio distribution in daily data:
portfolio_bm         1       2       3
portfolio_size                        
1               218040  585561  617327
2               636152  552114  234376</code></pre>
</div>
</div>
<div id="a3cd3e9a" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic: Check the daily portfolio merge</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSTIC: Daily Portfolio Merge"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Daily prices rows: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily FF3 portfolios rows: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff3)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Match rate: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff3)<span class="op">/</span><span class="bu">len</span>(prices_daily)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Check portfolio distribution in daily data</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily portfolio distribution:"</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_daily_ff3.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check a specific date</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>test_date <span class="op">=</span> portfolios_daily_ff3[<span class="st">"date"</span>].iloc[<span class="dv">1000</span>]</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Sample date: </span><span class="sc">{</span>test_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_daily_ff3.query(<span class="st">"date == @test_date"</span>).groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>==================================================
DIAGNOSTIC: Daily Portfolio Merge
==================================================

Daily prices rows: 3,443,815
Daily FF3 portfolios rows: 2,843,570
Match rate: 82.6%

Daily portfolio distribution:
portfolio_bm         1       2       3
portfolio_size                        
1               218040  585561  617327
2               636152  552114  234376

Sample date: 2023-06-28 00:00:00
portfolio_bm      1    2    3
portfolio_size               
1                93  232  312
2               291  280   67</code></pre>
</div>
</div>
</section>
<section id="computing-daily-three-factors" class="level3" data-number="11.7.5">
<h3 data-number="11.7.5" class="anchored" data-anchor-id="computing-daily-three-factors"><span class="header-section-number">11.7.5</span> Computing Daily Three Factors</h3>
<div id="4217fc66" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_daily_ff3_factors(portfolios_daily):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute daily Fama-French three factors.</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolios_daily : pd.DataFrame</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily returns with portfolio assignments</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily SMB and HML factors</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily portfolio returns</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> (portfolios_daily</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute factors</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (portfolio_returns</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean()),</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>factors_daily_smb_hml <span class="op">=</span> compute_daily_ff3_factors(portfolios_daily_ff3)</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily factor observations: </span><span class="sc">{</span><span class="bu">len</span>(factors_daily_smb_hml)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_daily_smb_hml.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily factor observations: 3,126
        date       smb       hml
0 2011-07-01  0.008587  0.000967
1 2011-07-04  0.005099 -0.001099
2 2011-07-05 -0.009088  0.010152
3 2011-07-06  0.004875 -0.003918
4 2011-07-07 -0.011239 -0.000584
5 2011-07-08  0.005636 -0.008003
6 2011-07-11  0.003940  0.006172
7 2011-07-12  0.003205  0.006543
8 2011-07-13 -0.000097 -0.001134
9 2011-07-14 -0.001248  0.001669</code></pre>
</div>
</div>
</section>
<section id="computing-daily-market-factor" class="level3" data-number="11.7.6">
<h3 data-number="11.7.6" class="anchored" data-anchor-id="computing-daily-market-factor"><span class="header-section-number">11.7.6</span> Computing Daily Market Factor</h3>
<div id="ff76226a" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_daily_market_factor(prices_daily):</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute daily value-weighted market excess return.</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_daily : pd.DataFrame</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily returns with mktcap_lag</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily market excess return</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    market_daily <span class="op">=</span> (prices_daily</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mkt_excess"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> market_daily</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>market_factor_daily <span class="op">=</span> compute_daily_market_factor(prices_daily)</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily market factor: </span><span class="sc">{</span><span class="bu">len</span>(market_factor_daily)<span class="sc">:,}</span><span class="ss"> days"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily market factor: 3,474 days</code></pre>
</div>
</div>
</section>
<section id="combining-daily-three-factors" class="level3" data-number="11.7.7">
<h3 data-number="11.7.7" class="anchored" data-anchor-id="combining-daily-three-factors"><span class="header-section-number">11.7.7</span> Combining Daily Three Factors</h3>
<div id="9dc3a525" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily <span class="op">=</span> (factors_daily_smb_hml</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor_daily, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add risk-free rate (use monthly rate / 21 as daily approximation, or load actual daily rate)</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily[<span class="st">"risk_free"</span>] <span class="op">=</span> <span class="fl">0.04</span> <span class="op">/</span> <span class="dv">252</span>  <span class="co"># Approximate daily risk-free</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily Fama-French Three Factors:"</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_daily.head(<span class="dv">10</span>))</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily Factor Summary Statistics:"</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_daily[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]].describe().<span class="bu">round</span>(<span class="dv">6</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily Fama-French Three Factors:
        date       smb       hml  mkt_excess  risk_free
0 2011-07-01  0.008587  0.000967   -0.019862   0.000159
1 2011-07-04  0.005099 -0.001099   -0.000633   0.000159
2 2011-07-05 -0.009088  0.010152    0.013314   0.000159
3 2011-07-06  0.004875 -0.003918   -0.008045   0.000159
4 2011-07-07 -0.011239 -0.000584    0.003391   0.000159
5 2011-07-08  0.005636 -0.008003    0.000218   0.000159
6 2011-07-11  0.003940  0.006172   -0.013393   0.000159
7 2011-07-12  0.003205  0.006543   -0.017505   0.000159
8 2011-07-13 -0.000097 -0.001134    0.000767   0.000159
9 2011-07-14 -0.001248  0.001669   -0.000695   0.000159

Daily Factor Summary Statistics:
        mkt_excess          smb          hml
count  3126.000000  3126.000000  3126.000000
mean     -0.000479     0.000236     0.000594
std       0.011269     0.008488     0.008585
min      -0.070268    -0.032671    -0.039418
25%      -0.005074    -0.004882    -0.003941
50%       0.000350    -0.000106     0.000522
75%       0.005531     0.004307     0.005233
max       0.043386     0.042686     0.083889</code></pre>
</div>
</div>
</section>
<section id="computing-daily-five-factors" class="level3" data-number="11.7.8">
<h3 data-number="11.7.8" class="anchored" data-anchor-id="computing-daily-five-factors"><span class="header-section-number">11.7.8</span> Computing Daily Five Factors</h3>
<div id="eccb5cac" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Clean portfolios</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>portfolios_ff5_clean <span class="op">=</span> portfolios_ff5[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">"portfolio_bm"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"portfolio_inv"</span>]].copy()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>portfolios_ff5_clean[<span class="st">"sorting_date"</span>] <span class="op">=</span> pd.to_datetime(portfolios_ff5_clean[<span class="st">"sorting_date"</span>])</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Merge with daily prices</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>portfolios_daily_ff5 <span class="op">=</span> prices_daily_with_sort.merge(</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    portfolios_ff5_clean,</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>],</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"FF5 Daily merged observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff5)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>FF5 Daily merged observations: 2,843,570</code></pre>
</div>
</div>
<div id="dd399305" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_daily_ff5_factors(portfolios_daily):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute daily Fama-French five factors."""</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HML from B/M sorts</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    portfolios_bm <span class="op">=</span> (portfolios_daily</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    factors_hml <span class="op">=</span> (portfolios_bm</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RMW from OP sorts</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    portfolios_op <span class="op">=</span> (portfolios_daily</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    factors_rmw <span class="op">=</span> (portfolios_op</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rmw"</span>: (x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CMA from INV sorts (note: low minus high)</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>    portfolios_inv <span class="op">=</span> (portfolios_daily</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_inv"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>    factors_cma <span class="op">=</span> (portfolios_inv</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cma"</span>: (x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SMB from all sorts</span></span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>    all_portfolios <span class="op">=</span> pd.concat([portfolios_bm, portfolios_op, portfolios_inv])</span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a>    factors_smb <span class="op">=</span> (all_portfolios</span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine</span></span>
<span id="cb62-71"><a href="#cb62-71" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (factors_smb</span>
<span id="cb62-72"><a href="#cb62-72" aria-hidden="true" tabindex="-1"></a>        .merge(factors_hml, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb62-73"><a href="#cb62-73" aria-hidden="true" tabindex="-1"></a>        .merge(factors_rmw, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb62-74"><a href="#cb62-74" aria-hidden="true" tabindex="-1"></a>        .merge(factors_cma, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb62-75"><a href="#cb62-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-76"><a href="#cb62-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-77"><a href="#cb62-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb62-78"><a href="#cb62-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-79"><a href="#cb62-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily FF5 factors</span></span>
<span id="cb62-80"><a href="#cb62-80" aria-hidden="true" tabindex="-1"></a>factors_daily_ff5 <span class="op">=</span> compute_daily_ff5_factors(portfolios_daily_ff5)</span>
<span id="cb62-81"><a href="#cb62-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-82"><a href="#cb62-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Add market factor</span></span>
<span id="cb62-83"><a href="#cb62-83" aria-hidden="true" tabindex="-1"></a>factors_ff5_daily <span class="op">=</span> (factors_daily_ff5</span>
<span id="cb62-84"><a href="#cb62-84" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor_daily, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb62-85"><a href="#cb62-85" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-86"><a href="#cb62-86" aria-hidden="true" tabindex="-1"></a>factors_ff5_daily[<span class="st">"risk_free"</span>] <span class="op">=</span> <span class="fl">0.04</span> <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb62-87"><a href="#cb62-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-88"><a href="#cb62-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily Fama-French Five Factors:"</span>)</span>
<span id="cb62-89"><a href="#cb62-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_daily.head(<span class="dv">10</span>))</span>
<span id="cb62-90"><a href="#cb62-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-91"><a href="#cb62-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily Five-Factor Summary Statistics:"</span>)</span>
<span id="cb62-92"><a href="#cb62-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_daily[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]].describe().<span class="bu">round</span>(<span class="dv">6</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily Fama-French Five Factors:
        date       smb       hml       rmw       cma  mkt_excess  risk_free
0 2011-07-01  0.006295  0.002515  0.013140  0.007680   -0.019862   0.000159
1 2011-07-04  0.002880 -0.002875  0.006560 -0.004886   -0.000633   0.000159
2 2011-07-05 -0.004260  0.009864 -0.012158 -0.004470    0.013314   0.000159
3 2011-07-06  0.001544 -0.009847  0.012977  0.006286   -0.008045   0.000159
4 2011-07-07 -0.009789 -0.003988 -0.000197 -0.006995    0.003391   0.000159
5 2011-07-08  0.001537 -0.006700  0.010841 -0.007661    0.000218   0.000159
6 2011-07-11  0.005396  0.004747  0.000655  0.013375   -0.013393   0.000159
7 2011-07-12  0.004759  0.007367  0.001989  0.014669   -0.017505   0.000159
8 2011-07-13 -0.000009  0.001110 -0.002052 -0.001633    0.000767   0.000159
9 2011-07-14 -0.001668  0.002916 -0.005427  0.005388   -0.000695   0.000159

Daily Five-Factor Summary Statistics:
        mkt_excess          smb          hml          rmw          cma
count  3126.000000  3126.000000  3126.000000  3126.000000  3126.000000
mean     -0.000479     0.000484     0.000549    -0.000136     0.000413
std       0.011269     0.008033     0.008312     0.008538     0.006756
min      -0.070268    -0.036283    -0.039155    -0.154013    -0.047698
25%      -0.005074    -0.004122    -0.003681    -0.004212    -0.003364
50%       0.000350     0.000105     0.000384     0.000030     0.000162
75%       0.005531     0.004358     0.004819     0.004036     0.003800
max       0.043386     0.060307     0.086269     0.102001     0.089907</code></pre>
</div>
</div>
</section>
<section id="saving-daily-factors" class="level3" data-number="11.7.9">
<h3 data-number="11.7.9" class="anchored" data-anchor-id="saving-daily-factors"><span class="header-section-number">11.7.9</span> Saving Daily Factors</h3>
<div id="75fc71e0" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily.to_sql(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff3_daily"</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>factors_ff5_daily.to_sql(</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff5_daily"</span>,</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily factor data saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily factor data saved to database.</code></pre>
</div>
</div>
</section>
</section>
<section id="factor-validation-and-diagnostics" class="level2" data-number="11.8">
<h2 data-number="11.8" class="anchored" data-anchor-id="factor-validation-and-diagnostics"><span class="header-section-number">11.8</span> Factor Validation and Diagnostics</h2>
<div id="f4eebb91" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify all tables are in database</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATABASE SUMMARY"</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>tables <span class="op">=</span> [<span class="st">"factors_ff3_monthly"</span>, <span class="st">"factors_ff5_monthly"</span>, </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">"factors_ff3_daily"</span>, <span class="st">"factors_ff5_daily"</span>]</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> table <span class="kw">in</span> tables:</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_sql_query(<span class="ss">f"SELECT COUNT(*) as n FROM </span><span class="sc">{</span>table<span class="sc">}</span><span class="ss">"</span>, con<span class="op">=</span>tidy_finance)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>table<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>df[<span class="st">'n'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation check: Monthly vs Daily (aggregated)</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MONTHLY VS DAILY CONSISTENCY CHECK"</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>factors_daily_agg <span class="op">=</span> (factors_ff3_daily</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year_month"</span>)[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]]</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>factors_monthly_check <span class="op">=</span> (factors_ff3_monthly</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> factors_monthly_check.merge(</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    factors_daily_agg, on<span class="op">=</span><span class="st">"year_month"</span>, suffixes<span class="op">=</span>(<span class="st">"_monthly"</span>, <span class="st">"_daily"</span>)</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]:</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_monthly"</span>].corr(comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_daily"</span>])</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">: Monthly-Daily correlation = </span><span class="sc">{</span>corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
==================================================
DATABASE SUMMARY
==================================================
factors_ff3_monthly: 150 observations
factors_ff5_monthly: 150 observations
factors_ff3_daily: 3,126 observations
factors_ff5_daily: 3,126 observations

==================================================
MONTHLY VS DAILY CONSISTENCY CHECK
==================================================
mkt_excess: Monthly-Daily correlation = 0.9980
smb: Monthly-Daily correlation = 0.9953
hml: Monthly-Daily correlation = 0.9936</code></pre>
</div>
</div>
<section id="cumulative-factor-returns" class="level3" data-number="11.8.1">
<h3 data-number="11.8.1" class="anchored" data-anchor-id="cumulative-factor-returns"><span class="header-section-number">11.8.1</span> Cumulative Factor Returns</h3>
<p>We visualize the cumulative performance of each factor to assess whether the factors generate meaningful premiums over time.</p>
<div id="cell-fig-cumulative-factors" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cumulative returns</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>factors_cumulative <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"date"</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    .add(<span class="dv">1</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    .cumprod()</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>factors_cumulative.plot(ax<span class="op">=</span>ax)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cumulative Factor Returns (Vietnam)"</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">""</span>)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Growth of $1"</span>)</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Factor"</span>)</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-cumulative-factors" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing cumulative factor returns over time." data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumulative-factors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="12_fama_french_files/figure-html/fig-cumulative-factors-output-1.png" class="quarto-figure quarto-figure-center figure-img" alt="Line chart showing cumulative factor returns over time." width="1142" height="566">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cumulative-factors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.1: Cumulative returns of Fama-French factors for the Vietnamese market. The figure shows the growth of $1 invested in each factor portfolio.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="average-factor-premiums" class="level3" data-number="11.8.2">
<h3 data-number="11.8.2" class="anchored" data-anchor-id="average-factor-premiums"><span class="header-section-number">11.8.2</span> Average Factor Premiums</h3>
<p>We compute annualized average factor premiums and their statistical significance.</p>
<div id="c3587dac" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Annualized average returns (monthly returns * 12)</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>factor_premiums <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    .mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span>  <span class="co"># Annualized percentage</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard errors</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>factor_se <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    .std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(factors_ff5_monthly)) <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="co"># T-statistics</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>factor_tstat <span class="op">=</span> factor_premiums <span class="op">/</span> factor_se</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Annualized Factor Premiums (%):"</span>)</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_premiums.<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">T-Statistics:"</span>)</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_tstat.<span class="bu">round</span>(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Annualized Factor Premiums (%):
mkt_excess   -12.09
smb            9.19
hml           13.75
rmw           -5.69
cma            9.94
dtype: float64

T-Statistics:
mkt_excess    -7.30
smb            7.76
hml            9.38
rmw           -4.22
cma           10.49
dtype: float64</code></pre>
</div>
</div>
</section>
<section id="comparing-monthly-and-daily-factors" class="level3" data-number="11.8.3">
<h3 data-number="11.8.3" class="anchored" data-anchor-id="comparing-monthly-and-daily-factors"><span class="header-section-number">11.8.3</span> Comparing Monthly and Daily Factors</h3>
<p>We verify consistency between monthly and daily factors by computing correlations.</p>
<div id="0a79a110" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily factors to monthly for comparison</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>factors_daily_monthly <span class="op">=</span> (factors_ff5_daily</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year_month"</span>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()  <span class="co"># Sum daily returns to get monthly</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with actual monthly factors</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        factors_daily_monthly,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"year_month"</span>,</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        suffixes<span class="op">=</span>(<span class="st">"_monthly"</span>, <span class="st">"_daily"</span>)</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlations</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]:</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_monthly"</span>].corr(comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_daily"</span>])</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">: Monthly-Daily correlation = </span><span class="sc">{</span>corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>mkt_excess: Monthly-Daily correlation = 0.9980
smb: Monthly-Daily correlation = 0.9950
hml: Monthly-Daily correlation = 0.9948
rmw: Monthly-Daily correlation = 0.9929
cma: Monthly-Daily correlation = 0.9884</code></pre>
</div>
</div>
</section>
</section>
<section id="key-takeaways" class="level2" data-number="11.9">
<h2 data-number="11.9" class="anchored" data-anchor-id="key-takeaways"><span class="header-section-number">11.9</span> Key Takeaways</h2>
<ol type="1">
<li><p><strong>Factor Models Explained</strong>: The Fama-French three-factor model adds size (SMB) and value (HML) factors to the CAPM, while the five-factor model further includes profitability (RMW) and investment (CMA) factors.</p></li>
<li><p><strong>Construction Methodology</strong>: Factors are constructed through double-sorted portfolios with careful attention to timing. Portfolios are formed in July using accounting data from the prior fiscal year to ensure information was publicly available.</p></li>
<li><p><strong>Independent vs.&nbsp;Dependent Sorts</strong>: The three-factor model uses independent sorts on size and book-to-market, creating a 2×3 grid. The five-factor model uses dependent sorts where characteristics are sorted within size groups.</p></li>
<li><p><strong>Value-Weighted Returns</strong>: Portfolio returns are computed using value-weighting with lagged market capitalization to avoid look-ahead bias.</p></li>
<li><p><strong>Daily Factors</strong>: Daily factors use the same annual portfolio assignments but compute returns at daily frequency, enabling higher-frequency applications like daily beta estimation.</p></li>
<li><p><strong>Market Factor</strong>: The market factor is computed independently as the value-weighted return of all stocks minus the risk-free rate.</p></li>
<li><p><strong>Validation</strong>: Factor quality can be assessed through characteristic monotonicity, portfolio diversification, cumulative returns, and consistency between daily and monthly frequencies.</p></li>
<li><p><strong>Vietnamese Market Adaptation</strong>: While following the original Fama-French methodology, we adapt for Vietnamese market characteristics including VAS accounting standards, reporting timelines, and currency units.</p></li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Fama1992" class="csl-entry" role="listitem">
Fama, Eugene F., and Kenneth R. French. 1992. <span>“<span class="nocase">The cross-section of expected stock returns</span>.”</span> <em><span>The Journal of Finance</span></em> 47 (2): 427–65. <a href="https://doi.org/2329112">https://doi.org/2329112</a>.
</div>
<div id="ref-FamaFrench2015" class="csl-entry" role="listitem">
———. 2015. <span>“A Five-Factor Asset Pricing Model.”</span> <em>Journal of Financial Economics</em> 116 (1): 1–22. <a href="https://doi.org/10.1016/j.jfineco.2014.10.010">https://doi.org/10.1016/j.jfineco.2014.10.010</a>.
</div>
<div id="ref-Sharpe1964" class="csl-entry" role="listitem">
Sharpe, William F. 1964. <span>“<span class="nocase">Capital asset prices: A theory of market equilibrium under conditions of risk </span>.”</span> <em><span>The Journal of Finance</span></em> 19 (3): 425–42. <a href="https://doi.org/10.1111/j.1540-6261.1964.tb02865.x">https://doi.org/10.1111/j.1540-6261.1964.tb02865.x</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
  (function () {
    const GA_ID = "G-LMDLDJXXSC"; // <-- replace
    const KEY = "cookie_consent_v1";

    function loadGtag() {
      if (window.__gtag_loaded__) return;
      window.__gtag_loaded__ = true;

      const s1 = document.createElement("script");
      s1.async = true;
      s1.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);
      document.head.appendChild(s1);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, { anonymize_ip: true });
    }

    function maybeEnableAnalytics() {
      const consent = localStorage.getItem(KEY);
      if (consent === "accepted") loadGtag();
    }

    // Load on first render if already accepted
    maybeEnableAnalytics();

    // Load when user changes consent
    window.addEventListener("cookie-consent-changed", function (e) {
      if (e.detail === "accepted") loadGtag();
    });
  })();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./09_univariate_portfolio_sort.html" class="pagination-link" aria-label="Univariate Portfolio Sorts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./13_fama_macbeth.html" class="pagination-link" aria-label="Fama-MacBeth Regressions">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Fama-French Factors</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>This chapter provides a replication of the Fama-French factor portfolios for the Vietnamese stock market. The Fama-French factor models represent a cornerstone of empirical asset pricing, originating from the seminal work of @Fama1992 and later extended in @FamaFrench2015. These models have transformed how academics and practitioners understand the cross-section of expected stock returns, moving beyond the single-factor Capital Asset Pricing Model to incorporate multiple sources of systematic risk.</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>We construct both the three-factor and five-factor models at monthly and daily frequencies. The monthly factors serve as the foundation for most asset pricing tests and portfolio analyses, while the daily factors enable higher-frequency applications including short-horizon event studies, market microstructure research, and daily beta estimation. By constructing factors at both frequencies, we create a complete toolkit for empirical finance research in the Vietnamese market.</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>The chapter proceeds as follows. We first discuss the theoretical motivation for each factor and the economic intuition behind the Fama-French methodology. We then prepare the necessary data, merging stock returns with accounting characteristics. Next, we implement the portfolio sorting procedures that form the basis of factor construction, carefully following the original Fama-French protocols while adapting them for Vietnamese market characteristics. We construct the three-factor model (market, size, and value) before extending to the five-factor model (adding profitability and investment). Finally, we construct daily factors and validate our replicated factors through various diagnostic checks.</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Theoretical Background</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Evolution from CAPM to Multi-Factor Models</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>The Capital Asset Pricing Model of @Sharpe1964 posits that a single factor—the market portfolio—should explain all cross-sectional variation in expected returns. However, decades of empirical research have documented persistent patterns that CAPM cannot explain. @Fama1992 demonstrated that two firm characteristics—size and book-to-market ratio—capture substantial variation in average returns that the market beta leaves unexplained.</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>Small firms tend to earn higher returns than large firms, a pattern known as the size effect. Similarly, firms with high book-to-market ratios (value stocks) tend to outperform firms with low book-to-market ratios (growth stocks), known as the value premium. The three-factor model formalizes these observations by constructing tradeable factor portfolios:</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>r_{i,t} - r_{f,t} = \alpha_i + \beta_i^{MKT}(r_{m,t} - r_{f,t}) + \beta_i^{SMB} \cdot SMB_t + \beta_i^{HML} \cdot HML_t + \varepsilon_{i,t}</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ff3}</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$r_{i,t} - r_{f,t}$ is the excess return on asset $i$</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$r_{m,t} - r_{f,t}$ is the market excess return</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$SMB_t$ (Small Minus Big) is the size factor</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$HML_t$ (High Minus Low) is the value factor</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Five-Factor Extension</span></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>@FamaFrench2015 extended the model to include two additional factors motivated by the dividend discount model. Firms with higher profitability should have higher expected returns (all else equal), and firms with aggressive investment policies should have lower expected returns:</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>r_{i,t} - r_{f,t} = \alpha_i + \beta_i^{MKT}MKT_t + \beta_i^{SMB}SMB_t + \beta_i^{HML}HML_t + \beta_i^{RMW}RMW_t + \beta_i^{CMA}CMA_t + \varepsilon_{i,t}</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ff5}</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$RMW_t$ (Robust Minus Weak) is the profitability factor</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$CMA_t$ (Conservative Minus Aggressive) is the investment factor</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a><span class="fu">### Factor Construction Methodology</span></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>The Fama-French methodology constructs factors through double-sorted portfolios:</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Size sorts**: Stocks are divided into Small and Big groups based on median market capitalization.</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Characteristic sorts**: Within each size group, stocks are sorted into terciles based on book-to-market (for HML), operating profitability (for RMW), or investment (for CMA).</span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Factor returns**: Factors are computed as the difference between average returns of portfolios with high versus low characteristic values, averaging across size groups to neutralize size effects.</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Timing**: Portfolios are formed at the end of June each year using accounting data from the prior fiscal year, ensuring all information was publicly available at formation.</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up the Environment</span></span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>We load the required Python packages for data manipulation, statistical analysis, and visualization.</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats.mstats <span class="im">import</span> winsorize</span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-78"><a href="#cb73-78" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb73-79"><a href="#cb73-79" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a>We connect to our SQLite database containing the processed Vietnamese financial data.</span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation</span></span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-92"><a href="#cb73-92" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Stock Returns</span></span>
<span id="cb73-93"><a href="#cb73-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a>We load the monthly stock returns data, which includes excess returns, market capitalization, and the risk-free rate. These variables are essential for computing value-weighted portfolio returns and factor premiums.</span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-98"><a href="#cb73-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-99"><a href="#cb73-99" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb73-100"><a href="#cb73-100" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb73-101"><a href="#cb73-101" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess, mktcap, mktcap_lag, risk_free</span></span>
<span id="cb73-102"><a href="#cb73-102" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb73-103"><a href="#cb73-103" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb73-104"><a href="#cb73-104" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-105"><a href="#cb73-105" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb73-106"><a href="#cb73-106" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb73-107"><a href="#cb73-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-108"><a href="#cb73-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly returns: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb73-109"><a href="#cb73-109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-110"><a href="#cb73-110" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-111"><a href="#cb73-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-112"><a href="#cb73-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-113"><a href="#cb73-113" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Company Fundamentals</span></span>
<span id="cb73-114"><a href="#cb73-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-115"><a href="#cb73-115" aria-hidden="true" tabindex="-1"></a>We load the company fundamentals data containing book equity, operating profitability, and investment—the characteristics needed for constructing the Fama-French factors.</span>
<span id="cb73-116"><a href="#cb73-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-119"><a href="#cb73-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-120"><a href="#cb73-120" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb73-121"><a href="#cb73-121" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb73-122"><a href="#cb73-122" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, datadate, be, op, inv</span></span>
<span id="cb73-123"><a href="#cb73-123" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM comp_vn</span></span>
<span id="cb73-124"><a href="#cb73-124" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb73-125"><a href="#cb73-125" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-126"><a href="#cb73-126" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"datadate"</span>}</span>
<span id="cb73-127"><a href="#cb73-127" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb73-128"><a href="#cb73-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-129"><a href="#cb73-129" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fundamentals: </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss"> firm-year observations"</span>)</span>
<span id="cb73-130"><a href="#cb73-130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-131"><a href="#cb73-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-132"><a href="#cb73-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-133"><a href="#cb73-133" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constructing Sorting Variables</span></span>
<span id="cb73-134"><a href="#cb73-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-135"><a href="#cb73-135" aria-hidden="true" tabindex="-1"></a>Following Fama-French conventions, we construct the sorting variables with careful attention to timing. The key principles are:</span>
<span id="cb73-136"><a href="#cb73-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-137"><a href="#cb73-137" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Size (June Market Cap)**: We use market capitalization at the end of June of year $t$ to sort stocks into size groups. This ensures we capture the firm's size at the moment of portfolio formation.</span>
<span id="cb73-138"><a href="#cb73-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-139"><a href="#cb73-139" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Book-to-Market Ratio**: We use book equity from fiscal year $t-1$ divided by market equity at the end of December $t-1$. This creates a six-month gap between the accounting data and portfolio formation, ensuring the information was publicly available.</span>
<span id="cb73-140"><a href="#cb73-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-141"><a href="#cb73-141" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Portfolio Formation Date**: Portfolios are formed on July 1st and held for twelve months until the following June.</span>
<span id="cb73-142"><a href="#cb73-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-145"><a href="#cb73-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-146"><a href="#cb73-146" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_sorting_variables(prices_monthly, comp_vn):</span>
<span id="cb73-147"><a href="#cb73-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-148"><a href="#cb73-148" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct sorting variables following Fama-French methodology.</span></span>
<span id="cb73-149"><a href="#cb73-149" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-150"><a href="#cb73-150" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-151"><a href="#cb73-151" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-152"><a href="#cb73-152" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_monthly : pd.DataFrame</span></span>
<span id="cb73-153"><a href="#cb73-153" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock returns with market cap</span></span>
<span id="cb73-154"><a href="#cb73-154" aria-hidden="true" tabindex="-1"></a><span class="co">    comp_vn : pd.DataFrame</span></span>
<span id="cb73-155"><a href="#cb73-155" aria-hidden="true" tabindex="-1"></a><span class="co">        Company fundamentals with book equity, profitability, investment</span></span>
<span id="cb73-156"><a href="#cb73-156" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-157"><a href="#cb73-157" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-158"><a href="#cb73-158" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-159"><a href="#cb73-159" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-160"><a href="#cb73-160" aria-hidden="true" tabindex="-1"></a><span class="co">        Sorting variables aligned with July 1st formation dates</span></span>
<span id="cb73-161"><a href="#cb73-161" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-162"><a href="#cb73-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-163"><a href="#cb73-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Size: June market capitalization</span></span>
<span id="cb73-164"><a href="#cb73-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Portfolio formation is July 1st, so we use June market cap</span></span>
<span id="cb73-165"><a href="#cb73-165" aria-hidden="true" tabindex="-1"></a>    size <span class="op">=</span> (prices_monthly</span>
<span id="cb73-166"><a href="#cb73-166" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"date.dt.month == 6"</span>)</span>
<span id="cb73-167"><a href="#cb73-167" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb73-168"><a href="#cb73-168" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb73-169"><a href="#cb73-169" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-170"><a href="#cb73-170" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"mktcap"</span>]]</span>
<span id="cb73-171"><a href="#cb73-171" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"mktcap"</span>: <span class="st">"size"</span>})</span>
<span id="cb73-172"><a href="#cb73-172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-173"><a href="#cb73-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-174"><a href="#cb73-174" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Size observations: </span><span class="sc">{</span><span class="bu">len</span>(size)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-175"><a href="#cb73-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-176"><a href="#cb73-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Market Equity: December market cap for B/M calculation</span></span>
<span id="cb73-177"><a href="#cb73-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># December t-1 market cap is used with fiscal year t-1 book equity</span></span>
<span id="cb73-178"><a href="#cb73-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is then used for July t portfolio formation</span></span>
<span id="cb73-179"><a href="#cb73-179" aria-hidden="true" tabindex="-1"></a>    market_equity <span class="op">=</span> (prices_monthly</span>
<span id="cb73-180"><a href="#cb73-180" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"date.dt.month == 12"</span>)</span>
<span id="cb73-181"><a href="#cb73-181" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb73-182"><a href="#cb73-182" aria-hidden="true" tabindex="-1"></a>            <span class="co"># December year t-1 maps to July year t formation</span></span>
<span id="cb73-183"><a href="#cb73-183" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">7</span>)</span>
<span id="cb73-184"><a href="#cb73-184" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-185"><a href="#cb73-185" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"mktcap"</span>]]</span>
<span id="cb73-186"><a href="#cb73-186" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"mktcap"</span>: <span class="st">"me"</span>})</span>
<span id="cb73-187"><a href="#cb73-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-188"><a href="#cb73-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-189"><a href="#cb73-189" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Market equity observations: </span><span class="sc">{</span><span class="bu">len</span>(market_equity)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-190"><a href="#cb73-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-191"><a href="#cb73-191" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Book-to-Market and other characteristics</span></span>
<span id="cb73-192"><a href="#cb73-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fiscal year t-1 data is used for July t portfolio formation</span></span>
<span id="cb73-193"><a href="#cb73-193" aria-hidden="true" tabindex="-1"></a>    book_to_market <span class="op">=</span> (comp_vn</span>
<span id="cb73-194"><a href="#cb73-194" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb73-195"><a href="#cb73-195" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fiscal year-end + 6 months = July formation</span></span>
<span id="cb73-196"><a href="#cb73-196" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(</span>
<span id="cb73-197"><a href="#cb73-197" aria-hidden="true" tabindex="-1"></a>                (x[<span class="st">"datadate"</span>].dt.year <span class="op">+</span> <span class="dv">1</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-07-01"</span></span>
<span id="cb73-198"><a href="#cb73-198" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-199"><a href="#cb73-199" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-200"><a href="#cb73-200" aria-hidden="true" tabindex="-1"></a>        .merge(market_equity, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-201"><a href="#cb73-201" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb73-202"><a href="#cb73-202" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Scale book equity to match market equity units</span></span>
<span id="cb73-203"><a href="#cb73-203" aria-hidden="true" tabindex="-1"></a>            <span class="co"># BE is in VND, ME is in millions VND</span></span>
<span id="cb73-204"><a href="#cb73-204" aria-hidden="true" tabindex="-1"></a>            bm<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"be"</span>] <span class="op">/</span> (x[<span class="st">"me"</span>] <span class="op">*</span> <span class="fl">1e9</span>)</span>
<span id="cb73-205"><a href="#cb73-205" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-206"><a href="#cb73-206" aria-hidden="true" tabindex="-1"></a>        [[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"me"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]]</span>
<span id="cb73-207"><a href="#cb73-207" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-208"><a href="#cb73-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-209"><a href="#cb73-209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Book-to-market observations: </span><span class="sc">{</span><span class="bu">len</span>(book_to_market)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-210"><a href="#cb73-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-211"><a href="#cb73-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Merge size with characteristics</span></span>
<span id="cb73-212"><a href="#cb73-212" aria-hidden="true" tabindex="-1"></a>    sorting_variables <span class="op">=</span> (size</span>
<span id="cb73-213"><a href="#cb73-213" aria-hidden="true" tabindex="-1"></a>        .merge(book_to_market, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-214"><a href="#cb73-214" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb73-215"><a href="#cb73-215" aria-hidden="true" tabindex="-1"></a>        .drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>])</span>
<span id="cb73-216"><a href="#cb73-216" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-217"><a href="#cb73-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-218"><a href="#cb73-218" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sorting_variables</span>
<span id="cb73-219"><a href="#cb73-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-220"><a href="#cb73-220" aria-hidden="true" tabindex="-1"></a>sorting_variables <span class="op">=</span> construct_sorting_variables(prices_monthly, comp_vn)</span>
<span id="cb73-221"><a href="#cb73-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-222"><a href="#cb73-222" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final sorting variables: </span><span class="sc">{</span><span class="bu">len</span>(sorting_variables)<span class="sc">:,}</span><span class="ss"> stock-years"</span>)</span>
<span id="cb73-223"><a href="#cb73-223" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sorting date range: </span><span class="sc">{</span>sorting_variables[<span class="st">'sorting_date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>sorting_variables[<span class="st">'sorting_date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-224"><a href="#cb73-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-225"><a href="#cb73-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-226"><a href="#cb73-226" aria-hidden="true" tabindex="-1"></a><span class="fu">### Validating Sorting Variables</span></span>
<span id="cb73-227"><a href="#cb73-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-228"><a href="#cb73-228" aria-hidden="true" tabindex="-1"></a>Before proceeding, we validate that our sorting variables have reasonable distributions. The book-to-market ratio should center around 1.0 for a typical market, though emerging markets may differ.</span>
<span id="cb73-229"><a href="#cb73-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-232"><a href="#cb73-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-233"><a href="#cb73-233" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sorting Variable Summary Statistics:"</span>)</span>
<span id="cb73-234"><a href="#cb73-234" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[[<span class="st">"size"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-235"><a href="#cb73-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-236"><a href="#cb73-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for extreme values that might indicate data issues</span></span>
<span id="cb73-237"><a href="#cb73-237" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">B/M Median: </span><span class="sc">{</span>sorting_variables[<span class="st">'bm'</span>]<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-238"><a href="#cb73-238" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"B/M 1st percentile: </span><span class="sc">{</span>sorting_variables[<span class="st">'bm'</span>]<span class="sc">.</span>quantile(<span class="fl">0.01</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-239"><a href="#cb73-239" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"B/M 99th percentile: </span><span class="sc">{</span>sorting_variables[<span class="st">'bm'</span>]<span class="sc">.</span>quantile(<span class="fl">0.99</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-240"><a href="#cb73-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-241"><a href="#cb73-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-242"><a href="#cb73-242" aria-hidden="true" tabindex="-1"></a><span class="fu">### Handling Outliers</span></span>
<span id="cb73-243"><a href="#cb73-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-244"><a href="#cb73-244" aria-hidden="true" tabindex="-1"></a>Extreme values in sorting characteristics can distort portfolio assignments and factor returns. We apply winsorization to limit the influence of outliers while preserving the general ranking of stocks.</span>
<span id="cb73-245"><a href="#cb73-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-248"><a href="#cb73-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-249"><a href="#cb73-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Check BEFORE winsorization</span></span>
<span id="cb73-250"><a href="#cb73-250" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BEFORE Winsorization:"</span>)</span>
<span id="cb73-251"><a href="#cb73-251" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[[<span class="st">"size"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-252"><a href="#cb73-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-253"><a href="#cb73-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply winsorization</span></span>
<span id="cb73-254"><a href="#cb73-254" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> winsorize_characteristics(df, columns, limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>)):</span>
<span id="cb73-255"><a href="#cb73-255" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-256"><a href="#cb73-256" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply winsorization using pandas clip.</span></span>
<span id="cb73-257"><a href="#cb73-257" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-258"><a href="#cb73-258" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb73-259"><a href="#cb73-259" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columns:</span>
<span id="cb73-260"><a href="#cb73-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb73-261"><a href="#cb73-261" aria-hidden="true" tabindex="-1"></a>            lower <span class="op">=</span> df[col].quantile(limits[<span class="dv">0</span>])</span>
<span id="cb73-262"><a href="#cb73-262" aria-hidden="true" tabindex="-1"></a>            upper <span class="op">=</span> df[col].quantile(limits[<span class="dv">1</span>])</span>
<span id="cb73-263"><a href="#cb73-263" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> df[col].clip(lower<span class="op">=</span>lower, upper<span class="op">=</span>upper)</span>
<span id="cb73-264"><a href="#cb73-264" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: clipped to [</span><span class="sc">{</span>lower<span class="sc">:.4f}</span><span class="ss">, </span><span class="sc">{</span>upper<span class="sc">:.4f}</span><span class="ss">]"</span>)</span>
<span id="cb73-265"><a href="#cb73-265" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb73-266"><a href="#cb73-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-267"><a href="#cb73-267" aria-hidden="true" tabindex="-1"></a>sorting_variables <span class="op">=</span> winsorize_characteristics(</span>
<span id="cb73-268"><a href="#cb73-268" aria-hidden="true" tabindex="-1"></a>    sorting_variables,</span>
<span id="cb73-269"><a href="#cb73-269" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>],  <span class="co"># Don't winsorize size</span></span>
<span id="cb73-270"><a href="#cb73-270" aria-hidden="true" tabindex="-1"></a>    limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>)</span>
<span id="cb73-271"><a href="#cb73-271" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-272"><a href="#cb73-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-273"><a href="#cb73-273" aria-hidden="true" tabindex="-1"></a><span class="co"># Check AFTER winsorization</span></span>
<span id="cb73-274"><a href="#cb73-274" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">AFTER Winsorization:"</span>)</span>
<span id="cb73-275"><a href="#cb73-275" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[[<span class="st">"size"</span>, <span class="st">"bm"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-276"><a href="#cb73-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-277"><a href="#cb73-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-278"><a href="#cb73-278" aria-hidden="true" tabindex="-1"></a><span class="fu">## Portfolio Assignment Functions</span></span>
<span id="cb73-279"><a href="#cb73-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-280"><a href="#cb73-280" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Portfolio Assignment Function</span></span>
<span id="cb73-281"><a href="#cb73-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-282"><a href="#cb73-282" aria-hidden="true" tabindex="-1"></a>We create a flexible function for assigning stocks to portfolios based on quantile breakpoints. This function handles both independent sorts (where breakpoints are computed across all stocks) and dependent sorts (where breakpoints are computed within subgroups).</span>
<span id="cb73-283"><a href="#cb73-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-286"><a href="#cb73-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-287"><a href="#cb73-287" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_portfolio(data, sorting_variable, percentiles):</span>
<span id="cb73-288"><a href="#cb73-288" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign portfolios to a bin according to a sorting variable."""</span></span>
<span id="cb73-289"><a href="#cb73-289" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-290"><a href="#cb73-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the values</span></span>
<span id="cb73-291"><a href="#cb73-291" aria-hidden="true" tabindex="-1"></a>    values <span class="op">=</span> data[sorting_variable].dropna()</span>
<span id="cb73-292"><a href="#cb73-292" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-293"><a href="#cb73-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(values) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb73-294"><a href="#cb73-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series([np.nan] <span class="op">*</span> <span class="bu">len</span>(data), index<span class="op">=</span>data.index)</span>
<span id="cb73-295"><a href="#cb73-295" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-296"><a href="#cb73-296" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate breakpoints</span></span>
<span id="cb73-297"><a href="#cb73-297" aria-hidden="true" tabindex="-1"></a>    breakpoints <span class="op">=</span> values.quantile(percentiles, interpolation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb73-298"><a href="#cb73-298" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-299"><a href="#cb73-299" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle duplicate breakpoints by using unique values</span></span>
<span id="cb73-300"><a href="#cb73-300" aria-hidden="true" tabindex="-1"></a>    unique_breakpoints <span class="op">=</span> np.unique(breakpoints)</span>
<span id="cb73-301"><a href="#cb73-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-302"><a href="#cb73-302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If all values are the same, assign all to portfolio 1</span></span>
<span id="cb73-303"><a href="#cb73-303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(unique_breakpoints) <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb73-304"><a href="#cb73-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series([<span class="dv">1</span>] <span class="op">*</span> <span class="bu">len</span>(data), index<span class="op">=</span>data.index)</span>
<span id="cb73-305"><a href="#cb73-305" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-306"><a href="#cb73-306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set boundaries to -inf and +inf</span></span>
<span id="cb73-307"><a href="#cb73-307" aria-hidden="true" tabindex="-1"></a>    unique_breakpoints.iloc[<span class="dv">0</span>] <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb73-308"><a href="#cb73-308" aria-hidden="true" tabindex="-1"></a>    unique_breakpoints.iloc[unique_breakpoints.size<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> np.inf</span>
<span id="cb73-309"><a href="#cb73-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-310"><a href="#cb73-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign to bins</span></span>
<span id="cb73-311"><a href="#cb73-311" aria-hidden="true" tabindex="-1"></a>    assigned <span class="op">=</span> pd.cut(</span>
<span id="cb73-312"><a href="#cb73-312" aria-hidden="true" tabindex="-1"></a>        data[sorting_variable],</span>
<span id="cb73-313"><a href="#cb73-313" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>unique_breakpoints,</span>
<span id="cb73-314"><a href="#cb73-314" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>pd.Series(<span class="bu">range</span>(<span class="dv">1</span>, breakpoints.size)),</span>
<span id="cb73-315"><a href="#cb73-315" aria-hidden="true" tabindex="-1"></a>        include_lowest<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb73-316"><a href="#cb73-316" aria-hidden="true" tabindex="-1"></a>        right<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-317"><a href="#cb73-317" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-318"><a href="#cb73-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-319"><a href="#cb73-319" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> assigned</span>
<span id="cb73-320"><a href="#cb73-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-321"><a href="#cb73-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-324"><a href="#cb73-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-325"><a href="#cb73-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the distribution of characteristics BEFORE portfolio assignment</span></span>
<span id="cb73-326"><a href="#cb73-326" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Operating Profitability Distribution:"</span>)</span>
<span id="cb73-327"><a href="#cb73-327" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[<span class="st">"op"</span>].describe())</span>
<span id="cb73-328"><a href="#cb73-328" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Unique OP values: </span><span class="sc">{</span>sorting_variables[<span class="st">'op'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-329"><a href="#cb73-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-330"><a href="#cb73-330" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Investment Distribution:"</span>)</span>
<span id="cb73-331"><a href="#cb73-331" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorting_variables[<span class="st">"inv"</span>].describe())</span>
<span id="cb73-332"><a href="#cb73-332" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Unique INV values: </span><span class="sc">{</span>sorting_variables[<span class="st">'inv'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-333"><a href="#cb73-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-334"><a href="#cb73-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Check breakpoints for a specific date</span></span>
<span id="cb73-335"><a href="#cb73-335" aria-hidden="true" tabindex="-1"></a>test_date <span class="op">=</span> sorting_variables[<span class="st">"sorting_date"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb73-336"><a href="#cb73-336" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> sorting_variables.query(<span class="st">"sorting_date == @test_date"</span>)</span>
<span id="cb73-337"><a href="#cb73-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-338"><a href="#cb73-338" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Breakpoints for </span><span class="sc">{</span>test_date<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb73-339"><a href="#cb73-339" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"OP 30th percentile: </span><span class="sc">{</span>test_data[<span class="st">'op'</span>]<span class="sc">.</span>quantile(<span class="fl">0.3</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-340"><a href="#cb73-340" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"OP 70th percentile: </span><span class="sc">{</span>test_data[<span class="st">'op'</span>]<span class="sc">.</span>quantile(<span class="fl">0.7</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-341"><a href="#cb73-341" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"INV 30th percentile: </span><span class="sc">{</span>test_data[<span class="st">'inv'</span>]<span class="sc">.</span>quantile(<span class="fl">0.3</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-342"><a href="#cb73-342" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"INV 70th percentile: </span><span class="sc">{</span>test_data[<span class="st">'inv'</span>]<span class="sc">.</span>quantile(<span class="fl">0.7</span>)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-343"><a href="#cb73-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-344"><a href="#cb73-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-345"><a href="#cb73-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-346"><a href="#cb73-346" aria-hidden="true" tabindex="-1"></a><span class="fu">### Assigning Portfolios for Three-Factor Model</span></span>
<span id="cb73-347"><a href="#cb73-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-348"><a href="#cb73-348" aria-hidden="true" tabindex="-1"></a>For the three-factor model, we perform independent double sorts on size and book-to-market. Size is split at the median (2 groups), and book-to-market is split at the 30th and 70th percentiles (3 groups), creating 6 portfolios.</span>
<span id="cb73-349"><a href="#cb73-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-352"><a href="#cb73-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-353"><a href="#cb73-353" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_ff3_portfolios(sorting_variables):</span>
<span id="cb73-354"><a href="#cb73-354" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-355"><a href="#cb73-355" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign portfolios for Fama-French three-factor model.</span></span>
<span id="cb73-356"><a href="#cb73-356" aria-hidden="true" tabindex="-1"></a><span class="co">    Independent 2x3 sort on size and book-to-market.</span></span>
<span id="cb73-357"><a href="#cb73-357" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-358"><a href="#cb73-358" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> sorting_variables.copy()</span>
<span id="cb73-359"><a href="#cb73-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-360"><a href="#cb73-360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Independent size sort (median split)</span></span>
<span id="cb73-361"><a href="#cb73-361" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_size"</span>] <span class="op">=</span> df.groupby(<span class="st">"sorting_date"</span>)[<span class="st">"size"</span>].transform(</span>
<span id="cb73-362"><a href="#cb73-362" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb73-363"><a href="#cb73-363" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-364"><a href="#cb73-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-365"><a href="#cb73-365" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Independent B/M sort (30/70 split)</span></span>
<span id="cb73-366"><a href="#cb73-366" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_bm"</span>] <span class="op">=</span> df.groupby(<span class="st">"sorting_date"</span>)[<span class="st">"bm"</span>].transform(</span>
<span id="cb73-367"><a href="#cb73-367" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb73-368"><a href="#cb73-368" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-369"><a href="#cb73-369" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-370"><a href="#cb73-370" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb73-371"><a href="#cb73-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-372"><a href="#cb73-372" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign portfolios</span></span>
<span id="cb73-373"><a href="#cb73-373" aria-hidden="true" tabindex="-1"></a>portfolios_ff3 <span class="op">=</span> assign_ff3_portfolios(sorting_variables)</span>
<span id="cb73-374"><a href="#cb73-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-375"><a href="#cb73-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate</span></span>
<span id="cb73-376"><a href="#cb73-376" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FF3 Book-to-Market by Portfolio (should be INCREASING):"</span>)</span>
<span id="cb73-377"><a href="#cb73-377" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3.groupby(<span class="st">"portfolio_bm"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"bm"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-378"><a href="#cb73-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-379"><a href="#cb73-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-380"><a href="#cb73-380" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Three-Factor Portfolio Assignments:"</span>)</span>
<span id="cb73-381"><a href="#cb73-381" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]].head(<span class="dv">10</span>))</span>
<span id="cb73-382"><a href="#cb73-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-383"><a href="#cb73-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-384"><a href="#cb73-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-385"><a href="#cb73-385" aria-hidden="true" tabindex="-1"></a><span class="fu">### Validating Portfolio Assignments</span></span>
<span id="cb73-386"><a href="#cb73-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-387"><a href="#cb73-387" aria-hidden="true" tabindex="-1"></a>We verify that the portfolio assignments create the expected 2×3 grid with reasonable stock counts in each cell.</span>
<span id="cb73-388"><a href="#cb73-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-391"><a href="#cb73-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-392"><a href="#cb73-392" aria-hidden="true" tabindex="-1"></a><span class="co"># Check portfolio distribution for most recent year</span></span>
<span id="cb73-393"><a href="#cb73-393" aria-hidden="true" tabindex="-1"></a>latest_date <span class="op">=</span> portfolios_ff3[<span class="st">"sorting_date"</span>].<span class="bu">max</span>()</span>
<span id="cb73-394"><a href="#cb73-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-395"><a href="#cb73-395" aria-hidden="true" tabindex="-1"></a>portfolio_counts <span class="op">=</span> (portfolios_ff3</span>
<span id="cb73-396"><a href="#cb73-396" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"sorting_date == @latest_date"</span>)</span>
<span id="cb73-397"><a href="#cb73-397" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-398"><a href="#cb73-398" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb73-399"><a href="#cb73-399" aria-hidden="true" tabindex="-1"></a>    .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb73-400"><a href="#cb73-400" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-401"><a href="#cb73-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-402"><a href="#cb73-402" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Portfolio Counts for </span><span class="sc">{</span>latest_date<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb73-403"><a href="#cb73-403" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio_counts)</span>
<span id="cb73-404"><a href="#cb73-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-405"><a href="#cb73-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify characteristic monotonicity</span></span>
<span id="cb73-406"><a href="#cb73-406" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Book-to-Market by Portfolio (should be increasing):"</span>)</span>
<span id="cb73-407"><a href="#cb73-407" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3.groupby(<span class="st">"portfolio_bm"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"bm"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-408"><a href="#cb73-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-409"><a href="#cb73-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-410"><a href="#cb73-410" aria-hidden="true" tabindex="-1"></a>We verify that for a single stock, the portfolio assignment remains constant between July of one year and June of the next.</span>
<span id="cb73-411"><a href="#cb73-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-414"><a href="#cb73-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-415"><a href="#cb73-415" aria-hidden="true" tabindex="-1"></a><span class="co"># Trace a single symbol (e.g., 'A32') across a formation window</span></span>
<span id="cb73-416"><a href="#cb73-416" aria-hidden="true" tabindex="-1"></a>persistence_check <span class="op">=</span> (portfolios_ff3</span>
<span id="cb73-417"><a href="#cb73-417" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"symbol == 'A32' &amp; sorting_date &gt;= '2022-01-01' &amp; sorting_date &lt;= '2023-12-31'"</span>)</span>
<span id="cb73-418"><a href="#cb73-418" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"sorting_date"</span>)</span>
<span id="cb73-419"><a href="#cb73-419" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">'symbol'</span>, <span class="st">'sorting_date'</span>, <span class="st">'portfolio_size'</span>, <span class="st">'portfolio_bm'</span>]]</span>
<span id="cb73-420"><a href="#cb73-420" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-421"><a href="#cb73-421" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Temporal Persistence Check (Symbol A32):"</span>)</span>
<span id="cb73-422"><a href="#cb73-422" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(persistence_check.head(<span class="dv">15</span>))</span>
<span id="cb73-423"><a href="#cb73-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-424"><a href="#cb73-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-425"><a href="#cb73-425" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fama-French Three-Factor Model (Monthly)</span></span>
<span id="cb73-426"><a href="#cb73-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-427"><a href="#cb73-427" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging Portfolios with Returns</span></span>
<span id="cb73-428"><a href="#cb73-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-429"><a href="#cb73-429" aria-hidden="true" tabindex="-1"></a>We merge the portfolio assignments with monthly returns. The key insight is that portfolios formed in July of year $t$ are held through June of year $t+1$. We implement this by computing a <span class="in">`sorting_date`</span> for each monthly return observation.</span>
<span id="cb73-430"><a href="#cb73-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-433"><a href="#cb73-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-434"><a href="#cb73-434" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_portfolios_with_returns(prices_monthly, portfolio_assignments):</span>
<span id="cb73-435"><a href="#cb73-435" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-436"><a href="#cb73-436" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge portfolio assignments with monthly returns.</span></span>
<span id="cb73-437"><a href="#cb73-437" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-438"><a href="#cb73-438" aria-hidden="true" tabindex="-1"></a><span class="co">    Portfolios formed in July t are held through June t+1.</span></span>
<span id="cb73-439"><a href="#cb73-439" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-440"><a href="#cb73-440" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-441"><a href="#cb73-441" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-442"><a href="#cb73-442" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_monthly : pd.DataFrame</span></span>
<span id="cb73-443"><a href="#cb73-443" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock returns</span></span>
<span id="cb73-444"><a href="#cb73-444" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolio_assignments : pd.DataFrame</span></span>
<span id="cb73-445"><a href="#cb73-445" aria-hidden="true" tabindex="-1"></a><span class="co">        Portfolio assignments with sorting_date</span></span>
<span id="cb73-446"><a href="#cb73-446" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-447"><a href="#cb73-447" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-448"><a href="#cb73-448" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-449"><a href="#cb73-449" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-450"><a href="#cb73-450" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns merged with portfolio assignments</span></span>
<span id="cb73-451"><a href="#cb73-451" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-452"><a href="#cb73-452" aria-hidden="true" tabindex="-1"></a>    portfolios <span class="op">=</span> (prices_monthly</span>
<span id="cb73-453"><a href="#cb73-453" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb73-454"><a href="#cb73-454" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Map each return month to its portfolio formation date</span></span>
<span id="cb73-455"><a href="#cb73-455" aria-hidden="true" tabindex="-1"></a>            sorting_date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(</span>
<span id="cb73-456"><a href="#cb73-456" aria-hidden="true" tabindex="-1"></a>                np.where(</span>
<span id="cb73-457"><a href="#cb73-457" aria-hidden="true" tabindex="-1"></a>                    x[<span class="st">"date"</span>].dt.month <span class="op">&lt;=</span> <span class="dv">6</span>,</span>
<span id="cb73-458"><a href="#cb73-458" aria-hidden="true" tabindex="-1"></a>                    (x[<span class="st">"date"</span>].dt.year <span class="op">-</span> <span class="dv">1</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-07-01"</span>,</span>
<span id="cb73-459"><a href="#cb73-459" aria-hidden="true" tabindex="-1"></a>                    x[<span class="st">"date"</span>].dt.year.astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-07-01"</span></span>
<span id="cb73-460"><a href="#cb73-460" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb73-461"><a href="#cb73-461" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-462"><a href="#cb73-462" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-463"><a href="#cb73-463" aria-hidden="true" tabindex="-1"></a>        .merge(</span>
<span id="cb73-464"><a href="#cb73-464" aria-hidden="true" tabindex="-1"></a>            portfolio_assignments,</span>
<span id="cb73-465"><a href="#cb73-465" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>],</span>
<span id="cb73-466"><a href="#cb73-466" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-467"><a href="#cb73-467" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-468"><a href="#cb73-468" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-469"><a href="#cb73-469" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-470"><a href="#cb73-470" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolios</span>
<span id="cb73-471"><a href="#cb73-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-472"><a href="#cb73-472" aria-hidden="true" tabindex="-1"></a>portfolios_monthly_ff3 <span class="op">=</span> merge_portfolios_with_returns(</span>
<span id="cb73-473"><a href="#cb73-473" aria-hidden="true" tabindex="-1"></a>    prices_monthly,</span>
<span id="cb73-474"><a href="#cb73-474" aria-hidden="true" tabindex="-1"></a>    portfolios_ff3[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]]</span>
<span id="cb73-475"><a href="#cb73-475" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-476"><a href="#cb73-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-477"><a href="#cb73-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-478"><a href="#cb73-478" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_monthly_ff3)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-479"><a href="#cb73-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-480"><a href="#cb73-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-481"><a href="#cb73-481" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Value-Weighted Portfolio Returns</span></span>
<span id="cb73-482"><a href="#cb73-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-483"><a href="#cb73-483" aria-hidden="true" tabindex="-1"></a>We compute value-weighted returns for each of the six portfolios. Value-weighting uses lagged market capitalization to avoid look-ahead bias.</span>
<span id="cb73-484"><a href="#cb73-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-487"><a href="#cb73-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-488"><a href="#cb73-488" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_returns(data, grouping_vars):</span>
<span id="cb73-489"><a href="#cb73-489" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-490"><a href="#cb73-490" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute value-weighted portfolio returns.</span></span>
<span id="cb73-491"><a href="#cb73-491" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-492"><a href="#cb73-492" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-493"><a href="#cb73-493" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-494"><a href="#cb73-494" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb73-495"><a href="#cb73-495" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns data with portfolio assignments and mktcap_lag</span></span>
<span id="cb73-496"><a href="#cb73-496" aria-hidden="true" tabindex="-1"></a><span class="co">    grouping_vars : list</span></span>
<span id="cb73-497"><a href="#cb73-497" aria-hidden="true" tabindex="-1"></a><span class="co">        Variables defining portfolio groups</span></span>
<span id="cb73-498"><a href="#cb73-498" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-499"><a href="#cb73-499" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-500"><a href="#cb73-500" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-501"><a href="#cb73-501" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-502"><a href="#cb73-502" aria-hidden="true" tabindex="-1"></a><span class="co">        Value-weighted returns for each portfolio-date</span></span>
<span id="cb73-503"><a href="#cb73-503" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-504"><a href="#cb73-504" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> (data</span>
<span id="cb73-505"><a href="#cb73-505" aria-hidden="true" tabindex="-1"></a>        .groupby(grouping_vars <span class="op">+</span> [<span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-506"><a href="#cb73-506" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-507"><a href="#cb73-507" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]),</span>
<span id="cb73-508"><a href="#cb73-508" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_stocks"</span>: <span class="bu">len</span>(x)</span>
<span id="cb73-509"><a href="#cb73-509" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-510"><a href="#cb73-510" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-511"><a href="#cb73-511" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-512"><a href="#cb73-512" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-513"><a href="#cb73-513" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio_returns</span>
<span id="cb73-514"><a href="#cb73-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-515"><a href="#cb73-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-516"><a href="#cb73-516" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute portfolio returns</span></span>
<span id="cb73-517"><a href="#cb73-517" aria-hidden="true" tabindex="-1"></a>portfolio_returns_ff3 <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb73-518"><a href="#cb73-518" aria-hidden="true" tabindex="-1"></a>    portfolios_monthly_ff3,</span>
<span id="cb73-519"><a href="#cb73-519" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]</span>
<span id="cb73-520"><a href="#cb73-520" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-521"><a href="#cb73-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-522"><a href="#cb73-522" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Portfolio Returns Summary:"</span>)</span>
<span id="cb73-523"><a href="#cb73-523" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio_returns_ff3.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-524"><a href="#cb73-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-525"><a href="#cb73-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-526"><a href="#cb73-526" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constructing SMB and HML Factors</span></span>
<span id="cb73-527"><a href="#cb73-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-528"><a href="#cb73-528" aria-hidden="true" tabindex="-1"></a>We now construct the SMB and HML factors from the portfolio returns.</span>
<span id="cb73-529"><a href="#cb73-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-530"><a href="#cb73-530" aria-hidden="true" tabindex="-1"></a>**SMB (Small Minus Big)**: Average return of three small portfolios minus average return of three big portfolios.</span>
<span id="cb73-531"><a href="#cb73-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-532"><a href="#cb73-532" aria-hidden="true" tabindex="-1"></a>**HML (High Minus Low)**: Average return of two high B/M portfolios minus average return of two low B/M portfolios.</span>
<span id="cb73-533"><a href="#cb73-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-536"><a href="#cb73-536" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-537"><a href="#cb73-537" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_ff3_factors(portfolio_returns):</span>
<span id="cb73-538"><a href="#cb73-538" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-539"><a href="#cb73-539" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct Fama-French three factors from portfolio returns.</span></span>
<span id="cb73-540"><a href="#cb73-540" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-541"><a href="#cb73-541" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-542"><a href="#cb73-542" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-543"><a href="#cb73-543" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolio_returns : pd.DataFrame</span></span>
<span id="cb73-544"><a href="#cb73-544" aria-hidden="true" tabindex="-1"></a><span class="co">        Value-weighted returns for 2x3 portfolios</span></span>
<span id="cb73-545"><a href="#cb73-545" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-546"><a href="#cb73-546" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-547"><a href="#cb73-547" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-548"><a href="#cb73-548" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-549"><a href="#cb73-549" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly SMB and HML factors</span></span>
<span id="cb73-550"><a href="#cb73-550" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-551"><a href="#cb73-551" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (portfolio_returns</span>
<span id="cb73-552"><a href="#cb73-552" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-553"><a href="#cb73-553" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-554"><a href="#cb73-554" aria-hidden="true" tabindex="-1"></a>            <span class="co"># SMB: Small minus Big (average across B/M groups)</span></span>
<span id="cb73-555"><a href="#cb73-555" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (</span>
<span id="cb73-556"><a href="#cb73-556" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-557"><a href="#cb73-557" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean()</span>
<span id="cb73-558"><a href="#cb73-558" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb73-559"><a href="#cb73-559" aria-hidden="true" tabindex="-1"></a>            <span class="co"># HML: High minus Low B/M (average across size groups)</span></span>
<span id="cb73-560"><a href="#cb73-560" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (</span>
<span id="cb73-561"><a href="#cb73-561" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-562"><a href="#cb73-562" aria-hidden="true" tabindex="-1"></a>                x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean()</span>
<span id="cb73-563"><a href="#cb73-563" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-564"><a href="#cb73-564" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-565"><a href="#cb73-565" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-566"><a href="#cb73-566" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-567"><a href="#cb73-567" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-568"><a href="#cb73-568" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb73-569"><a href="#cb73-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-570"><a href="#cb73-570" aria-hidden="true" tabindex="-1"></a>factors_smb_hml <span class="op">=</span> construct_ff3_factors(portfolio_returns_ff3)</span>
<span id="cb73-571"><a href="#cb73-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-572"><a href="#cb73-572" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SMB and HML Factors:"</span>)</span>
<span id="cb73-573"><a href="#cb73-573" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_smb_hml.head(<span class="dv">10</span>))</span>
<span id="cb73-574"><a href="#cb73-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-575"><a href="#cb73-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-576"><a href="#cb73-576" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing the Market Factor</span></span>
<span id="cb73-577"><a href="#cb73-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-578"><a href="#cb73-578" aria-hidden="true" tabindex="-1"></a>The market factor is the value-weighted return of all stocks minus the risk-free rate. We compute this independently from the sorted portfolios.</span>
<span id="cb73-579"><a href="#cb73-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-582"><a href="#cb73-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-583"><a href="#cb73-583" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_market_factor(prices_monthly):</span>
<span id="cb73-584"><a href="#cb73-584" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-585"><a href="#cb73-585" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute value-weighted market excess return.</span></span>
<span id="cb73-586"><a href="#cb73-586" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-587"><a href="#cb73-587" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-588"><a href="#cb73-588" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-589"><a href="#cb73-589" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_monthly : pd.DataFrame</span></span>
<span id="cb73-590"><a href="#cb73-590" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock returns with mktcap_lag</span></span>
<span id="cb73-591"><a href="#cb73-591" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-592"><a href="#cb73-592" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-593"><a href="#cb73-593" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-594"><a href="#cb73-594" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-595"><a href="#cb73-595" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly market excess return</span></span>
<span id="cb73-596"><a href="#cb73-596" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-597"><a href="#cb73-597" aria-hidden="true" tabindex="-1"></a>    market_factor <span class="op">=</span> (prices_monthly</span>
<span id="cb73-598"><a href="#cb73-598" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-599"><a href="#cb73-599" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-600"><a href="#cb73-600" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mkt_excess"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]),</span>
<span id="cb73-601"><a href="#cb73-601" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_stocks"</span>: <span class="bu">len</span>(x)</span>
<span id="cb73-602"><a href="#cb73-602" aria-hidden="true" tabindex="-1"></a>        }), include_groups<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-603"><a href="#cb73-603" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-604"><a href="#cb73-604" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-605"><a href="#cb73-605" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-606"><a href="#cb73-606" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> market_factor</span>
<span id="cb73-607"><a href="#cb73-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-608"><a href="#cb73-608" aria-hidden="true" tabindex="-1"></a>market_factor <span class="op">=</span> compute_market_factor(prices_monthly)</span>
<span id="cb73-609"><a href="#cb73-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-610"><a href="#cb73-610" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Market Factor Summary:"</span>)</span>
<span id="cb73-611"><a href="#cb73-611" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(market_factor[<span class="st">"mkt_excess"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-612"><a href="#cb73-612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-613"><a href="#cb73-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-614"><a href="#cb73-614" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combining Three Factors</span></span>
<span id="cb73-615"><a href="#cb73-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-616"><a href="#cb73-616" aria-hidden="true" tabindex="-1"></a>We combine SMB, HML, and the market factor into the complete three-factor dataset.</span>
<span id="cb73-617"><a href="#cb73-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-620"><a href="#cb73-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-621"><a href="#cb73-621" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> (factors_smb_hml</span>
<span id="cb73-622"><a href="#cb73-622" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-623"><a href="#cb73-623" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-624"><a href="#cb73-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-625"><a href="#cb73-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Add risk-free rate for completeness</span></span>
<span id="cb73-626"><a href="#cb73-626" aria-hidden="true" tabindex="-1"></a>rf_monthly <span class="op">=</span> (prices_monthly</span>
<span id="cb73-627"><a href="#cb73-627" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"risk_free"</span>]</span>
<span id="cb73-628"><a href="#cb73-628" aria-hidden="true" tabindex="-1"></a>    .first()</span>
<span id="cb73-629"><a href="#cb73-629" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-630"><a href="#cb73-630" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-631"><a href="#cb73-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-632"><a href="#cb73-632" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> factors_ff3_monthly.merge(rf_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb73-633"><a href="#cb73-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-634"><a href="#cb73-634" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-French Three Factors (Monthly):"</span>)</span>
<span id="cb73-635"><a href="#cb73-635" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_monthly.head(<span class="dv">10</span>))</span>
<span id="cb73-636"><a href="#cb73-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-637"><a href="#cb73-637" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Factor Summary Statistics:"</span>)</span>
<span id="cb73-638"><a href="#cb73-638" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_monthly[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-639"><a href="#cb73-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-640"><a href="#cb73-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-641"><a href="#cb73-641" aria-hidden="true" tabindex="-1"></a><span class="fu">### Saving Three-Factor Data</span></span>
<span id="cb73-642"><a href="#cb73-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-645"><a href="#cb73-645" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-646"><a href="#cb73-646" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly.to_sql(</span>
<span id="cb73-647"><a href="#cb73-647" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff3_monthly"</span>,</span>
<span id="cb73-648"><a href="#cb73-648" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-649"><a href="#cb73-649" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-650"><a href="#cb73-650" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-651"><a href="#cb73-651" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-652"><a href="#cb73-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-653"><a href="#cb73-653" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Three-factor monthly data saved to database."</span>)</span>
<span id="cb73-654"><a href="#cb73-654" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-655"><a href="#cb73-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-656"><a href="#cb73-656" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fama-French Five-Factor Model (Monthly)</span></span>
<span id="cb73-657"><a href="#cb73-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-658"><a href="#cb73-658" aria-hidden="true" tabindex="-1"></a><span class="fu">### Portfolio Assignments with Dependent Sorts</span></span>
<span id="cb73-659"><a href="#cb73-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-660"><a href="#cb73-660" aria-hidden="true" tabindex="-1"></a>For the five-factor model, we use dependent sorts: size is sorted independently, but profitability and investment are sorted within size groups. This controls for the correlation between size and these characteristics.</span>
<span id="cb73-661"><a href="#cb73-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-664"><a href="#cb73-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-665"><a href="#cb73-665" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_ff5_portfolios(sorting_variables):</span>
<span id="cb73-666"><a href="#cb73-666" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-667"><a href="#cb73-667" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign portfolios for Fama-French five-factor model.</span></span>
<span id="cb73-668"><a href="#cb73-668" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-669"><a href="#cb73-669" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> sorting_variables.copy()</span>
<span id="cb73-670"><a href="#cb73-670" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-671"><a href="#cb73-671" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Independent size sort</span></span>
<span id="cb73-672"><a href="#cb73-672" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_size"</span>] <span class="op">=</span> df.groupby(<span class="st">"sorting_date"</span>)[<span class="st">"size"</span>].transform(</span>
<span id="cb73-673"><a href="#cb73-673" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb73-674"><a href="#cb73-674" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-675"><a href="#cb73-675" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-676"><a href="#cb73-676" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dependent sorts within size groups</span></span>
<span id="cb73-677"><a href="#cb73-677" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_bm"</span>] <span class="op">=</span> df.groupby([<span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>])[<span class="st">"bm"</span>].transform(</span>
<span id="cb73-678"><a href="#cb73-678" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb73-679"><a href="#cb73-679" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-680"><a href="#cb73-680" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-681"><a href="#cb73-681" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_op"</span>] <span class="op">=</span> df.groupby([<span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>])[<span class="st">"op"</span>].transform(</span>
<span id="cb73-682"><a href="#cb73-682" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb73-683"><a href="#cb73-683" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-684"><a href="#cb73-684" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-685"><a href="#cb73-685" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio_inv"</span>] <span class="op">=</span> df.groupby([<span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>])[<span class="st">"inv"</span>].transform(</span>
<span id="cb73-686"><a href="#cb73-686" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, q<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>], labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb73-687"><a href="#cb73-687" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-688"><a href="#cb73-688" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-689"><a href="#cb73-689" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb73-690"><a href="#cb73-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-691"><a href="#cb73-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Run</span></span>
<span id="cb73-692"><a href="#cb73-692" aria-hidden="true" tabindex="-1"></a>portfolios_ff5 <span class="op">=</span> assign_ff5_portfolios(sorting_variables)</span>
<span id="cb73-693"><a href="#cb73-693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-694"><a href="#cb73-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-695"><a href="#cb73-695" aria-hidden="true" tabindex="-1"></a><span class="fu">### Validating Five-Factor Portfolios</span></span>
<span id="cb73-696"><a href="#cb73-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-699"><a href="#cb73-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-700"><a href="#cb73-700" aria-hidden="true" tabindex="-1"></a><span class="co"># Check characteristic monotonicity for each dimension</span></span>
<span id="cb73-701"><a href="#cb73-701" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Profitability by Portfolio (should be increasing):"</span>)</span>
<span id="cb73-702"><a href="#cb73-702" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff5.groupby(<span class="st">"portfolio_op"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"op"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-703"><a href="#cb73-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-704"><a href="#cb73-704" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Investment by Portfolio (should be increasing):"</span>)</span>
<span id="cb73-705"><a href="#cb73-705" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff5.groupby(<span class="st">"portfolio_inv"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"inv"</span>].median().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-706"><a href="#cb73-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-707"><a href="#cb73-707" aria-hidden="true" tabindex="-1"></a><span class="co"># Check portfolio counts</span></span>
<span id="cb73-708"><a href="#cb73-708" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Stocks per Size/Profitability Bin:"</span>)</span>
<span id="cb73-709"><a href="#cb73-709" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff5.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_op"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb73-710"><a href="#cb73-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-711"><a href="#cb73-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Check number of unique firms per year</span></span>
<span id="cb73-712"><a href="#cb73-712" aria-hidden="true" tabindex="-1"></a>(portfolios_ff5</span>
<span id="cb73-713"><a href="#cb73-713" aria-hidden="true" tabindex="-1"></a> .groupby(<span class="st">"sorting_date"</span>)[<span class="st">"symbol"</span>]</span>
<span id="cb73-714"><a href="#cb73-714" aria-hidden="true" tabindex="-1"></a> .nunique())</span>
<span id="cb73-715"><a href="#cb73-715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-716"><a href="#cb73-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-717"><a href="#cb73-717" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging and Computing Portfolio Returns</span></span>
<span id="cb73-718"><a href="#cb73-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-721"><a href="#cb73-721" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-722"><a href="#cb73-722" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with returns</span></span>
<span id="cb73-723"><a href="#cb73-723" aria-hidden="true" tabindex="-1"></a>portfolios_monthly_ff5 <span class="op">=</span> merge_portfolios_with_returns(</span>
<span id="cb73-724"><a href="#cb73-724" aria-hidden="true" tabindex="-1"></a>    prices_monthly,</span>
<span id="cb73-725"><a href="#cb73-725" aria-hidden="true" tabindex="-1"></a>    portfolios_ff5[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, </span>
<span id="cb73-726"><a href="#cb73-726" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"portfolio_bm"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"portfolio_inv"</span>]]</span>
<span id="cb73-727"><a href="#cb73-727" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-728"><a href="#cb73-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-729"><a href="#cb73-729" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Five-factor merged observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_monthly_ff5)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-730"><a href="#cb73-730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-731"><a href="#cb73-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-732"><a href="#cb73-732" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constructing All Five Factors</span></span>
<span id="cb73-733"><a href="#cb73-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-734"><a href="#cb73-734" aria-hidden="true" tabindex="-1"></a>We construct each factor from the appropriate portfolio sorts.</span>
<span id="cb73-735"><a href="#cb73-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-738"><a href="#cb73-738" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-739"><a href="#cb73-739" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_ff5_factors(portfolios_monthly):</span>
<span id="cb73-740"><a href="#cb73-740" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-741"><a href="#cb73-741" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct Fama-French five factors from portfolio data.</span></span>
<span id="cb73-742"><a href="#cb73-742" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-743"><a href="#cb73-743" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-744"><a href="#cb73-744" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-745"><a href="#cb73-745" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolios_monthly : pd.DataFrame</span></span>
<span id="cb73-746"><a href="#cb73-746" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly returns with all portfolio assignments</span></span>
<span id="cb73-747"><a href="#cb73-747" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-748"><a href="#cb73-748" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-749"><a href="#cb73-749" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-750"><a href="#cb73-750" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-751"><a href="#cb73-751" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly five-factor returns</span></span>
<span id="cb73-752"><a href="#cb73-752" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-753"><a href="#cb73-753" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-754"><a href="#cb73-754" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HML: Value factor from B/M sorts</span></span>
<span id="cb73-755"><a href="#cb73-755" aria-hidden="true" tabindex="-1"></a>    portfolios_bm <span class="op">=</span> (portfolios_monthly</span>
<span id="cb73-756"><a href="#cb73-756" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-757"><a href="#cb73-757" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-758"><a href="#cb73-758" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-759"><a href="#cb73-759" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-760"><a href="#cb73-760" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-761"><a href="#cb73-761" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-762"><a href="#cb73-762" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-763"><a href="#cb73-763" aria-hidden="true" tabindex="-1"></a>    factors_hml <span class="op">=</span> (portfolios_bm</span>
<span id="cb73-764"><a href="#cb73-764" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-765"><a href="#cb73-765" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-766"><a href="#cb73-766" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-767"><a href="#cb73-767" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-768"><a href="#cb73-768" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-769"><a href="#cb73-769" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-770"><a href="#cb73-770" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-771"><a href="#cb73-771" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-772"><a href="#cb73-772" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RMW: Profitability factor from OP sorts</span></span>
<span id="cb73-773"><a href="#cb73-773" aria-hidden="true" tabindex="-1"></a>    portfolios_op <span class="op">=</span> (portfolios_monthly</span>
<span id="cb73-774"><a href="#cb73-774" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-775"><a href="#cb73-775" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-776"><a href="#cb73-776" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-777"><a href="#cb73-777" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-778"><a href="#cb73-778" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-779"><a href="#cb73-779" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-780"><a href="#cb73-780" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-781"><a href="#cb73-781" aria-hidden="true" tabindex="-1"></a>    factors_rmw <span class="op">=</span> (portfolios_op</span>
<span id="cb73-782"><a href="#cb73-782" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-783"><a href="#cb73-783" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-784"><a href="#cb73-784" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rmw"</span>: (x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-785"><a href="#cb73-785" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-786"><a href="#cb73-786" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-787"><a href="#cb73-787" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-788"><a href="#cb73-788" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-789"><a href="#cb73-789" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-790"><a href="#cb73-790" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CMA: Investment factor from INV sorts</span></span>
<span id="cb73-791"><a href="#cb73-791" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: CMA is Conservative minus Aggressive (low inv - high inv)</span></span>
<span id="cb73-792"><a href="#cb73-792" aria-hidden="true" tabindex="-1"></a>    portfolios_inv <span class="op">=</span> (portfolios_monthly</span>
<span id="cb73-793"><a href="#cb73-793" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_inv"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-794"><a href="#cb73-794" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-795"><a href="#cb73-795" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-796"><a href="#cb73-796" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-797"><a href="#cb73-797" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-798"><a href="#cb73-798" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-799"><a href="#cb73-799" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-800"><a href="#cb73-800" aria-hidden="true" tabindex="-1"></a>    factors_cma <span class="op">=</span> (portfolios_inv</span>
<span id="cb73-801"><a href="#cb73-801" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-802"><a href="#cb73-802" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-803"><a href="#cb73-803" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cma"</span>: (x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-804"><a href="#cb73-804" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-805"><a href="#cb73-805" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-806"><a href="#cb73-806" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-807"><a href="#cb73-807" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-808"><a href="#cb73-808" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-809"><a href="#cb73-809" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SMB: Size factor (average across all characteristic portfolios)</span></span>
<span id="cb73-810"><a href="#cb73-810" aria-hidden="true" tabindex="-1"></a>    all_portfolios <span class="op">=</span> pd.concat([portfolios_bm, portfolios_op, portfolios_inv])</span>
<span id="cb73-811"><a href="#cb73-811" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-812"><a href="#cb73-812" aria-hidden="true" tabindex="-1"></a>    factors_smb <span class="op">=</span> (all_portfolios</span>
<span id="cb73-813"><a href="#cb73-813" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-814"><a href="#cb73-814" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-815"><a href="#cb73-815" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-816"><a href="#cb73-816" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-817"><a href="#cb73-817" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-818"><a href="#cb73-818" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-819"><a href="#cb73-819" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-820"><a href="#cb73-820" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-821"><a href="#cb73-821" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all factors</span></span>
<span id="cb73-822"><a href="#cb73-822" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (factors_smb</span>
<span id="cb73-823"><a href="#cb73-823" aria-hidden="true" tabindex="-1"></a>        .merge(factors_hml, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb73-824"><a href="#cb73-824" aria-hidden="true" tabindex="-1"></a>        .merge(factors_rmw, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb73-825"><a href="#cb73-825" aria-hidden="true" tabindex="-1"></a>        .merge(factors_cma, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb73-826"><a href="#cb73-826" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-827"><a href="#cb73-827" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-828"><a href="#cb73-828" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb73-829"><a href="#cb73-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-830"><a href="#cb73-830" aria-hidden="true" tabindex="-1"></a>factors_ff5 <span class="op">=</span> construct_ff5_factors(portfolios_monthly_ff5)</span>
<span id="cb73-831"><a href="#cb73-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-832"><a href="#cb73-832" aria-hidden="true" tabindex="-1"></a><span class="co"># Add market factor</span></span>
<span id="cb73-833"><a href="#cb73-833" aria-hidden="true" tabindex="-1"></a>factors_ff5_monthly <span class="op">=</span> (factors_ff5</span>
<span id="cb73-834"><a href="#cb73-834" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-835"><a href="#cb73-835" aria-hidden="true" tabindex="-1"></a>    .merge(rf_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb73-836"><a href="#cb73-836" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-837"><a href="#cb73-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-838"><a href="#cb73-838" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-French Five Factors (Monthly):"</span>)</span>
<span id="cb73-839"><a href="#cb73-839" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_monthly.head(<span class="dv">10</span>))</span>
<span id="cb73-840"><a href="#cb73-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-841"><a href="#cb73-841" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Factor Summary Statistics:"</span>)</span>
<span id="cb73-842"><a href="#cb73-842" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_monthly[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-843"><a href="#cb73-843" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-844"><a href="#cb73-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-845"><a href="#cb73-845" aria-hidden="true" tabindex="-1"></a><span class="fu">### Factor Correlations</span></span>
<span id="cb73-846"><a href="#cb73-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-847"><a href="#cb73-847" aria-hidden="true" tabindex="-1"></a>We examine correlations between factors, which should generally be low for the factors to capture distinct sources of risk.</span>
<span id="cb73-848"><a href="#cb73-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-851"><a href="#cb73-851" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-852"><a href="#cb73-852" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Factor Correlation Matrix:"</span>)</span>
<span id="cb73-853"><a href="#cb73-853" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> factors_ff5_monthly[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]].corr()</span>
<span id="cb73-854"><a href="#cb73-854" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(correlation_matrix.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb73-855"><a href="#cb73-855" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-856"><a href="#cb73-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-857"><a href="#cb73-857" aria-hidden="true" tabindex="-1"></a><span class="fu">### Saving Five-Factor Data</span></span>
<span id="cb73-858"><a href="#cb73-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-861"><a href="#cb73-861" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-862"><a href="#cb73-862" aria-hidden="true" tabindex="-1"></a>factors_ff5_monthly.to_sql(</span>
<span id="cb73-863"><a href="#cb73-863" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff5_monthly"</span>,</span>
<span id="cb73-864"><a href="#cb73-864" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-865"><a href="#cb73-865" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-866"><a href="#cb73-866" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-867"><a href="#cb73-867" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-868"><a href="#cb73-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-869"><a href="#cb73-869" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Five-factor monthly data saved to database."</span>)</span>
<span id="cb73-870"><a href="#cb73-870" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-871"><a href="#cb73-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-872"><a href="#cb73-872" aria-hidden="true" tabindex="-1"></a><span class="fu">## Daily Fama-French Factors</span></span>
<span id="cb73-873"><a href="#cb73-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-874"><a href="#cb73-874" aria-hidden="true" tabindex="-1"></a><span class="fu">### Motivation for Daily Factors</span></span>
<span id="cb73-875"><a href="#cb73-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-876"><a href="#cb73-876" aria-hidden="true" tabindex="-1"></a>Daily factors are essential for several applications:</span>
<span id="cb73-877"><a href="#cb73-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-878"><a href="#cb73-878" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Daily beta estimation**: CAPM regressions using daily data require daily market excess returns.</span>
<span id="cb73-879"><a href="#cb73-879" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Event studies**: Measuring abnormal returns around corporate events requires daily factor adjustments.</span>
<span id="cb73-880"><a href="#cb73-880" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**High-frequency research**: Market microstructure studies need daily or intraday factor data.</span>
<span id="cb73-881"><a href="#cb73-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-882"><a href="#cb73-882" aria-hidden="true" tabindex="-1"></a>The construction methodology mirrors the monthly approach, but we compute portfolio returns at daily frequency while maintaining the same annual portfolio formation dates.</span>
<span id="cb73-883"><a href="#cb73-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-884"><a href="#cb73-884" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Daily Returns</span></span>
<span id="cb73-885"><a href="#cb73-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-888"><a href="#cb73-888" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-889"><a href="#cb73-889" aria-hidden="true" tabindex="-1"></a><span class="co"># Load daily price data</span></span>
<span id="cb73-890"><a href="#cb73-890" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb73-891"><a href="#cb73-891" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb73-892"><a href="#cb73-892" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess</span></span>
<span id="cb73-893"><a href="#cb73-893" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_daily</span></span>
<span id="cb73-894"><a href="#cb73-894" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb73-895"><a href="#cb73-895" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-896"><a href="#cb73-896" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb73-897"><a href="#cb73-897" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-898"><a href="#cb73-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-899"><a href="#cb73-899" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily returns: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb73-900"><a href="#cb73-900" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="op">-%</span>d<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="op">-%</span>d<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-901"><a href="#cb73-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-902"><a href="#cb73-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-903"><a href="#cb73-903" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding Market Cap for Daily Weighting</span></span>
<span id="cb73-904"><a href="#cb73-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-905"><a href="#cb73-905" aria-hidden="true" tabindex="-1"></a>For value-weighted daily returns, we need market capitalization. We use the most recent monthly market cap as the weight for daily returns within that month.</span>
<span id="cb73-906"><a href="#cb73-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-909"><a href="#cb73-909" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-910"><a href="#cb73-910" aria-hidden="true" tabindex="-1"></a><span class="co"># Get monthly market cap to use as weights for daily returns</span></span>
<span id="cb73-911"><a href="#cb73-911" aria-hidden="true" tabindex="-1"></a>mktcap_monthly <span class="op">=</span> (prices_monthly</span>
<span id="cb73-912"><a href="#cb73-912" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"mktcap_lag"</span>]]</span>
<span id="cb73-913"><a href="#cb73-913" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb73-914"><a href="#cb73-914" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-915"><a href="#cb73-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-916"><a href="#cb73-916" aria-hidden="true" tabindex="-1"></a><span class="co"># Add year_month to daily data for merging</span></span>
<span id="cb73-917"><a href="#cb73-917" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> (prices_daily</span>
<span id="cb73-918"><a href="#cb73-918" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb73-919"><a href="#cb73-919" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb73-920"><a href="#cb73-920" aria-hidden="true" tabindex="-1"></a>        mktcap_monthly[[<span class="st">"symbol"</span>, <span class="st">"year_month"</span>, <span class="st">"mktcap_lag"</span>]],</span>
<span id="cb73-921"><a href="#cb73-921" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year_month"</span>],</span>
<span id="cb73-922"><a href="#cb73-922" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb73-923"><a href="#cb73-923" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-924"><a href="#cb73-924" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-925"><a href="#cb73-925" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-926"><a href="#cb73-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-927"><a href="#cb73-927" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily returns with weights: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb73-928"><a href="#cb73-928" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-929"><a href="#cb73-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-930"><a href="#cb73-930" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging Daily Returns with Portfolios</span></span>
<span id="cb73-931"><a href="#cb73-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-932"><a href="#cb73-932" aria-hidden="true" tabindex="-1"></a>We use the same portfolio assignments (formed annually in July) for daily returns.</span>
<span id="cb73-933"><a href="#cb73-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-936"><a href="#cb73-936" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-937"><a href="#cb73-937" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Ensure portfolios_ff3 has correct format</span></span>
<span id="cb73-938"><a href="#cb73-938" aria-hidden="true" tabindex="-1"></a>portfolios_ff3_clean <span class="op">=</span> portfolios_ff3[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>]].copy()</span>
<span id="cb73-939"><a href="#cb73-939" aria-hidden="true" tabindex="-1"></a>portfolios_ff3_clean[<span class="st">"sorting_date"</span>] <span class="op">=</span> pd.to_datetime(portfolios_ff3_clean[<span class="st">"sorting_date"</span>])</span>
<span id="cb73-940"><a href="#cb73-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-941"><a href="#cb73-941" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Portfolio sorting dates:"</span>)</span>
<span id="cb73-942"><a href="#cb73-942" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_ff3_clean[<span class="st">"sorting_date"</span>].unique()[:<span class="dv">5</span>])</span>
<span id="cb73-943"><a href="#cb73-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-944"><a href="#cb73-944" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create sorting_date for daily data</span></span>
<span id="cb73-945"><a href="#cb73-945" aria-hidden="true" tabindex="-1"></a>prices_daily_with_sort <span class="op">=</span> prices_daily.copy()</span>
<span id="cb73-946"><a href="#cb73-946" aria-hidden="true" tabindex="-1"></a>prices_daily_with_sort[<span class="st">"sorting_date"</span>] <span class="op">=</span> prices_daily_with_sort[<span class="st">"date"</span>].<span class="bu">apply</span>(</span>
<span id="cb73-947"><a href="#cb73-947" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: pd.Timestamp(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">.</span>year<span class="sc">}</span><span class="ss">-07-01"</span>) <span class="cf">if</span> x.month <span class="op">&gt;</span> <span class="dv">6</span> <span class="cf">else</span> pd.Timestamp(<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">.</span>year <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">-07-01"</span>)</span>
<span id="cb73-948"><a href="#cb73-948" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-949"><a href="#cb73-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-950"><a href="#cb73-950" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily sorting dates:"</span>)</span>
<span id="cb73-951"><a href="#cb73-951" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_daily_with_sort[<span class="st">"sorting_date"</span>].unique()[:<span class="dv">5</span>])</span>
<span id="cb73-952"><a href="#cb73-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-953"><a href="#cb73-953" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Merge</span></span>
<span id="cb73-954"><a href="#cb73-954" aria-hidden="true" tabindex="-1"></a>portfolios_daily_ff3 <span class="op">=</span> prices_daily_with_sort.merge(</span>
<span id="cb73-955"><a href="#cb73-955" aria-hidden="true" tabindex="-1"></a>    portfolios_ff3_clean,</span>
<span id="cb73-956"><a href="#cb73-956" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>],</span>
<span id="cb73-957"><a href="#cb73-957" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-958"><a href="#cb73-958" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-959"><a href="#cb73-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-960"><a href="#cb73-960" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Merged daily observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff3)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-961"><a href="#cb73-961" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique dates: </span><span class="sc">{</span>portfolios_daily_ff3[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-962"><a href="#cb73-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-963"><a href="#cb73-963" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Verify portfolio distribution</span></span>
<span id="cb73-964"><a href="#cb73-964" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Portfolio distribution in daily data:"</span>)</span>
<span id="cb73-965"><a href="#cb73-965" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_daily_ff3.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb73-966"><a href="#cb73-966" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-967"><a href="#cb73-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-968"><a href="#cb73-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-971"><a href="#cb73-971" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-972"><a href="#cb73-972" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic: Check the daily portfolio merge</span></span>
<span id="cb73-973"><a href="#cb73-973" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb73-974"><a href="#cb73-974" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSTIC: Daily Portfolio Merge"</span>)</span>
<span id="cb73-975"><a href="#cb73-975" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb73-976"><a href="#cb73-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-977"><a href="#cb73-977" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Daily prices rows: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-978"><a href="#cb73-978" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily FF3 portfolios rows: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff3)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-979"><a href="#cb73-979" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Match rate: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff3)<span class="op">/</span><span class="bu">len</span>(prices_daily)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb73-980"><a href="#cb73-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-981"><a href="#cb73-981" aria-hidden="true" tabindex="-1"></a><span class="co"># Check portfolio distribution in daily data</span></span>
<span id="cb73-982"><a href="#cb73-982" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily portfolio distribution:"</span>)</span>
<span id="cb73-983"><a href="#cb73-983" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_daily_ff3.groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb73-984"><a href="#cb73-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-985"><a href="#cb73-985" aria-hidden="true" tabindex="-1"></a><span class="co"># Check a specific date</span></span>
<span id="cb73-986"><a href="#cb73-986" aria-hidden="true" tabindex="-1"></a>test_date <span class="op">=</span> portfolios_daily_ff3[<span class="st">"date"</span>].iloc[<span class="dv">1000</span>]</span>
<span id="cb73-987"><a href="#cb73-987" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Sample date: </span><span class="sc">{</span>test_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-988"><a href="#cb73-988" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_daily_ff3.query(<span class="st">"date == @test_date"</span>).groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>], observed<span class="op">=</span><span class="va">True</span>).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb73-989"><a href="#cb73-989" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-990"><a href="#cb73-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-991"><a href="#cb73-991" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Daily Three Factors</span></span>
<span id="cb73-992"><a href="#cb73-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-995"><a href="#cb73-995" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-996"><a href="#cb73-996" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_daily_ff3_factors(portfolios_daily):</span>
<span id="cb73-997"><a href="#cb73-997" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-998"><a href="#cb73-998" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute daily Fama-French three factors.</span></span>
<span id="cb73-999"><a href="#cb73-999" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-1000"><a href="#cb73-1000" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-1001"><a href="#cb73-1001" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-1002"><a href="#cb73-1002" aria-hidden="true" tabindex="-1"></a><span class="co">    portfolios_daily : pd.DataFrame</span></span>
<span id="cb73-1003"><a href="#cb73-1003" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily returns with portfolio assignments</span></span>
<span id="cb73-1004"><a href="#cb73-1004" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-1005"><a href="#cb73-1005" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-1006"><a href="#cb73-1006" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-1007"><a href="#cb73-1007" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-1008"><a href="#cb73-1008" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily SMB and HML factors</span></span>
<span id="cb73-1009"><a href="#cb73-1009" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-1010"><a href="#cb73-1010" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily portfolio returns</span></span>
<span id="cb73-1011"><a href="#cb73-1011" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> (portfolios_daily</span>
<span id="cb73-1012"><a href="#cb73-1012" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1013"><a href="#cb73-1013" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1014"><a href="#cb73-1014" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-1015"><a href="#cb73-1015" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1016"><a href="#cb73-1016" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1017"><a href="#cb73-1017" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1018"><a href="#cb73-1018" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1019"><a href="#cb73-1019" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute factors</span></span>
<span id="cb73-1020"><a href="#cb73-1020" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (portfolio_returns</span>
<span id="cb73-1021"><a href="#cb73-1021" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-1022"><a href="#cb73-1022" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1023"><a href="#cb73-1023" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-1024"><a href="#cb73-1024" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean()),</span>
<span id="cb73-1025"><a href="#cb73-1025" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-1026"><a href="#cb73-1026" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-1027"><a href="#cb73-1027" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1028"><a href="#cb73-1028" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1029"><a href="#cb73-1029" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1030"><a href="#cb73-1030" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1031"><a href="#cb73-1031" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb73-1032"><a href="#cb73-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1033"><a href="#cb73-1033" aria-hidden="true" tabindex="-1"></a>factors_daily_smb_hml <span class="op">=</span> compute_daily_ff3_factors(portfolios_daily_ff3)</span>
<span id="cb73-1034"><a href="#cb73-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1035"><a href="#cb73-1035" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily factor observations: </span><span class="sc">{</span><span class="bu">len</span>(factors_daily_smb_hml)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-1036"><a href="#cb73-1036" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_daily_smb_hml.head(<span class="dv">10</span>))</span>
<span id="cb73-1037"><a href="#cb73-1037" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1038"><a href="#cb73-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1039"><a href="#cb73-1039" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Daily Market Factor</span></span>
<span id="cb73-1040"><a href="#cb73-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1043"><a href="#cb73-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1044"><a href="#cb73-1044" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_daily_market_factor(prices_daily):</span>
<span id="cb73-1045"><a href="#cb73-1045" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-1046"><a href="#cb73-1046" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute daily value-weighted market excess return.</span></span>
<span id="cb73-1047"><a href="#cb73-1047" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-1048"><a href="#cb73-1048" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-1049"><a href="#cb73-1049" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-1050"><a href="#cb73-1050" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_daily : pd.DataFrame</span></span>
<span id="cb73-1051"><a href="#cb73-1051" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily returns with mktcap_lag</span></span>
<span id="cb73-1052"><a href="#cb73-1052" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb73-1053"><a href="#cb73-1053" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-1054"><a href="#cb73-1054" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-1055"><a href="#cb73-1055" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-1056"><a href="#cb73-1056" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily market excess return</span></span>
<span id="cb73-1057"><a href="#cb73-1057" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-1058"><a href="#cb73-1058" aria-hidden="true" tabindex="-1"></a>    market_daily <span class="op">=</span> (prices_daily</span>
<span id="cb73-1059"><a href="#cb73-1059" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-1060"><a href="#cb73-1060" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1061"><a href="#cb73-1061" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mkt_excess"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-1062"><a href="#cb73-1062" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1063"><a href="#cb73-1063" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1064"><a href="#cb73-1064" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1065"><a href="#cb73-1065" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1066"><a href="#cb73-1066" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> market_daily</span>
<span id="cb73-1067"><a href="#cb73-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1068"><a href="#cb73-1068" aria-hidden="true" tabindex="-1"></a>market_factor_daily <span class="op">=</span> compute_daily_market_factor(prices_daily)</span>
<span id="cb73-1069"><a href="#cb73-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1070"><a href="#cb73-1070" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily market factor: </span><span class="sc">{</span><span class="bu">len</span>(market_factor_daily)<span class="sc">:,}</span><span class="ss"> days"</span>)</span>
<span id="cb73-1071"><a href="#cb73-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1072"><a href="#cb73-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1073"><a href="#cb73-1073" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combining Daily Three Factors</span></span>
<span id="cb73-1074"><a href="#cb73-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1077"><a href="#cb73-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1078"><a href="#cb73-1078" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily <span class="op">=</span> (factors_daily_smb_hml</span>
<span id="cb73-1079"><a href="#cb73-1079" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor_daily, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-1080"><a href="#cb73-1080" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1081"><a href="#cb73-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1082"><a href="#cb73-1082" aria-hidden="true" tabindex="-1"></a><span class="co"># Add risk-free rate (use monthly rate / 21 as daily approximation, or load actual daily rate)</span></span>
<span id="cb73-1083"><a href="#cb73-1083" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily[<span class="st">"risk_free"</span>] <span class="op">=</span> <span class="fl">0.04</span> <span class="op">/</span> <span class="dv">252</span>  <span class="co"># Approximate daily risk-free</span></span>
<span id="cb73-1084"><a href="#cb73-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1085"><a href="#cb73-1085" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily Fama-French Three Factors:"</span>)</span>
<span id="cb73-1086"><a href="#cb73-1086" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_daily.head(<span class="dv">10</span>))</span>
<span id="cb73-1087"><a href="#cb73-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1088"><a href="#cb73-1088" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily Factor Summary Statistics:"</span>)</span>
<span id="cb73-1089"><a href="#cb73-1089" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff3_daily[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]].describe().<span class="bu">round</span>(<span class="dv">6</span>))</span>
<span id="cb73-1090"><a href="#cb73-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1091"><a href="#cb73-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1092"><a href="#cb73-1092" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Daily Five Factors</span></span>
<span id="cb73-1093"><a href="#cb73-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1096"><a href="#cb73-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1097"><a href="#cb73-1097" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Clean portfolios</span></span>
<span id="cb73-1098"><a href="#cb73-1098" aria-hidden="true" tabindex="-1"></a>portfolios_ff5_clean <span class="op">=</span> portfolios_ff5[[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>, <span class="st">"portfolio_size"</span>, </span>
<span id="cb73-1099"><a href="#cb73-1099" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">"portfolio_bm"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"portfolio_inv"</span>]].copy()</span>
<span id="cb73-1100"><a href="#cb73-1100" aria-hidden="true" tabindex="-1"></a>portfolios_ff5_clean[<span class="st">"sorting_date"</span>] <span class="op">=</span> pd.to_datetime(portfolios_ff5_clean[<span class="st">"sorting_date"</span>])</span>
<span id="cb73-1101"><a href="#cb73-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1102"><a href="#cb73-1102" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Merge with daily prices</span></span>
<span id="cb73-1103"><a href="#cb73-1103" aria-hidden="true" tabindex="-1"></a>portfolios_daily_ff5 <span class="op">=</span> prices_daily_with_sort.merge(</span>
<span id="cb73-1104"><a href="#cb73-1104" aria-hidden="true" tabindex="-1"></a>    portfolios_ff5_clean,</span>
<span id="cb73-1105"><a href="#cb73-1105" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"sorting_date"</span>],</span>
<span id="cb73-1106"><a href="#cb73-1106" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-1107"><a href="#cb73-1107" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1108"><a href="#cb73-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1109"><a href="#cb73-1109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"FF5 Daily merged observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolios_daily_ff5)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-1110"><a href="#cb73-1110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1111"><a href="#cb73-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1114"><a href="#cb73-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1115"><a href="#cb73-1115" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_daily_ff5_factors(portfolios_daily):</span>
<span id="cb73-1116"><a href="#cb73-1116" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute daily Fama-French five factors."""</span></span>
<span id="cb73-1117"><a href="#cb73-1117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1118"><a href="#cb73-1118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HML from B/M sorts</span></span>
<span id="cb73-1119"><a href="#cb73-1119" aria-hidden="true" tabindex="-1"></a>    portfolios_bm <span class="op">=</span> (portfolios_daily</span>
<span id="cb73-1120"><a href="#cb73-1120" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_bm"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1121"><a href="#cb73-1121" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1122"><a href="#cb73-1122" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-1123"><a href="#cb73-1123" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1124"><a href="#cb73-1124" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1125"><a href="#cb73-1125" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1126"><a href="#cb73-1126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1127"><a href="#cb73-1127" aria-hidden="true" tabindex="-1"></a>    factors_hml <span class="op">=</span> (portfolios_bm</span>
<span id="cb73-1128"><a href="#cb73-1128" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-1129"><a href="#cb73-1129" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1130"><a href="#cb73-1130" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hml"</span>: (x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-1131"><a href="#cb73-1131" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_bm"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-1132"><a href="#cb73-1132" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1133"><a href="#cb73-1133" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1134"><a href="#cb73-1134" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1135"><a href="#cb73-1135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1136"><a href="#cb73-1136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RMW from OP sorts</span></span>
<span id="cb73-1137"><a href="#cb73-1137" aria-hidden="true" tabindex="-1"></a>    portfolios_op <span class="op">=</span> (portfolios_daily</span>
<span id="cb73-1138"><a href="#cb73-1138" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_op"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1139"><a href="#cb73-1139" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1140"><a href="#cb73-1140" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-1141"><a href="#cb73-1141" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1142"><a href="#cb73-1142" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1143"><a href="#cb73-1143" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1144"><a href="#cb73-1144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1145"><a href="#cb73-1145" aria-hidden="true" tabindex="-1"></a>    factors_rmw <span class="op">=</span> (portfolios_op</span>
<span id="cb73-1146"><a href="#cb73-1146" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-1147"><a href="#cb73-1147" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1148"><a href="#cb73-1148" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rmw"</span>: (x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-1149"><a href="#cb73-1149" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_op"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-1150"><a href="#cb73-1150" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1151"><a href="#cb73-1151" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1152"><a href="#cb73-1152" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1153"><a href="#cb73-1153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1154"><a href="#cb73-1154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CMA from INV sorts (note: low minus high)</span></span>
<span id="cb73-1155"><a href="#cb73-1155" aria-hidden="true" tabindex="-1"></a>    portfolios_inv <span class="op">=</span> (portfolios_daily</span>
<span id="cb73-1156"><a href="#cb73-1156" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"portfolio_size"</span>, <span class="st">"portfolio_inv"</span>, <span class="st">"date"</span>], observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1157"><a href="#cb73-1157" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1158"><a href="#cb73-1158" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ret"</span>: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-1159"><a href="#cb73-1159" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1160"><a href="#cb73-1160" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1161"><a href="#cb73-1161" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1162"><a href="#cb73-1162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1163"><a href="#cb73-1163" aria-hidden="true" tabindex="-1"></a>    factors_cma <span class="op">=</span> (portfolios_inv</span>
<span id="cb73-1164"><a href="#cb73-1164" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-1165"><a href="#cb73-1165" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1166"><a href="#cb73-1166" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cma"</span>: (x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-1167"><a href="#cb73-1167" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_inv"</span>] <span class="op">==</span> <span class="dv">3</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-1168"><a href="#cb73-1168" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1169"><a href="#cb73-1169" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1170"><a href="#cb73-1170" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1171"><a href="#cb73-1171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1172"><a href="#cb73-1172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SMB from all sorts</span></span>
<span id="cb73-1173"><a href="#cb73-1173" aria-hidden="true" tabindex="-1"></a>    all_portfolios <span class="op">=</span> pd.concat([portfolios_bm, portfolios_op, portfolios_inv])</span>
<span id="cb73-1174"><a href="#cb73-1174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1175"><a href="#cb73-1175" aria-hidden="true" tabindex="-1"></a>    factors_smb <span class="op">=</span> (all_portfolios</span>
<span id="cb73-1176"><a href="#cb73-1176" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb73-1177"><a href="#cb73-1177" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb73-1178"><a href="#cb73-1178" aria-hidden="true" tabindex="-1"></a>            <span class="st">"smb"</span>: (x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"ret"</span>].mean() <span class="op">-</span></span>
<span id="cb73-1179"><a href="#cb73-1179" aria-hidden="true" tabindex="-1"></a>                   x.loc[x[<span class="st">"portfolio_size"</span>] <span class="op">==</span> <span class="dv">2</span>, <span class="st">"ret"</span>].mean())</span>
<span id="cb73-1180"><a href="#cb73-1180" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb73-1181"><a href="#cb73-1181" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1182"><a href="#cb73-1182" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1183"><a href="#cb73-1183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1184"><a href="#cb73-1184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine</span></span>
<span id="cb73-1185"><a href="#cb73-1185" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> (factors_smb</span>
<span id="cb73-1186"><a href="#cb73-1186" aria-hidden="true" tabindex="-1"></a>        .merge(factors_hml, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb73-1187"><a href="#cb73-1187" aria-hidden="true" tabindex="-1"></a>        .merge(factors_rmw, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb73-1188"><a href="#cb73-1188" aria-hidden="true" tabindex="-1"></a>        .merge(factors_cma, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"outer"</span>)</span>
<span id="cb73-1189"><a href="#cb73-1189" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1190"><a href="#cb73-1190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1191"><a href="#cb73-1191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> factors</span>
<span id="cb73-1192"><a href="#cb73-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1193"><a href="#cb73-1193" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily FF5 factors</span></span>
<span id="cb73-1194"><a href="#cb73-1194" aria-hidden="true" tabindex="-1"></a>factors_daily_ff5 <span class="op">=</span> compute_daily_ff5_factors(portfolios_daily_ff5)</span>
<span id="cb73-1195"><a href="#cb73-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1196"><a href="#cb73-1196" aria-hidden="true" tabindex="-1"></a><span class="co"># Add market factor</span></span>
<span id="cb73-1197"><a href="#cb73-1197" aria-hidden="true" tabindex="-1"></a>factors_ff5_daily <span class="op">=</span> (factors_daily_ff5</span>
<span id="cb73-1198"><a href="#cb73-1198" aria-hidden="true" tabindex="-1"></a>    .merge(market_factor_daily, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-1199"><a href="#cb73-1199" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1200"><a href="#cb73-1200" aria-hidden="true" tabindex="-1"></a>factors_ff5_daily[<span class="st">"risk_free"</span>] <span class="op">=</span> <span class="fl">0.04</span> <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb73-1201"><a href="#cb73-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1202"><a href="#cb73-1202" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily Fama-French Five Factors:"</span>)</span>
<span id="cb73-1203"><a href="#cb73-1203" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_daily.head(<span class="dv">10</span>))</span>
<span id="cb73-1204"><a href="#cb73-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1205"><a href="#cb73-1205" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Daily Five-Factor Summary Statistics:"</span>)</span>
<span id="cb73-1206"><a href="#cb73-1206" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factors_ff5_daily[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]].describe().<span class="bu">round</span>(<span class="dv">6</span>))</span>
<span id="cb73-1207"><a href="#cb73-1207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1208"><a href="#cb73-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1209"><a href="#cb73-1209" aria-hidden="true" tabindex="-1"></a><span class="fu">### Saving Daily Factors</span></span>
<span id="cb73-1210"><a href="#cb73-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1213"><a href="#cb73-1213" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1214"><a href="#cb73-1214" aria-hidden="true" tabindex="-1"></a>factors_ff3_daily.to_sql(</span>
<span id="cb73-1215"><a href="#cb73-1215" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff3_daily"</span>,</span>
<span id="cb73-1216"><a href="#cb73-1216" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-1217"><a href="#cb73-1217" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-1218"><a href="#cb73-1218" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-1219"><a href="#cb73-1219" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1220"><a href="#cb73-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1221"><a href="#cb73-1221" aria-hidden="true" tabindex="-1"></a>factors_ff5_daily.to_sql(</span>
<span id="cb73-1222"><a href="#cb73-1222" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"factors_ff5_daily"</span>,</span>
<span id="cb73-1223"><a href="#cb73-1223" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-1224"><a href="#cb73-1224" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-1225"><a href="#cb73-1225" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-1226"><a href="#cb73-1226" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1227"><a href="#cb73-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1228"><a href="#cb73-1228" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily factor data saved to database."</span>)</span>
<span id="cb73-1229"><a href="#cb73-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1230"><a href="#cb73-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1231"><a href="#cb73-1231" aria-hidden="true" tabindex="-1"></a><span class="fu">## Factor Validation and Diagnostics</span></span>
<span id="cb73-1232"><a href="#cb73-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1235"><a href="#cb73-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1236"><a href="#cb73-1236" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify all tables are in database</span></span>
<span id="cb73-1237"><a href="#cb73-1237" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb73-1238"><a href="#cb73-1238" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATABASE SUMMARY"</span>)</span>
<span id="cb73-1239"><a href="#cb73-1239" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb73-1240"><a href="#cb73-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1241"><a href="#cb73-1241" aria-hidden="true" tabindex="-1"></a>tables <span class="op">=</span> [<span class="st">"factors_ff3_monthly"</span>, <span class="st">"factors_ff5_monthly"</span>, </span>
<span id="cb73-1242"><a href="#cb73-1242" aria-hidden="true" tabindex="-1"></a>          <span class="st">"factors_ff3_daily"</span>, <span class="st">"factors_ff5_daily"</span>]</span>
<span id="cb73-1243"><a href="#cb73-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1244"><a href="#cb73-1244" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> table <span class="kw">in</span> tables:</span>
<span id="cb73-1245"><a href="#cb73-1245" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_sql_query(<span class="ss">f"SELECT COUNT(*) as n FROM </span><span class="sc">{</span>table<span class="sc">}</span><span class="ss">"</span>, con<span class="op">=</span>tidy_finance)</span>
<span id="cb73-1246"><a href="#cb73-1246" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>table<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>df[<span class="st">'n'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb73-1247"><a href="#cb73-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1248"><a href="#cb73-1248" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation check: Monthly vs Daily (aggregated)</span></span>
<span id="cb73-1249"><a href="#cb73-1249" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb73-1250"><a href="#cb73-1250" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MONTHLY VS DAILY CONSISTENCY CHECK"</span>)</span>
<span id="cb73-1251"><a href="#cb73-1251" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb73-1252"><a href="#cb73-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1253"><a href="#cb73-1253" aria-hidden="true" tabindex="-1"></a>factors_daily_agg <span class="op">=</span> (factors_ff3_daily</span>
<span id="cb73-1254"><a href="#cb73-1254" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb73-1255"><a href="#cb73-1255" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year_month"</span>)[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]]</span>
<span id="cb73-1256"><a href="#cb73-1256" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb73-1257"><a href="#cb73-1257" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-1258"><a href="#cb73-1258" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1259"><a href="#cb73-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1260"><a href="#cb73-1260" aria-hidden="true" tabindex="-1"></a>factors_monthly_check <span class="op">=</span> (factors_ff3_monthly</span>
<span id="cb73-1261"><a href="#cb73-1261" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb73-1262"><a href="#cb73-1262" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1263"><a href="#cb73-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1264"><a href="#cb73-1264" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> factors_monthly_check.merge(</span>
<span id="cb73-1265"><a href="#cb73-1265" aria-hidden="true" tabindex="-1"></a>    factors_daily_agg, on<span class="op">=</span><span class="st">"year_month"</span>, suffixes<span class="op">=</span>(<span class="st">"_monthly"</span>, <span class="st">"_daily"</span>)</span>
<span id="cb73-1266"><a href="#cb73-1266" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1267"><a href="#cb73-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1268"><a href="#cb73-1268" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]:</span>
<span id="cb73-1269"><a href="#cb73-1269" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_monthly"</span>].corr(comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_daily"</span>])</span>
<span id="cb73-1270"><a href="#cb73-1270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">: Monthly-Daily correlation = </span><span class="sc">{</span>corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-1271"><a href="#cb73-1271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1272"><a href="#cb73-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1273"><a href="#cb73-1273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cumulative Factor Returns</span></span>
<span id="cb73-1274"><a href="#cb73-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1275"><a href="#cb73-1275" aria-hidden="true" tabindex="-1"></a>We visualize the cumulative performance of each factor to assess whether the factors generate meaningful premiums over time.</span>
<span id="cb73-1276"><a href="#cb73-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1279"><a href="#cb73-1279" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1280"><a href="#cb73-1280" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumulative-factors</span></span>
<span id="cb73-1281"><a href="#cb73-1281" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "70%"</span></span>
<span id="cb73-1282"><a href="#cb73-1282" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb73-1283"><a href="#cb73-1283" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative returns of Fama-French factors for the Vietnamese market. The figure shows the growth of $1 invested in each factor portfolio."</span></span>
<span id="cb73-1284"><a href="#cb73-1284" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing cumulative factor returns over time."</span></span>
<span id="cb73-1285"><a href="#cb73-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1286"><a href="#cb73-1286" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cumulative returns</span></span>
<span id="cb73-1287"><a href="#cb73-1287" aria-hidden="true" tabindex="-1"></a>factors_cumulative <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb73-1288"><a href="#cb73-1288" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"date"</span>)</span>
<span id="cb73-1289"><a href="#cb73-1289" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb73-1290"><a href="#cb73-1290" aria-hidden="true" tabindex="-1"></a>    .add(<span class="dv">1</span>)</span>
<span id="cb73-1291"><a href="#cb73-1291" aria-hidden="true" tabindex="-1"></a>    .cumprod()</span>
<span id="cb73-1292"><a href="#cb73-1292" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1293"><a href="#cb73-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1294"><a href="#cb73-1294" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb73-1295"><a href="#cb73-1295" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb73-1296"><a href="#cb73-1296" aria-hidden="true" tabindex="-1"></a>factors_cumulative.plot(ax<span class="op">=</span>ax)</span>
<span id="cb73-1297"><a href="#cb73-1297" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cumulative Factor Returns (Vietnam)"</span>)</span>
<span id="cb73-1298"><a href="#cb73-1298" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">""</span>)</span>
<span id="cb73-1299"><a href="#cb73-1299" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Growth of $1"</span>)</span>
<span id="cb73-1300"><a href="#cb73-1300" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Factor"</span>)</span>
<span id="cb73-1301"><a href="#cb73-1301" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb73-1302"><a href="#cb73-1302" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb73-1303"><a href="#cb73-1303" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb73-1304"><a href="#cb73-1304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1305"><a href="#cb73-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1306"><a href="#cb73-1306" aria-hidden="true" tabindex="-1"></a><span class="fu">### Average Factor Premiums</span></span>
<span id="cb73-1307"><a href="#cb73-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1308"><a href="#cb73-1308" aria-hidden="true" tabindex="-1"></a>We compute annualized average factor premiums and their statistical significance.</span>
<span id="cb73-1309"><a href="#cb73-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1312"><a href="#cb73-1312" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1313"><a href="#cb73-1313" aria-hidden="true" tabindex="-1"></a><span class="co"># Annualized average returns (monthly returns * 12)</span></span>
<span id="cb73-1314"><a href="#cb73-1314" aria-hidden="true" tabindex="-1"></a>factor_premiums <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb73-1315"><a href="#cb73-1315" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb73-1316"><a href="#cb73-1316" aria-hidden="true" tabindex="-1"></a>    .mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span>  <span class="co"># Annualized percentage</span></span>
<span id="cb73-1317"><a href="#cb73-1317" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1318"><a href="#cb73-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1319"><a href="#cb73-1319" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard errors</span></span>
<span id="cb73-1320"><a href="#cb73-1320" aria-hidden="true" tabindex="-1"></a>factor_se <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb73-1321"><a href="#cb73-1321" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb73-1322"><a href="#cb73-1322" aria-hidden="true" tabindex="-1"></a>    .std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(factors_ff5_monthly)) <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb73-1323"><a href="#cb73-1323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1324"><a href="#cb73-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1325"><a href="#cb73-1325" aria-hidden="true" tabindex="-1"></a><span class="co"># T-statistics</span></span>
<span id="cb73-1326"><a href="#cb73-1326" aria-hidden="true" tabindex="-1"></a>factor_tstat <span class="op">=</span> factor_premiums <span class="op">/</span> factor_se</span>
<span id="cb73-1327"><a href="#cb73-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1328"><a href="#cb73-1328" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Annualized Factor Premiums (%):"</span>)</span>
<span id="cb73-1329"><a href="#cb73-1329" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_premiums.<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb73-1330"><a href="#cb73-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1331"><a href="#cb73-1331" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">T-Statistics:"</span>)</span>
<span id="cb73-1332"><a href="#cb73-1332" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_tstat.<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb73-1333"><a href="#cb73-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1334"><a href="#cb73-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1335"><a href="#cb73-1335" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing Monthly and Daily Factors</span></span>
<span id="cb73-1336"><a href="#cb73-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1337"><a href="#cb73-1337" aria-hidden="true" tabindex="-1"></a>We verify consistency between monthly and daily factors by computing correlations.</span>
<span id="cb73-1338"><a href="#cb73-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1341"><a href="#cb73-1341" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1342"><a href="#cb73-1342" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily factors to monthly for comparison</span></span>
<span id="cb73-1343"><a href="#cb73-1343" aria-hidden="true" tabindex="-1"></a>factors_daily_monthly <span class="op">=</span> (factors_ff5_daily</span>
<span id="cb73-1344"><a href="#cb73-1344" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb73-1345"><a href="#cb73-1345" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year_month"</span>)</span>
<span id="cb73-1346"><a href="#cb73-1346" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb73-1347"><a href="#cb73-1347" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()  <span class="co"># Sum daily returns to get monthly</span></span>
<span id="cb73-1348"><a href="#cb73-1348" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-1349"><a href="#cb73-1349" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1350"><a href="#cb73-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1351"><a href="#cb73-1351" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with actual monthly factors</span></span>
<span id="cb73-1352"><a href="#cb73-1352" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> (factors_ff5_monthly</span>
<span id="cb73-1353"><a href="#cb73-1353" aria-hidden="true" tabindex="-1"></a>    .assign(year_month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>))</span>
<span id="cb73-1354"><a href="#cb73-1354" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb73-1355"><a href="#cb73-1355" aria-hidden="true" tabindex="-1"></a>        factors_daily_monthly,</span>
<span id="cb73-1356"><a href="#cb73-1356" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"year_month"</span>,</span>
<span id="cb73-1357"><a href="#cb73-1357" aria-hidden="true" tabindex="-1"></a>        suffixes<span class="op">=</span>(<span class="st">"_monthly"</span>, <span class="st">"_daily"</span>)</span>
<span id="cb73-1358"><a href="#cb73-1358" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1359"><a href="#cb73-1359" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1360"><a href="#cb73-1360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1361"><a href="#cb73-1361" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlations</span></span>
<span id="cb73-1362"><a href="#cb73-1362" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]:</span>
<span id="cb73-1363"><a href="#cb73-1363" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_monthly"</span>].corr(comparison[<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">_daily"</span>])</span>
<span id="cb73-1364"><a href="#cb73-1364" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">}</span><span class="ss">: Monthly-Daily correlation = </span><span class="sc">{</span>corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-1365"><a href="#cb73-1365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1366"><a href="#cb73-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1367"><a href="#cb73-1367" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways</span></span>
<span id="cb73-1368"><a href="#cb73-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1369"><a href="#cb73-1369" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Factor Models Explained**: The Fama-French three-factor model adds size (SMB) and value (HML) factors to the CAPM, while the five-factor model further includes profitability (RMW) and investment (CMA) factors.</span>
<span id="cb73-1370"><a href="#cb73-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1371"><a href="#cb73-1371" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Construction Methodology**: Factors are constructed through double-sorted portfolios with careful attention to timing. Portfolios are formed in July using accounting data from the prior fiscal year to ensure information was publicly available.</span>
<span id="cb73-1372"><a href="#cb73-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1373"><a href="#cb73-1373" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Independent vs. Dependent Sorts**: The three-factor model uses independent sorts on size and book-to-market, creating a 2×3 grid. The five-factor model uses dependent sorts where characteristics are sorted within size groups.</span>
<span id="cb73-1374"><a href="#cb73-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1375"><a href="#cb73-1375" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Value-Weighted Returns**: Portfolio returns are computed using value-weighting with lagged market capitalization to avoid look-ahead bias.</span>
<span id="cb73-1376"><a href="#cb73-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1377"><a href="#cb73-1377" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Daily Factors**: Daily factors use the same annual portfolio assignments but compute returns at daily frequency, enabling higher-frequency applications like daily beta estimation.</span>
<span id="cb73-1378"><a href="#cb73-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1379"><a href="#cb73-1379" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Market Factor**: The market factor is computed independently as the value-weighted return of all stocks minus the risk-free rate.</span>
<span id="cb73-1380"><a href="#cb73-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1381"><a href="#cb73-1381" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Validation**: Factor quality can be assessed through characteristic monotonicity, portfolio diversification, cumulative returns, and consistency between daily and monthly frequencies.</span>
<span id="cb73-1382"><a href="#cb73-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1383"><a href="#cb73-1383" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**Vietnamese Market Adaptation**: While following the original Fama-French methodology, we adapt for Vietnamese market characteristics including VAS accounting standards, reporting timelines, and currency units.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/12_fama_french.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>