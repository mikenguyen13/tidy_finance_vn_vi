<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>27&nbsp; Institutional Trades, Flows, and Turnover Ratios – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./53_governance.html" rel="next">
<link href="./50_institutional_ownership.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="27&nbsp; Institutional Trades, Flows, and Turnover Ratios – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:title" content="27&nbsp; Institutional Trades, Flows, and Turnover Ratios – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_institutional_ownership.html">Ownership, Market Frictions, and International Exposure</a></li><li class="breadcrumb-item"><a href="./52_institutional_trade_flow.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Data, Research Design, and Frontiers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./65_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#measuring-institutional-ownership-and-trading" id="toc-measuring-institutional-ownership-and-trading" class="nav-link active" data-scroll-target="#measuring-institutional-ownership-and-trading"><span class="header-section-number">27.1</span> Measuring Institutional Ownership and Trading</a></li>
  <li><a href="#trade-classification" id="toc-trade-classification" class="nav-link" data-scroll-target="#trade-classification"><span class="header-section-number">27.2</span> Trade Classification</a></li>
  <li><a href="#turnover-measures" id="toc-turnover-measures" class="nav-link" data-scroll-target="#turnover-measures"><span class="header-section-number">27.3</span> Turnover Measures</a></li>
  <li><a href="#institutional-ownership-in-emerging-markets" id="toc-institutional-ownership-in-emerging-markets" class="nav-link" data-scroll-target="#institutional-ownership-in-emerging-markets"><span class="header-section-number">27.4</span> Institutional Ownership in Emerging Markets</a></li>
  <li><a href="#net-flows-and-performance-attribution" id="toc-net-flows-and-performance-attribution" class="nav-link" data-scroll-target="#net-flows-and-performance-attribution"><span class="header-section-number">27.5</span> Net Flows and Performance Attribution</a></li>
  <li><a href="#sec-institutionaldata" id="toc-sec-institutionaldata" class="nav-link" data-scroll-target="#sec-institutionaldata"><span class="header-section-number">28</span> Data Infrastructure</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalreader" id="toc-sec-institutionalreader" class="nav-link" data-scroll-target="#sec-institutionalreader"><span class="header-section-number">28.1</span> Data Reader Class</a></li>
  </ul></li>
  <li><a href="#sec-institutionalcrsp" id="toc-sec-institutionalcrsp" class="nav-link" data-scroll-target="#sec-institutionalcrsp"><span class="header-section-number">29</span> Stock Price and Return Processing</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalprice-adj" id="toc-sec-institutionalprice-adj" class="nav-link" data-scroll-target="#sec-institutionalprice-adj"><span class="header-section-number">29.1</span> Price Data Extraction and Adjustment</a></li>
  <li><a href="#sec-institutionalprice-processing" id="toc-sec-institutionalprice-processing" class="nav-link" data-scroll-target="#sec-institutionalprice-processing"><span class="header-section-number">29.2</span> Monthly and Quarterly Price Processing</a></li>
  </ul></li>
  <li><a href="#sec-institutionalownership" id="toc-sec-institutionalownership" class="nav-link" data-scroll-target="#sec-institutionalownership"><span class="header-section-number">30</span> Ownership Data Processing</a>
  <ul class="collapse">
  <li><a href="#sec-institutionaltaxonomy" id="toc-sec-institutionaltaxonomy" class="nav-link" data-scroll-target="#sec-institutionaltaxonomy"><span class="header-section-number">30.1</span> Ownership Taxonomy</a></li>
  <li><a href="#sec-institutionalholdings-panel" id="toc-sec-institutionalholdings-panel" class="nav-link" data-scroll-target="#sec-institutionalholdings-panel"><span class="header-section-number">30.2</span> Building the Holdings Panel</a></li>
  </ul></li>
  <li><a href="#sec-institutionalio-metrics" id="toc-sec-institutionalio-metrics" class="nav-link" data-scroll-target="#sec-institutionalio-metrics"><span class="header-section-number">31</span> Institutional Ownership Metrics</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalio-ratio" id="toc-sec-institutionalio-ratio" class="nav-link" data-scroll-target="#sec-institutionalio-ratio"><span class="header-section-number">31.1</span> Institutional Ownership Ratio</a></li>
  <li><a href="#sec-institutionalhhi" id="toc-sec-institutionalhhi" class="nav-link" data-scroll-target="#sec-institutionalhhi"><span class="header-section-number">31.2</span> Ownership Concentration: Herfindahl-Hirschman Index</a></li>
  <li><a href="#sec-institutionalbreadth" id="toc-sec-institutionalbreadth" class="nav-link" data-scroll-target="#sec-institutionalbreadth"><span class="header-section-number">31.3</span> Ownership Breadth</a></li>
  <li><a href="#sec-institutionaltrade-impl" id="toc-sec-institutionaltrade-impl" class="nav-link" data-scroll-target="#sec-institutionaltrade-impl"><span class="header-section-number">31.4</span> Implementation</a>
  <ul class="collapse">
  <li><a href="#sec-institutionaltrade-viz" id="toc-sec-institutionaltrade-viz" class="nav-link" data-scroll-target="#sec-institutionaltrade-viz"><span class="header-section-number">31.4.1</span> Trade Visualization</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-institutionalassets-flows" id="toc-sec-institutionalassets-flows" class="nav-link" data-scroll-target="#sec-institutionalassets-flows"><span class="header-section-number">32</span> Portfolio Assets, Flows, and Returns</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalassets" id="toc-sec-institutionalassets" class="nav-link" data-scroll-target="#sec-institutionalassets"><span class="header-section-number">32.1</span> Total Assets and Portfolio Returns</a></li>
  <li><a href="#sec-institutionalaggregate-buysales" id="toc-sec-institutionalaggregate-buysales" class="nav-link" data-scroll-target="#sec-institutionalaggregate-buysales"><span class="header-section-number">32.2</span> Aggregate Buys and Sales</a></li>
  </ul></li>
  <li><a href="#sec-institutionalturnover" id="toc-sec-institutionalturnover" class="nav-link" data-scroll-target="#sec-institutionalturnover"><span class="header-section-number">33</span> Net Flows and Turnover Ratios</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalnetflows" id="toc-sec-institutionalnetflows" class="nav-link" data-scroll-target="#sec-institutionalnetflows"><span class="header-section-number">33.1</span> Net Flows</a></li>
  <li><a href="#sec-institutionalturnover-measures" id="toc-sec-institutionalturnover-measures" class="nav-link" data-scroll-target="#sec-institutionalturnover-measures"><span class="header-section-number">33.2</span> Three Turnover Measures</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalturnover-stats" id="toc-sec-institutionalturnover-stats" class="nav-link" data-scroll-target="#sec-institutionalturnover-stats"><span class="header-section-number">33.2.1</span> Turnover Summary Statistics</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-institutionalforeign" id="toc-sec-institutionalforeign" class="nav-link" data-scroll-target="#sec-institutionalforeign"><span class="header-section-number">34</span> Foreign Ownership Analytics</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalfol-util" id="toc-sec-institutionalfol-util" class="nav-link" data-scroll-target="#sec-institutionalfol-util"><span class="header-section-number">34.1</span> FOL Utilization</a></li>
  <li><a href="#sec-institutionalroom-premium" id="toc-sec-institutionalroom-premium" class="nav-link" data-scroll-target="#sec-institutionalroom-premium"><span class="header-section-number">34.2</span> Room Premium Regression</a></li>
  </ul></li>
  <li><a href="#sec-institutionalpipeline" id="toc-sec-institutionalpipeline" class="nav-link" data-scroll-target="#sec-institutionalpipeline"><span class="header-section-number">35</span> Complete Pipeline</a></li>
  <li><a href="#sec-institutionalextensions" id="toc-sec-institutionalextensions" class="nav-link" data-scroll-target="#sec-institutionalextensions"><span class="header-section-number">36</span> Advanced Extensions</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalherding" id="toc-sec-institutionalherding" class="nav-link" data-scroll-target="#sec-institutionalherding"><span class="header-section-number">36.1</span> Herding Measures</a></li>
  <li><a href="#sec-institutionalpersistence" id="toc-sec-institutionalpersistence" class="nav-link" data-scroll-target="#sec-institutionalpersistence"><span class="header-section-number">36.2</span> Demand Persistence</a></li>
  <li><a href="#sec-institutionalinfo-content" id="toc-sec-institutionalinfo-content" class="nav-link" data-scroll-target="#sec-institutionalinfo-content"><span class="header-section-number">36.3</span> Information Content of Trades</a></li>
  </ul></li>
  <li><a href="#sec-institutionalapplications" id="toc-sec-institutionalapplications" class="nav-link" data-scroll-target="#sec-institutionalapplications"><span class="header-section-number">37</span> Empirical Applications</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalapp-returns" id="toc-sec-institutionalapp-returns" class="nav-link" data-scroll-target="#sec-institutionalapp-returns"><span class="header-section-number">37.1</span> Application 1: Institutional Ownership Changes and Future Returns</a></li>
  <li><a href="#sec-institutionalapp-turnover" id="toc-sec-institutionalapp-turnover" class="nav-link" data-scroll-target="#sec-institutionalapp-turnover"><span class="header-section-number">37.2</span> Application 2: Turnover and Performance</a></li>
  <li><a href="#sec-institutionalapp-foreign-domestic" id="toc-sec-institutionalapp-foreign-domestic" class="nav-link" data-scroll-target="#sec-institutionalapp-foreign-domestic"><span class="header-section-number">37.3</span> Application 3: Foreign vs.&nbsp;Domestic Trading</a></li>
  </ul></li>
  <li><a href="#sec-institutionalrobustness" id="toc-sec-institutionalrobustness" class="nav-link" data-scroll-target="#sec-institutionalrobustness"><span class="header-section-number">38</span> Data Quality and Robustness</a>
  <ul class="collapse">
  <li><a href="#sec-institutionalpitfalls" id="toc-sec-institutionalpitfalls" class="nav-link" data-scroll-target="#sec-institutionalpitfalls"><span class="header-section-number">38.1</span> Common Pitfalls</a>
  <ul class="collapse">
  <li><a href="#corporate-action-misadjustment" id="toc-corporate-action-misadjustment" class="nav-link" data-scroll-target="#corporate-action-misadjustment"><span class="header-section-number">38.1.1</span> Corporate Action Misadjustment</a></li>
  <li><a href="#disclosure-timing-mismatches" id="toc-disclosure-timing-mismatches" class="nav-link" data-scroll-target="#disclosure-timing-mismatches"><span class="header-section-number">38.1.2</span> Disclosure Timing Mismatches</a></li>
  <li><a href="#name-changes-and-entity-mergers" id="toc-name-changes-and-entity-mergers" class="nav-link" data-scroll-target="#name-changes-and-entity-mergers"><span class="header-section-number">38.1.3</span> Name Changes and Entity Mergers</a></li>
  </ul></li>
  <li><a href="#sec-institutionalvalidation" id="toc-sec-institutionalvalidation" class="nav-link" data-scroll-target="#sec-institutionalvalidation"><span class="header-section-number">38.2</span> Validation Checks</a></li>
  </ul></li>
  <li><a href="#sec-institutionalsummary" id="toc-sec-institutionalsummary" class="nav-link" data-scroll-target="#sec-institutionalsummary"><span class="header-section-number">39</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/52_institutional_trade_flow.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_institutional_ownership.html">Ownership, Market Frictions, and International Exposure</a></li><li class="breadcrumb-item"><a href="./52_institutional_trade_flow.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Institutional investors play a pivotal role in price discovery, corporate governance, and market liquidity. Understanding <em>how</em> institutions trade and <em>how much</em> they trade provides insights into both asset pricing dynamics and the real effects of institutional monitoring. The seminal work of <span class="citation" data-cites="grinblatt1995momentum">Grinblatt, Titman, and Wermers (<a href="references.html#ref-grinblatt1995momentum" role="doc-biblioref">1995</a>)</span> on mutual fund momentum trading, <span class="citation" data-cites="wermers2000mutual">Wermers (<a href="references.html#ref-wermers2000mutual" role="doc-biblioref">2000</a>)</span> on fund performance decomposition, and <span class="citation" data-cites="yan2008liquidity">Yan (<a href="references.html#ref-yan2008liquidity" role="doc-biblioref">2008</a>)</span> on the relationship between turnover and future returns all rely on accurately measured institutional trades, flows, and turnover.</p>
<p>In the United States, this research is enabled by the mandatory quarterly 13F filing system administered by the Securities and Exchange Commission (SEC). Every institutional investment manager with at least $100 million in qualifying assets must disclose their equity holdings within 45 days of each calendar quarter end. The Thomson-Reuters (now Refinitiv) 13F database, accessible through WRDS, provides the canonical data infrastructure for this literature.</p>
<p>Vietnam’s equity market presents a fundamentally different institutional landscape. This chapter adapts the core methodology for the Vietnamese context, addressing five critical differences:</p>
<ol type="1">
<li><p><strong>Disclosure regime.</strong> Vietnam has no 13F-equivalent mandatory quarterly filing. Ownership disclosure is a patchwork of event-driven reports (threshold crossings at 5%, 10%, etc.), annual/semi-annual reports with shareholder registers, and daily foreign ownership tracking by exchanges.</p></li>
<li><p><strong>Corporate actions.</strong> Vietnamese firms issue stock dividends and bonus shares at extremely high rates compared to US firms. A firm might issue 20-30% bonus shares in a single year, fundamentally altering the share count. Share adjustment is therefore critical and nontrivial.</p></li>
<li><p><strong>Foreign ownership limits (FOLs).</strong> Binding foreign ownership ceiling, typically 49% for most sectors, 30% for banking, and 0% for certain restricted sectors, create a unique institutional constraint. When a stock approaches its FOL, foreign buying becomes mechanically restricted, distorting standard trade inference.</p></li>
<li><p><strong>State ownership.</strong> The Vietnamese government retains significant ownership in many listed firms through the State Capital Investment Corporation (SCIC) and other state entities. This creates a distinct ownership category not present in the US 13F data.</p></li>
<li><p><strong>Market microstructure.</strong> Daily price limits (<span class="math inline">\(\pm 7\%\)</span> on HOSE, <span class="math inline">\(\pm 10\%\)</span> on HNX, <span class="math inline">\(\pm 15\%\)</span> on UPCOM), T+2 settlement, and the absence of short-selling all affect how institutional trades translate into market outcomes.</p></li>
</ol>
<section id="measuring-institutional-ownership-and-trading" class="level2" data-number="27.1">
<h2 data-number="27.1" class="anchored" data-anchor-id="measuring-institutional-ownership-and-trading"><span class="header-section-number">27.1</span> Measuring Institutional Ownership and Trading</h2>
<p>The measurement of institutional ownership and trading activity has been a central concern in empirical finance since <span class="citation" data-cites="gompers2003corporate">Gompers, Ishii, and Metrick (<a href="references.html#ref-gompers2003corporate" role="doc-biblioref">2003</a>)</span> documented the rise of institutional investors. The approach relies on comparing holdings snapshots across consecutive reporting periods to infer trades. If manager <span class="math inline">\(j\)</span> holds <span class="math inline">\(h_{j,i,t}\)</span> shares of stock <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>, then the inferred trade is:</p>
<p><span id="eq-trade-simple"><span class="math display">\[
\Delta h_{j,i,t} = h_{j,i,t} - h_{j,i,t-1}
\tag{27.1}\]</span></span></p>
<p>where <span class="math inline">\(\Delta h_{j,i,t} &gt; 0\)</span> indicates a buy and <span class="math inline">\(\Delta h_{j,i,t} &lt; 0\)</span> indicates a sale. This simple differencing approach requires that holdings are observed at regular intervals (e.g., quarterly), share counts are adjusted for corporate actions between reporting dates, and entry and exit from the dataset are handled appropriately.</p>
<p><span class="citation" data-cites="chen2000value">Chen, Jegadeesh, and Wermers (<a href="references.html#ref-chen2000value" role="doc-biblioref">2000</a>)</span> introduced the concept of ownership <em>breadth</em> (i.e., the number of institutions holding a stock) and showed that changes in breadth predict future returns. <span class="citation" data-cites="sias2004institutional">Sias (<a href="references.html#ref-sias2004institutional" role="doc-biblioref">2004</a>)</span> decomposed institutional demand into a herding component and an information component. <span class="citation" data-cites="yan2008liquidity">Yan (<a href="references.html#ref-yan2008liquidity" role="doc-biblioref">2008</a>)</span> linked fund turnover to information-based trading and documented that high-turnover funds outperform, challenging the view that turnover reflects noise trading.</p>
</section>
<section id="trade-classification" class="level2" data-number="27.2">
<h2 data-number="27.2" class="anchored" data-anchor-id="trade-classification"><span class="header-section-number">27.2</span> Trade Classification</h2>
<p><a href="#tbl-trade-types" class="quarto-xref">Table&nbsp;<span>27.1</span></a> shows four categories of trades:</p>
<div id="tbl-trade-types" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-trade-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;27.1: Trade Classification Taxonomy
</figcaption>
<div aria-describedby="tbl-trade-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Code</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(+1\)</span></td>
<td style="text-align: left;">Initiating Buy</td>
<td style="text-align: left;">Manager enters a new position</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(+2\)</span></td>
<td style="text-align: left;">Incremental Buy</td>
<td style="text-align: left;">Manager increases an existing position</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><span class="math inline">\(-1\)</span></td>
<td style="text-align: left;">Terminating Sale</td>
<td style="text-align: left;">Manager completely exits a position</td>
</tr>
<tr class="even">
<td style="text-align: left;"><span class="math inline">\(-2\)</span></td>
<td style="text-align: left;">Regular Sale</td>
<td style="text-align: left;">Manager reduces an existing position</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>This classification is informative because initiating buys and terminating sales represent discrete portfolio decisions with different information content from marginal position adjustments <span class="citation" data-cites="alexander2007does">(<a href="references.html#ref-alexander2007does" role="doc-biblioref">Alexander, Cici, and Gibson 2007</a>)</span>.</p>
</section>
<section id="turnover-measures" class="level2" data-number="27.3">
<h2 data-number="27.3" class="anchored" data-anchor-id="turnover-measures"><span class="header-section-number">27.3</span> Turnover Measures</h2>
<p>Three standard turnover definitions have been used in the literature:</p>
<p><strong>Carhart (1997) Turnover.</strong> The minimum of aggregate buys and sales, normalized by average assets:</p>
<p><span id="eq-turnover-carhart"><span class="math display">\[
\text{Turnover}^{C}_{j,t} = \frac{\min\left(\sum_i B_{j,i,t},\, \sum_i S_{j,i,t}\right)}
{\frac{1}{2}\left(A_{j,t} + A_{j,t-1}\right)}
\tag{27.2}\]</span></span></p>
<p>where <span class="math inline">\(B_{j,i,t}\)</span> and <span class="math inline">\(S_{j,i,t}\)</span> are the dollar values of buys and sales of stock <span class="math inline">\(i\)</span> by manager <span class="math inline">\(j\)</span> in quarter <span class="math inline">\(t\)</span>, and <span class="math inline">\(A_{j,t}\)</span> is total portfolio assets <span class="citation" data-cites="Carhart1997">(<a href="references.html#ref-Carhart1997" role="doc-biblioref">Carhart 1997</a>)</span>.</p>
<p><strong>Flow-Adjusted Turnover.</strong> Adds back the absolute value of net flows to account for flow-driven trading:</p>
<p><span id="eq-turnover-flow"><span class="math display">\[
\text{Turnover}^{F}_{j,t} = \frac{\min\left(\sum_i B_{j,i,t},\, \sum_i S_{j,i,t}\right) + |\text{NetFlow}_{j,t}|}
{A_{j,t-1}}
\tag{27.3}\]</span></span></p>
<p><strong>Symmetric Turnover.</strong> Uses the sum of buys and sales minus the absolute net flow:</p>
<p><span id="eq-turnover-symmetric"><span class="math display">\[
\text{Turnover}^{S}_{j,t} = \frac{\sum_i B_{j,i,t} + \sum_i S_{j,i,t} - |\text{NetFlow}_{j,t}|}
{A_{j,t-1}}
\tag{27.4}\]</span></span></p>
<p>The relationship between these measures depends on the correlation between discretionary trading and flow-induced trading <span class="citation" data-cites="pastor2003liquidity">(<a href="references.html#ref-pastor2003liquidity" role="doc-biblioref">Pástor and Stambaugh 2003</a>)</span>.</p>
</section>
<section id="institutional-ownership-in-emerging-markets" class="level2" data-number="27.4">
<h2 data-number="27.4" class="anchored" data-anchor-id="institutional-ownership-in-emerging-markets"><span class="header-section-number">27.4</span> Institutional Ownership in Emerging Markets</h2>
<p>The emerging markets literature has documented several stylized facts about institutional ownership that differ from developed market findings. <span class="citation" data-cites="aggarwal2011does">Aggarwal et al. (<a href="references.html#ref-aggarwal2011does" role="doc-biblioref">2011</a>)</span> documented that foreign institutional ownership improves corporate governance in emerging markets. For Vietnam specifically, <span class="citation" data-cites="phung2016ownership">Phung and Mishra (<a href="references.html#ref-phung2016ownership" role="doc-biblioref">2016</a>)</span> examined the relationship between ownership structure and firm performance, while <span class="citation" data-cites="vo2015foreign">Vo (<a href="references.html#ref-vo2015foreign" role="doc-biblioref">2015</a>)</span> studied the impact of foreign ownership on stock market liquidity.</p>
</section>
<section id="net-flows-and-performance-attribution" class="level2" data-number="27.5">
<h2 data-number="27.5" class="anchored" data-anchor-id="net-flows-and-performance-attribution"><span class="header-section-number">27.5</span> Net Flows and Performance Attribution</h2>
<p>Net flows measure the dollar amount of new money entering or leaving a fund:</p>
<p><span id="eq-netflow"><span class="math display">\[
\text{NetFlow}_{j,t} = A_{j,t} - A_{j,t-1}(1 + R_{j,t}^p)
\tag{27.5}\]</span></span></p>
<p>where <span class="math inline">\(R_{j,t}^p\)</span> is the portfolio return. This decomposition, due to <span class="citation" data-cites="sirri1998costly">Sirri and Tufano (<a href="references.html#ref-sirri1998costly" role="doc-biblioref">1998</a>)</span>, separates changes in fund assets into investment returns and investor capital allocation decisions. <span class="citation" data-cites="coval2007asset">Coval and Stafford (<a href="references.html#ref-coval2007asset" role="doc-biblioref">2007</a>)</span> showed that flow-driven trades create price pressure, with fire sales by funds experiencing redemptions generating significant negative abnormal returns.</p>
</section>
<section id="sec-institutionaldata" class="level1" data-number="28">
<h1 data-number="28"><span class="header-section-number">28</span> Data Infrastructure</h1>
<p><a href="#tbl-datacore-datasets" class="quarto-xref">Table&nbsp;<span>28.1</span></a> summarizes the datasets used in this chapter.</p>
<div id="tbl-datacore-datasets" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-datacore-datasets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;28.1: DataCore.vn Datasets Used in This Chapter
</figcaption>
<div aria-describedby="tbl-datacore-datasets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Dataset</th>
<th style="text-align: left;">Content</th>
<th style="text-align: left;">Frequency</th>
<th style="text-align: left;">Key Variables</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Stock Prices</td>
<td style="text-align: left;">Daily/monthly OHLCV</td>
<td style="text-align: left;">Daily</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>close</code>, <code>adjusted_close</code>, <code>volume</code>, <code>shares_outstanding</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Ownership Structure</td>
<td style="text-align: left;">Shareholder composition</td>
<td style="text-align: left;">Quarterly/Annual</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>shareholder_name</code>, <code>shares_held</code>, <code>pct</code>, <code>type</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Major Shareholders</td>
<td style="text-align: left;">Holders <span class="math inline">\(\geq\)</span> 5%</td>
<td style="text-align: left;">Event-driven</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>shareholder_name</code>, <code>shares</code>, <code>is_foreign</code>, <code>is_state</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Corporate Actions</td>
<td style="text-align: left;">Splits, dividends, bonus</td>
<td style="text-align: left;">Event</td>
<td style="text-align: left;"><code>ticker</code>, <code>ex_date</code>, <code>action_type</code>, <code>ratio</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Company Profile</td>
<td style="text-align: left;">Sector, exchange, FOL</td>
<td style="text-align: left;">Static/Annual</td>
<td style="text-align: left;"><code>ticker</code>, <code>exchange</code>, <code>industry</code>, <code>listing_date</code>, <code>fol_limit</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Foreign Ownership</td>
<td style="text-align: left;">Daily foreign tracking</td>
<td style="text-align: left;">Daily</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>foreign_shares</code>, <code>foreign_pct</code>, <code>fol_limit</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fund Holdings</td>
<td style="text-align: left;">Fund portfolio snapshots</td>
<td style="text-align: left;">Semi-annual</td>
<td style="text-align: left;"><code>fund_name</code>, <code>report_date</code>, <code>ticker</code>, <code>shares_held</code>, <code>market_value</code></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<section id="sec-institutionalreader" class="level2" data-number="28.1">
<h2 data-number="28.1" class="anchored" data-anchor-id="sec-institutionalreader"><span class="header-section-number">28.1</span> Data Reader Class</h2>
<p>We begin by defining a unified data reader that handles file loading, date parsing, and basic validation:</p>
<div id="datacore-reader" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataCoreReader:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Unified reader for DataCore.vn datasets stored locally.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports Parquet (recommended) and CSV formats. Implements</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">    lazy loading with caching to minimize memory footprint.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">    data_dir : str or Path</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Directory containing DataCore.vn data files.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">    file_format : str</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">        File format: 'parquet' or 'csv'.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; dc = DataCoreReader('/data/datacore', file_format='parquet')</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; prices = dc.prices</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; ownership = dc.ownership</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    data_dir: Path</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    file_format: <span class="bu">str</span> <span class="op">=</span> <span class="st">'parquet'</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    _cache: Dict[<span class="bu">str</span>, pd.DataFrame] <span class="op">=</span> field(</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        default_factory<span class="op">=</span><span class="bu">dict</span>, <span class="bu">repr</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    FILE_MAP: Dict[<span class="bu">str</span>, <span class="bu">str</span>] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="kw">lambda</span>: {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'prices'</span>: <span class="st">'stock_prices'</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ownership'</span>: <span class="st">'ownership_structure'</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'major_shareholders'</span>: <span class="st">'major_shareholders'</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">'corporate_actions'</span>: <span class="st">'corporate_actions'</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'company_profile'</span>: <span class="st">'company_profile'</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'financials'</span>: <span class="st">'financial_statements'</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'foreign_ownership'</span>: <span class="st">'foreign_ownership'</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_holdings'</span>: <span class="st">'fund_holdings'</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    }, <span class="bu">repr</span><span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __post_init__(<span class="va">self</span>):</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_dir <span class="op">=</span> Path(<span class="va">self</span>.data_dir)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.data_dir.exists():</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Data directory not found: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _read(<span class="va">self</span>, key: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read and cache a dataset with automatic date parsing."""</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> <span class="va">self</span>._cache:</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._cache[key]</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> <span class="va">self</span>.FILE_MAP.get(key, key)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        filepath <span class="op">=</span> <span class="va">self</span>.data_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>file_format<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> filepath.exists():</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Dataset not found: </span><span class="sc">{</span>filepath<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Available: "</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span><span class="bu">list</span>(<span class="va">self</span>.data_dir.glob(<span class="ss">f'*.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>file_format<span class="sc">}</span><span class="ss">'</span>))<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.file_format <span class="op">==</span> <span class="st">'parquet'</span>:</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_parquet(filepath)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_csv(filepath, parse_dates<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Auto-detect and parse date columns</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        date_cols <span class="op">=</span> [</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">'date'</span>, <span class="st">'ex_date'</span>, <span class="st">'record_date'</span>, <span class="st">'period'</span>,</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">'report_date'</span>, <span class="st">'listing_date'</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col.lower() <span class="kw">in</span> date_cols <span class="kw">or</span> <span class="st">'date'</span> <span class="kw">in</span> col.lower():</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>                    df[col] <span class="op">=</span> pd.to_datetime(df[col])</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache[key] <span class="op">=</span> df</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Loaded </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows x </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> cols"</span>)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prices(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'prices'</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'ownership'</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> major_shareholders(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'major_shareholders'</span>)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> corporate_actions(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'corporate_actions'</span>)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> company_profile(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'company_profile'</span>)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> foreign_ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'foreign_ownership'</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fund_holdings(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'fund_holdings'</span>)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clear_cache(<span class="va">self</span>):</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(<span class="va">self</span>._cache)</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache.clear()</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Cleared </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> cached datasets"</span>)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize:</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="co"># dc = DataCoreReader('/path/to/datacore_data', file_format='parquet')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-institutionalcrsp" class="level1" data-number="29">
<h1 data-number="29"><span class="header-section-number">29</span> Stock Price and Return Processing</h1>
<p>The first step processes stock data to obtain adjusted prices, shares outstanding, and quarterly returns.</p>
<section id="sec-institutionalprice-adj" class="level2" data-number="29.1">
<h2 data-number="29.1" class="anchored" data-anchor-id="sec-institutionalprice-adj"><span class="header-section-number">29.1</span> Price Data Extraction and Adjustment</h2>
<p>Vietnamese stock data requires careful adjustment for frequent corporate actions. Unlike the US where CRSP provides a cumulative adjustment factor (<code>cfacpr</code>, <code>cfacshr</code>), in Vietnam we must construct adjustment factors from the corporate actions history.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Vietnamese Corporate Actions
</div>
</div>
<div class="callout-body-container callout-body">
<p>Vietnamese firms commonly execute the following corporate actions, each requiring share count and/or price adjustment:</p>
<ul>
<li><strong>Stock dividend</strong> (<em>co tuc bang co phieu</em>): e.g., 20% stock dividend means 100 shares become 120 shares</li>
<li><strong>Bonus shares</strong> (<em>co phieu thuong</em>): free shares distributed from retained earnings</li>
<li><strong>Rights issue</strong> (<em>phat hanh quyen mua</em>): right to buy new shares at a discount</li>
<li><strong>Stock split/reverse split</strong> (<em>chia/gop co phieu</em>): rare but occasionally used</li>
</ul>
</div>
</div>
<div id="corporate-action-adjustment" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_adjustment_factors(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    corporate_actions: pd.DataFrame,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct cumulative share adjustment factors from corporate actions.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the Vietnamese equivalent of CRSP's cfacshr factor. For each</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ticker, we compute a cumulative product of adjustment ratios from</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate actions, working forward in time.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">    The adjustment factor at date t converts historical share counts to</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">    be comparable with current (post-action) share counts:</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">        shares_adjusted_t = shares_raw_t * cfacshr_t</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate_actions : pd.DataFrame</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate actions with columns: ticker, ex_date, action_type,</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">        ratio. The ratio field represents:</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">        - Stock dividend 20%: ratio = 1.20</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">        - 2:1 stock split: ratio = 2.00</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">        - Bonus shares 10%: ratio = 1.10</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjustment factors: ticker, ex_date, cfacshr (cumulative).</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    share_actions <span class="op">=</span> corporate_actions[</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        corporate_actions[<span class="st">'action_type'</span>].isin([</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">'stock_dividend'</span>, <span class="st">'bonus_shares'</span>, <span class="st">'stock_split'</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reverse_split'</span>, <span class="st">'rights_issue'</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> share_actions.empty:</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'cfacshr'</span>])</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    share_actions <span class="op">=</span> share_actions.sort_values([<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>])</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    share_actions[<span class="st">'cfacshr'</span>] <span class="op">=</span> (</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        share_actions</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'ticker'</span>)[<span class="st">'ratio'</span>]</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        .cumprod()</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> share_actions[[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'cfacshr'</span>]].reset_index(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        drop<span class="op">=</span><span class="va">True</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cfacshr_at_date(</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    ticker: <span class="bu">str</span>,</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    date: pd.Timestamp,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">    Look up the cumulative share adjustment factor for a given</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">    ticker and date. Returns 1.0 if no corporate actions occurred.</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ex_date'</span>] <span class="op">&lt;=</span> date)</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> adj_factors.loc[mask]</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> subset.empty:</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> subset.iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'cfacshr'</span>]</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_shares_between_dates(</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    shares: <span class="bu">float</span>,</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    ticker: <span class="bu">str</span>,</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    date_from: pd.Timestamp,</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    date_to: pd.Timestamp,</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="co">    Adjust a share count observed at date_from to be comparable</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a><span class="co">    with shares observed at date_to, accounting for all intervening</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate actions.</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a><span class="co">    Example</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # Investor held 1000 shares on 2023-01-01</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # A 20% stock dividend occurred on 2023-03-15</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; adjust_shares_between_dates(</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     1000, 'VNM',</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     pd.Timestamp('2023-01-01'),</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     pd.Timestamp('2023-06-30'), adj_factors</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a><span class="co">    ... )</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a><span class="co">    1200.0</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    factor_from <span class="op">=</span> get_cfacshr_at_date(ticker, date_from, adj_factors)</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    factor_to <span class="op">=</span> get_cfacshr_at_date(ticker, date_to, adj_factors)</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    relative_factor <span class="op">=</span> factor_to <span class="op">/</span> factor_from</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shares <span class="op">*</span> relative_factor</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalprice-processing" class="level2" data-number="29.2">
<h2 data-number="29.2" class="anchored" data-anchor-id="sec-institutionalprice-processing"><span class="header-section-number">29.2</span> Monthly and Quarterly Price Processing</h2>
<div id="price-processing" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_prices(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    prices: pd.DataFrame,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    begdate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    enddate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2024-12-31'</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[pd.DataFrame, pd.DataFrame]:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Process raw DataCore.vn price data into analysis-ready format.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Block logic:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Filter to date range</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Compute adjusted prices and shares outstanding</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Compute quarterly compounded returns</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Create forward quarterly returns (shifted one quarter)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    prices : pd.DataFrame</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Raw price data with: ticker, date, close, adjusted_close,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">        volume, shares_outstanding.</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors.</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">    begdate, enddate : str</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Sample period boundaries.</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Tuple[pd.DataFrame, pd.DataFrame]</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">        (price_quarterly, qret): quarter-end observations with</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">        adjusted price, total shares, and forward quarterly return.</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> prices[</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        (prices[<span class="st">'date'</span>] <span class="op">&gt;=</span> begdate) <span class="op">&amp;</span> (prices[<span class="st">'date'</span>] <span class="op">&lt;=</span> enddate)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Month-end and quarter-end dates</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'mdate'</span>] <span class="op">=</span> price[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'qdate'</span>] <span class="op">=</span> price[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusted price</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'adjusted_close'</span> <span class="kw">in</span> price.columns:</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        price[<span class="st">'p'</span>] <span class="op">=</span> price[<span class="st">'adjusted_close'</span>]</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        price[<span class="st">'p'</span>] <span class="op">=</span> price[<span class="st">'close'</span>]</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total shares outstanding</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'tso'</span>] <span class="op">=</span> price[<span class="st">'shares_outstanding'</span>]</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market capitalization (millions VND)</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'mcap'</span>] <span class="op">=</span> price[<span class="st">'p'</span>] <span class="op">*</span> price[<span class="st">'tso'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out zero shares</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> price[price[<span class="st">'tso'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns if not present</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'ret'</span> <span class="kw">not</span> <span class="kw">in</span> price.columns:</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> price.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        price[<span class="st">'ret'</span>] <span class="op">=</span> price.groupby(<span class="st">'ticker'</span>)[<span class="st">'p'</span>].pct_change()</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'ret'</span>] <span class="op">=</span> price[<span class="st">'ret'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'logret'</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> price[<span class="st">'ret'</span>])</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Quarterly compounded returns ----</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    qret <span class="op">=</span> (</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        price</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'qdate'</span>])[<span class="st">'logret'</span>]</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>()</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    qret[<span class="st">'qret'</span>] <span class="op">=</span> np.exp(qret[<span class="st">'logret'</span>]) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shift qdate back one quarter: make qret a *forward* return</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    qret[<span class="st">'qdate'</span>] <span class="op">=</span> qret[<span class="st">'qdate'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    qret <span class="op">=</span> qret.drop(columns<span class="op">=</span>[<span class="st">'logret'</span>])</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Quarter-end observations ----</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    price_q <span class="op">=</span> price[price[<span class="st">'qdate'</span>] <span class="op">==</span> price[<span class="st">'mdate'</span>]].copy()</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    price_q <span class="op">=</span> price_q[[<span class="st">'qdate'</span>, <span class="st">'ticker'</span>, <span class="st">'p'</span>, <span class="st">'tso'</span>, <span class="st">'mcap'</span>]].copy()</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge forward quarterly return</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    price_q <span class="op">=</span> price_q.merge(qret, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build cfacshr lookup at each quarter-end</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    price_q[<span class="st">'cfacshr'</span>] <span class="op">=</span> price_q.<span class="bu">apply</span>(</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> row: get_cfacshr_at_date(</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'ticker'</span>], row[<span class="st">'qdate'</span>], adj_factors</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price_q, qret</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Performance Optimization
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>get_cfacshr_at_date</code> function uses a row-wise lookup which can be slow for large datasets. For production use with millions of rows, vectorize using <code>pd.merge_asof()</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>price_q <span class="op">=</span> pd.merge_asof(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    price_q.sort_values(<span class="st">'qdate'</span>),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    adj_factors.sort_values(<span class="st">'ex_date'</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'qdate'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'ex_date'</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'backward'</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>).fillna({<span class="st">'cfacshr'</span>: <span class="fl">1.0</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>The output is a quarterly panel of stock-level observations (@tbl-institutional-price-vars)</p>
<div id="tbl-institutional-price-vars" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-institutional-price-vars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;29.1: Quarter-End Price Panel Variables
</figcaption>
<div aria-describedby="tbl-institutional-price-vars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>ticker</code></td>
<td style="text-align: left;">Stock ticker (e.g., VNM, VCB, FPT)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>qdate</code></td>
<td style="text-align: left;">Quarter-end date</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>p</code></td>
<td style="text-align: left;">Adjusted closing price (VND)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>tso</code></td>
<td style="text-align: left;">Total shares outstanding</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>mcap</code></td>
<td style="text-align: left;">Market capitalization (millions VND)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>qret</code></td>
<td style="text-align: left;">Forward quarterly compounded return</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>cfacshr</code></td>
<td style="text-align: left;">Cumulative share adjustment factor</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-institutionalownership" class="level1" data-number="30">
<h1 data-number="30"><span class="header-section-number">30</span> Ownership Data Processing</h1>
<section id="sec-institutionaltaxonomy" class="level2" data-number="30.1">
<h2 data-number="30.1" class="anchored" data-anchor-id="sec-institutionaltaxonomy"><span class="header-section-number">30.1</span> Ownership Taxonomy</h2>
<p>We define a classification system for Vietnamese shareholders that maps to the categories available in DataCore.vn:</p>
<div id="ownership-taxonomy" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OwnershipType:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese ownership type classification.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam's ownership structure is fundamentally different from the US:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - **State** (Nha nuoc): SCIC, ministries, state-owned parents</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Foreign Institutional** (To chuc nuoc ngoai): foreign funds,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">      ETFs, pension funds, insurance, sovereign wealth funds</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Domestic Institutional** (To chuc trong nuoc): Vietnamese</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">      securities companies, fund managers, banks, insurance</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Individual** (Ca nhan): retail investors (domestic + foreign)</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Treasury** (Co phieu quy): company repurchases</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    STATE <span class="op">=</span> <span class="st">'State'</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    FOREIGN_INST <span class="op">=</span> <span class="st">'Foreign Institutional'</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    DOMESTIC_INST <span class="op">=</span> <span class="st">'Domestic Institutional'</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    INDIVIDUAL <span class="op">=</span> <span class="st">'Individual'</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    TREASURY <span class="op">=</span> <span class="st">'Treasury'</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    INSTITUTIONAL <span class="op">=</span> [FOREIGN_INST, DOMESTIC_INST]</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    ALL_INSTITUTIONAL <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    ALL_TYPES <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST, INDIVIDUAL, TREASURY]</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    STATE_KEYWORDS <span class="op">=</span> [</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scic'</span>, <span class="st">'state capital'</span>, <span class="st">'bo'</span>, <span class="st">'ubnd'</span>, <span class="st">'tong cong ty'</span>,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nha nuoc'</span>, <span class="st">'state'</span>, <span class="st">'government'</span>, <span class="st">"people's committee"</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ministry'</span>, <span class="st">'vietnam national'</span>, <span class="st">'vnpt'</span>, <span class="st">'evn'</span>, <span class="st">'pvn'</span>,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    FOREIGN_KEYWORDS <span class="op">=</span> [</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund'</span>, <span class="st">'investment'</span>, <span class="st">'capital'</span>, <span class="st">'asset management'</span>,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'securities'</span>, <span class="st">'gic'</span>, <span class="st">'templeton'</span>, <span class="st">'dragon capital'</span>,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'vinacapital'</span>, <span class="st">'mekong capital'</span>, <span class="st">'kb securities'</span>,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mirae asset'</span>, <span class="st">'samsung'</span>, <span class="st">'jp morgan'</span>, <span class="st">'goldman'</span>,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'blackrock'</span>, <span class="st">'vanguard'</span>, <span class="st">'aberdeen'</span>, <span class="st">'hsbc'</span>,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> classify(cls, row: pd.Series) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Classify based on explicit flags, then keyword fallback."""</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_state'</span>)) <span class="kw">and</span> row[<span class="st">'is_state'</span>]:</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.STATE</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_foreign'</span>)) <span class="kw">and</span> row[<span class="st">'is_foreign'</span>]:</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_institution'</span>)) <span class="kw">and</span> row[<span class="st">'is_institution'</span>]:</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> cls.FOREIGN_INST</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.INDIVIDUAL</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_institution'</span>)) <span class="kw">and</span> row[<span class="st">'is_institution'</span>]:</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.DOMESTIC_INST</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> <span class="bu">str</span>(row.get(<span class="st">'shareholder_name'</span>, <span class="st">''</span>)).lower()</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(kw <span class="kw">in</span> name <span class="cf">for</span> kw <span class="kw">in</span> cls.STATE_KEYWORDS):</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.STATE</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(kw <span class="kw">in</span> name <span class="cf">for</span> kw <span class="kw">in</span> cls.FOREIGN_KEYWORDS):</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.FOREIGN_INST</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls.INDIVIDUAL</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalholdings-panel" class="level2" data-number="30.2">
<h2 data-number="30.2" class="anchored" data-anchor-id="sec-institutionalholdings-panel"><span class="header-section-number">30.2</span> Building the Holdings Panel</h2>
<p>We construct the holdings panel (i.e., the Vietnamese equivalent of merging the 13F Type 1 and Type 3 datasets). The key steps are:</p>
<ol type="1">
<li>Identify the first available vintage for each shareholder-stock-report date combination.</li>
<li>Compute reporting gaps to flag first and last reports.</li>
<li>Classify shareholders.</li>
<li>Adjust shares for corporate actions.</li>
</ol>
<div id="holdings-panel" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_holdings_panel(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    ownership: pd.DataFrame,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    company_profile: pd.DataFrame,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    begdate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    enddate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2024-12-31'</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct the institutional holdings panel from DataCore.vn</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership data.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    own <span class="op">=</span> ownership.copy()</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align to quarter-end</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    own[<span class="st">'rdate'</span>] <span class="op">=</span> own[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    own[<span class="st">'fdate'</span>] <span class="op">=</span> own[<span class="st">'date'</span>]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    own <span class="op">=</span> own[</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        (own[<span class="st">'rdate'</span>] <span class="op">&gt;=</span> begdate) <span class="op">&amp;</span> (own[<span class="st">'rdate'</span>] <span class="op">&lt;=</span> enddate)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep earliest vintage per shareholder-ticker-rdate</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    own <span class="op">=</span> own.sort_values(</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'fdate'</span>]</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> (</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        own</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        .first()</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Reporting gaps for first/last flags ----</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.sort_values(</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> fst_vint.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'lag_rdate'</span>] <span class="op">=</span> grp[<span class="st">'rdate'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'qtr_gap'</span>] <span class="op">=</span> fst_vint.<span class="bu">apply</span>(</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>            (r[<span class="st">'rdate'</span>].to_period(<span class="st">'Q'</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>             <span class="op">-</span> r[<span class="st">'lag_rdate'</span>].to_period(<span class="st">'Q'</span>)).n</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(r[<span class="st">'lag_rdate'</span>]) <span class="cf">else</span> np.nan</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'first_report'</span>] <span class="op">=</span> (</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        fst_vint[<span class="st">'qtr_gap'</span>].isna() <span class="op">|</span> (fst_vint[<span class="st">'qtr_gap'</span>] <span class="op">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Last report flag (forward gap)</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.sort_values(</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>        ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">True</span>, <span class="va">False</span>]</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'lead_rdate'</span>] <span class="op">=</span> grp[<span class="st">'rdate'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'lead_gap'</span>] <span class="op">=</span> fst_vint.<span class="bu">apply</span>(</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>            (r[<span class="st">'lead_rdate'</span>].to_period(<span class="st">'Q'</span>)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>             <span class="op">-</span> r[<span class="st">'rdate'</span>].to_period(<span class="st">'Q'</span>)).n</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(r[<span class="st">'lead_rdate'</span>]) <span class="cf">else</span> np.nan</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'last_report'</span>] <span class="op">=</span> (</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        fst_vint[<span class="st">'lead_gap'</span>].isna() <span class="op">|</span> (fst_vint[<span class="st">'lead_gap'</span>] <span class="op">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.drop(</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">'lag_rdate'</span>, <span class="st">'qtr_gap'</span>, <span class="st">'lead_rdate'</span>, <span class="st">'lead_gap'</span>],</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">=</span><span class="st">'ignore'</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Classify shareholders ----</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'owner_type'</span>] <span class="op">=</span> fst_vint.<span class="bu">apply</span>(</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        OwnershipType.classify, axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Adjust shares for corporate actions ----</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.merge(</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'cfacshr'</span>]],</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'shares_adj'</span>] <span class="op">=</span> (</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        fst_vint[<span class="st">'shares_held'</span>] <span class="op">*</span> fst_vint[<span class="st">'cfacshr'</span>]</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint[fst_vint[<span class="st">'shares_adj'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.drop_duplicates(</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge company profile</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> company_profile <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>        fst_vint <span class="op">=</span> fst_vint.merge(</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>            company_profile[[<span class="st">'ticker'</span>, <span class="st">'exchange'</span>, <span class="st">'fol_limit'</span>]]</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>            .drop_duplicates(),</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> [</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'fdate'</span>,</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shares_held'</span>, <span class="st">'shares_adj'</span>, <span class="st">'owner_type'</span>,</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">'first_report'</span>, <span class="st">'last_report'</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'exchange'</span> <span class="kw">in</span> fst_vint.columns:</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>        cols.extend([<span class="st">'exchange'</span>, <span class="st">'fol_limit'</span>])</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    holdings <span class="op">=</span> fst_vint[cols].copy()</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Holdings panel: </span><span class="sc">{</span><span class="bu">len</span>(holdings)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Shareholders: </span><span class="sc">{</span>holdings[<span class="st">'shareholder_name'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stocks: </span><span class="sc">{</span>holdings[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Quarters: </span><span class="sc">{</span>holdings[<span class="st">'rdate'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> holdings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-institutionalio-metrics" class="level1" data-number="31">
<h1 data-number="31"><span class="header-section-number">31</span> Institutional Ownership Metrics</h1>
<p>Before computing trades, we establish the standard institutional ownership metrics that serve as both outputs and inputs to the trading analysis.</p>
<section id="sec-institutionalio-ratio" class="level2" data-number="31.1">
<h2 data-number="31.1" class="anchored" data-anchor-id="sec-institutionalio-ratio"><span class="header-section-number">31.1</span> Institutional Ownership Ratio</h2>
<p>The institutional ownership ratio (IO) for stock <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> is:</p>
<p><span id="eq-io-ratio"><span class="math display">\[
IO_{i,t} = \frac{\sum_{j \in \mathcal{J}} h_{j,i,t}}{TSO_{i,t}}
\tag{31.1}\]</span></span></p>
<p>where <span class="math inline">\(\mathcal{J}\)</span> is the set of institutional investors and <span class="math inline">\(TSO_{i,t}\)</span> is total shares outstanding. In Vietnam, we compute separate ratios for each ownership type:</p>
<p><span id="eq-io-by-type"><span class="math display">\[
IO_{i,t}^{\text{type}} = \frac{\sum_{j \in \mathcal{J}^{\text{type}}} h_{j,i,t}}{TSO_{i,t}},
\quad \text{type} \in \{\text{State}, \text{Foreign}, \text{Domestic}, \text{Individual}\}
\tag{31.2}\]</span></span></p>
<div id="io-ratio-computation" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_io_ratios(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute IO ratios by type for each stock-quarter."""</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> (</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        holdings</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'owner_type'</span>])[<span class="st">'shares_adj'</span>]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    io_wide <span class="op">=</span> agg.pivot_table(</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'owner_type'</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">'shares_adj'</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    io_wide.columns <span class="op">=</span> [</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        c <span class="cf">if</span> c <span class="kw">in</span> [<span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="ss">f'shares_</span><span class="sc">{</span>c<span class="sc">.</span>lower()<span class="sc">.</span>replace(<span class="st">" "</span>, <span class="st">"_"</span>)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> io_wide.columns</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    io_wide <span class="op">=</span> io_wide.merge(</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'tso'</span>]],</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    share_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> io_wide.columns <span class="cf">if</span> c.startswith(<span class="st">'shares_'</span>)]</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> share_cols:</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        ratio_name <span class="op">=</span> col.replace(<span class="st">'shares_'</span>, <span class="st">'io_'</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        io_wide[ratio_name] <span class="op">=</span> io_wide[col] <span class="op">/</span> io_wide[<span class="st">'tso'</span>]</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    inst_cols <span class="op">=</span> [</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        c <span class="cf">for</span> c <span class="kw">in</span> io_wide.columns</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> c.startswith(<span class="st">'shares_'</span>)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> <span class="st">'individual'</span> <span class="kw">not</span> <span class="kw">in</span> c</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> <span class="st">'treasury'</span> <span class="kw">not</span> <span class="kw">in</span> c</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    io_wide[<span class="st">'io_total_inst'</span>] <span class="op">=</span> (</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        io_wide[inst_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> io_wide[<span class="st">'tso'</span>]</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> io_wide</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalhhi" class="level2" data-number="31.2">
<h2 data-number="31.2" class="anchored" data-anchor-id="sec-institutionalhhi"><span class="header-section-number">31.2</span> Ownership Concentration: Herfindahl-Hirschman Index</h2>
<p>The HHI measures ownership concentration:</p>
<p><span id="eq-hhi"><span class="math display">\[
HHI_{i,t} = \sum_{j=1}^{N_{i,t}} \left(\frac{h_{j,i,t}}{\sum_{k=1}^{N_{i,t}} h_{k,i,t}}\right)^2
\tag{31.3}\]</span></span></p>
<p>where <span class="math inline">\(N_{i,t}\)</span> is the number of shareholders. HHI ranges from <span class="math inline">\(1/N_{i,t}\)</span> (equal) to 1 (single shareholder). In Vietnam, ownership tends to be highly concentrated due to large state and founding-family blocks.</p>
<div id="hhi-computation" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_hhi(holdings: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute HHI for each stock-quarter, overall and institutional."""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _hhi(shares: pd.Series) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> shares.<span class="bu">sum</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> shares <span class="op">/</span> total</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (weights <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    hhi_overall <span class="op">=</span> (</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        holdings.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])[<span class="st">'shares_adj'</span>]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(_hhi).reset_index()</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'shares_adj'</span>: <span class="st">'hhi_overall'</span>})</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> holdings[</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        holdings[<span class="st">'owner_type'</span>].isin(OwnershipType.ALL_INSTITUTIONAL)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    hhi_inst <span class="op">=</span> (</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        inst.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])[<span class="st">'shares_adj'</span>]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(_hhi).reset_index()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'shares_adj'</span>: <span class="st">'hhi_institutional'</span>})</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hhi_overall.merge(hhi_inst, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalbreadth" class="level2" data-number="31.3">
<h2 data-number="31.3" class="anchored" data-anchor-id="sec-institutionalbreadth"><span class="header-section-number">31.3</span> Ownership Breadth</h2>
<p>Following <span class="citation" data-cites="chen2000value">Chen, Jegadeesh, and Wermers (<a href="references.html#ref-chen2000value" role="doc-biblioref">2000</a>)</span>, ownership breadth is the number of institutional holders:</p>
<p><span id="eq-breadth"><span class="math display">\[
\text{Breadth}_{i,t} = \#\{j : h_{j,i,t} &gt; 0, \, j \in \mathcal{J}\}
\tag{31.4}\]</span></span></p>
<p>The <em>change</em> in breadth predicts future returns:</p>
<p><span id="eq-breadth-change"><span class="math display">\[
\Delta\text{Breadth}_{i,t} = \text{Breadth}_{i,t} - \text{Breadth}_{i,t-1}
\tag{31.5}\]</span></span></p>
<div id="breadth-computation" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_breadth(holdings: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute ownership breadth and changes by type."""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    breadth <span class="op">=</span> (</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        holdings[</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            holdings[<span class="st">'owner_type'</span>].isin(OwnershipType.ALL_INSTITUTIONAL)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'owner_type'</span>])[<span class="st">'shareholder_name'</span>]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        .nunique()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_holders'</span>})</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    breadth_wide <span class="op">=</span> breadth.pivot_table(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'owner_type'</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">'n_holders'</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    breadth_wide.columns <span class="op">=</span> [</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        c <span class="cf">if</span> c <span class="kw">in</span> [<span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="ss">f'n_</span><span class="sc">{</span>c<span class="sc">.</span>lower()<span class="sc">.</span>replace(<span class="st">" "</span>, <span class="st">"_"</span>)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> breadth_wide.columns</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> breadth_wide.columns <span class="cf">if</span> c.startswith(<span class="st">'n_'</span>)]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    breadth_wide[<span class="st">'n_total_inst'</span>] <span class="op">=</span> breadth_wide[n_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    breadth_wide <span class="op">=</span> breadth_wide.sort_values([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> n_cols <span class="op">+</span> [<span class="st">'n_total_inst'</span>]:</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        breadth_wide[<span class="ss">f'd_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> (</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>            breadth_wide.groupby(<span class="st">'ticker'</span>)[col].diff()</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> breadth_wide</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>(<span class="math inline">\(\text{BS} = -1\)</span>) is generated for the prior position, dated to the quarter after the last report.</p>
<p>For intermediate gaps (reports at <span class="math inline">\(t-2\)</span> and <span class="math inline">\(t\)</span> but not <span class="math inline">\(t-1\)</span>), we split into:</p>
<ul>
<li>A terminating sale at <span class="math inline">\(t-1\)</span> of <span class="math inline">\(-h_{j,i,t-2}^{\text{adj}}\)</span>;</li>
<li>An initiating buy at <span class="math inline">\(t\)</span> of <span class="math inline">\(h_{j,i,t}\)</span>.</li>
</ul>
</section>
<section id="sec-institutionaltrade-impl" class="level2" data-number="31.4">
<h2 data-number="31.4" class="anchored" data-anchor-id="sec-institutionaltrade-impl"><span class="header-section-number">31.4</span> Implementation</h2>
<div id="trade-computation" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_trades(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute institutional trades from holdings panel.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses vectorized conditional logic (NOT apply()) for performance.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Algorithm:</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Sort holdings by shareholder, ticker, quarter</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Compute lagged holdings and reporting gaps</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Apply modified trade logic based on first_report, gap</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Handle terminating sales and intermediate gaps</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Append all trade records</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> holdings.sort_values(</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    ).copy()</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Previous holding quarter and shares</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> t1.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'phrdate'</span>] <span class="op">=</span> grp[<span class="st">'rdate'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'pshares_adj'</span>] <span class="op">=</span> grp[<span class="st">'shares_adj'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Raw trade</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'trade'</span>] <span class="op">=</span> t1[<span class="st">'shares_adj'</span>] <span class="op">-</span> t1[<span class="st">'pshares_adj'</span>]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quarter gap</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'qtrgap'</span>] <span class="op">=</span> t1.<span class="bu">apply</span>(</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            (r[<span class="st">'rdate'</span>].to_period(<span class="st">'Q'</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>             <span class="op">-</span> r[<span class="st">'phrdate'</span>].to_period(<span class="st">'Q'</span>)).n</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(r[<span class="st">'phrdate'</span>]) <span class="cf">else</span> np.nan</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Boundary detection keys</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'l_key'</span>] <span class="op">=</span> (</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        t1[<span class="st">'shareholder_name'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> t1[<span class="st">'ticker'</span>]</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    ).shift(<span class="dv">1</span>)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'n_key'</span>] <span class="op">=</span> (</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        t1[<span class="st">'shareholder_name'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> t1[<span class="st">'ticker'</span>]</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    ).shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'curr_key'</span>] <span class="op">=</span> t1[<span class="st">'shareholder_name'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> t1[<span class="st">'ticker'</span>]</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Vectorized trade classification ----</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    is_new <span class="op">=</span> (t1[<span class="st">'curr_key'</span>] <span class="op">!=</span> t1[<span class="st">'l_key'</span>])</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    not_first <span class="op">=</span> <span class="op">~</span>t1[<span class="st">'first_report'</span>]</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    consec <span class="op">=</span> (t1[<span class="st">'qtrgap'</span>] <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    gap <span class="op">=</span> (t1[<span class="st">'qtrgap'</span>] <span class="op">!=</span> <span class="dv">1</span>) <span class="op">&amp;</span> t1[<span class="st">'qtrgap'</span>].notna()</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    cond1   <span class="op">=</span> is_new</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    cond1_1 <span class="op">=</span> is_new <span class="op">&amp;</span> not_first</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    cond2_1 <span class="op">=</span> (<span class="op">~</span>is_new) <span class="op">&amp;</span> not_first <span class="op">&amp;</span> consec</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    cond2_2 <span class="op">=</span> (<span class="op">~</span>is_new) <span class="op">&amp;</span> not_first <span class="op">&amp;</span> gap</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modified trade amounts</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'modtrade'</span>] <span class="op">=</span> t1[<span class="st">'trade'</span>]</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond1, <span class="st">'modtrade'</span>] <span class="op">=</span> np.nan</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond1_1, <span class="st">'modtrade'</span>] <span class="op">=</span> t1.loc[cond1_1, <span class="st">'shares_adj'</span>]</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_1, <span class="st">'modtrade'</span>] <span class="op">=</span> t1.loc[cond2_1, <span class="st">'trade'</span>]</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_2, <span class="st">'modtrade'</span>] <span class="op">=</span> t1.loc[cond2_2, <span class="st">'shares_adj'</span>]</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy/sale classification</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'buysale'</span>] <span class="op">=</span> np.nan</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond1_1, <span class="st">'buysale'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_1, <span class="st">'buysale'</span>] <span class="op">=</span> (</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="op">*</span> np.sign(t1.loc[cond2_1, <span class="st">'trade'</span>])</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_2, <span class="st">'buysale'</span>] <span class="op">=</span> <span class="fl">1.5</span>  <span class="co"># placeholder for split</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Handle intermediate gaps (buysale == 1.5) ----</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> t1[t1[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="fl">1.5</span>].copy()</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    t2[<span class="st">'rdate'</span>] <span class="op">=</span> t2[<span class="st">'phrdate'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">1</span>)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    t2[<span class="st">'buysale'</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>    t2[<span class="st">'modtrade'</span>] <span class="op">=</span> <span class="op">-</span>t2[<span class="st">'pshares_adj'</span>]</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    t1.loc[t1[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="fl">1.5</span>, <span class="st">'buysale'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Terminating sales ----</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>    is_last_combo <span class="op">=</span> (t1[<span class="st">'curr_key'</span>] <span class="op">!=</span> t1[<span class="st">'n_key'</span>])</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    not_last_rpt <span class="op">=</span> <span class="op">~</span>t1[<span class="st">'last_report'</span>]</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    t3 <span class="op">=</span> t1[is_last_combo <span class="op">&amp;</span> not_last_rpt].copy()</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    t3[<span class="st">'rdate'</span>] <span class="op">=</span> t3[<span class="st">'rdate'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">1</span>)</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    t3[<span class="st">'modtrade'</span>] <span class="op">=</span> <span class="op">-</span>t3[<span class="st">'shares_adj'</span>]</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    t3[<span class="st">'buysale'</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Combine ----</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> pd.concat([t1, t2, t3], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades[</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>        (trades[<span class="st">'modtrade'</span>] <span class="op">!=</span> <span class="dv">0</span>) <span class="op">&amp;</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>        trades[<span class="st">'modtrade'</span>].notna() <span class="op">&amp;</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>        trades[<span class="st">'buysale'</span>].notna()</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades[[</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rdate'</span>, <span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'modtrade'</span>,</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">'buysale'</span>, <span class="st">'owner_type'</span>, <span class="st">'first_report'</span>, <span class="st">'last_report'</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    ]].rename(columns<span class="op">=</span>{<span class="st">'modtrade'</span>: <span class="st">'trade'</span>})</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Trade computation complete:"</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total records: </span><span class="sc">{</span><span class="bu">len</span>(trades)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Initiating buys:  </span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Incremental buys: </span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="dv">2</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Terminating sales:</span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Regular sales:    </span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="op">-</span><span class="dv">2</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="sec-institutionaltrade-viz" class="level3" data-number="31.4.1">
<h3 data-number="31.4.1" class="anchored" data-anchor-id="sec-institutionaltrade-viz"><span class="header-section-number">31.4.1</span> Trade Visualization</h3>
<div id="fig-trade-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="12">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trade-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_trade_distribution(trades: pd.DataFrame):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot time series of trade types by quarter."""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    bs_labels <span class="op">=</span> {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>: <span class="st">'Initiating Buy'</span>, <span class="dv">2</span>: <span class="st">'Incremental Buy'</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span><span class="dv">1</span>: <span class="st">'Terminating Sale'</span>, <span class="op">-</span><span class="dv">2</span>: <span class="st">'Regular Sale'</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades.copy()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    trades[<span class="st">'trade_type'</span>] <span class="op">=</span> trades[<span class="st">'buysale'</span>].<span class="bu">map</span>(bs_labels)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> (</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        trades</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        .groupby([pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>), <span class="st">'trade_type'</span>])</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        .size()</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    buy_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> counts.columns <span class="cf">if</span> <span class="st">'Buy'</span> <span class="kw">in</span> c]</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    counts[buy_cols].plot(</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>[<span class="st">'#1f77b4'</span>, <span class="st">'#aec7e8'</span>], width<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Institutional Purchases'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    sale_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> counts.columns <span class="cf">if</span> <span class="st">'Sale'</span> <span class="kw">in</span> c]</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    counts[sale_cols].plot(</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>[<span class="st">'#d62728'</span>, <span class="st">'#ff9896'</span>], width<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Institutional Sales'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axes:</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, label <span class="kw">in</span> <span class="bu">enumerate</span>(ax.get_xticklabels()):</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">4</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                label.set_visible(<span class="va">False</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_trade_distribution(trades)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-trade-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;31.1
</figcaption>
</figure>
</div>
<div id="fig-net-trading-by-type" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-net-trading-by-type-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_net_trading_by_type(trades: pd.DataFrame, price_q: pd.DataFrame):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot net trading volume by owner type over time."""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'trade_vnd'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    net <span class="op">=</span> (</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        _t</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        .groupby([pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>), <span class="st">'owner_type'</span>])</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'trade_vnd'</span>].<span class="bu">sum</span>()</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> net.columns:</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        ax.plot(net.index, net[col], label<span class="op">=</span>col,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>OWNER_COLORS.get(col, <span class="st">'#333'</span>), linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Net Institutional Trading by Ownership Type'</span>,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                 fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Net Trading (Billions VND)'</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_net_trading_by_type(trades, price_q)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-net-trading-by-type-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;31.2
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="sec-institutionalassets-flows" class="level1" data-number="32">
<h1 data-number="32"><span class="header-section-number">32</span> Portfolio Assets, Flows, and Returns</h1>
<p>This section computes total portfolio assets, aggregates buys and sales, and portfolio-level returns for each institutional investor.</p>
<section id="sec-institutionalassets" class="level2" data-number="32.1">
<h2 data-number="32.1" class="anchored" data-anchor-id="sec-institutionalassets"><span class="header-section-number">32.1</span> Total Assets and Portfolio Returns</h2>
<p>For each manager <span class="math inline">\(j\)</span> and quarter <span class="math inline">\(t\)</span>, portfolio assets are:</p>
<p><span id="eq-assets"><span class="math display">\[
A_{j,t} = \sum_{i=1}^{N_{j,t}} h_{j,i,t} \cdot P_{i,t}
\tag{32.1}\]</span></span></p>
<p>The portfolio return assuming buy-and-hold is:</p>
<p><span id="eq-portfolio-return"><span class="math display">\[
R_{j,t}^{p} = \frac{\sum_{i=1}^{N_{j,t}} h_{j,i,t} \cdot P_{i,t} \cdot r_{i,t+1}}
{\sum_{i=1}^{N_{j,t}} h_{j,i,t} \cdot P_{i,t}}
\tag{32.2}\]</span></span></p>
<div id="assets-computation" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_assets_and_returns(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute total portfolio assets and buy-and-hold returns."""</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    _assets <span class="op">=</span> holdings[</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'shares_adj'</span>]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    ].merge(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    _assets[<span class="st">'hold_per_stock'</span>] <span class="op">=</span> _assets[<span class="st">'shares_adj'</span>] <span class="op">*</span> _assets[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    _assets[<span class="st">'next_value'</span>] <span class="op">=</span> (</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        _assets[<span class="st">'shares_adj'</span>] <span class="op">*</span> _assets[<span class="st">'p'</span>] <span class="op">*</span> _assets[<span class="st">'qret'</span>]</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    _assets[<span class="st">'curr_value'</span>] <span class="op">=</span> _assets[<span class="st">'shares_adj'</span>] <span class="op">*</span> _assets[<span class="st">'p'</span>]</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> (</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        _assets</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>            assets<span class="op">=</span>(<span class="st">'hold_per_stock'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>            total_next<span class="op">=</span>(<span class="st">'next_value'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>            total_curr<span class="op">=</span>(<span class="st">'curr_value'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    assets[<span class="st">'pret'</span>] <span class="op">=</span> assets[<span class="st">'total_next'</span>] <span class="op">/</span> assets[<span class="st">'total_curr'</span>]</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> assets.drop(columns<span class="op">=</span>[<span class="st">'total_next'</span>, <span class="st">'total_curr'</span>])</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> assets</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalaggregate-buysales" class="level2" data-number="32.2">
<h2 data-number="32.2" class="anchored" data-anchor-id="sec-institutionalaggregate-buysales"><span class="header-section-number">32.2</span> Aggregate Buys and Sales</h2>
<p>Total buys and sales for manager <span class="math inline">\(j\)</span> in quarter <span class="math inline">\(t\)</span>:</p>
<p><span id="eq-total-buys-sales"><span class="math display">\[
B_{j,t} = \sum_{i : \Delta h &gt; 0} \Delta h_{j,i,t} \cdot P_{i,t}, \qquad
S_{j,t} = \sum_{i : \Delta h &lt; 0} |\Delta h_{j,i,t}| \cdot P_{i,t}
\tag{32.3}\]</span></span></p>
<p>The trade gain is:</p>
<p><span id="eq-trade-gain"><span class="math display">\[
G_{j,t} = \sum_{i=1}^{N_{j,t}} \Delta h_{j,i,t} \cdot P_{i,t} \cdot r_{i,t+1}
\tag{32.4}\]</span></span></p>
<div id="buys-sales-computation" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_buys_sales(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute aggregate buys, sales, trade gains per manager-quarter."""</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    _flows <span class="op">=</span> trades.merge(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    _flows[<span class="st">'tbuys'</span>] <span class="op">=</span> (</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        _flows[<span class="st">'trade'</span>] <span class="op">*</span> (_flows[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">float</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span> _flows[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    _flows[<span class="st">'tsales'</span>] <span class="op">=</span> (</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        (<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> _flows[<span class="st">'trade'</span>] <span class="op">*</span> (_flows[<span class="st">'trade'</span>] <span class="op">&lt;</span> <span class="dv">0</span>).astype(<span class="bu">float</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span> _flows[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    _flows[<span class="st">'tgain'</span>] <span class="op">=</span> (</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        _flows[<span class="st">'trade'</span>] <span class="op">*</span> _flows[<span class="st">'p'</span>] <span class="op">*</span> _flows[<span class="st">'qret'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    flows <span class="op">=</span> (</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        _flows</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            tbuys<span class="op">=</span>(<span class="st">'tbuys'</span>, <span class="st">'sum'</span>),</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            tsales<span class="op">=</span>(<span class="st">'tsales'</span>, <span class="st">'sum'</span>),</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            tgain<span class="op">=</span>(<span class="st">'tgain'</span>, <span class="st">'sum'</span>),</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> flows</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-institutionalturnover" class="level1" data-number="33">
<h1 data-number="33"><span class="header-section-number">33</span> Net Flows and Turnover Ratios</h1>
<section id="sec-institutionalnetflows" class="level2" data-number="33.1">
<h2 data-number="33.1" class="anchored" data-anchor-id="sec-institutionalnetflows"><span class="header-section-number">33.1</span> Net Flows</h2>
<p>Net flows separate capital allocation decisions from investment returns:</p>
<p><span id="eq-netflow-def"><span class="math display">\[
\text{NetFlow}_{j,t} = A_{j,t} - A_{j,t-1}(1 + R_{j,t}^p)
\tag{33.1}\]</span></span></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Interpreting Net Flows in Vietnam
</div>
</div>
<div class="callout-body-container callout-body">
<p>For state entities or corporate cross-holders, “net flows” do not necessarily reflect investment decisions. State ownership changes often result from government policy (equitization, divestment programs). Interpretation should account for institutional context.</p>
</div>
</div>
</section>
<section id="sec-institutionalturnover-measures" class="level2" data-number="33.2">
<h2 data-number="33.2" class="anchored" data-anchor-id="sec-institutionalturnover-measures"><span class="header-section-number">33.2</span> Three Turnover Measures</h2>
<div id="turnover-computation" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_aggregates(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    assets: pd.DataFrame,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    flows: pd.DataFrame,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute net flows and three turnover measures.</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Carhart (1997): min(buys, sales) / avg(assets)</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Flow-adjusted: [min(buys, sales) + |net flows|] / lag assets</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Symmetric: [buys + sales - |net flows|] / lag assets</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    report_flags <span class="op">=</span> (</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        holdings</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        .agg(first_report<span class="op">=</span>(<span class="st">'first_report'</span>, <span class="st">'any'</span>),</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>             last_report<span class="op">=</span>(<span class="st">'last_report'</span>, <span class="st">'any'</span>))</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> report_flags.merge(</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        assets, on<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> agg.merge(</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        flows, on<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> agg.sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'assets_comp'</span>] <span class="op">=</span> agg[<span class="st">'assets'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> agg[<span class="st">'pret'</span>].fillna(<span class="dv">0</span>))</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> agg.groupby(<span class="st">'shareholder_name'</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'lassets_comp'</span>] <span class="op">=</span> grp[<span class="st">'assets_comp'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'lassets'</span>] <span class="op">=</span> grp[<span class="st">'assets'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trade gain return</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'tgainret'</span>] <span class="op">=</span> agg[<span class="st">'tgain'</span>] <span class="op">/</span> (agg[<span class="st">'tbuys'</span>] <span class="op">+</span> agg[<span class="st">'tsales'</span>])</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Net flows</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'netflows'</span>] <span class="op">=</span> agg[<span class="st">'assets'</span>] <span class="op">-</span> agg[<span class="st">'lassets_comp'</span>]</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover 1: Carhart (1997)</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'turnover1'</span>] <span class="op">=</span> (</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        agg[[<span class="st">'tbuys'</span>, <span class="st">'tsales'</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        agg[[<span class="st">'assets'</span>, <span class="st">'lassets'</span>]].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover 2: Flow-adjusted</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'turnover2'</span>] <span class="op">=</span> (</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        (agg[[<span class="st">'tbuys'</span>, <span class="st">'tsales'</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>         <span class="op">+</span> agg[<span class="st">'netflows'</span>].<span class="bu">abs</span>().fillna(<span class="dv">0</span>))</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span> agg[<span class="st">'lassets'</span>]</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover 3: Symmetric</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'turnover3'</span>] <span class="op">=</span> (</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        (agg[<span class="st">'tbuys'</span>].fillna(<span class="dv">0</span>) <span class="op">+</span> agg[<span class="st">'tsales'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> agg[<span class="st">'netflows'</span>].<span class="bu">abs</span>().fillna(<span class="dv">0</span>))</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span> agg[<span class="st">'lassets'</span>]</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Missing for first report</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    first_mask <span class="op">=</span> agg[<span class="st">'first_report'</span>]</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'netflows'</span>, <span class="st">'tgainret'</span>,</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>                <span class="st">'turnover1'</span>, <span class="st">'turnover2'</span>, <span class="st">'turnover3'</span>]:</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>        agg.loc[first_mask, col] <span class="op">=</span> np.nan</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> agg.drop(columns<span class="op">=</span>[<span class="st">'assets_comp'</span>, <span class="st">'lassets_comp'</span>, <span class="st">'lassets'</span>])</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Aggregates: </span><span class="sc">{</span><span class="bu">len</span>(agg)<span class="sc">:,}</span><span class="ss"> manager-quarters"</span>)</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Turnover1 mean: </span><span class="sc">{</span>agg[<span class="st">'turnover1'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Turnover2 mean: </span><span class="sc">{</span>agg[<span class="st">'turnover2'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Turnover3 mean: </span><span class="sc">{</span>agg[<span class="st">'turnover3'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> agg</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="sec-institutionalturnover-stats" class="level3" data-number="33.2.1">
<h3 data-number="33.2.1" class="anchored" data-anchor-id="sec-institutionalturnover-stats"><span class="header-section-number">33.2.1</span> Turnover Summary Statistics</h3>
<div id="tbl-turnover-summary" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="17">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-turnover-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;33.1: Summary statistics for three turnover measures across institutional investor types in Vietnam. Turnover 1 follows <span class="citation" data-cites="Carhart1997">Carhart (<a href="references.html#ref-Carhart1997" role="doc-biblioref">1997</a>)</span>, Turnover 2 adds back absolute net flows, and Turnover 3 uses the symmetric definition.
</figcaption>
<div aria-describedby="tbl-turnover-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> turnover_summary_table(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    aggregates: pd.DataFrame,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Publication-quality turnover summary statistics table."""</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    owner_map <span class="op">=</span> (</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        holdings.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'owner_type'</span>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        .first().reset_index()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> aggregates.merge(owner_map, on<span class="op">=</span><span class="st">'shareholder_name'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    turnover_cols <span class="op">=</span> [<span class="st">'turnover1'</span>, <span class="st">'turnover2'</span>, <span class="st">'turnover3'</span>]</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> otype <span class="kw">in</span> [<span class="st">'All'</span>] <span class="op">+</span> OwnershipType.ALL_TYPES:</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> agg <span class="cf">if</span> otype <span class="op">==</span> <span class="st">'All'</span> <span class="cf">else</span> agg[agg[<span class="st">'owner_type'</span>] <span class="op">==</span> otype]</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {<span class="st">'Owner Type'</span>: otype, <span class="st">'N'</span>: <span class="bu">len</span>(subset)}</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> turnover_cols:</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> subset[col].dropna()</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_mean'</span>] <span class="op">=</span> s.mean()</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_median'</span>] <span class="op">=</span> s.median()</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_std'</span>] <span class="op">=</span> s.std()</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        results.append(row)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># turnover_summary_table(aggregates, holdings)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</figure>
</div>
<div id="fig-turnover-timeseries" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-turnover-timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_turnover_timeseries(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    aggregates: pd.DataFrame, holdings: pd.DataFrame</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot turnover time series by ownership type."""</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    owner_map <span class="op">=</span> (</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        holdings.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'owner_type'</span>]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        .first().reset_index()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> aggregates.merge(owner_map, on<span class="op">=</span><span class="st">'shareholder_name'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> otype <span class="kw">in</span> OwnershipType.ALL_INSTITUTIONAL:</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> agg[agg[<span class="st">'owner_type'</span>] <span class="op">==</span> otype]</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        qtr_mean <span class="op">=</span> (</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>            subset</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>            .groupby(pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>))[<span class="st">'turnover1'</span>]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            .mean()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        ax.plot(qtr_mean.index, qtr_mean.values, label<span class="op">=</span>otype,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>OWNER_COLORS.get(otype, <span class="st">'#333'</span>), linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Quarterly Average Turnover (Carhart)'</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>                 fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Turnover Ratio'</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_formatter(mticker.PercentFormatter(<span class="fl">1.0</span>))</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_turnover_timeseries(aggregates, holdings)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-turnover-timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;33.1
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="sec-institutionalforeign" class="level1" data-number="34">
<h1 data-number="34"><span class="header-section-number">34</span> Foreign Ownership Analytics</h1>
<p>Vietnam’s foreign ownership limits create unique analytical dimensions absent from developed market studies.</p>
<section id="sec-institutionalfol-util" class="level2" data-number="34.1">
<h2 data-number="34.1" class="anchored" data-anchor-id="sec-institutionalfol-util"><span class="header-section-number">34.1</span> FOL Utilization</h2>
<p><span id="eq-fol-util"><span class="math display">\[
\text{FOL\_Util}_{i,t} = \frac{FO_{i,t}}{FOL_i}
\tag{34.1}\]</span></span></p>
<p>Stocks with <span class="math inline">\(\text{FOL\_Util}_{i,t} \to 1\)</span> face mechanical foreign buying restrictions.</p>
<div id="fol-analytics" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_fol_analytics(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    foreign_ownership: pd.DataFrame,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    company_profile: pd.DataFrame,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute FOL utilization and related metrics."""</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    fo <span class="op">=</span> foreign_ownership.copy()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    fo <span class="op">=</span> fo.merge(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        company_profile[[<span class="st">'ticker'</span>, <span class="st">'fol_limit'</span>]].drop_duplicates(),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'ticker'</span>, how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'fol_utilization'</span>] <span class="op">=</span> fo[<span class="st">'foreign_pct'</span>] <span class="op">/</span> fo[<span class="st">'fol_limit'</span>]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'foreign_room'</span>] <span class="op">=</span> fo[<span class="st">'fol_limit'</span>] <span class="op">-</span> fo[<span class="st">'foreign_pct'</span>]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'fol_binding'</span>] <span class="op">=</span> (fo[<span class="st">'fol_utilization'</span>] <span class="op">&gt;=</span> <span class="fl">0.98</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'fol_category'</span>] <span class="op">=</span> pd.cut(</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        fo[<span class="st">'fol_utilization'</span>],</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>, <span class="fl">1.0</span>, <span class="bu">float</span>(<span class="st">'inf'</span>)],</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>[<span class="st">'&lt;25%'</span>, <span class="st">'25-50%'</span>, <span class="st">'50-75%'</span>, <span class="st">'75-95%'</span>,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">'95-100%'</span>, <span class="st">'&gt;100%'</span>]</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fo</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalroom-premium" class="level2" data-number="34.2">
<h2 data-number="34.2" class="anchored" data-anchor-id="sec-institutionalroom-premium"><span class="header-section-number">34.2</span> Room Premium Regression</h2>
<p>When foreign ownership approaches the FOL, remaining “room” becomes scarce. We model:</p>
<p><span id="eq-room-premium"><span class="math display">\[
r_{i,t+1} = \alpha + \beta_1 \cdot \text{FOL\_Util}_{i,t} +
\beta_2 \cdot \text{FOL\_Util}_{i,t}^2 + \gamma \cdot X_{i,t} + \varepsilon_{i,t}
\tag{34.2}\]</span></span></p>
<p>The quadratic term captures nonlinear acceleration of the premium as ownership approaches the limit.</p>
<div id="room-premium-regression" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_room_premium(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    fol_analytics: pd.DataFrame,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate foreign ownership room premium via panel regression."""</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    fol_q <span class="op">=</span> (</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        fol_analytics</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        .assign(qdate<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>))</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'qdate'</span>])</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        .agg(fol_utilization<span class="op">=</span>(<span class="st">'fol_utilization'</span>, <span class="st">'last'</span>),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>             foreign_room<span class="op">=</span>(<span class="st">'foreign_room'</span>, <span class="st">'last'</span>))</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> fol_q.merge(</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'mcap'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>], how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'mcap'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'fol_util_sq'</span>] <span class="op">=</span> panel[<span class="st">'fol_utilization'</span>] <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> panel.dropna(subset<span class="op">=</span>[<span class="st">'qret'</span>, <span class="st">'fol_utilization'</span>, <span class="st">'log_mcap'</span>])</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> panel[[<span class="st">'fol_utilization'</span>, <span class="st">'fol_util_sq'</span>, <span class="st">'log_mcap'</span>]]</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> panel[<span class="st">'qret'</span>]</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(y, X).fit(</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        cov_type<span class="op">=</span><span class="st">'cluster'</span>, cov_kwds<span class="op">=</span>{<span class="st">'groups'</span>: panel[<span class="st">'ticker'</span>]}</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'model'</span>: model, <span class="st">'n_obs'</span>: <span class="bu">len</span>(panel)}</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># results = estimate_room_premium(fol_analytics, price_q)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-fol-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="21">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fol-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_fol_utilization(fol_analytics: pd.DataFrame):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot FOL utilization distribution."""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> (</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        fol_analytics.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'ticker'</span>).last().reset_index()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].hist(latest[<span class="st">'fol_utilization'</span>].dropna(), bins<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'#1f77b4'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">0.95</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>                     label<span class="op">=</span><span class="st">'95% threshold'</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: FOL Utilization Distribution'</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                       fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'FOL Utilization Ratio'</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Stocks'</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].legend()</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> exch <span class="kw">in</span> [<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCOM'</span>]:</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        sub <span class="op">=</span> latest[latest.get(<span class="st">'exchange'</span>) <span class="op">==</span> exch]</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sub) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].hist(sub[<span class="st">'fol_utilization'</span>].dropna(), bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>                        alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>exch,</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>EXCHANGE_COLORS.get(exch, <span class="st">'#333'</span>))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: By Exchange'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'FOL Utilization Ratio'</span>)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].legend()</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_fol_utilization(fol_analytics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-fol-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;34.1
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-institutionalpipeline" class="level1" data-number="35">
<h1 data-number="35"><span class="header-section-number">35</span> Complete Pipeline</h1>
<p>We integrate all steps into a single end-to-end function:</p>
<div id="complete-pipeline" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_complete_pipeline(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    dc: <span class="st">'DataCoreReader'</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    begdate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    enddate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2024-12-31'</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, pd.DataFrame]:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Execute the complete institutional ownership analytics pipeline.</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Steps:</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Build corporate action adjustment factors</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Process stock prices</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Construct holdings panel (Steps 2-4)</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Compute IO metrics</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Compute institutional trades (Step 5)</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co">    6. Compute portfolio assets and returns (Step 6a)</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">    7. Compute aggregate buys, sales, trade gains (Step 6b)</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co">    8. Compute net flows and turnover (Step 7)</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co">    9. Compute foreign ownership analytics</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns dict of all output DataFrames.</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"INSTITUTIONAL TRADES, FLOWS, AND TURNOVER PIPELINE"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sample: </span><span class="sc">{</span>begdate<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>enddate<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/9] Building adjustment factors..."</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    adj_factors <span class="op">=</span> build_adjustment_factors(dc.corporate_actions)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/9] Processing stock prices..."</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    price_q, qret <span class="op">=</span> process_prices(</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        dc.prices, adj_factors, begdate, enddate</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/9] Building holdings panel..."</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    holdings <span class="op">=</span> build_holdings_panel(</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        dc.ownership, adj_factors, price_q,</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        dc.company_profile, begdate, enddate</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[4/9] Computing ownership metrics..."</span>)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    io_ratios <span class="op">=</span> compute_io_ratios(holdings, price_q)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    hhi <span class="op">=</span> compute_hhi(holdings)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    breadth <span class="op">=</span> compute_breadth(holdings)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[5/9] Computing institutional trades..."</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> compute_trades(holdings, adj_factors)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[6/9] Computing portfolio assets..."</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> compute_assets_and_returns(holdings, price_q)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[7/9] Computing aggregate buys and sales..."</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    flows <span class="op">=</span> compute_buys_sales(trades, price_q)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[8/9] Computing net flows and turnover..."</span>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    aggregates <span class="op">=</span> compute_aggregates(holdings, assets, flows)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[9/9] Computing foreign ownership analytics..."</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    fol_analytics <span class="op">=</span> compute_fol_analytics(</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        dc.foreign_ownership, dc.company_profile</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"PIPELINE COMPLETE"</span>)</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">'price_q'</span>: price_q, <span class="st">'holdings'</span>: holdings,</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">'io_ratios'</span>: io_ratios, <span class="st">'hhi'</span>: hhi,</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'breadth'</span>: breadth, <span class="st">'trades'</span>: trades,</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'assets'</span>: assets, <span class="st">'flows'</span>: flows,</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aggregates'</span>: aggregates, <span class="st">'fol_analytics'</span>: fol_analytics,</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a><span class="co"># dc = DataCoreReader('/path/to/datacore_data', file_format='parquet')</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="co"># results = run_complete_pipeline(dc, '2010-01-01', '2024-12-31')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalextensions" class="level1" data-number="36">
<h1 data-number="36"><span class="header-section-number">36</span> Advanced Extensions</h1>
<section id="sec-institutionalherding" class="level2" data-number="36.1">
<h2 data-number="36.1" class="anchored" data-anchor-id="sec-institutionalherding"><span class="header-section-number">36.1</span> Herding Measures</h2>
<p>Following <span class="citation" data-cites="sias2004institutional">Sias (<a href="references.html#ref-sias2004institutional" role="doc-biblioref">2004</a>)</span>, the Lakonishok-Shleifer-Vishny herding measure is:</p>
<p><span id="eq-herding"><span class="math display">\[
HM_{i,t} = \left|\frac{B_{i,t}}{B_{i,t} + S_{i,t}} - p_t\right|
- E\left[\left|\frac{B_{i,t}}{B_{i,t} + S_{i,t}} - p_t\right|\right]
\tag{36.1}\]</span></span></p>
<p>where <span class="math inline">\(B_{i,t}\)</span> is the number of managers buying stock <span class="math inline">\(i\)</span> in quarter <span class="math inline">\(t\)</span>, <span class="math inline">\(S_{i,t}\)</span> the number selling, and <span class="math inline">\(p_t\)</span> the expected buyer proportion under independent trading.</p>
<div id="herding-measure" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_lsv_herding(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    min_traders: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute LSV herding measure for each stock-quarter."""</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    tc <span class="op">=</span> (</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        trades.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> g: pd.Series({</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_buyers'</span>: (g[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>(),</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_sellers'</span>: (g[<span class="st">'trade'</span>] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>(),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_traders'</span>: <span class="bu">len</span>(g),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    tc <span class="op">=</span> tc[tc[<span class="st">'n_traders'</span>] <span class="op">&gt;=</span> min_traders].copy()</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'buy_prop'</span>] <span class="op">=</span> tc[<span class="st">'n_buyers'</span>] <span class="op">/</span> tc[<span class="st">'n_traders'</span>]</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'p_t'</span>] <span class="op">=</span> tc.groupby(<span class="st">'rdate'</span>)[<span class="st">'buy_prop'</span>].transform(<span class="st">'mean'</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'raw_hm'</span>] <span class="op">=</span> (tc[<span class="st">'buy_prop'</span>] <span class="op">-</span> tc[<span class="st">'p_t'</span>]).<span class="bu">abs</span>()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> expected_abs_deviation(row):</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">int</span>(row[<span class="st">'n_traders'</span>])</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> row[<span class="st">'p_t'</span>]</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> p <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> p <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> scipy.stats <span class="im">import</span> binom</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> np.arange(<span class="dv">0</span>, n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> binom.pmf(k, n, p)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(k <span class="op">/</span> n <span class="op">-</span> p) <span class="op">*</span> probs)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'expected_hm'</span>] <span class="op">=</span> tc.<span class="bu">apply</span>(expected_abs_deviation, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'herding'</span>] <span class="op">=</span> tc[<span class="st">'raw_hm'</span>] <span class="op">-</span> tc[<span class="st">'expected_hm'</span>]</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'buy_herding'</span>] <span class="op">=</span> np.where(</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        tc[<span class="st">'buy_prop'</span>] <span class="op">&gt;</span> tc[<span class="st">'p_t'</span>], tc[<span class="st">'herding'</span>], np.nan</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'sell_herding'</span>] <span class="op">=</span> np.where(</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        tc[<span class="st">'buy_prop'</span>] <span class="op">&lt;</span> tc[<span class="st">'p_t'</span>], tc[<span class="st">'herding'</span>], np.nan</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tc[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'n_buyers'</span>, <span class="st">'n_sellers'</span>,</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>               <span class="st">'n_traders'</span>, <span class="st">'herding'</span>, <span class="st">'buy_herding'</span>, <span class="st">'sell_herding'</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalpersistence" class="level2" data-number="36.2">
<h2 data-number="36.2" class="anchored" data-anchor-id="sec-institutionalpersistence"><span class="header-section-number">36.2</span> Demand Persistence</h2>
<p><span class="citation" data-cites="sias2004institutional">Sias (<a href="references.html#ref-sias2004institutional" role="doc-biblioref">2004</a>)</span> showed institutional demand is persistent:</p>
<p><span id="eq-persistence"><span class="math display">\[
\rho_t = \text{Corr}\left(\Delta IO_{i,t},\, \Delta IO_{i,t-1}\right)
\tag{36.2}\]</span></span></p>
<div id="demand-persistence" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_demand_persistence(io_ratios: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Rolling cross-sectional correlation of IO changes."""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    io <span class="op">=</span> io_ratios[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'io_total_inst'</span>]].copy()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    io <span class="op">=</span> io.sort_values([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    io[<span class="st">'dio'</span>] <span class="op">=</span> io.groupby(<span class="st">'ticker'</span>)[<span class="st">'io_total_inst'</span>].diff()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    io[<span class="st">'lag_dio'</span>] <span class="op">=</span> io.groupby(<span class="st">'ticker'</span>)[<span class="st">'dio'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    persistence <span class="op">=</span> (</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        io.dropna(subset<span class="op">=</span>[<span class="st">'dio'</span>, <span class="st">'lag_dio'</span>])</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'rdate'</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> g: g[<span class="st">'dio'</span>].corr(g[<span class="st">'lag_dio'</span>]))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">'persistence'</span>})</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    persistence <span class="op">=</span> persistence.sort_values(<span class="st">'rdate'</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    persistence[<span class="st">'persistence_ma'</span>] <span class="op">=</span> (</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        persistence[<span class="st">'persistence'</span>].rolling(window<span class="op">=</span><span class="dv">20</span>, min_periods<span class="op">=</span><span class="dv">4</span>).mean()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> persistence</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-persistence" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="25">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-persistence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_demand_persistence(persistence: pd.DataFrame):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    ax.bar(persistence[<span class="st">'rdate'</span>], persistence[<span class="st">'persistence'</span>],</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>           width<span class="op">=</span><span class="dv">80</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>, label<span class="op">=</span><span class="st">'Quarterly'</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    ax.plot(persistence[<span class="st">'rdate'</span>], persistence[<span class="st">'persistence_ma'</span>],</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#d62728'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Rolling Average'</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Persistence of Institutional Demand'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Cross-Sectional Correlation'</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-persistence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;36.1
</figcaption>
</figure>
</div>
</section>
<section id="sec-institutionalinfo-content" class="level2" data-number="36.3">
<h2 data-number="36.3" class="anchored" data-anchor-id="sec-institutionalinfo-content"><span class="header-section-number">36.3</span> Information Content of Trades</h2>
<p>Following <span class="citation" data-cites="alexander2007does">Alexander, Cici, and Gibson (<a href="references.html#ref-alexander2007does" role="doc-biblioref">2007</a>)</span>, the InfoTrade ratio measures the proportion of dollar trading from entry/exit decisions vs.&nbsp;position adjustments:</p>
<p><span id="eq-info-trade"><span class="math display">\[
\text{InfoTrade}_{i,t} = \frac{
\sum_{j: BS \in \{+1,-1\}} |\Delta h_{j,i,t}| \cdot P_{i,t}
}{
\sum_j |\Delta h_{j,i,t}| \cdot P_{i,t}
}
\tag{36.3}\]</span></span></p>
<div id="info-trade-ratio" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_info_trade_ratio(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame, price_q: pd.DataFrame</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute info trade ratio for each stock-quarter."""</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'dollar_trade'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>].<span class="bu">abs</span>() <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'is_discrete'</span>] <span class="op">=</span> _t[<span class="st">'buysale'</span>].isin([<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    info <span class="op">=</span> _t.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>]).<span class="bu">apply</span>(</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> g: pd.Series({</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'discrete_vol'</span>: g.loc[g[<span class="st">'is_discrete'</span>], <span class="st">'dollar_trade'</span>].<span class="bu">sum</span>(),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_vol'</span>: g[<span class="st">'dollar_trade'</span>].<span class="bu">sum</span>(),</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    info[<span class="st">'info_trade_ratio'</span>] <span class="op">=</span> (</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        info[<span class="st">'discrete_vol'</span>] <span class="op">/</span> info[<span class="st">'total_vol'</span>]</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    ).clip(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> info</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-institutionalapplications" class="level1" data-number="37">
<h1 data-number="37"><span class="header-section-number">37</span> Empirical Applications</h1>
<section id="sec-institutionalapp-returns" class="level2" data-number="37.1">
<h2 data-number="37.1" class="anchored" data-anchor-id="sec-institutionalapp-returns"><span class="header-section-number">37.1</span> Application 1: Institutional Ownership Changes and Future Returns</h2>
<p>We test whether changes in institutional ownership predict future stock returns <span class="citation" data-cites="chen2000value">(<a href="references.html#ref-chen2000value" role="doc-biblioref">Chen, Jegadeesh, and Wermers 2000</a>)</span> via Fama-MacBeth regressions:</p>
<p><span id="eq-fama-macbeth"><span class="math display">\[
r_{i,t+1} = \alpha_t + \beta_{1,t} \cdot \Delta IO_{i,t} + \beta_{2,t} \cdot
\Delta\text{Breadth}_{i,t} + \gamma_t \cdot X_{i,t} + \varepsilon_{i,t}
\tag{37.1}\]</span></span></p>
<div id="fama-macbeth" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_io_returns(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    io_ratios: pd.DataFrame,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    breadth: pd.DataFrame,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run Fama-MacBeth regressions of future returns on IO changes."""</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> io_ratios[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'io_total_inst'</span>]].merge(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        breadth[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'n_total_inst'</span>, <span class="st">'d_n_total_inst'</span>]],</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    ).merge(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'mcap'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> panel.sort_values([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'dio'</span>] <span class="op">=</span> panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'io_total_inst'</span>].diff()</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'mcap'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'mom'</span>] <span class="op">=</span> panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'qret'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    reg_vars <span class="op">=</span> [<span class="st">'qret'</span>, <span class="st">'dio'</span>, <span class="st">'d_n_total_inst'</span>, <span class="st">'log_mcap'</span>, <span class="st">'mom'</span>]</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> panel.dropna(subset<span class="op">=</span>reg_vars)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    quarters <span class="op">=</span> <span class="bu">sorted</span>(panel[<span class="st">'rdate'</span>].unique())</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> quarters:</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        qdata <span class="op">=</span> panel[panel[<span class="st">'rdate'</span>] <span class="op">==</span> q]</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(qdata) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>            qdata[[<span class="st">'dio'</span>, <span class="st">'d_n_total_inst'</span>, <span class="st">'log_mcap'</span>, <span class="st">'mom'</span>]]</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(qdata[<span class="st">'qret'</span>], X).fit()</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>            coefs <span class="op">=</span> model.params.to_dict()</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>            coefs[<span class="st">'rdate'</span>] <span class="op">=</span> q</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>            coefs[<span class="st">'n_obs'</span>] <span class="op">=</span> <span class="bu">len</span>(qdata)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>            results.append(coefs)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    fm <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series averages with Newey-West t-statistics</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Fama-MacBeth Results:"</span>)</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">'const'</span>, <span class="st">'dio'</span>, <span class="st">'d_n_total_inst'</span>, <span class="st">'log_mcap'</span>, <span class="st">'mom'</span>]:</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>        coefs <span class="op">=</span> fm[var].dropna()</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>        mean_c <span class="op">=</span> coefs.mean()</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>        nw_se <span class="op">=</span> sm.OLS(</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>            coefs <span class="op">-</span> mean_c, np.ones(<span class="bu">len</span>(coefs))</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>        ).fit(cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">4</span>}).bse[<span class="dv">0</span>]</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> mean_c <span class="op">/</span> nw_se <span class="cf">if</span> nw_se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">:20s}</span><span class="ss">: coef=</span><span class="sc">{</span>mean_c<span class="sc">:8.4f}</span><span class="ss">, t=</span><span class="sc">{</span>t<span class="sc">:6.2f}</span><span class="ss">"</span>)</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fm</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalapp-turnover" class="level2" data-number="37.2">
<h2 data-number="37.2" class="anchored" data-anchor-id="sec-institutionalapp-turnover"><span class="header-section-number">37.2</span> Application 2: Turnover and Performance</h2>
<p><span class="citation" data-cites="yan2008liquidity">Yan (<a href="references.html#ref-yan2008liquidity" role="doc-biblioref">2008</a>)</span> documented a positive turnover-performance relationship. We test in Vietnam:</p>
<p><span id="eq-turnover-perf"><span class="math display">\[
\alpha_{j,t} = a + b \cdot \text{Turnover}_{j,t-1} + c \cdot
\log(A_{j,t-1}) + d \cdot \text{Flow}_{j,t} + \varepsilon_{j,t}
\tag{37.2}\]</span></span></p>
<div id="turnover-performance" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> turnover_performance_regression(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    aggregates: pd.DataFrame,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test turnover-performance relationship."""</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> aggregates.sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>]).copy()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'lag_turnover1'</span>] <span class="op">=</span> (</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        agg.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'turnover1'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(agg[<span class="st">'assets'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'flow_ratio'</span>] <span class="op">=</span> agg[<span class="st">'netflows'</span>] <span class="op">/</span> agg[<span class="st">'assets'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> agg.dropna(</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">'pret'</span>, <span class="st">'lag_turnover1'</span>, <span class="st">'log_assets'</span>, <span class="st">'flow_ratio'</span>]</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'pret'</span>, <span class="st">'lag_turnover1'</span>, <span class="st">'flow_ratio'</span>]:</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        lo, hi <span class="op">=</span> panel[col].quantile([<span class="fl">0.01</span>, <span class="fl">0.99</span>])</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        panel[col] <span class="op">=</span> panel[col].clip(lo, hi)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        panel[[<span class="st">'lag_turnover1'</span>, <span class="st">'log_assets'</span>, <span class="st">'flow_ratio'</span>]]</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(panel[<span class="st">'pret'</span>], X).fit(</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        cov_type<span class="op">=</span><span class="st">'cluster'</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        cov_kwds<span class="op">=</span>{<span class="st">'groups'</span>: panel[<span class="st">'shareholder_name'</span>]}</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'model'</span>: model, <span class="st">'n'</span>: <span class="bu">len</span>(panel)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-institutionalapp-foreign-domestic" class="level2" data-number="37.3">
<h2 data-number="37.3" class="anchored" data-anchor-id="sec-institutionalapp-foreign-domestic"><span class="header-section-number">37.3</span> Application 3: Foreign vs.&nbsp;Domestic Trading</h2>
<div id="foreign-domestic-comparison" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_foreign_domestic(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame, price_q: pd.DataFrame,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compare trading patterns between foreign and domestic institutions."""</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'dollar_trade'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'is_buy'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        _t[_t[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)]</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'owner_type'</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>            n_trades<span class="op">=</span>(<span class="st">'trade'</span>, <span class="st">'count'</span>),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>            n_buys<span class="op">=</span>(<span class="st">'is_buy'</span>, <span class="st">'sum'</span>),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>            avg_dollar<span class="op">=</span>(<span class="st">'dollar_trade'</span>, <span class="kw">lambda</span> x: x.<span class="bu">abs</span>().mean()),</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>            net_buying<span class="op">=</span>(<span class="st">'dollar_trade'</span>, <span class="st">'sum'</span>),</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>            pct_initiating<span class="op">=</span>(<span class="st">'buysale'</span>, <span class="kw">lambda</span> x: (x.<span class="bu">abs</span>() <span class="op">==</span> <span class="dv">1</span>).mean()),</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-cumulative-net-buying" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="30">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumulative-net-buying-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_cumulative_net_buying(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame, price_q: pd.DataFrame</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'trade_vnd'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> _t[_t[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    net <span class="op">=</span> (</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        inst.groupby(</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>            [pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>), <span class="st">'owner_type'</span>]</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        )[<span class="st">'trade_vnd'</span>].<span class="bu">sum</span>().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> net.cumsum()</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> cum.columns:</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        ax.plot(cum.index, cum[col], label<span class="op">=</span>col,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>OWNER_COLORS.get(col, <span class="st">'#333'</span>), linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Cumulative Net Institutional Buying'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Billions VND'</span>)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-cumulative-net-buying-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;37.1
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-institutionalrobustness" class="level1" data-number="38">
<h1 data-number="38"><span class="header-section-number">38</span> Data Quality and Robustness</h1>
<section id="sec-institutionalpitfalls" class="level2" data-number="38.1">
<h2 data-number="38.1" class="anchored" data-anchor-id="sec-institutionalpitfalls"><span class="header-section-number">38.1</span> Common Pitfalls</h2>
<section id="corporate-action-misadjustment" class="level3" data-number="38.1.1">
<h3 data-number="38.1.1" class="anchored" data-anchor-id="corporate-action-misadjustment"><span class="header-section-number">38.1.1</span> Corporate Action Misadjustment</h3>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Example: Phantom Trade from Unadjusted Stock Dividend
</div>
</div>
<div class="callout-body-container callout-body">
<p>Vinamilk (VNM) issues a 20% stock dividend with ex-date March 15, 2023.</p>
<ul>
<li>Q4 2022: Fund X holds 1,000,000 shares of VNM</li>
<li>Q1 2023: Fund X holds 1,200,000 shares of VNM</li>
</ul>
<p><strong>Without adjustment:</strong> Inferred buy of +200,000 shares (BS = +2) <strong>With adjustment:</strong> Prior holdings become 1,200,000 adjusted shares, trade = 0</p>
<p>This phantom trade inflates measured turnover and creates spurious buying signals.</p>
</div>
</div>
</section>
<section id="disclosure-timing-mismatches" class="level3" data-number="38.1.2">
<h3 data-number="38.1.2" class="anchored" data-anchor-id="disclosure-timing-mismatches"><span class="header-section-number">38.1.2</span> Disclosure Timing Mismatches</h3>
<p>Vietnamese ownership disclosure dates may not align with calendar quarter ends. Our pipeline addresses this by aligning all disclosures to the nearest quarter-end.</p>
</section>
<section id="name-changes-and-entity-mergers" class="level3" data-number="38.1.3">
<h3 data-number="38.1.3" class="anchored" data-anchor-id="name-changes-and-entity-mergers"><span class="header-section-number">38.1.3</span> Name Changes and Entity Mergers</h3>
<p>Vietnamese institutions frequently rename. Without a stable identifier, the same entity may appear as two different shareholders, creating phantom entries/exits. We recommend maintaining a master entity mapping table.</p>
</section>
</section>
<section id="sec-institutionalvalidation" class="level2" data-number="38.2">
<h2 data-number="38.2" class="anchored" data-anchor-id="sec-institutionalvalidation"><span class="header-section-number">38.2</span> Validation Checks</h2>
<div id="validation" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_pipeline_outputs(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    results: Dict[<span class="bu">str</span>, pd.DataFrame],</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run comprehensive validation on pipeline outputs."""</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    checks <span class="op">=</span> []</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> results[<span class="st">'holdings'</span>]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> results[<span class="st">'trades'</span>]</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> results[<span class="st">'aggregates'</span>]</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'No negative adjusted shares'</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> (h[<span class="st">'shares_adj'</span>] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Detail'</span>: <span class="ss">f'</span><span class="sc">{</span>(h[<span class="st">"shares_adj"</span>] <span class="op">&lt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> negative obs'</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'No duplicate holdings'</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> h.duplicated(</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>            subset<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'Valid buysale codes only'</span>,</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> t[<span class="st">'buysale'</span>].isin([<span class="dv">1</span>, <span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">2</span>]).<span class="bu">all</span>()</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'No zero trades'</span>,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> (t[<span class="st">'trade'</span>] <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> a[<span class="st">'turnover1'</span>].dropna()</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'Turnover1 in [0, 10]'</span>,</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> ((t1 <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">|</span> (t1 <span class="op">&gt;</span> <span class="dv">10</span>)).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="st">'WARNING'</span>,</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Detail'</span>: <span class="ss">f'</span><span class="sc">{</span>((t1<span class="op">&lt;</span><span class="dv">0</span>)<span class="op">|</span>(t1<span class="op">&gt;</span><span class="dv">10</span>))<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> extreme values'</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    first_rpt <span class="op">=</span> a[a[<span class="st">'first_report'</span>]]</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'First report -&gt; missing netflows'</span>,</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> first_rpt[<span class="st">'netflows'</span>].isna().<span class="bu">all</span>()</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(checks)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="co"># validate_pipeline_outputs(results)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-institutionalsummary" class="level1" data-number="39">
<h1 data-number="39"><span class="header-section-number">39</span> Summary</h1>
<p>This chapter developed a framework for computing institutional trades, flows, and turnover ratios in the Vietnamese equity market. The key contributions include:</p>
<ol type="1">
<li><p><strong>Corporate action adjustment</strong> for Vietnam’s frequent stock dividends and bonus shares, preventing phantom trades that contaminate standard differencing.</p></li>
<li><p><strong>Four-way ownership taxonomy</strong> (state, foreign institutional, domestic institutional, individual) capturing Vietnam’s unique ownership landscape.</p></li>
<li><p><strong>FOL utilization analytics</strong> for studying foreign ownership constraints absent from developed markets.</p></li>
<li><p><strong>Irregular disclosure handling</strong> with correct gap splitting into terminating sales and initiating buys.</p></li>
<li><p><strong>Advanced extensions</strong> including herding, demand persistence, and information content decomposition.</p></li>
</ol>
<p>The pipeline produces several output datasets (<a href="#tbl-institutional-outputs" class="quarto-xref">Table&nbsp;<span>39.1</span></a>)</p>
<div id="tbl-institutional-outputs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-institutional-outputs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;39.1: Summary of Pipeline Output Datasets
</figcaption>
<div aria-describedby="tbl-institutional-outputs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Output</th>
<th style="text-align: left;">Grain</th>
<th style="text-align: left;">Key Variables</th>
<th style="text-align: left;">Use Cases</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>holdings</code></td>
<td style="text-align: left;">Shareholder x Ticker x Quarter</td>
<td style="text-align: left;"><code>shares_adj</code>, <code>owner_type</code></td>
<td style="text-align: left;">Cross-sectional ownership</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>io_ratios</code></td>
<td style="text-align: left;">Ticker x Quarter</td>
<td style="text-align: left;"><code>io_state</code>, <code>io_foreign</code>, etc.</td>
<td style="text-align: left;">Governance, liquidity</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>trades</code></td>
<td style="text-align: left;">Shareholder x Ticker x Quarter</td>
<td style="text-align: left;"><code>trade</code>, <code>buysale</code></td>
<td style="text-align: left;">Informed trading, herding</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>aggregates</code></td>
<td style="text-align: left;">Shareholder x Quarter</td>
<td style="text-align: left;"><code>assets</code>, <code>turnover</code>, <code>netflows</code></td>
<td style="text-align: left;">Fund performance, flows</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>fol_analytics</code></td>
<td style="text-align: left;">Ticker x Date</td>
<td style="text-align: left;"><code>fol_utilization</code>, <code>foreign_room</code></td>
<td style="text-align: left;">FOL premium, foreign investment</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<!-- # Exercises {#sec-institutionalexercises}

1.  **Corporate Action Sensitivity.** Download corporate action data for VNM from DataCore.vn and compute the cumulative share adjustment factor from 2010 to 2024. How many phantom trades would be generated without adjustment? Plot the factor.

2.  **FOL Binding and Returns.** Construct a long-short portfolio: long FOL-binding stocks ($\text{FOL\_Util} > 0.95$), short non-binding ($< 0.50$). What is the average quarterly return spread? Is it statistically significant?

3.  **Herding Asymmetry.** Compute LSV herding separately for large-cap (HOSE top 50) and small-cap stocks. Is herding stronger in small caps? Compare buy vs. sell herding.

4.  **State Divestment Events.** Identify quarters where SCIC conducted major divestments. What happens to breadth and foreign ownership post-divestment?

5.  **Turnover Quintile Portfolios.** Sort investors by lagged Carhart turnover into quintiles. Compare returns: is the turnover-performance relation positive (information) or negative (costs) in Vietnam?

6.  **Replication Exercise.** Replicate @chen2000value: do breadth changes predict future returns in the Vietnamese market? -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-aggarwal2011does" class="csl-entry" role="listitem">
Aggarwal, Reena, Isil Erel, Miguel Ferreira, and Pedro Matos. 2011. <span>“Does Governance Travel Around the World? Evidence from Institutional Investors.”</span> <em>Journal of Financial Economics</em> 100 (1): 154–81.
</div>
<div id="ref-alexander2007does" class="csl-entry" role="listitem">
Alexander, Gordon J, Gjergji Cici, and Scott Gibson. 2007. <span>“Does Motivation Matter When Assessing Trade Performance? An Analysis of Mutual Funds.”</span> <em>The Review of Financial Studies</em> 20 (1): 125–50.
</div>
<div id="ref-Carhart1997" class="csl-entry" role="listitem">
Carhart, Mark M. 1997. <span>“<span class="nocase">On persistence in mutual fund performance</span>.”</span> <em><span>The Journal of Finance</span></em> 52 (1): 57–82. <a href="https://doi.org/10.1111/j.1540-6261.1997.tb03808.x">https://doi.org/10.1111/j.1540-6261.1997.tb03808.x</a>.
</div>
<div id="ref-chen2000value" class="csl-entry" role="listitem">
Chen, Hsiu-Lang, Narasimhan Jegadeesh, and Russ Wermers. 2000. <span>“The Value of Active Mutual Fund Management: An Examination of the Stockholdings and Trades of Fund Managers.”</span> <em>Journal of Financial and Quantitative Analysis</em> 35 (3): 343–68.
</div>
<div id="ref-coval2007asset" class="csl-entry" role="listitem">
Coval, Joshua, and Erik Stafford. 2007. <span>“Asset Fire Sales (and Purchases) in Equity Markets.”</span> <em>Journal of Financial Economics</em> 86 (2): 479–512.
</div>
<div id="ref-gompers2003corporate" class="csl-entry" role="listitem">
Gompers, Paul, Joy Ishii, and Andrew Metrick. 2003. <span>“Corporate Governance and Equity Prices.”</span> <em>The Quarterly Journal of Economics</em> 118 (1): 107–56.
</div>
<div id="ref-grinblatt1995momentum" class="csl-entry" role="listitem">
Grinblatt, Mark, Sheridan Titman, and Russ Wermers. 1995. <span>“Momentum Investment Strategies, Portfolio Performance, and Herding: A Study of Mutual Fund Behavior.”</span> <em>American Economic Review</em> 85 (5): 1088–1105.
</div>
<div id="ref-pastor2003liquidity" class="csl-entry" role="listitem">
Pástor, L’uboš, and Robert F Stambaugh. 2003. <span>“Liquidity Risk and Expected Stock Returns.”</span> <em>Journal of Political Economy</em> 111 (3): 642–85.
</div>
<div id="ref-phung2016ownership" class="csl-entry" role="listitem">
Phung, Duc Nam, and Anil V Mishra. 2016. <span>“Ownership Structure and Firm Performance: Evidence from Vietnamese Listed Firms.”</span> <em>Australian Economic Papers</em> 55 (1): 63–98.
</div>
<div id="ref-sias2004institutional" class="csl-entry" role="listitem">
Sias, Richard W. 2004. <span>“Institutional Herding.”</span> <em>The Review of Financial Studies</em> 17 (1): 165–206.
</div>
<div id="ref-sirri1998costly" class="csl-entry" role="listitem">
Sirri, Erik R, and Peter Tufano. 1998. <span>“Costly Search and Mutual Fund Flows.”</span> <em>The Journal of Finance</em> 53 (5): 1589–1622.
</div>
<div id="ref-vo2015foreign" class="csl-entry" role="listitem">
Vo, Xuan Vinh. 2015. <span>“Foreign Ownership and Stock Return Volatility–Evidence from Vietnam.”</span> <em>Journal of Multinational Financial Management</em> 30: 101–9.
</div>
<div id="ref-wermers2000mutual" class="csl-entry" role="listitem">
Wermers, Russ. 2000. <span>“Mutual Fund Performance: An Empirical Decomposition into Stock-Picking Talent, Style, Transactions Costs, and Expenses.”</span> <em>The Journal of Finance</em> 55 (4): 1655–95.
</div>
<div id="ref-yan2008liquidity" class="csl-entry" role="listitem">
Yan, Xuemin Sterling. 2008. <span>“Liquidity, Investment Style, and the Relation Between Fund Size and Fund Performance.”</span> <em>Journal of Financial and Quantitative Analysis</em> 43 (3): 741–67.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./50_institutional_ownership.html" class="pagination-link" aria-label="Institutional Ownership Analytics in Vietnam">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./53_governance.html" class="pagination-link" aria-label="Corporate Governance">
        <span class="nav-page-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Institutional Trades, Flows, and Turnover Ratios</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> pdist, squareform</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Union, Dict, List, Tuple</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting configuration — academic style (Times New Roman)</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.family'</span>: <span class="st">'serif'</span>,</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.serif'</span>: [<span class="st">'Times New Roman'</span>, <span class="st">'DejaVu Serif'</span>],</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.titlesize'</span>: <span class="dv">13</span>,</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.labelsize'</span>: <span class="dv">11</span>,</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'xtick.labelsize'</span>: <span class="dv">10</span>,</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ytick.labelsize'</span>: <span class="dv">10</span>,</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'legend.fontsize'</span>: <span class="dv">10</span>,</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.titlesize'</span>: <span class="dv">14</span>,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span>,</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.grid'</span>: <span class="va">True</span>,</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grid.alpha'</span>: <span class="fl">0.3</span>,</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grid.linestyle'</span>: <span class="st">'--'</span>,</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>OWNER_COLORS <span class="op">=</span> {</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'State'</span>: <span class="st">'#d62728'</span>,</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Foreign Institutional'</span>: <span class="st">'#1f77b4'</span>,</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Domestic Institutional'</span>: <span class="st">'#2ca02c'</span>,</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Individual'</span>: <span class="st">'#ff7f0e'</span>,</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Treasury'</span>: <span class="st">'#9467bd'</span>,</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Total Institutional'</span>: <span class="st">'#333333'</span>,</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>EXCHANGE_COLORS <span class="op">=</span> {<span class="st">'HOSE'</span>: <span class="st">'#1f77b4'</span>, <span class="st">'HNX'</span>: <span class="st">'#ff7f0e'</span>, <span class="st">'UPCOM'</span>: <span class="st">'#2ca02c'</span>}</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="dv">20</span>)</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">120</span>)</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.4f}</span><span class="st">'</span>.<span class="bu">format</span>)</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>Institutional investors play a pivotal role in price discovery, corporate governance, and market liquidity. Understanding *how* institutions trade and *how much* they trade provides insights into both asset pricing dynamics and the real effects of institutional monitoring. The seminal work of @grinblatt1995momentum on mutual fund momentum trading, @wermers2000mutual on fund performance decomposition, and @yan2008liquidity on the relationship between turnover and future returns all rely on accurately measured institutional trades, flows, and turnover.</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>In the United States, this research is enabled by the mandatory quarterly 13F filing system administered by the Securities and Exchange Commission (SEC). Every institutional investment manager with at least \$100 million in qualifying assets must disclose their equity holdings within 45 days of each calendar quarter end. The Thomson-Reuters (now Refinitiv) 13F database, accessible through WRDS, provides the canonical data infrastructure for this literature.</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>Vietnam's equity market presents a fundamentally different institutional landscape. This chapter adapts the core methodology for the Vietnamese context, addressing five critical differences:</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Disclosure regime.** Vietnam has no 13F-equivalent mandatory quarterly filing. Ownership disclosure is a patchwork of event-driven reports (threshold crossings at 5%, 10%, etc.), annual/semi-annual reports with shareholder registers, and daily foreign ownership tracking by exchanges.</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Corporate actions.** Vietnamese firms issue stock dividends and bonus shares at extremely high rates compared to US firms. A firm might issue 20-30% bonus shares in a single year, fundamentally altering the share count. Share adjustment is therefore critical and nontrivial.</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Foreign ownership limits (FOLs).** Binding foreign ownership ceiling, typically 49% for most sectors, 30% for banking, and 0% for certain restricted sectors, create a unique institutional constraint. When a stock approaches its FOL, foreign buying becomes mechanically restricted, distorting standard trade inference.</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**State ownership.** The Vietnamese government retains significant ownership in many listed firms through the State Capital Investment Corporation (SCIC) and other state entities. This creates a distinct ownership category not present in the US 13F data.</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Market microstructure.** Daily price limits ($\pm 7\%$ on HOSE, $\pm 10\%$ on HNX, $\pm 15\%$ on UPCOM), T+2 settlement, and the absence of short-selling all affect how institutional trades translate into market outcomes.</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## Measuring Institutional Ownership and Trading</span></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>The measurement of institutional ownership and trading activity has been a central concern in empirical finance since @gompers2003corporate documented the rise of institutional investors. The approach relies on comparing holdings snapshots across consecutive reporting periods to infer trades. If manager $j$ holds $h_{j,i,t}$ shares of stock $i$ at time $t$, then the inferred trade is:</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>\Delta h_{j,i,t} = h_{j,i,t} - h_{j,i,t-1}</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>$$ {#eq-trade-simple}</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>where $\Delta h_{j,i,t} &gt; 0$ indicates a buy and $\Delta h_{j,i,t} &lt; 0$ indicates a sale. This simple differencing approach requires that holdings are observed at regular intervals (e.g., quarterly), share counts are adjusted for corporate actions between reporting dates, and entry and exit from the dataset are handled appropriately.</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>@chen2000value introduced the concept of ownership *breadth* (i.e., the number of institutions holding a stock) and showed that changes in breadth predict future returns. @sias2004institutional decomposed institutional demand into a herding component and an information component. @yan2008liquidity linked fund turnover to information-based trading and documented that high-turnover funds outperform, challenging the view that turnover reflects noise trading.</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## Trade Classification</span></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>@tbl-trade-types shows four categories of trades:</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Code <span class="pp">|</span> Type             <span class="pp">|</span> Description                            <span class="pp">|</span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="pp">|:-----|:-----------------|:---------------------------------------|</span></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $+1$ <span class="pp">|</span> Initiating Buy   <span class="pp">|</span> Manager enters a new position          <span class="pp">|</span></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $+2$ <span class="pp">|</span> Incremental Buy  <span class="pp">|</span> Manager increases an existing position <span class="pp">|</span></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $-1$ <span class="pp">|</span> Terminating Sale <span class="pp">|</span> Manager completely exits a position    <span class="pp">|</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $-2$ <span class="pp">|</span> Regular Sale     <span class="pp">|</span> Manager reduces an existing position   <span class="pp">|</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>: Trade Classification Taxonomy {#tbl-trade-types}</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>This classification is informative because initiating buys and terminating sales represent discrete portfolio decisions with different information content from marginal position adjustments <span class="co">[</span><span class="ot">@alexander2007does</span><span class="co">]</span>.</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a><span class="fu">## Turnover Measures</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>Three standard turnover definitions have been used in the literature:</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>**Carhart (1997) Turnover.** The minimum of aggregate buys and sales, normalized by average assets:</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>\text{Turnover}^{C}_{j,t} = \frac{\min\left(\sum_i B_{j,i,t},\, \sum_i S_{j,i,t}\right)}</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>{\frac{1}{2}\left(A_{j,t} + A_{j,t-1}\right)}</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>$$ {#eq-turnover-carhart}</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>where $B_{j,i,t}$ and $S_{j,i,t}$ are the dollar values of buys and sales of stock $i$ by manager $j$ in quarter $t$, and $A_{j,t}$ is total portfolio assets <span class="co">[</span><span class="ot">@Carhart1997</span><span class="co">]</span>.</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>**Flow-Adjusted Turnover.** Adds back the absolute value of net flows to account for flow-driven trading:</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>\text{Turnover}^{F}_{j,t} = \frac{\min\left(\sum_i B_{j,i,t},\, \sum_i S_{j,i,t}\right) + |\text{NetFlow}_{j,t}|}</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>{A_{j,t-1}}</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>$$ {#eq-turnover-flow}</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>**Symmetric Turnover.** Uses the sum of buys and sales minus the absolute net flow:</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>\text{Turnover}^{S}_{j,t} = \frac{\sum_i B_{j,i,t} + \sum_i S_{j,i,t} - |\text{NetFlow}_{j,t}|}</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>{A_{j,t-1}}</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>$$ {#eq-turnover-symmetric}</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>The relationship between these measures depends on the correlation between discretionary trading and flow-induced trading <span class="co">[</span><span class="ot">@pastor2003liquidity</span><span class="co">]</span>.</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="fu">## Institutional Ownership in Emerging Markets</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>The emerging markets literature has documented several stylized facts about institutional ownership that differ from developed market findings. @aggarwal2011does documented that foreign institutional ownership improves corporate governance in emerging markets. For Vietnam specifically, @phung2016ownership examined the relationship between ownership structure and firm performance, while @vo2015foreign studied the impact of foreign ownership on stock market liquidity.</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a><span class="fu">## Net Flows and Performance Attribution</span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a>Net flows measure the dollar amount of new money entering or leaving a fund:</span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>\text{NetFlow}_{j,t} = A_{j,t} - A_{j,t-1}(1 + R_{j,t}^p)</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>$$ {#eq-netflow}</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>where $R_{j,t}^p$ is the portfolio return. This decomposition, due to @sirri1998costly, separates changes in fund assets into investment returns and investor capital allocation decisions. @coval2007asset showed that flow-driven trades create price pressure, with fire sales by funds experiencing redemptions generating significant negative abnormal returns.</span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Infrastructure {#sec-institutionaldata}</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>@tbl-datacore-datasets summarizes the datasets used in this chapter.</span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Dataset <span class="pp">|</span> Content <span class="pp">|</span> Frequency <span class="pp">|</span> Key Variables <span class="pp">|</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a><span class="pp">|:-----------------|:-----------------|:-----------------|:------------------|</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Stock Prices <span class="pp">|</span> Daily/monthly OHLCV <span class="pp">|</span> Daily <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`close`</span>, <span class="in">`adjusted_close`</span>, <span class="in">`volume`</span>, <span class="in">`shares_outstanding`</span> <span class="pp">|</span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Ownership Structure <span class="pp">|</span> Shareholder composition <span class="pp">|</span> Quarterly/Annual <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`shareholder_name`</span>, <span class="in">`shares_held`</span>, <span class="in">`pct`</span>, <span class="in">`type`</span> <span class="pp">|</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Major Shareholders <span class="pp">|</span> Holders $\geq$ 5% <span class="pp">|</span> Event-driven <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`shareholder_name`</span>, <span class="in">`shares`</span>, <span class="in">`is_foreign`</span>, <span class="in">`is_state`</span> <span class="pp">|</span></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Corporate Actions <span class="pp">|</span> Splits, dividends, bonus <span class="pp">|</span> Event <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`ex_date`</span>, <span class="in">`action_type`</span>, <span class="in">`ratio`</span> <span class="pp">|</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Company Profile <span class="pp">|</span> Sector, exchange, FOL <span class="pp">|</span> Static/Annual <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`exchange`</span>, <span class="in">`industry`</span>, <span class="in">`listing_date`</span>, <span class="in">`fol_limit`</span> <span class="pp">|</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Foreign Ownership <span class="pp">|</span> Daily foreign tracking <span class="pp">|</span> Daily <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`foreign_shares`</span>, <span class="in">`foreign_pct`</span>, <span class="in">`fol_limit`</span> <span class="pp">|</span></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Fund Holdings <span class="pp">|</span> Fund portfolio snapshots <span class="pp">|</span> Semi-annual <span class="pp">|</span> <span class="in">`fund_name`</span>, <span class="in">`report_date`</span>, <span class="in">`ticker`</span>, <span class="in">`shares_held`</span>, <span class="in">`market_value`</span> <span class="pp">|</span></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>: DataCore.vn Datasets Used in This Chapter {#tbl-datacore-datasets}</span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Reader Class {#sec-institutionalreader}</span></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>We begin by defining a unified data reader that handles file loading, date parsing, and basic validation:</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: datacore-reader</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "DataCoreReader: Unified Data Access Layer"</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataCoreReader:</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a><span class="co">    Unified reader for DataCore.vn datasets stored locally.</span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports Parquet (recommended) and CSV formats. Implements</span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a><span class="co">    lazy loading with caching to minimize memory footprint.</span></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="co">    data_dir : str or Path</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a><span class="co">        Directory containing DataCore.vn data files.</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="co">    file_format : str</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a><span class="co">        File format: 'parquet' or 'csv'.</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; dc = DataCoreReader('/data/datacore', file_format='parquet')</span></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; prices = dc.prices</span></span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; ownership = dc.ownership</span></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>    data_dir: Path</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>    file_format: <span class="bu">str</span> <span class="op">=</span> <span class="st">'parquet'</span></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>    _cache: Dict[<span class="bu">str</span>, pd.DataFrame] <span class="op">=</span> field(</span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>        default_factory<span class="op">=</span><span class="bu">dict</span>, <span class="bu">repr</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>    FILE_MAP: Dict[<span class="bu">str</span>, <span class="bu">str</span>] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="kw">lambda</span>: {</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>        <span class="st">'prices'</span>: <span class="st">'stock_prices'</span>,</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ownership'</span>: <span class="st">'ownership_structure'</span>,</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>        <span class="st">'major_shareholders'</span>: <span class="st">'major_shareholders'</span>,</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>        <span class="st">'corporate_actions'</span>: <span class="st">'corporate_actions'</span>,</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>        <span class="st">'company_profile'</span>: <span class="st">'company_profile'</span>,</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>        <span class="st">'financials'</span>: <span class="st">'financial_statements'</span>,</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>        <span class="st">'foreign_ownership'</span>: <span class="st">'foreign_ownership'</span>,</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_holdings'</span>: <span class="st">'fund_holdings'</span>,</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>    }, <span class="bu">repr</span><span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __post_init__(<span class="va">self</span>):</span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_dir <span class="op">=</span> Path(<span class="va">self</span>.data_dir)</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.data_dir.exists():</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Data directory not found: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _read(<span class="va">self</span>, key: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read and cache a dataset with automatic date parsing."""</span></span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> <span class="va">self</span>._cache:</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._cache[key]</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> <span class="va">self</span>.FILE_MAP.get(key, key)</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>        filepath <span class="op">=</span> <span class="va">self</span>.data_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>file_format<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> filepath.exists():</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Dataset not found: </span><span class="sc">{</span>filepath<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Available: "</span></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span><span class="bu">list</span>(<span class="va">self</span>.data_dir.glob(<span class="ss">f'*.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>file_format<span class="sc">}</span><span class="ss">'</span>))<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.file_format <span class="op">==</span> <span class="st">'parquet'</span>:</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_parquet(filepath)</span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_csv(filepath, parse_dates<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Auto-detect and parse date columns</span></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>        date_cols <span class="op">=</span> [</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>            <span class="st">'date'</span>, <span class="st">'ex_date'</span>, <span class="st">'record_date'</span>, <span class="st">'period'</span>,</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>            <span class="st">'report_date'</span>, <span class="st">'listing_date'</span></span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col.lower() <span class="kw">in</span> date_cols <span class="kw">or</span> <span class="st">'date'</span> <span class="kw">in</span> col.lower():</span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a>                    df[col] <span class="op">=</span> pd.to_datetime(df[col])</span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache[key] <span class="op">=</span> df</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Loaded </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows x </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> cols"</span>)</span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prices(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'prices'</span>)</span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'ownership'</span>)</span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> major_shareholders(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'major_shareholders'</span>)</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> corporate_actions(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'corporate_actions'</span>)</span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> company_profile(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'company_profile'</span>)</span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> foreign_ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'foreign_ownership'</span>)</span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fund_holdings(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'fund_holdings'</span>)</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clear_cache(<span class="va">self</span>):</span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(<span class="va">self</span>._cache)</span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache.clear()</span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Cleared </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> cached datasets"</span>)</span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize:</span></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a><span class="co"># dc = DataCoreReader('/path/to/datacore_data', file_format='parquet')</span></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a><span class="fu"># Stock Price and Return Processing {#sec-institutionalcrsp}</span></span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>The first step processes stock data to obtain adjusted prices, shares outstanding, and quarterly returns.</span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a><span class="fu">## Price Data Extraction and Adjustment {#sec-institutionalprice-adj}</span></span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>Vietnamese stock data requires careful adjustment for frequent corporate actions. Unlike the US where CRSP provides a cumulative adjustment factor (<span class="in">`cfacpr`</span>, <span class="in">`cfacshr`</span>), in Vietnam we must construct adjustment factors from the corporate actions history.</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vietnamese Corporate Actions</span></span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a>Vietnamese firms commonly execute the following corporate actions, each requiring share count and/or price adjustment:</span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Stock dividend** (*co tuc bang co phieu*): e.g., 20% stock dividend means 100 shares become 120 shares</span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Bonus shares** (*co phieu thuong*): free shares distributed from retained earnings</span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Rights issue** (*phat hanh quyen mua*): right to buy new shares at a discount</span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Stock split/reverse split** (*chia/gop co phieu*): rare but occasionally used</span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: corporate-action-adjustment</span></span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Corporate Action Adjustment Factor Construction"</span></span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_adjustment_factors(</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>    corporate_actions: pd.DataFrame,</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct cumulative share adjustment factors from corporate actions.</span></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the Vietnamese equivalent of CRSP's cfacshr factor. For each</span></span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a><span class="co">    ticker, we compute a cumulative product of adjustment ratios from</span></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate actions, working forward in time.</span></span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a><span class="co">    The adjustment factor at date t converts historical share counts to</span></span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a><span class="co">    be comparable with current (post-action) share counts:</span></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a><span class="co">        shares_adjusted_t = shares_raw_t * cfacshr_t</span></span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate_actions : pd.DataFrame</span></span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate actions with columns: ticker, ex_date, action_type,</span></span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a><span class="co">        ratio. The ratio field represents:</span></span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a><span class="co">        - Stock dividend 20%: ratio = 1.20</span></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a><span class="co">        - 2:1 stock split: ratio = 2.00</span></span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a><span class="co">        - Bonus shares 10%: ratio = 1.10</span></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjustment factors: ticker, ex_date, cfacshr (cumulative).</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>    share_actions <span class="op">=</span> corporate_actions[</span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a>        corporate_actions[<span class="st">'action_type'</span>].isin([</span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a>            <span class="st">'stock_dividend'</span>, <span class="st">'bonus_shares'</span>, <span class="st">'stock_split'</span>,</span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reverse_split'</span>, <span class="st">'rights_issue'</span></span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> share_actions.empty:</span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'cfacshr'</span>])</span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a>    share_actions <span class="op">=</span> share_actions.sort_values([<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>])</span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>    share_actions[<span class="st">'cfacshr'</span>] <span class="op">=</span> (</span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>        share_actions</span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'ticker'</span>)[<span class="st">'ratio'</span>]</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>        .cumprod()</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> share_actions[[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'cfacshr'</span>]].reset_index(</span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>        drop<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cfacshr_at_date(</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>    ticker: <span class="bu">str</span>,</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a>    date: pd.Timestamp,</span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a><span class="co">    Look up the cumulative share adjustment factor for a given</span></span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a><span class="co">    ticker and date. Returns 1.0 if no corporate actions occurred.</span></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (</span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span></span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ex_date'</span>] <span class="op">&lt;=</span> date)</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> adj_factors.loc[mask]</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> subset.empty:</span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> subset.iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'cfacshr'</span>]</span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_shares_between_dates(</span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a>    shares: <span class="bu">float</span>,</span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a>    ticker: <span class="bu">str</span>,</span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a>    date_from: pd.Timestamp,</span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>    date_to: pd.Timestamp,</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a><span class="co">    Adjust a share count observed at date_from to be comparable</span></span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a><span class="co">    with shares observed at date_to, accounting for all intervening</span></span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate actions.</span></span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="co">    Example</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # Investor held 1000 shares on 2023-01-01</span></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; # A 20% stock dividend occurred on 2023-03-15</span></span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; adjust_shares_between_dates(</span></span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     1000, 'VNM',</span></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     pd.Timestamp('2023-01-01'),</span></span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     pd.Timestamp('2023-06-30'), adj_factors</span></span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a><span class="co">    ... )</span></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a><span class="co">    1200.0</span></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>    factor_from <span class="op">=</span> get_cfacshr_at_date(ticker, date_from, adj_factors)</span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a>    factor_to <span class="op">=</span> get_cfacshr_at_date(ticker, date_to, adj_factors)</span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>    relative_factor <span class="op">=</span> factor_to <span class="op">/</span> factor_from</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shares <span class="op">*</span> relative_factor</span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a><span class="fu">## Monthly and Quarterly Price Processing {#sec-institutionalprice-processing}</span></span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: price-processing</span></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Step 1: Price Data Processing"</span></span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_prices(</span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a>    prices: pd.DataFrame,</span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a>    begdate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a>    enddate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2024-12-31'</span>,</span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[pd.DataFrame, pd.DataFrame]:</span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a><span class="co">    Process raw DataCore.vn price data into analysis-ready format.</span></span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a><span class="co">    Block logic:</span></span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Filter to date range</span></span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Compute adjusted prices and shares outstanding</span></span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Compute quarterly compounded returns</span></span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Create forward quarterly returns (shifted one quarter)</span></span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a><span class="co">    prices : pd.DataFrame</span></span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a><span class="co">        Raw price data with: ticker, date, close, adjusted_close,</span></span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a><span class="co">        volume, shares_outstanding.</span></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors.</span></span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a><span class="co">    begdate, enddate : str</span></span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a><span class="co">        Sample period boundaries.</span></span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a><span class="co">    Tuple[pd.DataFrame, pd.DataFrame]</span></span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a><span class="co">        (price_quarterly, qret): quarter-end observations with</span></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a><span class="co">        adjusted price, total shares, and forward quarterly return.</span></span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> prices[</span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a>        (prices[<span class="st">'date'</span>] <span class="op">&gt;=</span> begdate) <span class="op">&amp;</span> (prices[<span class="st">'date'</span>] <span class="op">&lt;=</span> enddate)</span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Month-end and quarter-end dates</span></span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'mdate'</span>] <span class="op">=</span> price[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'qdate'</span>] <span class="op">=</span> price[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusted price</span></span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'adjusted_close'</span> <span class="kw">in</span> price.columns:</span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>        price[<span class="st">'p'</span>] <span class="op">=</span> price[<span class="st">'adjusted_close'</span>]</span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>        price[<span class="st">'p'</span>] <span class="op">=</span> price[<span class="st">'close'</span>]</span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total shares outstanding</span></span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'tso'</span>] <span class="op">=</span> price[<span class="st">'shares_outstanding'</span>]</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market capitalization (millions VND)</span></span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'mcap'</span>] <span class="op">=</span> price[<span class="st">'p'</span>] <span class="op">*</span> price[<span class="st">'tso'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out zero shares</span></span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> price[price[<span class="st">'tso'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns if not present</span></span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'ret'</span> <span class="kw">not</span> <span class="kw">in</span> price.columns:</span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> price.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>        price[<span class="st">'ret'</span>] <span class="op">=</span> price.groupby(<span class="st">'ticker'</span>)[<span class="st">'p'</span>].pct_change()</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'ret'</span>] <span class="op">=</span> price[<span class="st">'ret'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>    price[<span class="st">'logret'</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> price[<span class="st">'ret'</span>])</span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Quarterly compounded returns ----</span></span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a>    qret <span class="op">=</span> (</span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a>        price</span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'qdate'</span>])[<span class="st">'logret'</span>]</span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>()</span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a>    qret[<span class="st">'qret'</span>] <span class="op">=</span> np.exp(qret[<span class="st">'logret'</span>]) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shift qdate back one quarter: make qret a *forward* return</span></span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a>    qret[<span class="st">'qdate'</span>] <span class="op">=</span> qret[<span class="st">'qdate'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a>    qret <span class="op">=</span> qret.drop(columns<span class="op">=</span>[<span class="st">'logret'</span>])</span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Quarter-end observations ----</span></span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a>    price_q <span class="op">=</span> price[price[<span class="st">'qdate'</span>] <span class="op">==</span> price[<span class="st">'mdate'</span>]].copy()</span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a>    price_q <span class="op">=</span> price_q[[<span class="st">'qdate'</span>, <span class="st">'ticker'</span>, <span class="st">'p'</span>, <span class="st">'tso'</span>, <span class="st">'mcap'</span>]].copy()</span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge forward quarterly return</span></span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a>    price_q <span class="op">=</span> price_q.merge(qret, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build cfacshr lookup at each quarter-end</span></span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a>    price_q[<span class="st">'cfacshr'</span>] <span class="op">=</span> price_q.<span class="bu">apply</span>(</span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> row: get_cfacshr_at_date(</span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'ticker'</span>], row[<span class="st">'qdate'</span>], adj_factors</span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price_q, qret</span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a><span class="fu">## Performance Optimization</span></span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a>The <span class="in">`get_cfacshr_at_date`</span> function uses a row-wise lookup which can be slow for large datasets. For production use with millions of rows, vectorize using <span class="in">`pd.merge_asof()`</span>:</span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a><span class="in">``` python</span></span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a>price_q <span class="op">=</span> pd.merge_asof(</span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a>    price_q.sort_values(<span class="st">'qdate'</span>),</span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>    adj_factors.sort_values(<span class="st">'ex_date'</span>),</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'qdate'</span>,</span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'ex_date'</span>,</span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'backward'</span></span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>).fillna({<span class="st">'cfacshr'</span>: <span class="fl">1.0</span>})</span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>The output is a quarterly panel of stock-level observations (\@tbl-institutional-price-vars)</span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Variable  <span class="pp">|</span> Description                          <span class="pp">|</span></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a><span class="pp">|:----------|:-------------------------------------|</span></span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`ticker`</span>  <span class="pp">|</span> Stock ticker (e.g., VNM, VCB, FPT)   <span class="pp">|</span></span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`qdate`</span>   <span class="pp">|</span> Quarter-end date                     <span class="pp">|</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`p`</span>       <span class="pp">|</span> Adjusted closing price (VND)         <span class="pp">|</span></span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`tso`</span>     <span class="pp">|</span> Total shares outstanding             <span class="pp">|</span></span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`mcap`</span>    <span class="pp">|</span> Market capitalization (millions VND) <span class="pp">|</span></span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`qret`</span>    <span class="pp">|</span> Forward quarterly compounded return  <span class="pp">|</span></span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`cfacshr`</span> <span class="pp">|</span> Cumulative share adjustment factor   <span class="pp">|</span></span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a>: Quarter-End Price Panel Variables {#tbl-institutional-price-vars}</span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a><span class="fu"># Ownership Data Processing {#sec-institutionalownership}</span></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ownership Taxonomy {#sec-institutionaltaxonomy}</span></span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a>We define a classification system for Vietnamese shareholders that maps to the categories available in DataCore.vn:</span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ownership-taxonomy</span></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Vietnamese Ownership Type Classification"</span></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OwnershipType:</span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese ownership type classification.</span></span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam's ownership structure is fundamentally different from the US:</span></span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a><span class="co">    - **State** (Nha nuoc): SCIC, ministries, state-owned parents</span></span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Foreign Institutional** (To chuc nuoc ngoai): foreign funds,</span></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a><span class="co">      ETFs, pension funds, insurance, sovereign wealth funds</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Domestic Institutional** (To chuc trong nuoc): Vietnamese</span></span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a><span class="co">      securities companies, fund managers, banks, insurance</span></span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Individual** (Ca nhan): retail investors (domestic + foreign)</span></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a><span class="co">    - **Treasury** (Co phieu quy): company repurchases</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a>    STATE <span class="op">=</span> <span class="st">'State'</span></span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a>    FOREIGN_INST <span class="op">=</span> <span class="st">'Foreign Institutional'</span></span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a>    DOMESTIC_INST <span class="op">=</span> <span class="st">'Domestic Institutional'</span></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a>    INDIVIDUAL <span class="op">=</span> <span class="st">'Individual'</span></span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a>    TREASURY <span class="op">=</span> <span class="st">'Treasury'</span></span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a>    INSTITUTIONAL <span class="op">=</span> [FOREIGN_INST, DOMESTIC_INST]</span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a>    ALL_INSTITUTIONAL <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST]</span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a>    ALL_TYPES <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST, INDIVIDUAL, TREASURY]</span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a>    STATE_KEYWORDS <span class="op">=</span> [</span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scic'</span>, <span class="st">'state capital'</span>, <span class="st">'bo'</span>, <span class="st">'ubnd'</span>, <span class="st">'tong cong ty'</span>,</span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nha nuoc'</span>, <span class="st">'state'</span>, <span class="st">'government'</span>, <span class="st">"people's committee"</span>,</span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ministry'</span>, <span class="st">'vietnam national'</span>, <span class="st">'vnpt'</span>, <span class="st">'evn'</span>, <span class="st">'pvn'</span>,</span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a>    FOREIGN_KEYWORDS <span class="op">=</span> [</span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund'</span>, <span class="st">'investment'</span>, <span class="st">'capital'</span>, <span class="st">'asset management'</span>,</span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a>        <span class="st">'securities'</span>, <span class="st">'gic'</span>, <span class="st">'templeton'</span>, <span class="st">'dragon capital'</span>,</span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a>        <span class="st">'vinacapital'</span>, <span class="st">'mekong capital'</span>, <span class="st">'kb securities'</span>,</span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mirae asset'</span>, <span class="st">'samsung'</span>, <span class="st">'jp morgan'</span>, <span class="st">'goldman'</span>,</span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>        <span class="st">'blackrock'</span>, <span class="st">'vanguard'</span>, <span class="st">'aberdeen'</span>, <span class="st">'hsbc'</span>,</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> classify(cls, row: pd.Series) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Classify based on explicit flags, then keyword fallback."""</span></span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_state'</span>)) <span class="kw">and</span> row[<span class="st">'is_state'</span>]:</span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.STATE</span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_foreign'</span>)) <span class="kw">and</span> row[<span class="st">'is_foreign'</span>]:</span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_institution'</span>)) <span class="kw">and</span> row[<span class="st">'is_institution'</span>]:</span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> cls.FOREIGN_INST</span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.INDIVIDUAL</span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row.get(<span class="st">'is_institution'</span>)) <span class="kw">and</span> row[<span class="st">'is_institution'</span>]:</span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.DOMESTIC_INST</span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> <span class="bu">str</span>(row.get(<span class="st">'shareholder_name'</span>, <span class="st">''</span>)).lower()</span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(kw <span class="kw">in</span> name <span class="cf">for</span> kw <span class="kw">in</span> cls.STATE_KEYWORDS):</span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.STATE</span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(kw <span class="kw">in</span> name <span class="cf">for</span> kw <span class="kw">in</span> cls.FOREIGN_KEYWORDS):</span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cls.FOREIGN_INST</span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls.INDIVIDUAL</span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a><span class="fu">## Building the Holdings Panel {#sec-institutionalholdings-panel}</span></span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a>We construct the holdings panel (i.e., the Vietnamese equivalent of merging the 13F Type 1 and Type 3 datasets). The key steps are:</span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Identify the first available vintage for each shareholder-stock-report date combination.</span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Compute reporting gaps to flag first and last reports.</span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Classify shareholders.</span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Adjust shares for corporate actions.</span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: holdings-panel</span></span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Steps 2--4: Holdings Panel Construction"</span></span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_holdings_panel(</span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a>    ownership: pd.DataFrame,</span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a>    company_profile: pd.DataFrame,</span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a>    begdate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a>    enddate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2024-12-31'</span>,</span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct the institutional holdings panel from DataCore.vn</span></span>
<span id="cb31-650"><a href="#cb31-650" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership data.</span></span>
<span id="cb31-651"><a href="#cb31-651" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a>    own <span class="op">=</span> ownership.copy()</span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align to quarter-end</span></span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a>    own[<span class="st">'rdate'</span>] <span class="op">=</span> own[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a>    own[<span class="st">'fdate'</span>] <span class="op">=</span> own[<span class="st">'date'</span>]</span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a>    own <span class="op">=</span> own[</span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a>        (own[<span class="st">'rdate'</span>] <span class="op">&gt;=</span> begdate) <span class="op">&amp;</span> (own[<span class="st">'rdate'</span>] <span class="op">&lt;=</span> enddate)</span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep earliest vintage per shareholder-ticker-rdate</span></span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a>    own <span class="op">=</span> own.sort_values(</span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'fdate'</span>]</span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> (</span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a>        own</span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a>        .first()</span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-673"><a href="#cb31-673" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Reporting gaps for first/last flags ----</span></span>
<span id="cb31-674"><a href="#cb31-674" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.sort_values(</span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> fst_vint.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])</span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'lag_rdate'</span>] <span class="op">=</span> grp[<span class="st">'rdate'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'qtr_gap'</span>] <span class="op">=</span> fst_vint.<span class="bu">apply</span>(</span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (</span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a>            (r[<span class="st">'rdate'</span>].to_period(<span class="st">'Q'</span>)</span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a>             <span class="op">-</span> r[<span class="st">'lag_rdate'</span>].to_period(<span class="st">'Q'</span>)).n</span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(r[<span class="st">'lag_rdate'</span>]) <span class="cf">else</span> np.nan</span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb31-688"><a href="#cb31-688" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-689"><a href="#cb31-689" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'first_report'</span>] <span class="op">=</span> (</span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a>        fst_vint[<span class="st">'qtr_gap'</span>].isna() <span class="op">|</span> (fst_vint[<span class="st">'qtr_gap'</span>] <span class="op">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Last report flag (forward gap)</span></span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.sort_values(</span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a>        ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">True</span>, <span class="va">False</span>]</span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'lead_rdate'</span>] <span class="op">=</span> grp[<span class="st">'rdate'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'lead_gap'</span>] <span class="op">=</span> fst_vint.<span class="bu">apply</span>(</span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (</span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a>            (r[<span class="st">'lead_rdate'</span>].to_period(<span class="st">'Q'</span>)</span>
<span id="cb31-704"><a href="#cb31-704" aria-hidden="true" tabindex="-1"></a>             <span class="op">-</span> r[<span class="st">'rdate'</span>].to_period(<span class="st">'Q'</span>)).n</span>
<span id="cb31-705"><a href="#cb31-705" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(r[<span class="st">'lead_rdate'</span>]) <span class="cf">else</span> np.nan</span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'last_report'</span>] <span class="op">=</span> (</span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a>        fst_vint[<span class="st">'lead_gap'</span>].isna() <span class="op">|</span> (fst_vint[<span class="st">'lead_gap'</span>] <span class="op">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb31-712"><a href="#cb31-712" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-713"><a href="#cb31-713" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.drop(</span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">'lag_rdate'</span>, <span class="st">'qtr_gap'</span>, <span class="st">'lead_rdate'</span>, <span class="st">'lead_gap'</span>],</span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">=</span><span class="st">'ignore'</span></span>
<span id="cb31-717"><a href="#cb31-717" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-718"><a href="#cb31-718" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Classify shareholders ----</span></span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'owner_type'</span>] <span class="op">=</span> fst_vint.<span class="bu">apply</span>(</span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a>        OwnershipType.classify, axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Adjust shares for corporate actions ----</span></span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.merge(</span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'cfacshr'</span>]],</span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-730"><a href="#cb31-730" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-731"><a href="#cb31-731" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a>    fst_vint[<span class="st">'shares_adj'</span>] <span class="op">=</span> (</span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a>        fst_vint[<span class="st">'shares_held'</span>] <span class="op">*</span> fst_vint[<span class="st">'cfacshr'</span>]</span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint[fst_vint[<span class="st">'shares_adj'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a>    fst_vint <span class="op">=</span> fst_vint.drop_duplicates(</span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge company profile</span></span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> company_profile <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb31-743"><a href="#cb31-743" aria-hidden="true" tabindex="-1"></a>        fst_vint <span class="op">=</span> fst_vint.merge(</span>
<span id="cb31-744"><a href="#cb31-744" aria-hidden="true" tabindex="-1"></a>            company_profile[[<span class="st">'ticker'</span>, <span class="st">'exchange'</span>, <span class="st">'fol_limit'</span>]]</span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a>            .drop_duplicates(),</span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> [</span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'fdate'</span>,</span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shares_held'</span>, <span class="st">'shares_adj'</span>, <span class="st">'owner_type'</span>,</span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a>        <span class="st">'first_report'</span>, <span class="st">'last_report'</span></span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'exchange'</span> <span class="kw">in</span> fst_vint.columns:</span>
<span id="cb31-756"><a href="#cb31-756" aria-hidden="true" tabindex="-1"></a>        cols.extend([<span class="st">'exchange'</span>, <span class="st">'fol_limit'</span>])</span>
<span id="cb31-757"><a href="#cb31-757" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a>    holdings <span class="op">=</span> fst_vint[cols].copy()</span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Holdings panel: </span><span class="sc">{</span><span class="bu">len</span>(holdings)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Shareholders: </span><span class="sc">{</span>holdings[<span class="st">'shareholder_name'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stocks: </span><span class="sc">{</span>holdings[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Quarters: </span><span class="sc">{</span>holdings[<span class="st">'rdate'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> holdings</span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a><span class="fu"># Institutional Ownership Metrics {#sec-institutionalio-metrics}</span></span>
<span id="cb31-769"><a href="#cb31-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-770"><a href="#cb31-770" aria-hidden="true" tabindex="-1"></a>Before computing trades, we establish the standard institutional ownership metrics that serve as both outputs and inputs to the trading analysis.</span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a><span class="fu">## Institutional Ownership Ratio {#sec-institutionalio-ratio}</span></span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a>The institutional ownership ratio (IO) for stock $i$ at time $t$ is:</span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a>IO_{i,t} = \frac{\sum_{j \in \mathcal{J}} h_{j,i,t}}{TSO_{i,t}}</span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a>$$ {#eq-io-ratio}</span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a>where $\mathcal{J}$ is the set of institutional investors and $TSO_{i,t}$ is total shares outstanding. In Vietnam, we compute separate ratios for each ownership type:</span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a>IO_{i,t}^{\text{type}} = \frac{\sum_{j \in \mathcal{J}^{\text{type}}} h_{j,i,t}}{TSO_{i,t}},</span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a>\quad \text{type} \in <span class="sc">\{</span>\text{State}, \text{Foreign}, \text{Domestic}, \text{Individual}<span class="sc">\}</span></span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a>$$ {#eq-io-by-type}</span>
<span id="cb31-786"><a href="#cb31-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-789"><a href="#cb31-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-790"><a href="#cb31-790" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: io-ratio-computation</span></span>
<span id="cb31-791"><a href="#cb31-791" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Institutional Ownership Ratio Computation"</span></span>
<span id="cb31-792"><a href="#cb31-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-793"><a href="#cb31-793" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_io_ratios(</span>
<span id="cb31-794"><a href="#cb31-794" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb31-795"><a href="#cb31-795" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb31-796"><a href="#cb31-796" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-797"><a href="#cb31-797" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute IO ratios by type for each stock-quarter."""</span></span>
<span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> (</span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a>        holdings</span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'owner_type'</span>])[<span class="st">'shares_adj'</span>]</span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>()</span>
<span id="cb31-802"><a href="#cb31-802" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-803"><a href="#cb31-803" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-804"><a href="#cb31-804" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-805"><a href="#cb31-805" aria-hidden="true" tabindex="-1"></a>    io_wide <span class="op">=</span> agg.pivot_table(</span>
<span id="cb31-806"><a href="#cb31-806" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-807"><a href="#cb31-807" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'owner_type'</span>,</span>
<span id="cb31-808"><a href="#cb31-808" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">'shares_adj'</span>,</span>
<span id="cb31-809"><a href="#cb31-809" aria-hidden="true" tabindex="-1"></a>        fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb31-810"><a href="#cb31-810" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb31-811"><a href="#cb31-811" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-812"><a href="#cb31-812" aria-hidden="true" tabindex="-1"></a>    io_wide.columns <span class="op">=</span> [</span>
<span id="cb31-813"><a href="#cb31-813" aria-hidden="true" tabindex="-1"></a>        c <span class="cf">if</span> c <span class="kw">in</span> [<span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb31-814"><a href="#cb31-814" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="ss">f'shares_</span><span class="sc">{</span>c<span class="sc">.</span>lower()<span class="sc">.</span>replace(<span class="st">" "</span>, <span class="st">"_"</span>)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb31-815"><a href="#cb31-815" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> io_wide.columns</span>
<span id="cb31-816"><a href="#cb31-816" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-817"><a href="#cb31-817" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-818"><a href="#cb31-818" aria-hidden="true" tabindex="-1"></a>    io_wide <span class="op">=</span> io_wide.merge(</span>
<span id="cb31-819"><a href="#cb31-819" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'tso'</span>]],</span>
<span id="cb31-820"><a href="#cb31-820" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-821"><a href="#cb31-821" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-822"><a href="#cb31-822" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-823"><a href="#cb31-823" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-824"><a href="#cb31-824" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-825"><a href="#cb31-825" aria-hidden="true" tabindex="-1"></a>    share_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> io_wide.columns <span class="cf">if</span> c.startswith(<span class="st">'shares_'</span>)]</span>
<span id="cb31-826"><a href="#cb31-826" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> share_cols:</span>
<span id="cb31-827"><a href="#cb31-827" aria-hidden="true" tabindex="-1"></a>        ratio_name <span class="op">=</span> col.replace(<span class="st">'shares_'</span>, <span class="st">'io_'</span>)</span>
<span id="cb31-828"><a href="#cb31-828" aria-hidden="true" tabindex="-1"></a>        io_wide[ratio_name] <span class="op">=</span> io_wide[col] <span class="op">/</span> io_wide[<span class="st">'tso'</span>]</span>
<span id="cb31-829"><a href="#cb31-829" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-830"><a href="#cb31-830" aria-hidden="true" tabindex="-1"></a>    inst_cols <span class="op">=</span> [</span>
<span id="cb31-831"><a href="#cb31-831" aria-hidden="true" tabindex="-1"></a>        c <span class="cf">for</span> c <span class="kw">in</span> io_wide.columns</span>
<span id="cb31-832"><a href="#cb31-832" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> c.startswith(<span class="st">'shares_'</span>)</span>
<span id="cb31-833"><a href="#cb31-833" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> <span class="st">'individual'</span> <span class="kw">not</span> <span class="kw">in</span> c</span>
<span id="cb31-834"><a href="#cb31-834" aria-hidden="true" tabindex="-1"></a>        <span class="kw">and</span> <span class="st">'treasury'</span> <span class="kw">not</span> <span class="kw">in</span> c</span>
<span id="cb31-835"><a href="#cb31-835" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-836"><a href="#cb31-836" aria-hidden="true" tabindex="-1"></a>    io_wide[<span class="st">'io_total_inst'</span>] <span class="op">=</span> (</span>
<span id="cb31-837"><a href="#cb31-837" aria-hidden="true" tabindex="-1"></a>        io_wide[inst_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> io_wide[<span class="st">'tso'</span>]</span>
<span id="cb31-838"><a href="#cb31-838" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-839"><a href="#cb31-839" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-840"><a href="#cb31-840" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> io_wide</span>
<span id="cb31-841"><a href="#cb31-841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-842"><a href="#cb31-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-843"><a href="#cb31-843" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ownership Concentration: Herfindahl-Hirschman Index {#sec-institutionalhhi}</span></span>
<span id="cb31-844"><a href="#cb31-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-845"><a href="#cb31-845" aria-hidden="true" tabindex="-1"></a>The HHI measures ownership concentration:</span>
<span id="cb31-846"><a href="#cb31-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-847"><a href="#cb31-847" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-848"><a href="#cb31-848" aria-hidden="true" tabindex="-1"></a>HHI_{i,t} = \sum_{j=1}^{N_{i,t}} \left(\frac{h_{j,i,t}}{\sum_{k=1}^{N_{i,t}} h_{k,i,t}}\right)^2</span>
<span id="cb31-849"><a href="#cb31-849" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hhi}</span>
<span id="cb31-850"><a href="#cb31-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-851"><a href="#cb31-851" aria-hidden="true" tabindex="-1"></a>where $N_{i,t}$ is the number of shareholders. HHI ranges from $1/N_{i,t}$ (equal) to 1 (single shareholder). In Vietnam, ownership tends to be highly concentrated due to large state and founding-family blocks.</span>
<span id="cb31-852"><a href="#cb31-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-855"><a href="#cb31-855" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-856"><a href="#cb31-856" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: hhi-computation</span></span>
<span id="cb31-857"><a href="#cb31-857" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Ownership Concentration (HHI)"</span></span>
<span id="cb31-858"><a href="#cb31-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-859"><a href="#cb31-859" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_hhi(holdings: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-860"><a href="#cb31-860" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute HHI for each stock-quarter, overall and institutional."""</span></span>
<span id="cb31-861"><a href="#cb31-861" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _hhi(shares: pd.Series) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb31-862"><a href="#cb31-862" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> shares.<span class="bu">sum</span>()</span>
<span id="cb31-863"><a href="#cb31-863" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb31-864"><a href="#cb31-864" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-865"><a href="#cb31-865" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> shares <span class="op">/</span> total</span>
<span id="cb31-866"><a href="#cb31-866" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (weights <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb31-867"><a href="#cb31-867" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-868"><a href="#cb31-868" aria-hidden="true" tabindex="-1"></a>    hhi_overall <span class="op">=</span> (</span>
<span id="cb31-869"><a href="#cb31-869" aria-hidden="true" tabindex="-1"></a>        holdings.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])[<span class="st">'shares_adj'</span>]</span>
<span id="cb31-870"><a href="#cb31-870" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(_hhi).reset_index()</span>
<span id="cb31-871"><a href="#cb31-871" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'shares_adj'</span>: <span class="st">'hhi_overall'</span>})</span>
<span id="cb31-872"><a href="#cb31-872" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-873"><a href="#cb31-873" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-874"><a href="#cb31-874" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> holdings[</span>
<span id="cb31-875"><a href="#cb31-875" aria-hidden="true" tabindex="-1"></a>        holdings[<span class="st">'owner_type'</span>].isin(OwnershipType.ALL_INSTITUTIONAL)</span>
<span id="cb31-876"><a href="#cb31-876" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-877"><a href="#cb31-877" aria-hidden="true" tabindex="-1"></a>    hhi_inst <span class="op">=</span> (</span>
<span id="cb31-878"><a href="#cb31-878" aria-hidden="true" tabindex="-1"></a>        inst.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])[<span class="st">'shares_adj'</span>]</span>
<span id="cb31-879"><a href="#cb31-879" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(_hhi).reset_index()</span>
<span id="cb31-880"><a href="#cb31-880" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'shares_adj'</span>: <span class="st">'hhi_institutional'</span>})</span>
<span id="cb31-881"><a href="#cb31-881" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-882"><a href="#cb31-882" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-883"><a href="#cb31-883" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hhi_overall.merge(hhi_inst, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb31-884"><a href="#cb31-884" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-885"><a href="#cb31-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-886"><a href="#cb31-886" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ownership Breadth {#sec-institutionalbreadth}</span></span>
<span id="cb31-887"><a href="#cb31-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-888"><a href="#cb31-888" aria-hidden="true" tabindex="-1"></a>Following @chen2000value, ownership breadth is the number of institutional holders:</span>
<span id="cb31-889"><a href="#cb31-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-890"><a href="#cb31-890" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-891"><a href="#cb31-891" aria-hidden="true" tabindex="-1"></a>\text{Breadth}_{i,t} = \#\{j : h_{j,i,t} &gt; 0, \, j \in \mathcal{J}<span class="sc">\}</span></span>
<span id="cb31-892"><a href="#cb31-892" aria-hidden="true" tabindex="-1"></a>$$ {#eq-breadth}</span>
<span id="cb31-893"><a href="#cb31-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-894"><a href="#cb31-894" aria-hidden="true" tabindex="-1"></a>The *change* in breadth predicts future returns:</span>
<span id="cb31-895"><a href="#cb31-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-896"><a href="#cb31-896" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-897"><a href="#cb31-897" aria-hidden="true" tabindex="-1"></a>\Delta\text{Breadth}_{i,t} = \text{Breadth}_{i,t} - \text{Breadth}_{i,t-1}</span>
<span id="cb31-898"><a href="#cb31-898" aria-hidden="true" tabindex="-1"></a>$$ {#eq-breadth-change}</span>
<span id="cb31-899"><a href="#cb31-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-902"><a href="#cb31-902" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-903"><a href="#cb31-903" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: breadth-computation</span></span>
<span id="cb31-904"><a href="#cb31-904" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Ownership Breadth and Breadth Changes"</span></span>
<span id="cb31-905"><a href="#cb31-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-906"><a href="#cb31-906" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_breadth(holdings: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-907"><a href="#cb31-907" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute ownership breadth and changes by type."""</span></span>
<span id="cb31-908"><a href="#cb31-908" aria-hidden="true" tabindex="-1"></a>    breadth <span class="op">=</span> (</span>
<span id="cb31-909"><a href="#cb31-909" aria-hidden="true" tabindex="-1"></a>        holdings[</span>
<span id="cb31-910"><a href="#cb31-910" aria-hidden="true" tabindex="-1"></a>            holdings[<span class="st">'owner_type'</span>].isin(OwnershipType.ALL_INSTITUTIONAL)</span>
<span id="cb31-911"><a href="#cb31-911" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb31-912"><a href="#cb31-912" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'owner_type'</span>])[<span class="st">'shareholder_name'</span>]</span>
<span id="cb31-913"><a href="#cb31-913" aria-hidden="true" tabindex="-1"></a>        .nunique()</span>
<span id="cb31-914"><a href="#cb31-914" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-915"><a href="#cb31-915" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_holders'</span>})</span>
<span id="cb31-916"><a href="#cb31-916" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-917"><a href="#cb31-917" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-918"><a href="#cb31-918" aria-hidden="true" tabindex="-1"></a>    breadth_wide <span class="op">=</span> breadth.pivot_table(</span>
<span id="cb31-919"><a href="#cb31-919" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-920"><a href="#cb31-920" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'owner_type'</span>,</span>
<span id="cb31-921"><a href="#cb31-921" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">'n_holders'</span>,</span>
<span id="cb31-922"><a href="#cb31-922" aria-hidden="true" tabindex="-1"></a>        fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb31-923"><a href="#cb31-923" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb31-924"><a href="#cb31-924" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-925"><a href="#cb31-925" aria-hidden="true" tabindex="-1"></a>    breadth_wide.columns <span class="op">=</span> [</span>
<span id="cb31-926"><a href="#cb31-926" aria-hidden="true" tabindex="-1"></a>        c <span class="cf">if</span> c <span class="kw">in</span> [<span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb31-927"><a href="#cb31-927" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="ss">f'n_</span><span class="sc">{</span>c<span class="sc">.</span>lower()<span class="sc">.</span>replace(<span class="st">" "</span>, <span class="st">"_"</span>)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb31-928"><a href="#cb31-928" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> breadth_wide.columns</span>
<span id="cb31-929"><a href="#cb31-929" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-930"><a href="#cb31-930" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-931"><a href="#cb31-931" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> breadth_wide.columns <span class="cf">if</span> c.startswith(<span class="st">'n_'</span>)]</span>
<span id="cb31-932"><a href="#cb31-932" aria-hidden="true" tabindex="-1"></a>    breadth_wide[<span class="st">'n_total_inst'</span>] <span class="op">=</span> breadth_wide[n_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-933"><a href="#cb31-933" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-934"><a href="#cb31-934" aria-hidden="true" tabindex="-1"></a>    breadth_wide <span class="op">=</span> breadth_wide.sort_values([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-935"><a href="#cb31-935" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> n_cols <span class="op">+</span> [<span class="st">'n_total_inst'</span>]:</span>
<span id="cb31-936"><a href="#cb31-936" aria-hidden="true" tabindex="-1"></a>        breadth_wide[<span class="ss">f'd_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> (</span>
<span id="cb31-937"><a href="#cb31-937" aria-hidden="true" tabindex="-1"></a>            breadth_wide.groupby(<span class="st">'ticker'</span>)[col].diff()</span>
<span id="cb31-938"><a href="#cb31-938" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-939"><a href="#cb31-939" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-940"><a href="#cb31-940" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> breadth_wide</span>
<span id="cb31-941"><a href="#cb31-941" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-942"><a href="#cb31-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-943"><a href="#cb31-943" aria-hidden="true" tabindex="-1"></a>($\text{BS} = -1$) is generated for the prior position, dated to the quarter after the last report.</span>
<span id="cb31-944"><a href="#cb31-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-945"><a href="#cb31-945" aria-hidden="true" tabindex="-1"></a>For intermediate gaps (reports at $t-2$ and $t$ but not $t-1$), we split into:</span>
<span id="cb31-946"><a href="#cb31-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-947"><a href="#cb31-947" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A terminating sale at $t-1$ of $-h_{j,i,t-2}^{\text{adj}}$;</span>
<span id="cb31-948"><a href="#cb31-948" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>An initiating buy at $t$ of $h_{j,i,t}$.</span>
<span id="cb31-949"><a href="#cb31-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-950"><a href="#cb31-950" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation {#sec-institutionaltrade-impl}</span></span>
<span id="cb31-951"><a href="#cb31-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-954"><a href="#cb31-954" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-955"><a href="#cb31-955" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: trade-computation</span></span>
<span id="cb31-956"><a href="#cb31-956" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Step 5: Institutional Trade Computation"</span></span>
<span id="cb31-957"><a href="#cb31-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-958"><a href="#cb31-958" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_trades(</span>
<span id="cb31-959"><a href="#cb31-959" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb31-960"><a href="#cb31-960" aria-hidden="true" tabindex="-1"></a>    adj_factors: pd.DataFrame,</span>
<span id="cb31-961"><a href="#cb31-961" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-962"><a href="#cb31-962" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-963"><a href="#cb31-963" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute institutional trades from holdings panel.</span></span>
<span id="cb31-964"><a href="#cb31-964" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-965"><a href="#cb31-965" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses vectorized conditional logic (NOT apply()) for performance.</span></span>
<span id="cb31-966"><a href="#cb31-966" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-967"><a href="#cb31-967" aria-hidden="true" tabindex="-1"></a><span class="co">    Algorithm:</span></span>
<span id="cb31-968"><a href="#cb31-968" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Sort holdings by shareholder, ticker, quarter</span></span>
<span id="cb31-969"><a href="#cb31-969" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Compute lagged holdings and reporting gaps</span></span>
<span id="cb31-970"><a href="#cb31-970" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Apply modified trade logic based on first_report, gap</span></span>
<span id="cb31-971"><a href="#cb31-971" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Handle terminating sales and intermediate gaps</span></span>
<span id="cb31-972"><a href="#cb31-972" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Append all trade records</span></span>
<span id="cb31-973"><a href="#cb31-973" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-974"><a href="#cb31-974" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> holdings.sort_values(</span>
<span id="cb31-975"><a href="#cb31-975" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb31-976"><a href="#cb31-976" aria-hidden="true" tabindex="-1"></a>    ).copy()</span>
<span id="cb31-977"><a href="#cb31-977" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-978"><a href="#cb31-978" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Previous holding quarter and shares</span></span>
<span id="cb31-979"><a href="#cb31-979" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> t1.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])</span>
<span id="cb31-980"><a href="#cb31-980" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'phrdate'</span>] <span class="op">=</span> grp[<span class="st">'rdate'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-981"><a href="#cb31-981" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'pshares_adj'</span>] <span class="op">=</span> grp[<span class="st">'shares_adj'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-982"><a href="#cb31-982" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-983"><a href="#cb31-983" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Raw trade</span></span>
<span id="cb31-984"><a href="#cb31-984" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'trade'</span>] <span class="op">=</span> t1[<span class="st">'shares_adj'</span>] <span class="op">-</span> t1[<span class="st">'pshares_adj'</span>]</span>
<span id="cb31-985"><a href="#cb31-985" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-986"><a href="#cb31-986" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quarter gap</span></span>
<span id="cb31-987"><a href="#cb31-987" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'qtrgap'</span>] <span class="op">=</span> t1.<span class="bu">apply</span>(</span>
<span id="cb31-988"><a href="#cb31-988" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (</span>
<span id="cb31-989"><a href="#cb31-989" aria-hidden="true" tabindex="-1"></a>            (r[<span class="st">'rdate'</span>].to_period(<span class="st">'Q'</span>)</span>
<span id="cb31-990"><a href="#cb31-990" aria-hidden="true" tabindex="-1"></a>             <span class="op">-</span> r[<span class="st">'phrdate'</span>].to_period(<span class="st">'Q'</span>)).n</span>
<span id="cb31-991"><a href="#cb31-991" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(r[<span class="st">'phrdate'</span>]) <span class="cf">else</span> np.nan</span>
<span id="cb31-992"><a href="#cb31-992" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-993"><a href="#cb31-993" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb31-994"><a href="#cb31-994" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-995"><a href="#cb31-995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-996"><a href="#cb31-996" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Boundary detection keys</span></span>
<span id="cb31-997"><a href="#cb31-997" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'l_key'</span>] <span class="op">=</span> (</span>
<span id="cb31-998"><a href="#cb31-998" aria-hidden="true" tabindex="-1"></a>        t1[<span class="st">'shareholder_name'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> t1[<span class="st">'ticker'</span>]</span>
<span id="cb31-999"><a href="#cb31-999" aria-hidden="true" tabindex="-1"></a>    ).shift(<span class="dv">1</span>)</span>
<span id="cb31-1000"><a href="#cb31-1000" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'n_key'</span>] <span class="op">=</span> (</span>
<span id="cb31-1001"><a href="#cb31-1001" aria-hidden="true" tabindex="-1"></a>        t1[<span class="st">'shareholder_name'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> t1[<span class="st">'ticker'</span>]</span>
<span id="cb31-1002"><a href="#cb31-1002" aria-hidden="true" tabindex="-1"></a>    ).shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb31-1003"><a href="#cb31-1003" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'curr_key'</span>] <span class="op">=</span> t1[<span class="st">'shareholder_name'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> t1[<span class="st">'ticker'</span>]</span>
<span id="cb31-1004"><a href="#cb31-1004" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1005"><a href="#cb31-1005" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Vectorized trade classification ----</span></span>
<span id="cb31-1006"><a href="#cb31-1006" aria-hidden="true" tabindex="-1"></a>    is_new <span class="op">=</span> (t1[<span class="st">'curr_key'</span>] <span class="op">!=</span> t1[<span class="st">'l_key'</span>])</span>
<span id="cb31-1007"><a href="#cb31-1007" aria-hidden="true" tabindex="-1"></a>    not_first <span class="op">=</span> <span class="op">~</span>t1[<span class="st">'first_report'</span>]</span>
<span id="cb31-1008"><a href="#cb31-1008" aria-hidden="true" tabindex="-1"></a>    consec <span class="op">=</span> (t1[<span class="st">'qtrgap'</span>] <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb31-1009"><a href="#cb31-1009" aria-hidden="true" tabindex="-1"></a>    gap <span class="op">=</span> (t1[<span class="st">'qtrgap'</span>] <span class="op">!=</span> <span class="dv">1</span>) <span class="op">&amp;</span> t1[<span class="st">'qtrgap'</span>].notna()</span>
<span id="cb31-1010"><a href="#cb31-1010" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1011"><a href="#cb31-1011" aria-hidden="true" tabindex="-1"></a>    cond1   <span class="op">=</span> is_new</span>
<span id="cb31-1012"><a href="#cb31-1012" aria-hidden="true" tabindex="-1"></a>    cond1_1 <span class="op">=</span> is_new <span class="op">&amp;</span> not_first</span>
<span id="cb31-1013"><a href="#cb31-1013" aria-hidden="true" tabindex="-1"></a>    cond2_1 <span class="op">=</span> (<span class="op">~</span>is_new) <span class="op">&amp;</span> not_first <span class="op">&amp;</span> consec</span>
<span id="cb31-1014"><a href="#cb31-1014" aria-hidden="true" tabindex="-1"></a>    cond2_2 <span class="op">=</span> (<span class="op">~</span>is_new) <span class="op">&amp;</span> not_first <span class="op">&amp;</span> gap</span>
<span id="cb31-1015"><a href="#cb31-1015" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1016"><a href="#cb31-1016" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modified trade amounts</span></span>
<span id="cb31-1017"><a href="#cb31-1017" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'modtrade'</span>] <span class="op">=</span> t1[<span class="st">'trade'</span>]</span>
<span id="cb31-1018"><a href="#cb31-1018" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond1, <span class="st">'modtrade'</span>] <span class="op">=</span> np.nan</span>
<span id="cb31-1019"><a href="#cb31-1019" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond1_1, <span class="st">'modtrade'</span>] <span class="op">=</span> t1.loc[cond1_1, <span class="st">'shares_adj'</span>]</span>
<span id="cb31-1020"><a href="#cb31-1020" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_1, <span class="st">'modtrade'</span>] <span class="op">=</span> t1.loc[cond2_1, <span class="st">'trade'</span>]</span>
<span id="cb31-1021"><a href="#cb31-1021" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_2, <span class="st">'modtrade'</span>] <span class="op">=</span> t1.loc[cond2_2, <span class="st">'shares_adj'</span>]</span>
<span id="cb31-1022"><a href="#cb31-1022" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1023"><a href="#cb31-1023" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy/sale classification</span></span>
<span id="cb31-1024"><a href="#cb31-1024" aria-hidden="true" tabindex="-1"></a>    t1[<span class="st">'buysale'</span>] <span class="op">=</span> np.nan</span>
<span id="cb31-1025"><a href="#cb31-1025" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond1_1, <span class="st">'buysale'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb31-1026"><a href="#cb31-1026" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_1, <span class="st">'buysale'</span>] <span class="op">=</span> (</span>
<span id="cb31-1027"><a href="#cb31-1027" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span> <span class="op">*</span> np.sign(t1.loc[cond2_1, <span class="st">'trade'</span>])</span>
<span id="cb31-1028"><a href="#cb31-1028" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1029"><a href="#cb31-1029" aria-hidden="true" tabindex="-1"></a>    t1.loc[cond2_2, <span class="st">'buysale'</span>] <span class="op">=</span> <span class="fl">1.5</span>  <span class="co"># placeholder for split</span></span>
<span id="cb31-1030"><a href="#cb31-1030" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1031"><a href="#cb31-1031" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Handle intermediate gaps (buysale == 1.5) ----</span></span>
<span id="cb31-1032"><a href="#cb31-1032" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> t1[t1[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="fl">1.5</span>].copy()</span>
<span id="cb31-1033"><a href="#cb31-1033" aria-hidden="true" tabindex="-1"></a>    t2[<span class="st">'rdate'</span>] <span class="op">=</span> t2[<span class="st">'phrdate'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">1</span>)</span>
<span id="cb31-1034"><a href="#cb31-1034" aria-hidden="true" tabindex="-1"></a>    t2[<span class="st">'buysale'</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb31-1035"><a href="#cb31-1035" aria-hidden="true" tabindex="-1"></a>    t2[<span class="st">'modtrade'</span>] <span class="op">=</span> <span class="op">-</span>t2[<span class="st">'pshares_adj'</span>]</span>
<span id="cb31-1036"><a href="#cb31-1036" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1037"><a href="#cb31-1037" aria-hidden="true" tabindex="-1"></a>    t1.loc[t1[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="fl">1.5</span>, <span class="st">'buysale'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb31-1038"><a href="#cb31-1038" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1039"><a href="#cb31-1039" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Terminating sales ----</span></span>
<span id="cb31-1040"><a href="#cb31-1040" aria-hidden="true" tabindex="-1"></a>    is_last_combo <span class="op">=</span> (t1[<span class="st">'curr_key'</span>] <span class="op">!=</span> t1[<span class="st">'n_key'</span>])</span>
<span id="cb31-1041"><a href="#cb31-1041" aria-hidden="true" tabindex="-1"></a>    not_last_rpt <span class="op">=</span> <span class="op">~</span>t1[<span class="st">'last_report'</span>]</span>
<span id="cb31-1042"><a href="#cb31-1042" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1043"><a href="#cb31-1043" aria-hidden="true" tabindex="-1"></a>    t3 <span class="op">=</span> t1[is_last_combo <span class="op">&amp;</span> not_last_rpt].copy()</span>
<span id="cb31-1044"><a href="#cb31-1044" aria-hidden="true" tabindex="-1"></a>    t3[<span class="st">'rdate'</span>] <span class="op">=</span> t3[<span class="st">'rdate'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">1</span>)</span>
<span id="cb31-1045"><a href="#cb31-1045" aria-hidden="true" tabindex="-1"></a>    t3[<span class="st">'modtrade'</span>] <span class="op">=</span> <span class="op">-</span>t3[<span class="st">'shares_adj'</span>]</span>
<span id="cb31-1046"><a href="#cb31-1046" aria-hidden="true" tabindex="-1"></a>    t3[<span class="st">'buysale'</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb31-1047"><a href="#cb31-1047" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1048"><a href="#cb31-1048" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Combine ----</span></span>
<span id="cb31-1049"><a href="#cb31-1049" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> pd.concat([t1, t2, t3], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-1050"><a href="#cb31-1050" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades[</span>
<span id="cb31-1051"><a href="#cb31-1051" aria-hidden="true" tabindex="-1"></a>        (trades[<span class="st">'modtrade'</span>] <span class="op">!=</span> <span class="dv">0</span>) <span class="op">&amp;</span></span>
<span id="cb31-1052"><a href="#cb31-1052" aria-hidden="true" tabindex="-1"></a>        trades[<span class="st">'modtrade'</span>].notna() <span class="op">&amp;</span></span>
<span id="cb31-1053"><a href="#cb31-1053" aria-hidden="true" tabindex="-1"></a>        trades[<span class="st">'buysale'</span>].notna()</span>
<span id="cb31-1054"><a href="#cb31-1054" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb31-1055"><a href="#cb31-1055" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1056"><a href="#cb31-1056" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades[[</span>
<span id="cb31-1057"><a href="#cb31-1057" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rdate'</span>, <span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'modtrade'</span>,</span>
<span id="cb31-1058"><a href="#cb31-1058" aria-hidden="true" tabindex="-1"></a>        <span class="st">'buysale'</span>, <span class="st">'owner_type'</span>, <span class="st">'first_report'</span>, <span class="st">'last_report'</span></span>
<span id="cb31-1059"><a href="#cb31-1059" aria-hidden="true" tabindex="-1"></a>    ]].rename(columns<span class="op">=</span>{<span class="st">'modtrade'</span>: <span class="st">'trade'</span>})</span>
<span id="cb31-1060"><a href="#cb31-1060" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1061"><a href="#cb31-1061" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Trade computation complete:"</span>)</span>
<span id="cb31-1062"><a href="#cb31-1062" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total records: </span><span class="sc">{</span><span class="bu">len</span>(trades)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-1063"><a href="#cb31-1063" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Initiating buys:  </span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-1064"><a href="#cb31-1064" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Incremental buys: </span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="dv">2</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-1065"><a href="#cb31-1065" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Terminating sales:</span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-1066"><a href="#cb31-1066" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Regular sales:    </span><span class="sc">{</span>(trades[<span class="st">'buysale'</span>] <span class="op">==</span> <span class="op">-</span><span class="dv">2</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb31-1067"><a href="#cb31-1067" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1068"><a href="#cb31-1068" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades</span>
<span id="cb31-1069"><a href="#cb31-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1070"><a href="#cb31-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1071"><a href="#cb31-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trade Visualization {#sec-institutionaltrade-viz}</span></span>
<span id="cb31-1072"><a href="#cb31-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1075"><a href="#cb31-1075" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1076"><a href="#cb31-1076" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-trade-distribution</span></span>
<span id="cb31-1077"><a href="#cb31-1077" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of institutional trade types across quarters. The figure shows initiating buys, incremental buys, regular sales, and terminating sales, providing insights into institutional entry/exit patterns in the Vietnamese market."</span></span>
<span id="cb31-1078"><a href="#cb31-1078" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-1079"><a href="#cb31-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1080"><a href="#cb31-1080" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_trade_distribution(trades: pd.DataFrame):</span>
<span id="cb31-1081"><a href="#cb31-1081" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot time series of trade types by quarter."""</span></span>
<span id="cb31-1082"><a href="#cb31-1082" aria-hidden="true" tabindex="-1"></a>    bs_labels <span class="op">=</span> {</span>
<span id="cb31-1083"><a href="#cb31-1083" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>: <span class="st">'Initiating Buy'</span>, <span class="dv">2</span>: <span class="st">'Incremental Buy'</span>,</span>
<span id="cb31-1084"><a href="#cb31-1084" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span><span class="dv">1</span>: <span class="st">'Terminating Sale'</span>, <span class="op">-</span><span class="dv">2</span>: <span class="st">'Regular Sale'</span></span>
<span id="cb31-1085"><a href="#cb31-1085" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1086"><a href="#cb31-1086" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades.copy()</span>
<span id="cb31-1087"><a href="#cb31-1087" aria-hidden="true" tabindex="-1"></a>    trades[<span class="st">'trade_type'</span>] <span class="op">=</span> trades[<span class="st">'buysale'</span>].<span class="bu">map</span>(bs_labels)</span>
<span id="cb31-1088"><a href="#cb31-1088" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1089"><a href="#cb31-1089" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> (</span>
<span id="cb31-1090"><a href="#cb31-1090" aria-hidden="true" tabindex="-1"></a>        trades</span>
<span id="cb31-1091"><a href="#cb31-1091" aria-hidden="true" tabindex="-1"></a>        .groupby([pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>), <span class="st">'trade_type'</span>])</span>
<span id="cb31-1092"><a href="#cb31-1092" aria-hidden="true" tabindex="-1"></a>        .size()</span>
<span id="cb31-1093"><a href="#cb31-1093" aria-hidden="true" tabindex="-1"></a>        .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-1094"><a href="#cb31-1094" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1095"><a href="#cb31-1095" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1096"><a href="#cb31-1096" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-1097"><a href="#cb31-1097" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1098"><a href="#cb31-1098" aria-hidden="true" tabindex="-1"></a>    buy_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> counts.columns <span class="cf">if</span> <span class="st">'Buy'</span> <span class="kw">in</span> c]</span>
<span id="cb31-1099"><a href="#cb31-1099" aria-hidden="true" tabindex="-1"></a>    counts[buy_cols].plot(</span>
<span id="cb31-1100"><a href="#cb31-1100" aria-hidden="true" tabindex="-1"></a>        kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb31-1101"><a href="#cb31-1101" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>[<span class="st">'#1f77b4'</span>, <span class="st">'#aec7e8'</span>], width<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb31-1102"><a href="#cb31-1102" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1103"><a href="#cb31-1103" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Institutional Purchases'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1104"><a href="#cb31-1104" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb31-1105"><a href="#cb31-1105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1106"><a href="#cb31-1106" aria-hidden="true" tabindex="-1"></a>    sale_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> counts.columns <span class="cf">if</span> <span class="st">'Sale'</span> <span class="kw">in</span> c]</span>
<span id="cb31-1107"><a href="#cb31-1107" aria-hidden="true" tabindex="-1"></a>    counts[sale_cols].plot(</span>
<span id="cb31-1108"><a href="#cb31-1108" aria-hidden="true" tabindex="-1"></a>        kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb31-1109"><a href="#cb31-1109" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>[<span class="st">'#d62728'</span>, <span class="st">'#ff9896'</span>], width<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb31-1110"><a href="#cb31-1110" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1111"><a href="#cb31-1111" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Institutional Sales'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1112"><a href="#cb31-1112" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb31-1113"><a href="#cb31-1113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1114"><a href="#cb31-1114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axes:</span>
<span id="cb31-1115"><a href="#cb31-1115" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb31-1116"><a href="#cb31-1116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, label <span class="kw">in</span> <span class="bu">enumerate</span>(ax.get_xticklabels()):</span>
<span id="cb31-1117"><a href="#cb31-1117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">4</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb31-1118"><a href="#cb31-1118" aria-hidden="true" tabindex="-1"></a>                label.set_visible(<span class="va">False</span>)</span>
<span id="cb31-1119"><a href="#cb31-1119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1120"><a href="#cb31-1120" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-1121"><a href="#cb31-1121" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb31-1122"><a href="#cb31-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1123"><a href="#cb31-1123" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_trade_distribution(trades)</span></span>
<span id="cb31-1124"><a href="#cb31-1124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1125"><a href="#cb31-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1128"><a href="#cb31-1128" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1129"><a href="#cb31-1129" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-net-trading-by-type</span></span>
<span id="cb31-1130"><a href="#cb31-1130" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Net institutional trading (buys minus sales, billions VND) by ownership type. Foreign institutional investors exhibit countercyclical behavior, while state entities show more stable patterns consistent with strategic rather than portfolio objectives."</span></span>
<span id="cb31-1131"><a href="#cb31-1131" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-1132"><a href="#cb31-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1133"><a href="#cb31-1133" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_net_trading_by_type(trades: pd.DataFrame, price_q: pd.DataFrame):</span>
<span id="cb31-1134"><a href="#cb31-1134" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot net trading volume by owner type over time."""</span></span>
<span id="cb31-1135"><a href="#cb31-1135" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb31-1136"><a href="#cb31-1136" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb31-1137"><a href="#cb31-1137" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-1138"><a href="#cb31-1138" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-1139"><a href="#cb31-1139" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1140"><a href="#cb31-1140" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1141"><a href="#cb31-1141" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'trade_vnd'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb31-1142"><a href="#cb31-1142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1143"><a href="#cb31-1143" aria-hidden="true" tabindex="-1"></a>    net <span class="op">=</span> (</span>
<span id="cb31-1144"><a href="#cb31-1144" aria-hidden="true" tabindex="-1"></a>        _t</span>
<span id="cb31-1145"><a href="#cb31-1145" aria-hidden="true" tabindex="-1"></a>        .groupby([pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>), <span class="st">'owner_type'</span>])</span>
<span id="cb31-1146"><a href="#cb31-1146" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'trade_vnd'</span>].<span class="bu">sum</span>()</span>
<span id="cb31-1147"><a href="#cb31-1147" aria-hidden="true" tabindex="-1"></a>        .unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-1148"><a href="#cb31-1148" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1149"><a href="#cb31-1149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1150"><a href="#cb31-1150" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb31-1151"><a href="#cb31-1151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> net.columns:</span>
<span id="cb31-1152"><a href="#cb31-1152" aria-hidden="true" tabindex="-1"></a>        ax.plot(net.index, net[col], label<span class="op">=</span>col,</span>
<span id="cb31-1153"><a href="#cb31-1153" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>OWNER_COLORS.get(col, <span class="st">'#333'</span>), linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb31-1154"><a href="#cb31-1154" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-1155"><a href="#cb31-1155" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Net Institutional Trading by Ownership Type'</span>,</span>
<span id="cb31-1156"><a href="#cb31-1156" aria-hidden="true" tabindex="-1"></a>                 fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1157"><a href="#cb31-1157" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Net Trading (Billions VND)'</span>)</span>
<span id="cb31-1158"><a href="#cb31-1158" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb31-1159"><a href="#cb31-1159" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-1160"><a href="#cb31-1160" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb31-1161"><a href="#cb31-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1162"><a href="#cb31-1162" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_net_trading_by_type(trades, price_q)</span></span>
<span id="cb31-1163"><a href="#cb31-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1164"><a href="#cb31-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1165"><a href="#cb31-1165" aria-hidden="true" tabindex="-1"></a><span class="fu"># Portfolio Assets, Flows, and Returns {#sec-institutionalassets-flows}</span></span>
<span id="cb31-1166"><a href="#cb31-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1167"><a href="#cb31-1167" aria-hidden="true" tabindex="-1"></a>This section computes total portfolio assets, aggregates buys and sales, and portfolio-level returns for each institutional investor.</span>
<span id="cb31-1168"><a href="#cb31-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1169"><a href="#cb31-1169" aria-hidden="true" tabindex="-1"></a><span class="fu">## Total Assets and Portfolio Returns {#sec-institutionalassets}</span></span>
<span id="cb31-1170"><a href="#cb31-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1171"><a href="#cb31-1171" aria-hidden="true" tabindex="-1"></a>For each manager $j$ and quarter $t$, portfolio assets are:</span>
<span id="cb31-1172"><a href="#cb31-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1173"><a href="#cb31-1173" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1174"><a href="#cb31-1174" aria-hidden="true" tabindex="-1"></a>A_{j,t} = \sum_{i=1}^{N_{j,t}} h_{j,i,t} \cdot P_{i,t}</span>
<span id="cb31-1175"><a href="#cb31-1175" aria-hidden="true" tabindex="-1"></a>$$ {#eq-assets}</span>
<span id="cb31-1176"><a href="#cb31-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1177"><a href="#cb31-1177" aria-hidden="true" tabindex="-1"></a>The portfolio return assuming buy-and-hold is:</span>
<span id="cb31-1178"><a href="#cb31-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1179"><a href="#cb31-1179" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1180"><a href="#cb31-1180" aria-hidden="true" tabindex="-1"></a>R_{j,t}^{p} = \frac{\sum_{i=1}^{N_{j,t}} h_{j,i,t} \cdot P_{i,t} \cdot r_{i,t+1}}</span>
<span id="cb31-1181"><a href="#cb31-1181" aria-hidden="true" tabindex="-1"></a>{\sum_{i=1}^{N_{j,t}} h_{j,i,t} \cdot P_{i,t}}</span>
<span id="cb31-1182"><a href="#cb31-1182" aria-hidden="true" tabindex="-1"></a>$$ {#eq-portfolio-return}</span>
<span id="cb31-1183"><a href="#cb31-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1186"><a href="#cb31-1186" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1187"><a href="#cb31-1187" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: assets-computation</span></span>
<span id="cb31-1188"><a href="#cb31-1188" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Step 6a: Portfolio Assets and Returns"</span></span>
<span id="cb31-1189"><a href="#cb31-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1190"><a href="#cb31-1190" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_assets_and_returns(</span>
<span id="cb31-1191"><a href="#cb31-1191" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb31-1192"><a href="#cb31-1192" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb31-1193"><a href="#cb31-1193" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1194"><a href="#cb31-1194" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute total portfolio assets and buy-and-hold returns."""</span></span>
<span id="cb31-1195"><a href="#cb31-1195" aria-hidden="true" tabindex="-1"></a>    _assets <span class="op">=</span> holdings[</span>
<span id="cb31-1196"><a href="#cb31-1196" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'shares_adj'</span>]</span>
<span id="cb31-1197"><a href="#cb31-1197" aria-hidden="true" tabindex="-1"></a>    ].merge(</span>
<span id="cb31-1198"><a href="#cb31-1198" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb31-1199"><a href="#cb31-1199" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-1200"><a href="#cb31-1200" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-1201"><a href="#cb31-1201" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1202"><a href="#cb31-1202" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1203"><a href="#cb31-1203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1204"><a href="#cb31-1204" aria-hidden="true" tabindex="-1"></a>    _assets[<span class="st">'hold_per_stock'</span>] <span class="op">=</span> _assets[<span class="st">'shares_adj'</span>] <span class="op">*</span> _assets[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-1205"><a href="#cb31-1205" aria-hidden="true" tabindex="-1"></a>    _assets[<span class="st">'next_value'</span>] <span class="op">=</span> (</span>
<span id="cb31-1206"><a href="#cb31-1206" aria-hidden="true" tabindex="-1"></a>        _assets[<span class="st">'shares_adj'</span>] <span class="op">*</span> _assets[<span class="st">'p'</span>] <span class="op">*</span> _assets[<span class="st">'qret'</span>]</span>
<span id="cb31-1207"><a href="#cb31-1207" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1208"><a href="#cb31-1208" aria-hidden="true" tabindex="-1"></a>    _assets[<span class="st">'curr_value'</span>] <span class="op">=</span> _assets[<span class="st">'shares_adj'</span>] <span class="op">*</span> _assets[<span class="st">'p'</span>]</span>
<span id="cb31-1209"><a href="#cb31-1209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1210"><a href="#cb31-1210" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> (</span>
<span id="cb31-1211"><a href="#cb31-1211" aria-hidden="true" tabindex="-1"></a>        _assets</span>
<span id="cb31-1212"><a href="#cb31-1212" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1213"><a href="#cb31-1213" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb31-1214"><a href="#cb31-1214" aria-hidden="true" tabindex="-1"></a>            assets<span class="op">=</span>(<span class="st">'hold_per_stock'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1215"><a href="#cb31-1215" aria-hidden="true" tabindex="-1"></a>            total_next<span class="op">=</span>(<span class="st">'next_value'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1216"><a href="#cb31-1216" aria-hidden="true" tabindex="-1"></a>            total_curr<span class="op">=</span>(<span class="st">'curr_value'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1217"><a href="#cb31-1217" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1218"><a href="#cb31-1218" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-1219"><a href="#cb31-1219" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1220"><a href="#cb31-1220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1221"><a href="#cb31-1221" aria-hidden="true" tabindex="-1"></a>    assets[<span class="st">'pret'</span>] <span class="op">=</span> assets[<span class="st">'total_next'</span>] <span class="op">/</span> assets[<span class="st">'total_curr'</span>]</span>
<span id="cb31-1222"><a href="#cb31-1222" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> assets.drop(columns<span class="op">=</span>[<span class="st">'total_next'</span>, <span class="st">'total_curr'</span>])</span>
<span id="cb31-1223"><a href="#cb31-1223" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> assets</span>
<span id="cb31-1224"><a href="#cb31-1224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1225"><a href="#cb31-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1226"><a href="#cb31-1226" aria-hidden="true" tabindex="-1"></a><span class="fu">## Aggregate Buys and Sales {#sec-institutionalaggregate-buysales}</span></span>
<span id="cb31-1227"><a href="#cb31-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1228"><a href="#cb31-1228" aria-hidden="true" tabindex="-1"></a>Total buys and sales for manager $j$ in quarter $t$:</span>
<span id="cb31-1229"><a href="#cb31-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1230"><a href="#cb31-1230" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1231"><a href="#cb31-1231" aria-hidden="true" tabindex="-1"></a>B_{j,t} = \sum_{i : \Delta h &gt; 0} \Delta h_{j,i,t} \cdot P_{i,t}, \qquad</span>
<span id="cb31-1232"><a href="#cb31-1232" aria-hidden="true" tabindex="-1"></a>S_{j,t} = \sum_{i : \Delta h &lt; 0} |\Delta h_{j,i,t}| \cdot P_{i,t}</span>
<span id="cb31-1233"><a href="#cb31-1233" aria-hidden="true" tabindex="-1"></a>$$ {#eq-total-buys-sales}</span>
<span id="cb31-1234"><a href="#cb31-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1235"><a href="#cb31-1235" aria-hidden="true" tabindex="-1"></a>The trade gain is:</span>
<span id="cb31-1236"><a href="#cb31-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1237"><a href="#cb31-1237" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1238"><a href="#cb31-1238" aria-hidden="true" tabindex="-1"></a>G_{j,t} = \sum_{i=1}^{N_{j,t}} \Delta h_{j,i,t} \cdot P_{i,t} \cdot r_{i,t+1}</span>
<span id="cb31-1239"><a href="#cb31-1239" aria-hidden="true" tabindex="-1"></a>$$ {#eq-trade-gain}</span>
<span id="cb31-1240"><a href="#cb31-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1243"><a href="#cb31-1243" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1244"><a href="#cb31-1244" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: buys-sales-computation</span></span>
<span id="cb31-1245"><a href="#cb31-1245" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Step 6b: Aggregate Buys, Sales, and Trade Gains"</span></span>
<span id="cb31-1246"><a href="#cb31-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1247"><a href="#cb31-1247" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_buys_sales(</span>
<span id="cb31-1248"><a href="#cb31-1248" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame,</span>
<span id="cb31-1249"><a href="#cb31-1249" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb31-1250"><a href="#cb31-1250" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1251"><a href="#cb31-1251" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute aggregate buys, sales, trade gains per manager-quarter."""</span></span>
<span id="cb31-1252"><a href="#cb31-1252" aria-hidden="true" tabindex="-1"></a>    _flows <span class="op">=</span> trades.merge(</span>
<span id="cb31-1253"><a href="#cb31-1253" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb31-1254"><a href="#cb31-1254" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-1255"><a href="#cb31-1255" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-1256"><a href="#cb31-1256" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1257"><a href="#cb31-1257" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1258"><a href="#cb31-1258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1259"><a href="#cb31-1259" aria-hidden="true" tabindex="-1"></a>    _flows[<span class="st">'tbuys'</span>] <span class="op">=</span> (</span>
<span id="cb31-1260"><a href="#cb31-1260" aria-hidden="true" tabindex="-1"></a>        _flows[<span class="st">'trade'</span>] <span class="op">*</span> (_flows[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">float</span>)</span>
<span id="cb31-1261"><a href="#cb31-1261" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span> _flows[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-1262"><a href="#cb31-1262" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1263"><a href="#cb31-1263" aria-hidden="true" tabindex="-1"></a>    _flows[<span class="st">'tsales'</span>] <span class="op">=</span> (</span>
<span id="cb31-1264"><a href="#cb31-1264" aria-hidden="true" tabindex="-1"></a>        (<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> _flows[<span class="st">'trade'</span>] <span class="op">*</span> (_flows[<span class="st">'trade'</span>] <span class="op">&lt;</span> <span class="dv">0</span>).astype(<span class="bu">float</span>)</span>
<span id="cb31-1265"><a href="#cb31-1265" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span> _flows[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-1266"><a href="#cb31-1266" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1267"><a href="#cb31-1267" aria-hidden="true" tabindex="-1"></a>    _flows[<span class="st">'tgain'</span>] <span class="op">=</span> (</span>
<span id="cb31-1268"><a href="#cb31-1268" aria-hidden="true" tabindex="-1"></a>        _flows[<span class="st">'trade'</span>] <span class="op">*</span> _flows[<span class="st">'p'</span>] <span class="op">*</span> _flows[<span class="st">'qret'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-1269"><a href="#cb31-1269" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1270"><a href="#cb31-1270" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1271"><a href="#cb31-1271" aria-hidden="true" tabindex="-1"></a>    flows <span class="op">=</span> (</span>
<span id="cb31-1272"><a href="#cb31-1272" aria-hidden="true" tabindex="-1"></a>        _flows</span>
<span id="cb31-1273"><a href="#cb31-1273" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1274"><a href="#cb31-1274" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb31-1275"><a href="#cb31-1275" aria-hidden="true" tabindex="-1"></a>            tbuys<span class="op">=</span>(<span class="st">'tbuys'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1276"><a href="#cb31-1276" aria-hidden="true" tabindex="-1"></a>            tsales<span class="op">=</span>(<span class="st">'tsales'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1277"><a href="#cb31-1277" aria-hidden="true" tabindex="-1"></a>            tgain<span class="op">=</span>(<span class="st">'tgain'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1278"><a href="#cb31-1278" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1279"><a href="#cb31-1279" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-1280"><a href="#cb31-1280" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1281"><a href="#cb31-1281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> flows</span>
<span id="cb31-1282"><a href="#cb31-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1283"><a href="#cb31-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1284"><a href="#cb31-1284" aria-hidden="true" tabindex="-1"></a><span class="fu"># Net Flows and Turnover Ratios {#sec-institutionalturnover}</span></span>
<span id="cb31-1285"><a href="#cb31-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1286"><a href="#cb31-1286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Net Flows {#sec-institutionalnetflows}</span></span>
<span id="cb31-1287"><a href="#cb31-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1288"><a href="#cb31-1288" aria-hidden="true" tabindex="-1"></a>Net flows separate capital allocation decisions from investment returns:</span>
<span id="cb31-1289"><a href="#cb31-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1290"><a href="#cb31-1290" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1291"><a href="#cb31-1291" aria-hidden="true" tabindex="-1"></a>\text{NetFlow}_{j,t} = A_{j,t} - A_{j,t-1}(1 + R_{j,t}^p)</span>
<span id="cb31-1292"><a href="#cb31-1292" aria-hidden="true" tabindex="-1"></a>$$ {#eq-netflow-def}</span>
<span id="cb31-1293"><a href="#cb31-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1294"><a href="#cb31-1294" aria-hidden="true" tabindex="-1"></a>::: callout-warning</span>
<span id="cb31-1295"><a href="#cb31-1295" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Net Flows in Vietnam</span></span>
<span id="cb31-1296"><a href="#cb31-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1297"><a href="#cb31-1297" aria-hidden="true" tabindex="-1"></a>For state entities or corporate cross-holders, "net flows" do not necessarily reflect investment decisions. State ownership changes often result from government policy (equitization, divestment programs). Interpretation should account for institutional context.</span>
<span id="cb31-1298"><a href="#cb31-1298" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-1299"><a href="#cb31-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1300"><a href="#cb31-1300" aria-hidden="true" tabindex="-1"></a><span class="fu">## Three Turnover Measures {#sec-institutionalturnover-measures}</span></span>
<span id="cb31-1301"><a href="#cb31-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1304"><a href="#cb31-1304" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1305"><a href="#cb31-1305" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: turnover-computation</span></span>
<span id="cb31-1306"><a href="#cb31-1306" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Step 7: Net Flows and Turnover Ratios"</span></span>
<span id="cb31-1307"><a href="#cb31-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1308"><a href="#cb31-1308" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_aggregates(</span>
<span id="cb31-1309"><a href="#cb31-1309" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb31-1310"><a href="#cb31-1310" aria-hidden="true" tabindex="-1"></a>    assets: pd.DataFrame,</span>
<span id="cb31-1311"><a href="#cb31-1311" aria-hidden="true" tabindex="-1"></a>    flows: pd.DataFrame,</span>
<span id="cb31-1312"><a href="#cb31-1312" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1313"><a href="#cb31-1313" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1314"><a href="#cb31-1314" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute net flows and three turnover measures.</span></span>
<span id="cb31-1315"><a href="#cb31-1315" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1316"><a href="#cb31-1316" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Carhart (1997): min(buys, sales) / avg(assets)</span></span>
<span id="cb31-1317"><a href="#cb31-1317" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Flow-adjusted: [min(buys, sales) + |net flows|] / lag assets</span></span>
<span id="cb31-1318"><a href="#cb31-1318" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Symmetric: [buys + sales - |net flows|] / lag assets</span></span>
<span id="cb31-1319"><a href="#cb31-1319" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1320"><a href="#cb31-1320" aria-hidden="true" tabindex="-1"></a>    report_flags <span class="op">=</span> (</span>
<span id="cb31-1321"><a href="#cb31-1321" aria-hidden="true" tabindex="-1"></a>        holdings</span>
<span id="cb31-1322"><a href="#cb31-1322" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1323"><a href="#cb31-1323" aria-hidden="true" tabindex="-1"></a>        .agg(first_report<span class="op">=</span>(<span class="st">'first_report'</span>, <span class="st">'any'</span>),</span>
<span id="cb31-1324"><a href="#cb31-1324" aria-hidden="true" tabindex="-1"></a>             last_report<span class="op">=</span>(<span class="st">'last_report'</span>, <span class="st">'any'</span>))</span>
<span id="cb31-1325"><a href="#cb31-1325" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-1326"><a href="#cb31-1326" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1327"><a href="#cb31-1327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1328"><a href="#cb31-1328" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> report_flags.merge(</span>
<span id="cb31-1329"><a href="#cb31-1329" aria-hidden="true" tabindex="-1"></a>        assets, on<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1330"><a href="#cb31-1330" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1331"><a href="#cb31-1331" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> agg.merge(</span>
<span id="cb31-1332"><a href="#cb31-1332" aria-hidden="true" tabindex="-1"></a>        flows, on<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb31-1333"><a href="#cb31-1333" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1334"><a href="#cb31-1334" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1335"><a href="#cb31-1335" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> agg.sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1336"><a href="#cb31-1336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1337"><a href="#cb31-1337" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'assets_comp'</span>] <span class="op">=</span> agg[<span class="st">'assets'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> agg[<span class="st">'pret'</span>].fillna(<span class="dv">0</span>))</span>
<span id="cb31-1338"><a href="#cb31-1338" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1339"><a href="#cb31-1339" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> agg.groupby(<span class="st">'shareholder_name'</span>)</span>
<span id="cb31-1340"><a href="#cb31-1340" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'lassets_comp'</span>] <span class="op">=</span> grp[<span class="st">'assets_comp'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-1341"><a href="#cb31-1341" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'lassets'</span>] <span class="op">=</span> grp[<span class="st">'assets'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-1342"><a href="#cb31-1342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1343"><a href="#cb31-1343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trade gain return</span></span>
<span id="cb31-1344"><a href="#cb31-1344" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'tgainret'</span>] <span class="op">=</span> agg[<span class="st">'tgain'</span>] <span class="op">/</span> (agg[<span class="st">'tbuys'</span>] <span class="op">+</span> agg[<span class="st">'tsales'</span>])</span>
<span id="cb31-1345"><a href="#cb31-1345" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1346"><a href="#cb31-1346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Net flows</span></span>
<span id="cb31-1347"><a href="#cb31-1347" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'netflows'</span>] <span class="op">=</span> agg[<span class="st">'assets'</span>] <span class="op">-</span> agg[<span class="st">'lassets_comp'</span>]</span>
<span id="cb31-1348"><a href="#cb31-1348" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1349"><a href="#cb31-1349" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover 1: Carhart (1997)</span></span>
<span id="cb31-1350"><a href="#cb31-1350" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'turnover1'</span>] <span class="op">=</span> (</span>
<span id="cb31-1351"><a href="#cb31-1351" aria-hidden="true" tabindex="-1"></a>        agg[[<span class="st">'tbuys'</span>, <span class="st">'tsales'</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span></span>
<span id="cb31-1352"><a href="#cb31-1352" aria-hidden="true" tabindex="-1"></a>        agg[[<span class="st">'assets'</span>, <span class="st">'lassets'</span>]].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-1353"><a href="#cb31-1353" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1354"><a href="#cb31-1354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1355"><a href="#cb31-1355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover 2: Flow-adjusted</span></span>
<span id="cb31-1356"><a href="#cb31-1356" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'turnover2'</span>] <span class="op">=</span> (</span>
<span id="cb31-1357"><a href="#cb31-1357" aria-hidden="true" tabindex="-1"></a>        (agg[[<span class="st">'tbuys'</span>, <span class="st">'tsales'</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-1358"><a href="#cb31-1358" aria-hidden="true" tabindex="-1"></a>         <span class="op">+</span> agg[<span class="st">'netflows'</span>].<span class="bu">abs</span>().fillna(<span class="dv">0</span>))</span>
<span id="cb31-1359"><a href="#cb31-1359" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span> agg[<span class="st">'lassets'</span>]</span>
<span id="cb31-1360"><a href="#cb31-1360" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1361"><a href="#cb31-1361" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1362"><a href="#cb31-1362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover 3: Symmetric</span></span>
<span id="cb31-1363"><a href="#cb31-1363" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'turnover3'</span>] <span class="op">=</span> (</span>
<span id="cb31-1364"><a href="#cb31-1364" aria-hidden="true" tabindex="-1"></a>        (agg[<span class="st">'tbuys'</span>].fillna(<span class="dv">0</span>) <span class="op">+</span> agg[<span class="st">'tsales'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb31-1365"><a href="#cb31-1365" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> agg[<span class="st">'netflows'</span>].<span class="bu">abs</span>().fillna(<span class="dv">0</span>))</span>
<span id="cb31-1366"><a href="#cb31-1366" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span> agg[<span class="st">'lassets'</span>]</span>
<span id="cb31-1367"><a href="#cb31-1367" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1368"><a href="#cb31-1368" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1369"><a href="#cb31-1369" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Missing for first report</span></span>
<span id="cb31-1370"><a href="#cb31-1370" aria-hidden="true" tabindex="-1"></a>    first_mask <span class="op">=</span> agg[<span class="st">'first_report'</span>]</span>
<span id="cb31-1371"><a href="#cb31-1371" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'netflows'</span>, <span class="st">'tgainret'</span>,</span>
<span id="cb31-1372"><a href="#cb31-1372" aria-hidden="true" tabindex="-1"></a>                <span class="st">'turnover1'</span>, <span class="st">'turnover2'</span>, <span class="st">'turnover3'</span>]:</span>
<span id="cb31-1373"><a href="#cb31-1373" aria-hidden="true" tabindex="-1"></a>        agg.loc[first_mask, col] <span class="op">=</span> np.nan</span>
<span id="cb31-1374"><a href="#cb31-1374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1375"><a href="#cb31-1375" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> agg.drop(columns<span class="op">=</span>[<span class="st">'assets_comp'</span>, <span class="st">'lassets_comp'</span>, <span class="st">'lassets'</span>])</span>
<span id="cb31-1376"><a href="#cb31-1376" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1377"><a href="#cb31-1377" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Aggregates: </span><span class="sc">{</span><span class="bu">len</span>(agg)<span class="sc">:,}</span><span class="ss"> manager-quarters"</span>)</span>
<span id="cb31-1378"><a href="#cb31-1378" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Turnover1 mean: </span><span class="sc">{</span>agg[<span class="st">'turnover1'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-1379"><a href="#cb31-1379" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Turnover2 mean: </span><span class="sc">{</span>agg[<span class="st">'turnover2'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-1380"><a href="#cb31-1380" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Turnover3 mean: </span><span class="sc">{</span>agg[<span class="st">'turnover3'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb31-1381"><a href="#cb31-1381" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1382"><a href="#cb31-1382" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> agg</span>
<span id="cb31-1383"><a href="#cb31-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1384"><a href="#cb31-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1385"><a href="#cb31-1385" aria-hidden="true" tabindex="-1"></a><span class="fu">### Turnover Summary Statistics {#sec-institutionalturnover-stats}</span></span>
<span id="cb31-1386"><a href="#cb31-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1389"><a href="#cb31-1389" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1390"><a href="#cb31-1390" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-turnover-summary</span></span>
<span id="cb31-1391"><a href="#cb31-1391" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary statistics for three turnover measures across institutional investor types in Vietnam. Turnover 1 follows @Carhart1997, Turnover 2 adds back absolute net flows, and Turnover 3 uses the symmetric definition."</span></span>
<span id="cb31-1392"><a href="#cb31-1392" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-1393"><a href="#cb31-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1394"><a href="#cb31-1394" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> turnover_summary_table(</span>
<span id="cb31-1395"><a href="#cb31-1395" aria-hidden="true" tabindex="-1"></a>    aggregates: pd.DataFrame,</span>
<span id="cb31-1396"><a href="#cb31-1396" aria-hidden="true" tabindex="-1"></a>    holdings: pd.DataFrame,</span>
<span id="cb31-1397"><a href="#cb31-1397" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1398"><a href="#cb31-1398" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Publication-quality turnover summary statistics table."""</span></span>
<span id="cb31-1399"><a href="#cb31-1399" aria-hidden="true" tabindex="-1"></a>    owner_map <span class="op">=</span> (</span>
<span id="cb31-1400"><a href="#cb31-1400" aria-hidden="true" tabindex="-1"></a>        holdings.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'owner_type'</span>]</span>
<span id="cb31-1401"><a href="#cb31-1401" aria-hidden="true" tabindex="-1"></a>        .first().reset_index()</span>
<span id="cb31-1402"><a href="#cb31-1402" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1403"><a href="#cb31-1403" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> aggregates.merge(owner_map, on<span class="op">=</span><span class="st">'shareholder_name'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb31-1404"><a href="#cb31-1404" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1405"><a href="#cb31-1405" aria-hidden="true" tabindex="-1"></a>    turnover_cols <span class="op">=</span> [<span class="st">'turnover1'</span>, <span class="st">'turnover2'</span>, <span class="st">'turnover3'</span>]</span>
<span id="cb31-1406"><a href="#cb31-1406" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb31-1407"><a href="#cb31-1407" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1408"><a href="#cb31-1408" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> otype <span class="kw">in</span> [<span class="st">'All'</span>] <span class="op">+</span> OwnershipType.ALL_TYPES:</span>
<span id="cb31-1409"><a href="#cb31-1409" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> agg <span class="cf">if</span> otype <span class="op">==</span> <span class="st">'All'</span> <span class="cf">else</span> agg[agg[<span class="st">'owner_type'</span>] <span class="op">==</span> otype]</span>
<span id="cb31-1410"><a href="#cb31-1410" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {<span class="st">'Owner Type'</span>: otype, <span class="st">'N'</span>: <span class="bu">len</span>(subset)}</span>
<span id="cb31-1411"><a href="#cb31-1411" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> turnover_cols:</span>
<span id="cb31-1412"><a href="#cb31-1412" aria-hidden="true" tabindex="-1"></a>            s <span class="op">=</span> subset[col].dropna()</span>
<span id="cb31-1413"><a href="#cb31-1413" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_mean'</span>] <span class="op">=</span> s.mean()</span>
<span id="cb31-1414"><a href="#cb31-1414" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_median'</span>] <span class="op">=</span> s.median()</span>
<span id="cb31-1415"><a href="#cb31-1415" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f'</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_std'</span>] <span class="op">=</span> s.std()</span>
<span id="cb31-1416"><a href="#cb31-1416" aria-hidden="true" tabindex="-1"></a>        results.append(row)</span>
<span id="cb31-1417"><a href="#cb31-1417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1418"><a href="#cb31-1418" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb31-1419"><a href="#cb31-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1420"><a href="#cb31-1420" aria-hidden="true" tabindex="-1"></a><span class="co"># turnover_summary_table(aggregates, holdings)</span></span>
<span id="cb31-1421"><a href="#cb31-1421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1422"><a href="#cb31-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1425"><a href="#cb31-1425" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1426"><a href="#cb31-1426" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-turnover-timeseries</span></span>
<span id="cb31-1427"><a href="#cb31-1427" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Quarterly average turnover ratios (Carhart definition) by ownership type, 2010--2024. Foreign institutional investors exhibit higher turnover than domestic institutions, consistent with shorter investment horizons and more active portfolio management."</span></span>
<span id="cb31-1428"><a href="#cb31-1428" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-1429"><a href="#cb31-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1430"><a href="#cb31-1430" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_turnover_timeseries(</span>
<span id="cb31-1431"><a href="#cb31-1431" aria-hidden="true" tabindex="-1"></a>    aggregates: pd.DataFrame, holdings: pd.DataFrame</span>
<span id="cb31-1432"><a href="#cb31-1432" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb31-1433"><a href="#cb31-1433" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot turnover time series by ownership type."""</span></span>
<span id="cb31-1434"><a href="#cb31-1434" aria-hidden="true" tabindex="-1"></a>    owner_map <span class="op">=</span> (</span>
<span id="cb31-1435"><a href="#cb31-1435" aria-hidden="true" tabindex="-1"></a>        holdings.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'owner_type'</span>]</span>
<span id="cb31-1436"><a href="#cb31-1436" aria-hidden="true" tabindex="-1"></a>        .first().reset_index()</span>
<span id="cb31-1437"><a href="#cb31-1437" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1438"><a href="#cb31-1438" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> aggregates.merge(owner_map, on<span class="op">=</span><span class="st">'shareholder_name'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb31-1439"><a href="#cb31-1439" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1440"><a href="#cb31-1440" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb31-1441"><a href="#cb31-1441" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> otype <span class="kw">in</span> OwnershipType.ALL_INSTITUTIONAL:</span>
<span id="cb31-1442"><a href="#cb31-1442" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> agg[agg[<span class="st">'owner_type'</span>] <span class="op">==</span> otype]</span>
<span id="cb31-1443"><a href="#cb31-1443" aria-hidden="true" tabindex="-1"></a>        qtr_mean <span class="op">=</span> (</span>
<span id="cb31-1444"><a href="#cb31-1444" aria-hidden="true" tabindex="-1"></a>            subset</span>
<span id="cb31-1445"><a href="#cb31-1445" aria-hidden="true" tabindex="-1"></a>            .groupby(pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>))[<span class="st">'turnover1'</span>]</span>
<span id="cb31-1446"><a href="#cb31-1446" aria-hidden="true" tabindex="-1"></a>            .mean()</span>
<span id="cb31-1447"><a href="#cb31-1447" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1448"><a href="#cb31-1448" aria-hidden="true" tabindex="-1"></a>        ax.plot(qtr_mean.index, qtr_mean.values, label<span class="op">=</span>otype,</span>
<span id="cb31-1449"><a href="#cb31-1449" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>OWNER_COLORS.get(otype, <span class="st">'#333'</span>), linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb31-1450"><a href="#cb31-1450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1451"><a href="#cb31-1451" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Quarterly Average Turnover (Carhart)'</span>,</span>
<span id="cb31-1452"><a href="#cb31-1452" aria-hidden="true" tabindex="-1"></a>                 fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1453"><a href="#cb31-1453" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Turnover Ratio'</span>)</span>
<span id="cb31-1454"><a href="#cb31-1454" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb31-1455"><a href="#cb31-1455" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_major_formatter(mticker.PercentFormatter(<span class="fl">1.0</span>))</span>
<span id="cb31-1456"><a href="#cb31-1456" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-1457"><a href="#cb31-1457" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb31-1458"><a href="#cb31-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1459"><a href="#cb31-1459" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_turnover_timeseries(aggregates, holdings)</span></span>
<span id="cb31-1460"><a href="#cb31-1460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1461"><a href="#cb31-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1462"><a href="#cb31-1462" aria-hidden="true" tabindex="-1"></a><span class="fu"># Foreign Ownership Analytics {#sec-institutionalforeign}</span></span>
<span id="cb31-1463"><a href="#cb31-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1464"><a href="#cb31-1464" aria-hidden="true" tabindex="-1"></a>Vietnam's foreign ownership limits create unique analytical dimensions absent from developed market studies.</span>
<span id="cb31-1465"><a href="#cb31-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1466"><a href="#cb31-1466" aria-hidden="true" tabindex="-1"></a><span class="fu">## FOL Utilization {#sec-institutionalfol-util}</span></span>
<span id="cb31-1467"><a href="#cb31-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1468"><a href="#cb31-1468" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1469"><a href="#cb31-1469" aria-hidden="true" tabindex="-1"></a>\text{FOL<span class="sc">\_</span>Util}_{i,t} = \frac{FO_{i,t}}{FOL_i}</span>
<span id="cb31-1470"><a href="#cb31-1470" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fol-util}</span>
<span id="cb31-1471"><a href="#cb31-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1472"><a href="#cb31-1472" aria-hidden="true" tabindex="-1"></a>Stocks with $\text{FOL<span class="sc">\_</span>Util}_{i,t} \to 1$ face mechanical foreign buying restrictions.</span>
<span id="cb31-1473"><a href="#cb31-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1476"><a href="#cb31-1476" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1477"><a href="#cb31-1477" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fol-analytics</span></span>
<span id="cb31-1478"><a href="#cb31-1478" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Foreign Ownership Limit Analytics"</span></span>
<span id="cb31-1479"><a href="#cb31-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1480"><a href="#cb31-1480" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_fol_analytics(</span>
<span id="cb31-1481"><a href="#cb31-1481" aria-hidden="true" tabindex="-1"></a>    foreign_ownership: pd.DataFrame,</span>
<span id="cb31-1482"><a href="#cb31-1482" aria-hidden="true" tabindex="-1"></a>    company_profile: pd.DataFrame,</span>
<span id="cb31-1483"><a href="#cb31-1483" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1484"><a href="#cb31-1484" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute FOL utilization and related metrics."""</span></span>
<span id="cb31-1485"><a href="#cb31-1485" aria-hidden="true" tabindex="-1"></a>    fo <span class="op">=</span> foreign_ownership.copy()</span>
<span id="cb31-1486"><a href="#cb31-1486" aria-hidden="true" tabindex="-1"></a>    fo <span class="op">=</span> fo.merge(</span>
<span id="cb31-1487"><a href="#cb31-1487" aria-hidden="true" tabindex="-1"></a>        company_profile[[<span class="st">'ticker'</span>, <span class="st">'fol_limit'</span>]].drop_duplicates(),</span>
<span id="cb31-1488"><a href="#cb31-1488" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'ticker'</span>, how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb31-1489"><a href="#cb31-1489" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1490"><a href="#cb31-1490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1491"><a href="#cb31-1491" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'fol_utilization'</span>] <span class="op">=</span> fo[<span class="st">'foreign_pct'</span>] <span class="op">/</span> fo[<span class="st">'fol_limit'</span>]</span>
<span id="cb31-1492"><a href="#cb31-1492" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'foreign_room'</span>] <span class="op">=</span> fo[<span class="st">'fol_limit'</span>] <span class="op">-</span> fo[<span class="st">'foreign_pct'</span>]</span>
<span id="cb31-1493"><a href="#cb31-1493" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'fol_binding'</span>] <span class="op">=</span> (fo[<span class="st">'fol_utilization'</span>] <span class="op">&gt;=</span> <span class="fl">0.98</span>)</span>
<span id="cb31-1494"><a href="#cb31-1494" aria-hidden="true" tabindex="-1"></a>    fo[<span class="st">'fol_category'</span>] <span class="op">=</span> pd.cut(</span>
<span id="cb31-1495"><a href="#cb31-1495" aria-hidden="true" tabindex="-1"></a>        fo[<span class="st">'fol_utilization'</span>],</span>
<span id="cb31-1496"><a href="#cb31-1496" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>, <span class="fl">1.0</span>, <span class="bu">float</span>(<span class="st">'inf'</span>)],</span>
<span id="cb31-1497"><a href="#cb31-1497" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>[<span class="st">'&lt;25%'</span>, <span class="st">'25-50%'</span>, <span class="st">'50-75%'</span>, <span class="st">'75-95%'</span>,</span>
<span id="cb31-1498"><a href="#cb31-1498" aria-hidden="true" tabindex="-1"></a>                <span class="st">'95-100%'</span>, <span class="st">'&gt;100%'</span>]</span>
<span id="cb31-1499"><a href="#cb31-1499" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1500"><a href="#cb31-1500" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fo</span>
<span id="cb31-1501"><a href="#cb31-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1502"><a href="#cb31-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1503"><a href="#cb31-1503" aria-hidden="true" tabindex="-1"></a><span class="fu">## Room Premium Regression {#sec-institutionalroom-premium}</span></span>
<span id="cb31-1504"><a href="#cb31-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1505"><a href="#cb31-1505" aria-hidden="true" tabindex="-1"></a>When foreign ownership approaches the FOL, remaining "room" becomes scarce. We model:</span>
<span id="cb31-1506"><a href="#cb31-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1507"><a href="#cb31-1507" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1508"><a href="#cb31-1508" aria-hidden="true" tabindex="-1"></a>r_{i,t+1} = \alpha + \beta_1 \cdot \text{FOL<span class="sc">\_</span>Util}_{i,t} +</span>
<span id="cb31-1509"><a href="#cb31-1509" aria-hidden="true" tabindex="-1"></a>\beta_2 \cdot \text{FOL<span class="sc">\_</span>Util}_{i,t}^2 + \gamma \cdot X_{i,t} + \varepsilon_{i,t}</span>
<span id="cb31-1510"><a href="#cb31-1510" aria-hidden="true" tabindex="-1"></a>$$ {#eq-room-premium}</span>
<span id="cb31-1511"><a href="#cb31-1511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1512"><a href="#cb31-1512" aria-hidden="true" tabindex="-1"></a>The quadratic term captures nonlinear acceleration of the premium as ownership approaches the limit.</span>
<span id="cb31-1513"><a href="#cb31-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1516"><a href="#cb31-1516" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1517"><a href="#cb31-1517" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: room-premium-regression</span></span>
<span id="cb31-1518"><a href="#cb31-1518" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "FOL Room Premium Regression"</span></span>
<span id="cb31-1519"><a href="#cb31-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1520"><a href="#cb31-1520" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_room_premium(</span>
<span id="cb31-1521"><a href="#cb31-1521" aria-hidden="true" tabindex="-1"></a>    fol_analytics: pd.DataFrame,</span>
<span id="cb31-1522"><a href="#cb31-1522" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb31-1523"><a href="#cb31-1523" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb31-1524"><a href="#cb31-1524" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate foreign ownership room premium via panel regression."""</span></span>
<span id="cb31-1525"><a href="#cb31-1525" aria-hidden="true" tabindex="-1"></a>    fol_q <span class="op">=</span> (</span>
<span id="cb31-1526"><a href="#cb31-1526" aria-hidden="true" tabindex="-1"></a>        fol_analytics</span>
<span id="cb31-1527"><a href="#cb31-1527" aria-hidden="true" tabindex="-1"></a>        .assign(qdate<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>))</span>
<span id="cb31-1528"><a href="#cb31-1528" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">'ticker'</span>, <span class="st">'qdate'</span>])</span>
<span id="cb31-1529"><a href="#cb31-1529" aria-hidden="true" tabindex="-1"></a>        .agg(fol_utilization<span class="op">=</span>(<span class="st">'fol_utilization'</span>, <span class="st">'last'</span>),</span>
<span id="cb31-1530"><a href="#cb31-1530" aria-hidden="true" tabindex="-1"></a>             foreign_room<span class="op">=</span>(<span class="st">'foreign_room'</span>, <span class="st">'last'</span>))</span>
<span id="cb31-1531"><a href="#cb31-1531" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-1532"><a href="#cb31-1532" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1533"><a href="#cb31-1533" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1534"><a href="#cb31-1534" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> fol_q.merge(</span>
<span id="cb31-1535"><a href="#cb31-1535" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'mcap'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb31-1536"><a href="#cb31-1536" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>], how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1537"><a href="#cb31-1537" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1538"><a href="#cb31-1538" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1539"><a href="#cb31-1539" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'mcap'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb31-1540"><a href="#cb31-1540" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'fol_util_sq'</span>] <span class="op">=</span> panel[<span class="st">'fol_utilization'</span>] <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb31-1541"><a href="#cb31-1541" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> panel.dropna(subset<span class="op">=</span>[<span class="st">'qret'</span>, <span class="st">'fol_utilization'</span>, <span class="st">'log_mcap'</span>])</span>
<span id="cb31-1542"><a href="#cb31-1542" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1543"><a href="#cb31-1543" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> panel[[<span class="st">'fol_utilization'</span>, <span class="st">'fol_util_sq'</span>, <span class="st">'log_mcap'</span>]]</span>
<span id="cb31-1544"><a href="#cb31-1544" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb31-1545"><a href="#cb31-1545" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> panel[<span class="st">'qret'</span>]</span>
<span id="cb31-1546"><a href="#cb31-1546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1547"><a href="#cb31-1547" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(y, X).fit(</span>
<span id="cb31-1548"><a href="#cb31-1548" aria-hidden="true" tabindex="-1"></a>        cov_type<span class="op">=</span><span class="st">'cluster'</span>, cov_kwds<span class="op">=</span>{<span class="st">'groups'</span>: panel[<span class="st">'ticker'</span>]}</span>
<span id="cb31-1549"><a href="#cb31-1549" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1550"><a href="#cb31-1550" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'model'</span>: model, <span class="st">'n_obs'</span>: <span class="bu">len</span>(panel)}</span>
<span id="cb31-1551"><a href="#cb31-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1552"><a href="#cb31-1552" aria-hidden="true" tabindex="-1"></a><span class="co"># results = estimate_room_premium(fol_analytics, price_q)</span></span>
<span id="cb31-1553"><a href="#cb31-1553" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1554"><a href="#cb31-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1557"><a href="#cb31-1557" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1558"><a href="#cb31-1558" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fol-distribution</span></span>
<span id="cb31-1559"><a href="#cb31-1559" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of FOL utilization across Vietnamese listed stocks. The bimodal distribution reflects two populations: stocks with minimal foreign interest (left mode) and stocks approaching their FOL ceiling (right mode)."</span></span>
<span id="cb31-1560"><a href="#cb31-1560" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-1561"><a href="#cb31-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1562"><a href="#cb31-1562" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_fol_utilization(fol_analytics: pd.DataFrame):</span>
<span id="cb31-1563"><a href="#cb31-1563" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot FOL utilization distribution."""</span></span>
<span id="cb31-1564"><a href="#cb31-1564" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> (</span>
<span id="cb31-1565"><a href="#cb31-1565" aria-hidden="true" tabindex="-1"></a>        fol_analytics.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb31-1566"><a href="#cb31-1566" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'ticker'</span>).last().reset_index()</span>
<span id="cb31-1567"><a href="#cb31-1567" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1568"><a href="#cb31-1568" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1569"><a href="#cb31-1569" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb31-1570"><a href="#cb31-1570" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1571"><a href="#cb31-1571" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].hist(latest[<span class="st">'fol_utilization'</span>].dropna(), bins<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb31-1572"><a href="#cb31-1572" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'#1f77b4'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb31-1573"><a href="#cb31-1573" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">0.95</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb31-1574"><a href="#cb31-1574" aria-hidden="true" tabindex="-1"></a>                     label<span class="op">=</span><span class="st">'95% threshold'</span>)</span>
<span id="cb31-1575"><a href="#cb31-1575" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: FOL Utilization Distribution'</span>,</span>
<span id="cb31-1576"><a href="#cb31-1576" aria-hidden="true" tabindex="-1"></a>                       fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1577"><a href="#cb31-1577" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'FOL Utilization Ratio'</span>)</span>
<span id="cb31-1578"><a href="#cb31-1578" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Stocks'</span>)</span>
<span id="cb31-1579"><a href="#cb31-1579" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].legend()</span>
<span id="cb31-1580"><a href="#cb31-1580" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1581"><a href="#cb31-1581" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> exch <span class="kw">in</span> [<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCOM'</span>]:</span>
<span id="cb31-1582"><a href="#cb31-1582" aria-hidden="true" tabindex="-1"></a>        sub <span class="op">=</span> latest[latest.get(<span class="st">'exchange'</span>) <span class="op">==</span> exch]</span>
<span id="cb31-1583"><a href="#cb31-1583" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sub) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-1584"><a href="#cb31-1584" aria-hidden="true" tabindex="-1"></a>            axes[<span class="dv">1</span>].hist(sub[<span class="st">'fol_utilization'</span>].dropna(), bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb31-1585"><a href="#cb31-1585" aria-hidden="true" tabindex="-1"></a>                        alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>exch,</span>
<span id="cb31-1586"><a href="#cb31-1586" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>EXCHANGE_COLORS.get(exch, <span class="st">'#333'</span>))</span>
<span id="cb31-1587"><a href="#cb31-1587" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: By Exchange'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1588"><a href="#cb31-1588" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'FOL Utilization Ratio'</span>)</span>
<span id="cb31-1589"><a href="#cb31-1589" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].legend()</span>
<span id="cb31-1590"><a href="#cb31-1590" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1591"><a href="#cb31-1591" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-1592"><a href="#cb31-1592" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb31-1593"><a href="#cb31-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1594"><a href="#cb31-1594" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_fol_utilization(fol_analytics)</span></span>
<span id="cb31-1595"><a href="#cb31-1595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1596"><a href="#cb31-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1597"><a href="#cb31-1597" aria-hidden="true" tabindex="-1"></a><span class="fu"># Complete Pipeline {#sec-institutionalpipeline}</span></span>
<span id="cb31-1598"><a href="#cb31-1598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1599"><a href="#cb31-1599" aria-hidden="true" tabindex="-1"></a>We integrate all steps into a single end-to-end function:</span>
<span id="cb31-1600"><a href="#cb31-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1603"><a href="#cb31-1603" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1604"><a href="#cb31-1604" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: complete-pipeline</span></span>
<span id="cb31-1605"><a href="#cb31-1605" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Complete End-to-End Pipeline"</span></span>
<span id="cb31-1606"><a href="#cb31-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1607"><a href="#cb31-1607" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_complete_pipeline(</span>
<span id="cb31-1608"><a href="#cb31-1608" aria-hidden="true" tabindex="-1"></a>    dc: <span class="st">'DataCoreReader'</span>,</span>
<span id="cb31-1609"><a href="#cb31-1609" aria-hidden="true" tabindex="-1"></a>    begdate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2010-01-01'</span>,</span>
<span id="cb31-1610"><a href="#cb31-1610" aria-hidden="true" tabindex="-1"></a>    enddate: <span class="bu">str</span> <span class="op">=</span> <span class="st">'2024-12-31'</span>,</span>
<span id="cb31-1611"><a href="#cb31-1611" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, pd.DataFrame]:</span>
<span id="cb31-1612"><a href="#cb31-1612" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1613"><a href="#cb31-1613" aria-hidden="true" tabindex="-1"></a><span class="co">    Execute the complete institutional ownership analytics pipeline.</span></span>
<span id="cb31-1614"><a href="#cb31-1614" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1615"><a href="#cb31-1615" aria-hidden="true" tabindex="-1"></a><span class="co">    Steps:</span></span>
<span id="cb31-1616"><a href="#cb31-1616" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Build corporate action adjustment factors</span></span>
<span id="cb31-1617"><a href="#cb31-1617" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Process stock prices</span></span>
<span id="cb31-1618"><a href="#cb31-1618" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Construct holdings panel (Steps 2-4)</span></span>
<span id="cb31-1619"><a href="#cb31-1619" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Compute IO metrics</span></span>
<span id="cb31-1620"><a href="#cb31-1620" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Compute institutional trades (Step 5)</span></span>
<span id="cb31-1621"><a href="#cb31-1621" aria-hidden="true" tabindex="-1"></a><span class="co">    6. Compute portfolio assets and returns (Step 6a)</span></span>
<span id="cb31-1622"><a href="#cb31-1622" aria-hidden="true" tabindex="-1"></a><span class="co">    7. Compute aggregate buys, sales, trade gains (Step 6b)</span></span>
<span id="cb31-1623"><a href="#cb31-1623" aria-hidden="true" tabindex="-1"></a><span class="co">    8. Compute net flows and turnover (Step 7)</span></span>
<span id="cb31-1624"><a href="#cb31-1624" aria-hidden="true" tabindex="-1"></a><span class="co">    9. Compute foreign ownership analytics</span></span>
<span id="cb31-1625"><a href="#cb31-1625" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1626"><a href="#cb31-1626" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns dict of all output DataFrames.</span></span>
<span id="cb31-1627"><a href="#cb31-1627" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1628"><a href="#cb31-1628" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb31-1629"><a href="#cb31-1629" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"INSTITUTIONAL TRADES, FLOWS, AND TURNOVER PIPELINE"</span>)</span>
<span id="cb31-1630"><a href="#cb31-1630" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sample: </span><span class="sc">{</span>begdate<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>enddate<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1631"><a href="#cb31-1631" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb31-1632"><a href="#cb31-1632" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1633"><a href="#cb31-1633" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/9] Building adjustment factors..."</span>)</span>
<span id="cb31-1634"><a href="#cb31-1634" aria-hidden="true" tabindex="-1"></a>    adj_factors <span class="op">=</span> build_adjustment_factors(dc.corporate_actions)</span>
<span id="cb31-1635"><a href="#cb31-1635" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1636"><a href="#cb31-1636" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/9] Processing stock prices..."</span>)</span>
<span id="cb31-1637"><a href="#cb31-1637" aria-hidden="true" tabindex="-1"></a>    price_q, qret <span class="op">=</span> process_prices(</span>
<span id="cb31-1638"><a href="#cb31-1638" aria-hidden="true" tabindex="-1"></a>        dc.prices, adj_factors, begdate, enddate</span>
<span id="cb31-1639"><a href="#cb31-1639" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1640"><a href="#cb31-1640" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1641"><a href="#cb31-1641" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/9] Building holdings panel..."</span>)</span>
<span id="cb31-1642"><a href="#cb31-1642" aria-hidden="true" tabindex="-1"></a>    holdings <span class="op">=</span> build_holdings_panel(</span>
<span id="cb31-1643"><a href="#cb31-1643" aria-hidden="true" tabindex="-1"></a>        dc.ownership, adj_factors, price_q,</span>
<span id="cb31-1644"><a href="#cb31-1644" aria-hidden="true" tabindex="-1"></a>        dc.company_profile, begdate, enddate</span>
<span id="cb31-1645"><a href="#cb31-1645" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1646"><a href="#cb31-1646" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1647"><a href="#cb31-1647" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[4/9] Computing ownership metrics..."</span>)</span>
<span id="cb31-1648"><a href="#cb31-1648" aria-hidden="true" tabindex="-1"></a>    io_ratios <span class="op">=</span> compute_io_ratios(holdings, price_q)</span>
<span id="cb31-1649"><a href="#cb31-1649" aria-hidden="true" tabindex="-1"></a>    hhi <span class="op">=</span> compute_hhi(holdings)</span>
<span id="cb31-1650"><a href="#cb31-1650" aria-hidden="true" tabindex="-1"></a>    breadth <span class="op">=</span> compute_breadth(holdings)</span>
<span id="cb31-1651"><a href="#cb31-1651" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1652"><a href="#cb31-1652" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[5/9] Computing institutional trades..."</span>)</span>
<span id="cb31-1653"><a href="#cb31-1653" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> compute_trades(holdings, adj_factors)</span>
<span id="cb31-1654"><a href="#cb31-1654" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1655"><a href="#cb31-1655" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[6/9] Computing portfolio assets..."</span>)</span>
<span id="cb31-1656"><a href="#cb31-1656" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> compute_assets_and_returns(holdings, price_q)</span>
<span id="cb31-1657"><a href="#cb31-1657" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1658"><a href="#cb31-1658" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[7/9] Computing aggregate buys and sales..."</span>)</span>
<span id="cb31-1659"><a href="#cb31-1659" aria-hidden="true" tabindex="-1"></a>    flows <span class="op">=</span> compute_buys_sales(trades, price_q)</span>
<span id="cb31-1660"><a href="#cb31-1660" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1661"><a href="#cb31-1661" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[8/9] Computing net flows and turnover..."</span>)</span>
<span id="cb31-1662"><a href="#cb31-1662" aria-hidden="true" tabindex="-1"></a>    aggregates <span class="op">=</span> compute_aggregates(holdings, assets, flows)</span>
<span id="cb31-1663"><a href="#cb31-1663" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1664"><a href="#cb31-1664" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[9/9] Computing foreign ownership analytics..."</span>)</span>
<span id="cb31-1665"><a href="#cb31-1665" aria-hidden="true" tabindex="-1"></a>    fol_analytics <span class="op">=</span> compute_fol_analytics(</span>
<span id="cb31-1666"><a href="#cb31-1666" aria-hidden="true" tabindex="-1"></a>        dc.foreign_ownership, dc.company_profile</span>
<span id="cb31-1667"><a href="#cb31-1667" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1668"><a href="#cb31-1668" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1669"><a href="#cb31-1669" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb31-1670"><a href="#cb31-1670" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"PIPELINE COMPLETE"</span>)</span>
<span id="cb31-1671"><a href="#cb31-1671" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb31-1672"><a href="#cb31-1672" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1673"><a href="#cb31-1673" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb31-1674"><a href="#cb31-1674" aria-hidden="true" tabindex="-1"></a>        <span class="st">'price_q'</span>: price_q, <span class="st">'holdings'</span>: holdings,</span>
<span id="cb31-1675"><a href="#cb31-1675" aria-hidden="true" tabindex="-1"></a>        <span class="st">'io_ratios'</span>: io_ratios, <span class="st">'hhi'</span>: hhi,</span>
<span id="cb31-1676"><a href="#cb31-1676" aria-hidden="true" tabindex="-1"></a>        <span class="st">'breadth'</span>: breadth, <span class="st">'trades'</span>: trades,</span>
<span id="cb31-1677"><a href="#cb31-1677" aria-hidden="true" tabindex="-1"></a>        <span class="st">'assets'</span>: assets, <span class="st">'flows'</span>: flows,</span>
<span id="cb31-1678"><a href="#cb31-1678" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aggregates'</span>: aggregates, <span class="st">'fol_analytics'</span>: fol_analytics,</span>
<span id="cb31-1679"><a href="#cb31-1679" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1680"><a href="#cb31-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1681"><a href="#cb31-1681" aria-hidden="true" tabindex="-1"></a><span class="co"># dc = DataCoreReader('/path/to/datacore_data', file_format='parquet')</span></span>
<span id="cb31-1682"><a href="#cb31-1682" aria-hidden="true" tabindex="-1"></a><span class="co"># results = run_complete_pipeline(dc, '2010-01-01', '2024-12-31')</span></span>
<span id="cb31-1683"><a href="#cb31-1683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1684"><a href="#cb31-1684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1685"><a href="#cb31-1685" aria-hidden="true" tabindex="-1"></a><span class="fu"># Advanced Extensions {#sec-institutionalextensions}</span></span>
<span id="cb31-1686"><a href="#cb31-1686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1687"><a href="#cb31-1687" aria-hidden="true" tabindex="-1"></a><span class="fu">## Herding Measures {#sec-institutionalherding}</span></span>
<span id="cb31-1688"><a href="#cb31-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1689"><a href="#cb31-1689" aria-hidden="true" tabindex="-1"></a>Following @sias2004institutional, the Lakonishok-Shleifer-Vishny herding measure is:</span>
<span id="cb31-1690"><a href="#cb31-1690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1691"><a href="#cb31-1691" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1692"><a href="#cb31-1692" aria-hidden="true" tabindex="-1"></a>HM_{i,t} = \left|\frac{B_{i,t}}{B_{i,t} + S_{i,t}} - p_t\right|</span>
<span id="cb31-1693"><a href="#cb31-1693" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>E\left<span class="co">[</span><span class="ot">\left|\frac{B_{i,t}}{B_{i,t} + S_{i,t}} - p_t\right|\right</span><span class="co">]</span></span>
<span id="cb31-1694"><a href="#cb31-1694" aria-hidden="true" tabindex="-1"></a>$$ {#eq-herding}</span>
<span id="cb31-1695"><a href="#cb31-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1696"><a href="#cb31-1696" aria-hidden="true" tabindex="-1"></a>where $B_{i,t}$ is the number of managers buying stock $i$ in quarter $t$, $S_{i,t}$ the number selling, and $p_t$ the expected buyer proportion under independent trading.</span>
<span id="cb31-1697"><a href="#cb31-1697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1700"><a href="#cb31-1700" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1701"><a href="#cb31-1701" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: herding-measure</span></span>
<span id="cb31-1702"><a href="#cb31-1702" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "LSV Herding Measure"</span></span>
<span id="cb31-1703"><a href="#cb31-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1704"><a href="#cb31-1704" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_lsv_herding(</span>
<span id="cb31-1705"><a href="#cb31-1705" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame,</span>
<span id="cb31-1706"><a href="#cb31-1706" aria-hidden="true" tabindex="-1"></a>    min_traders: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb31-1707"><a href="#cb31-1707" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1708"><a href="#cb31-1708" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute LSV herding measure for each stock-quarter."""</span></span>
<span id="cb31-1709"><a href="#cb31-1709" aria-hidden="true" tabindex="-1"></a>    tc <span class="op">=</span> (</span>
<span id="cb31-1710"><a href="#cb31-1710" aria-hidden="true" tabindex="-1"></a>        trades.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1711"><a href="#cb31-1711" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> g: pd.Series({</span>
<span id="cb31-1712"><a href="#cb31-1712" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_buyers'</span>: (g[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">sum</span>(),</span>
<span id="cb31-1713"><a href="#cb31-1713" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_sellers'</span>: (g[<span class="st">'trade'</span>] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>(),</span>
<span id="cb31-1714"><a href="#cb31-1714" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_traders'</span>: <span class="bu">len</span>(g),</span>
<span id="cb31-1715"><a href="#cb31-1715" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb31-1716"><a href="#cb31-1716" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-1717"><a href="#cb31-1717" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1718"><a href="#cb31-1718" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1719"><a href="#cb31-1719" aria-hidden="true" tabindex="-1"></a>    tc <span class="op">=</span> tc[tc[<span class="st">'n_traders'</span>] <span class="op">&gt;=</span> min_traders].copy()</span>
<span id="cb31-1720"><a href="#cb31-1720" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'buy_prop'</span>] <span class="op">=</span> tc[<span class="st">'n_buyers'</span>] <span class="op">/</span> tc[<span class="st">'n_traders'</span>]</span>
<span id="cb31-1721"><a href="#cb31-1721" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'p_t'</span>] <span class="op">=</span> tc.groupby(<span class="st">'rdate'</span>)[<span class="st">'buy_prop'</span>].transform(<span class="st">'mean'</span>)</span>
<span id="cb31-1722"><a href="#cb31-1722" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'raw_hm'</span>] <span class="op">=</span> (tc[<span class="st">'buy_prop'</span>] <span class="op">-</span> tc[<span class="st">'p_t'</span>]).<span class="bu">abs</span>()</span>
<span id="cb31-1723"><a href="#cb31-1723" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1724"><a href="#cb31-1724" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> expected_abs_deviation(row):</span>
<span id="cb31-1725"><a href="#cb31-1725" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">int</span>(row[<span class="st">'n_traders'</span>])</span>
<span id="cb31-1726"><a href="#cb31-1726" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> row[<span class="st">'p_t'</span>]</span>
<span id="cb31-1727"><a href="#cb31-1727" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> p <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> p <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb31-1728"><a href="#cb31-1728" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb31-1729"><a href="#cb31-1729" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> scipy.stats <span class="im">import</span> binom</span>
<span id="cb31-1730"><a href="#cb31-1730" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> np.arange(<span class="dv">0</span>, n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb31-1731"><a href="#cb31-1731" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> binom.pmf(k, n, p)</span>
<span id="cb31-1732"><a href="#cb31-1732" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(k <span class="op">/</span> n <span class="op">-</span> p) <span class="op">*</span> probs)</span>
<span id="cb31-1733"><a href="#cb31-1733" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1734"><a href="#cb31-1734" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'expected_hm'</span>] <span class="op">=</span> tc.<span class="bu">apply</span>(expected_abs_deviation, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-1735"><a href="#cb31-1735" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'herding'</span>] <span class="op">=</span> tc[<span class="st">'raw_hm'</span>] <span class="op">-</span> tc[<span class="st">'expected_hm'</span>]</span>
<span id="cb31-1736"><a href="#cb31-1736" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1737"><a href="#cb31-1737" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'buy_herding'</span>] <span class="op">=</span> np.where(</span>
<span id="cb31-1738"><a href="#cb31-1738" aria-hidden="true" tabindex="-1"></a>        tc[<span class="st">'buy_prop'</span>] <span class="op">&gt;</span> tc[<span class="st">'p_t'</span>], tc[<span class="st">'herding'</span>], np.nan</span>
<span id="cb31-1739"><a href="#cb31-1739" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1740"><a href="#cb31-1740" aria-hidden="true" tabindex="-1"></a>    tc[<span class="st">'sell_herding'</span>] <span class="op">=</span> np.where(</span>
<span id="cb31-1741"><a href="#cb31-1741" aria-hidden="true" tabindex="-1"></a>        tc[<span class="st">'buy_prop'</span>] <span class="op">&lt;</span> tc[<span class="st">'p_t'</span>], tc[<span class="st">'herding'</span>], np.nan</span>
<span id="cb31-1742"><a href="#cb31-1742" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1743"><a href="#cb31-1743" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1744"><a href="#cb31-1744" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tc[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'n_buyers'</span>, <span class="st">'n_sellers'</span>,</span>
<span id="cb31-1745"><a href="#cb31-1745" aria-hidden="true" tabindex="-1"></a>               <span class="st">'n_traders'</span>, <span class="st">'herding'</span>, <span class="st">'buy_herding'</span>, <span class="st">'sell_herding'</span>]]</span>
<span id="cb31-1746"><a href="#cb31-1746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1747"><a href="#cb31-1747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1748"><a href="#cb31-1748" aria-hidden="true" tabindex="-1"></a><span class="fu">## Demand Persistence {#sec-institutionalpersistence}</span></span>
<span id="cb31-1749"><a href="#cb31-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1750"><a href="#cb31-1750" aria-hidden="true" tabindex="-1"></a>@sias2004institutional showed institutional demand is persistent:</span>
<span id="cb31-1751"><a href="#cb31-1751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1752"><a href="#cb31-1752" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1753"><a href="#cb31-1753" aria-hidden="true" tabindex="-1"></a>\rho_t = \text{Corr}\left(\Delta IO_{i,t},\, \Delta IO_{i,t-1}\right)</span>
<span id="cb31-1754"><a href="#cb31-1754" aria-hidden="true" tabindex="-1"></a>$$ {#eq-persistence}</span>
<span id="cb31-1755"><a href="#cb31-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1758"><a href="#cb31-1758" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1759"><a href="#cb31-1759" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: demand-persistence</span></span>
<span id="cb31-1760"><a href="#cb31-1760" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Institutional Demand Persistence"</span></span>
<span id="cb31-1761"><a href="#cb31-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1762"><a href="#cb31-1762" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_demand_persistence(io_ratios: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1763"><a href="#cb31-1763" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Rolling cross-sectional correlation of IO changes."""</span></span>
<span id="cb31-1764"><a href="#cb31-1764" aria-hidden="true" tabindex="-1"></a>    io <span class="op">=</span> io_ratios[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'io_total_inst'</span>]].copy()</span>
<span id="cb31-1765"><a href="#cb31-1765" aria-hidden="true" tabindex="-1"></a>    io <span class="op">=</span> io.sort_values([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1766"><a href="#cb31-1766" aria-hidden="true" tabindex="-1"></a>    io[<span class="st">'dio'</span>] <span class="op">=</span> io.groupby(<span class="st">'ticker'</span>)[<span class="st">'io_total_inst'</span>].diff()</span>
<span id="cb31-1767"><a href="#cb31-1767" aria-hidden="true" tabindex="-1"></a>    io[<span class="st">'lag_dio'</span>] <span class="op">=</span> io.groupby(<span class="st">'ticker'</span>)[<span class="st">'dio'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-1768"><a href="#cb31-1768" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1769"><a href="#cb31-1769" aria-hidden="true" tabindex="-1"></a>    persistence <span class="op">=</span> (</span>
<span id="cb31-1770"><a href="#cb31-1770" aria-hidden="true" tabindex="-1"></a>        io.dropna(subset<span class="op">=</span>[<span class="st">'dio'</span>, <span class="st">'lag_dio'</span>])</span>
<span id="cb31-1771"><a href="#cb31-1771" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'rdate'</span>)</span>
<span id="cb31-1772"><a href="#cb31-1772" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> g: g[<span class="st">'dio'</span>].corr(g[<span class="st">'lag_dio'</span>]))</span>
<span id="cb31-1773"><a href="#cb31-1773" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-1774"><a href="#cb31-1774" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">'persistence'</span>})</span>
<span id="cb31-1775"><a href="#cb31-1775" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1776"><a href="#cb31-1776" aria-hidden="true" tabindex="-1"></a>    persistence <span class="op">=</span> persistence.sort_values(<span class="st">'rdate'</span>)</span>
<span id="cb31-1777"><a href="#cb31-1777" aria-hidden="true" tabindex="-1"></a>    persistence[<span class="st">'persistence_ma'</span>] <span class="op">=</span> (</span>
<span id="cb31-1778"><a href="#cb31-1778" aria-hidden="true" tabindex="-1"></a>        persistence[<span class="st">'persistence'</span>].rolling(window<span class="op">=</span><span class="dv">20</span>, min_periods<span class="op">=</span><span class="dv">4</span>).mean()</span>
<span id="cb31-1779"><a href="#cb31-1779" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1780"><a href="#cb31-1780" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> persistence</span>
<span id="cb31-1781"><a href="#cb31-1781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1782"><a href="#cb31-1782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1785"><a href="#cb31-1785" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1786"><a href="#cb31-1786" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-persistence</span></span>
<span id="cb31-1787"><a href="#cb31-1787" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-sectional persistence of institutional demand in Vietnam (rolling 5-year average). Positive values indicate momentum-like institutional trading patterns."</span></span>
<span id="cb31-1788"><a href="#cb31-1788" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-1789"><a href="#cb31-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1790"><a href="#cb31-1790" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_demand_persistence(persistence: pd.DataFrame):</span>
<span id="cb31-1791"><a href="#cb31-1791" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb31-1792"><a href="#cb31-1792" aria-hidden="true" tabindex="-1"></a>    ax.bar(persistence[<span class="st">'rdate'</span>], persistence[<span class="st">'persistence'</span>],</span>
<span id="cb31-1793"><a href="#cb31-1793" aria-hidden="true" tabindex="-1"></a>           width<span class="op">=</span><span class="dv">80</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>, label<span class="op">=</span><span class="st">'Quarterly'</span>)</span>
<span id="cb31-1794"><a href="#cb31-1794" aria-hidden="true" tabindex="-1"></a>    ax.plot(persistence[<span class="st">'rdate'</span>], persistence[<span class="st">'persistence_ma'</span>],</span>
<span id="cb31-1795"><a href="#cb31-1795" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#d62728'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Rolling Average'</span>)</span>
<span id="cb31-1796"><a href="#cb31-1796" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-1797"><a href="#cb31-1797" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Persistence of Institutional Demand'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-1798"><a href="#cb31-1798" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Cross-Sectional Correlation'</span>)</span>
<span id="cb31-1799"><a href="#cb31-1799" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb31-1800"><a href="#cb31-1800" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-1801"><a href="#cb31-1801" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb31-1802"><a href="#cb31-1802" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1803"><a href="#cb31-1803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1804"><a href="#cb31-1804" aria-hidden="true" tabindex="-1"></a><span class="fu">## Information Content of Trades {#sec-institutionalinfo-content}</span></span>
<span id="cb31-1805"><a href="#cb31-1805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1806"><a href="#cb31-1806" aria-hidden="true" tabindex="-1"></a>Following @alexander2007does, the InfoTrade ratio measures the proportion of dollar trading from entry/exit decisions vs. position adjustments:</span>
<span id="cb31-1807"><a href="#cb31-1807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1808"><a href="#cb31-1808" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1809"><a href="#cb31-1809" aria-hidden="true" tabindex="-1"></a>\text{InfoTrade}_{i,t} = \frac{</span>
<span id="cb31-1810"><a href="#cb31-1810" aria-hidden="true" tabindex="-1"></a>\sum_{j: BS \in <span class="sc">\{</span>+1,-1<span class="sc">\}</span>} |\Delta h_{j,i,t}| \cdot P_{i,t}</span>
<span id="cb31-1811"><a href="#cb31-1811" aria-hidden="true" tabindex="-1"></a>}{</span>
<span id="cb31-1812"><a href="#cb31-1812" aria-hidden="true" tabindex="-1"></a>\sum_j |\Delta h_{j,i,t}| \cdot P_{i,t}</span>
<span id="cb31-1813"><a href="#cb31-1813" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-1814"><a href="#cb31-1814" aria-hidden="true" tabindex="-1"></a>$$ {#eq-info-trade}</span>
<span id="cb31-1815"><a href="#cb31-1815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1818"><a href="#cb31-1818" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1819"><a href="#cb31-1819" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: info-trade-ratio</span></span>
<span id="cb31-1820"><a href="#cb31-1820" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Information Content of Trades"</span></span>
<span id="cb31-1821"><a href="#cb31-1821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1822"><a href="#cb31-1822" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_info_trade_ratio(</span>
<span id="cb31-1823"><a href="#cb31-1823" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame, price_q: pd.DataFrame</span>
<span id="cb31-1824"><a href="#cb31-1824" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1825"><a href="#cb31-1825" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute info trade ratio for each stock-quarter."""</span></span>
<span id="cb31-1826"><a href="#cb31-1826" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb31-1827"><a href="#cb31-1827" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb31-1828"><a href="#cb31-1828" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-1829"><a href="#cb31-1829" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-1830"><a href="#cb31-1830" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1831"><a href="#cb31-1831" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1832"><a href="#cb31-1832" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'dollar_trade'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>].<span class="bu">abs</span>() <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-1833"><a href="#cb31-1833" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'is_discrete'</span>] <span class="op">=</span> _t[<span class="st">'buysale'</span>].isin([<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb31-1834"><a href="#cb31-1834" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1835"><a href="#cb31-1835" aria-hidden="true" tabindex="-1"></a>    info <span class="op">=</span> _t.groupby([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>]).<span class="bu">apply</span>(</span>
<span id="cb31-1836"><a href="#cb31-1836" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> g: pd.Series({</span>
<span id="cb31-1837"><a href="#cb31-1837" aria-hidden="true" tabindex="-1"></a>            <span class="st">'discrete_vol'</span>: g.loc[g[<span class="st">'is_discrete'</span>], <span class="st">'dollar_trade'</span>].<span class="bu">sum</span>(),</span>
<span id="cb31-1838"><a href="#cb31-1838" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_vol'</span>: g[<span class="st">'dollar_trade'</span>].<span class="bu">sum</span>(),</span>
<span id="cb31-1839"><a href="#cb31-1839" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb31-1840"><a href="#cb31-1840" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb31-1841"><a href="#cb31-1841" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1842"><a href="#cb31-1842" aria-hidden="true" tabindex="-1"></a>    info[<span class="st">'info_trade_ratio'</span>] <span class="op">=</span> (</span>
<span id="cb31-1843"><a href="#cb31-1843" aria-hidden="true" tabindex="-1"></a>        info[<span class="st">'discrete_vol'</span>] <span class="op">/</span> info[<span class="st">'total_vol'</span>]</span>
<span id="cb31-1844"><a href="#cb31-1844" aria-hidden="true" tabindex="-1"></a>    ).clip(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb31-1845"><a href="#cb31-1845" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> info</span>
<span id="cb31-1846"><a href="#cb31-1846" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1847"><a href="#cb31-1847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1848"><a href="#cb31-1848" aria-hidden="true" tabindex="-1"></a><span class="fu"># Empirical Applications {#sec-institutionalapplications}</span></span>
<span id="cb31-1849"><a href="#cb31-1849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1850"><a href="#cb31-1850" aria-hidden="true" tabindex="-1"></a><span class="fu">## Application 1: Institutional Ownership Changes and Future Returns {#sec-institutionalapp-returns}</span></span>
<span id="cb31-1851"><a href="#cb31-1851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1852"><a href="#cb31-1852" aria-hidden="true" tabindex="-1"></a>We test whether changes in institutional ownership predict future stock returns <span class="co">[</span><span class="ot">@chen2000value</span><span class="co">]</span> via Fama-MacBeth regressions:</span>
<span id="cb31-1853"><a href="#cb31-1853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1854"><a href="#cb31-1854" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1855"><a href="#cb31-1855" aria-hidden="true" tabindex="-1"></a>r_{i,t+1} = \alpha_t + \beta_{1,t} \cdot \Delta IO_{i,t} + \beta_{2,t} \cdot</span>
<span id="cb31-1856"><a href="#cb31-1856" aria-hidden="true" tabindex="-1"></a>\Delta\text{Breadth}_{i,t} + \gamma_t \cdot X_{i,t} + \varepsilon_{i,t}</span>
<span id="cb31-1857"><a href="#cb31-1857" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fama-macbeth}</span>
<span id="cb31-1858"><a href="#cb31-1858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1861"><a href="#cb31-1861" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1862"><a href="#cb31-1862" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fama-macbeth</span></span>
<span id="cb31-1863"><a href="#cb31-1863" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Fama-MacBeth: IO Changes and Future Returns"</span></span>
<span id="cb31-1864"><a href="#cb31-1864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1865"><a href="#cb31-1865" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_io_returns(</span>
<span id="cb31-1866"><a href="#cb31-1866" aria-hidden="true" tabindex="-1"></a>    io_ratios: pd.DataFrame,</span>
<span id="cb31-1867"><a href="#cb31-1867" aria-hidden="true" tabindex="-1"></a>    breadth: pd.DataFrame,</span>
<span id="cb31-1868"><a href="#cb31-1868" aria-hidden="true" tabindex="-1"></a>    price_q: pd.DataFrame,</span>
<span id="cb31-1869"><a href="#cb31-1869" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1870"><a href="#cb31-1870" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run Fama-MacBeth regressions of future returns on IO changes."""</span></span>
<span id="cb31-1871"><a href="#cb31-1871" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> io_ratios[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'io_total_inst'</span>]].merge(</span>
<span id="cb31-1872"><a href="#cb31-1872" aria-hidden="true" tabindex="-1"></a>        breadth[[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>, <span class="st">'n_total_inst'</span>, <span class="st">'d_n_total_inst'</span>]],</span>
<span id="cb31-1873"><a href="#cb31-1873" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>], how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1874"><a href="#cb31-1874" aria-hidden="true" tabindex="-1"></a>    ).merge(</span>
<span id="cb31-1875"><a href="#cb31-1875" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'mcap'</span>, <span class="st">'qret'</span>]],</span>
<span id="cb31-1876"><a href="#cb31-1876" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-1877"><a href="#cb31-1877" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-1878"><a href="#cb31-1878" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1879"><a href="#cb31-1879" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1880"><a href="#cb31-1880" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1881"><a href="#cb31-1881" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> panel.sort_values([<span class="st">'ticker'</span>, <span class="st">'rdate'</span>])</span>
<span id="cb31-1882"><a href="#cb31-1882" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'dio'</span>] <span class="op">=</span> panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'io_total_inst'</span>].diff()</span>
<span id="cb31-1883"><a href="#cb31-1883" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'mcap'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb31-1884"><a href="#cb31-1884" aria-hidden="true" tabindex="-1"></a>    panel[<span class="st">'mom'</span>] <span class="op">=</span> panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'qret'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-1885"><a href="#cb31-1885" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1886"><a href="#cb31-1886" aria-hidden="true" tabindex="-1"></a>    reg_vars <span class="op">=</span> [<span class="st">'qret'</span>, <span class="st">'dio'</span>, <span class="st">'d_n_total_inst'</span>, <span class="st">'log_mcap'</span>, <span class="st">'mom'</span>]</span>
<span id="cb31-1887"><a href="#cb31-1887" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> panel.dropna(subset<span class="op">=</span>reg_vars)</span>
<span id="cb31-1888"><a href="#cb31-1888" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1889"><a href="#cb31-1889" aria-hidden="true" tabindex="-1"></a>    quarters <span class="op">=</span> <span class="bu">sorted</span>(panel[<span class="st">'rdate'</span>].unique())</span>
<span id="cb31-1890"><a href="#cb31-1890" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb31-1891"><a href="#cb31-1891" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1892"><a href="#cb31-1892" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> quarters:</span>
<span id="cb31-1893"><a href="#cb31-1893" aria-hidden="true" tabindex="-1"></a>        qdata <span class="op">=</span> panel[panel[<span class="st">'rdate'</span>] <span class="op">==</span> q]</span>
<span id="cb31-1894"><a href="#cb31-1894" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(qdata) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb31-1895"><a href="#cb31-1895" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1896"><a href="#cb31-1896" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(</span>
<span id="cb31-1897"><a href="#cb31-1897" aria-hidden="true" tabindex="-1"></a>            qdata[[<span class="st">'dio'</span>, <span class="st">'d_n_total_inst'</span>, <span class="st">'log_mcap'</span>, <span class="st">'mom'</span>]]</span>
<span id="cb31-1898"><a href="#cb31-1898" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1899"><a href="#cb31-1899" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb31-1900"><a href="#cb31-1900" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(qdata[<span class="st">'qret'</span>], X).fit()</span>
<span id="cb31-1901"><a href="#cb31-1901" aria-hidden="true" tabindex="-1"></a>            coefs <span class="op">=</span> model.params.to_dict()</span>
<span id="cb31-1902"><a href="#cb31-1902" aria-hidden="true" tabindex="-1"></a>            coefs[<span class="st">'rdate'</span>] <span class="op">=</span> q</span>
<span id="cb31-1903"><a href="#cb31-1903" aria-hidden="true" tabindex="-1"></a>            coefs[<span class="st">'n_obs'</span>] <span class="op">=</span> <span class="bu">len</span>(qdata)</span>
<span id="cb31-1904"><a href="#cb31-1904" aria-hidden="true" tabindex="-1"></a>            results.append(coefs)</span>
<span id="cb31-1905"><a href="#cb31-1905" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb31-1906"><a href="#cb31-1906" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1907"><a href="#cb31-1907" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1908"><a href="#cb31-1908" aria-hidden="true" tabindex="-1"></a>    fm <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb31-1909"><a href="#cb31-1909" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1910"><a href="#cb31-1910" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series averages with Newey-West t-statistics</span></span>
<span id="cb31-1911"><a href="#cb31-1911" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Fama-MacBeth Results:"</span>)</span>
<span id="cb31-1912"><a href="#cb31-1912" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb31-1913"><a href="#cb31-1913" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">'const'</span>, <span class="st">'dio'</span>, <span class="st">'d_n_total_inst'</span>, <span class="st">'log_mcap'</span>, <span class="st">'mom'</span>]:</span>
<span id="cb31-1914"><a href="#cb31-1914" aria-hidden="true" tabindex="-1"></a>        coefs <span class="op">=</span> fm[var].dropna()</span>
<span id="cb31-1915"><a href="#cb31-1915" aria-hidden="true" tabindex="-1"></a>        mean_c <span class="op">=</span> coefs.mean()</span>
<span id="cb31-1916"><a href="#cb31-1916" aria-hidden="true" tabindex="-1"></a>        nw_se <span class="op">=</span> sm.OLS(</span>
<span id="cb31-1917"><a href="#cb31-1917" aria-hidden="true" tabindex="-1"></a>            coefs <span class="op">-</span> mean_c, np.ones(<span class="bu">len</span>(coefs))</span>
<span id="cb31-1918"><a href="#cb31-1918" aria-hidden="true" tabindex="-1"></a>        ).fit(cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">4</span>}).bse[<span class="dv">0</span>]</span>
<span id="cb31-1919"><a href="#cb31-1919" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> mean_c <span class="op">/</span> nw_se <span class="cf">if</span> nw_se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb31-1920"><a href="#cb31-1920" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">:20s}</span><span class="ss">: coef=</span><span class="sc">{</span>mean_c<span class="sc">:8.4f}</span><span class="ss">, t=</span><span class="sc">{</span>t<span class="sc">:6.2f}</span><span class="ss">"</span>)</span>
<span id="cb31-1921"><a href="#cb31-1921" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1922"><a href="#cb31-1922" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fm</span>
<span id="cb31-1923"><a href="#cb31-1923" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1924"><a href="#cb31-1924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1925"><a href="#cb31-1925" aria-hidden="true" tabindex="-1"></a><span class="fu">## Application 2: Turnover and Performance {#sec-institutionalapp-turnover}</span></span>
<span id="cb31-1926"><a href="#cb31-1926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1927"><a href="#cb31-1927" aria-hidden="true" tabindex="-1"></a>@yan2008liquidity documented a positive turnover-performance relationship. We test in Vietnam:</span>
<span id="cb31-1928"><a href="#cb31-1928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1929"><a href="#cb31-1929" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1930"><a href="#cb31-1930" aria-hidden="true" tabindex="-1"></a>\alpha_{j,t} = a + b \cdot \text{Turnover}_{j,t-1} + c \cdot</span>
<span id="cb31-1931"><a href="#cb31-1931" aria-hidden="true" tabindex="-1"></a>\log(A_{j,t-1}) + d \cdot \text{Flow}_{j,t} + \varepsilon_{j,t}</span>
<span id="cb31-1932"><a href="#cb31-1932" aria-hidden="true" tabindex="-1"></a>$$ {#eq-turnover-perf}</span>
<span id="cb31-1933"><a href="#cb31-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1936"><a href="#cb31-1936" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1937"><a href="#cb31-1937" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: turnover-performance</span></span>
<span id="cb31-1938"><a href="#cb31-1938" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Turnover-Performance Relationship"</span></span>
<span id="cb31-1939"><a href="#cb31-1939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1940"><a href="#cb31-1940" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> turnover_performance_regression(</span>
<span id="cb31-1941"><a href="#cb31-1941" aria-hidden="true" tabindex="-1"></a>    aggregates: pd.DataFrame,</span>
<span id="cb31-1942"><a href="#cb31-1942" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb31-1943"><a href="#cb31-1943" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Test turnover-performance relationship."""</span></span>
<span id="cb31-1944"><a href="#cb31-1944" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> aggregates.sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'rdate'</span>]).copy()</span>
<span id="cb31-1945"><a href="#cb31-1945" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'lag_turnover1'</span>] <span class="op">=</span> (</span>
<span id="cb31-1946"><a href="#cb31-1946" aria-hidden="true" tabindex="-1"></a>        agg.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'turnover1'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-1947"><a href="#cb31-1947" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1948"><a href="#cb31-1948" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(agg[<span class="st">'assets'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb31-1949"><a href="#cb31-1949" aria-hidden="true" tabindex="-1"></a>    agg[<span class="st">'flow_ratio'</span>] <span class="op">=</span> agg[<span class="st">'netflows'</span>] <span class="op">/</span> agg[<span class="st">'assets'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb31-1950"><a href="#cb31-1950" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1951"><a href="#cb31-1951" aria-hidden="true" tabindex="-1"></a>    panel <span class="op">=</span> agg.dropna(</span>
<span id="cb31-1952"><a href="#cb31-1952" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">'pret'</span>, <span class="st">'lag_turnover1'</span>, <span class="st">'log_assets'</span>, <span class="st">'flow_ratio'</span>]</span>
<span id="cb31-1953"><a href="#cb31-1953" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1954"><a href="#cb31-1954" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1955"><a href="#cb31-1955" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'pret'</span>, <span class="st">'lag_turnover1'</span>, <span class="st">'flow_ratio'</span>]:</span>
<span id="cb31-1956"><a href="#cb31-1956" aria-hidden="true" tabindex="-1"></a>        lo, hi <span class="op">=</span> panel[col].quantile([<span class="fl">0.01</span>, <span class="fl">0.99</span>])</span>
<span id="cb31-1957"><a href="#cb31-1957" aria-hidden="true" tabindex="-1"></a>        panel[col] <span class="op">=</span> panel[col].clip(lo, hi)</span>
<span id="cb31-1958"><a href="#cb31-1958" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1959"><a href="#cb31-1959" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(</span>
<span id="cb31-1960"><a href="#cb31-1960" aria-hidden="true" tabindex="-1"></a>        panel[[<span class="st">'lag_turnover1'</span>, <span class="st">'log_assets'</span>, <span class="st">'flow_ratio'</span>]]</span>
<span id="cb31-1961"><a href="#cb31-1961" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1962"><a href="#cb31-1962" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(panel[<span class="st">'pret'</span>], X).fit(</span>
<span id="cb31-1963"><a href="#cb31-1963" aria-hidden="true" tabindex="-1"></a>        cov_type<span class="op">=</span><span class="st">'cluster'</span>,</span>
<span id="cb31-1964"><a href="#cb31-1964" aria-hidden="true" tabindex="-1"></a>        cov_kwds<span class="op">=</span>{<span class="st">'groups'</span>: panel[<span class="st">'shareholder_name'</span>]}</span>
<span id="cb31-1965"><a href="#cb31-1965" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1966"><a href="#cb31-1966" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'model'</span>: model, <span class="st">'n'</span>: <span class="bu">len</span>(panel)}</span>
<span id="cb31-1967"><a href="#cb31-1967" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1968"><a href="#cb31-1968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1969"><a href="#cb31-1969" aria-hidden="true" tabindex="-1"></a><span class="fu">## Application 3: Foreign vs. Domestic Trading {#sec-institutionalapp-foreign-domestic}</span></span>
<span id="cb31-1970"><a href="#cb31-1970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1973"><a href="#cb31-1973" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-1974"><a href="#cb31-1974" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: foreign-domestic-comparison</span></span>
<span id="cb31-1975"><a href="#cb31-1975" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Foreign vs. Domestic Trading Comparison"</span></span>
<span id="cb31-1976"><a href="#cb31-1976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1977"><a href="#cb31-1977" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_foreign_domestic(</span>
<span id="cb31-1978"><a href="#cb31-1978" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame, price_q: pd.DataFrame,</span>
<span id="cb31-1979"><a href="#cb31-1979" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-1980"><a href="#cb31-1980" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compare trading patterns between foreign and domestic institutions."""</span></span>
<span id="cb31-1981"><a href="#cb31-1981" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb31-1982"><a href="#cb31-1982" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb31-1983"><a href="#cb31-1983" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-1984"><a href="#cb31-1984" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-1985"><a href="#cb31-1985" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-1986"><a href="#cb31-1986" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-1987"><a href="#cb31-1987" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'dollar_trade'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb31-1988"><a href="#cb31-1988" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'is_buy'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb31-1989"><a href="#cb31-1989" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1990"><a href="#cb31-1990" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb31-1991"><a href="#cb31-1991" aria-hidden="true" tabindex="-1"></a>        _t[_t[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)]</span>
<span id="cb31-1992"><a href="#cb31-1992" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'owner_type'</span>)</span>
<span id="cb31-1993"><a href="#cb31-1993" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb31-1994"><a href="#cb31-1994" aria-hidden="true" tabindex="-1"></a>            n_trades<span class="op">=</span>(<span class="st">'trade'</span>, <span class="st">'count'</span>),</span>
<span id="cb31-1995"><a href="#cb31-1995" aria-hidden="true" tabindex="-1"></a>            n_buys<span class="op">=</span>(<span class="st">'is_buy'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1996"><a href="#cb31-1996" aria-hidden="true" tabindex="-1"></a>            avg_dollar<span class="op">=</span>(<span class="st">'dollar_trade'</span>, <span class="kw">lambda</span> x: x.<span class="bu">abs</span>().mean()),</span>
<span id="cb31-1997"><a href="#cb31-1997" aria-hidden="true" tabindex="-1"></a>            net_buying<span class="op">=</span>(<span class="st">'dollar_trade'</span>, <span class="st">'sum'</span>),</span>
<span id="cb31-1998"><a href="#cb31-1998" aria-hidden="true" tabindex="-1"></a>            pct_initiating<span class="op">=</span>(<span class="st">'buysale'</span>, <span class="kw">lambda</span> x: (x.<span class="bu">abs</span>() <span class="op">==</span> <span class="dv">1</span>).mean()),</span>
<span id="cb31-1999"><a href="#cb31-1999" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-2000"><a href="#cb31-2000" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-2001"><a href="#cb31-2001" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-2002"><a href="#cb31-2002" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2003"><a href="#cb31-2003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2006"><a href="#cb31-2006" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-2007"><a href="#cb31-2007" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumulative-net-buying</span></span>
<span id="cb31-2008"><a href="#cb31-2008" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative net buying by foreign vs. domestic institutional investors (billions VND). Divergent patterns reflect different investment mandates: foreign institutions respond to global risk cycles, while domestic institutions are more sensitive to local conditions."</span></span>
<span id="cb31-2009"><a href="#cb31-2009" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb31-2010"><a href="#cb31-2010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2011"><a href="#cb31-2011" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_cumulative_net_buying(</span>
<span id="cb31-2012"><a href="#cb31-2012" aria-hidden="true" tabindex="-1"></a>    trades: pd.DataFrame, price_q: pd.DataFrame</span>
<span id="cb31-2013"><a href="#cb31-2013" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb31-2014"><a href="#cb31-2014" aria-hidden="true" tabindex="-1"></a>    _t <span class="op">=</span> trades.merge(</span>
<span id="cb31-2015"><a href="#cb31-2015" aria-hidden="true" tabindex="-1"></a>        price_q[[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>, <span class="st">'p'</span>]],</span>
<span id="cb31-2016"><a href="#cb31-2016" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'rdate'</span>],</span>
<span id="cb31-2017"><a href="#cb31-2017" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'qdate'</span>],</span>
<span id="cb31-2018"><a href="#cb31-2018" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb31-2019"><a href="#cb31-2019" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-2020"><a href="#cb31-2020" aria-hidden="true" tabindex="-1"></a>    _t[<span class="st">'trade_vnd'</span>] <span class="op">=</span> _t[<span class="st">'trade'</span>] <span class="op">*</span> _t[<span class="st">'p'</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb31-2021"><a href="#cb31-2021" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2022"><a href="#cb31-2022" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> _t[_t[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)]</span>
<span id="cb31-2023"><a href="#cb31-2023" aria-hidden="true" tabindex="-1"></a>    net <span class="op">=</span> (</span>
<span id="cb31-2024"><a href="#cb31-2024" aria-hidden="true" tabindex="-1"></a>        inst.groupby(</span>
<span id="cb31-2025"><a href="#cb31-2025" aria-hidden="true" tabindex="-1"></a>            [pd.Grouper(key<span class="op">=</span><span class="st">'rdate'</span>, freq<span class="op">=</span><span class="st">'QE'</span>), <span class="st">'owner_type'</span>]</span>
<span id="cb31-2026"><a href="#cb31-2026" aria-hidden="true" tabindex="-1"></a>        )[<span class="st">'trade_vnd'</span>].<span class="bu">sum</span>().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-2027"><a href="#cb31-2027" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-2028"><a href="#cb31-2028" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> net.cumsum()</span>
<span id="cb31-2029"><a href="#cb31-2029" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2030"><a href="#cb31-2030" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb31-2031"><a href="#cb31-2031" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> cum.columns:</span>
<span id="cb31-2032"><a href="#cb31-2032" aria-hidden="true" tabindex="-1"></a>        ax.plot(cum.index, cum[col], label<span class="op">=</span>col,</span>
<span id="cb31-2033"><a href="#cb31-2033" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>OWNER_COLORS.get(col, <span class="st">'#333'</span>), linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-2034"><a href="#cb31-2034" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-2035"><a href="#cb31-2035" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Cumulative Net Institutional Buying'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb31-2036"><a href="#cb31-2036" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Billions VND'</span>)</span>
<span id="cb31-2037"><a href="#cb31-2037" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb31-2038"><a href="#cb31-2038" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-2039"><a href="#cb31-2039" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb31-2040"><a href="#cb31-2040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2041"><a href="#cb31-2041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2042"><a href="#cb31-2042" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Quality and Robustness {#sec-institutionalrobustness}</span></span>
<span id="cb31-2043"><a href="#cb31-2043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2044"><a href="#cb31-2044" aria-hidden="true" tabindex="-1"></a><span class="fu">## Common Pitfalls {#sec-institutionalpitfalls}</span></span>
<span id="cb31-2045"><a href="#cb31-2045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2046"><a href="#cb31-2046" aria-hidden="true" tabindex="-1"></a><span class="fu">### Corporate Action Misadjustment</span></span>
<span id="cb31-2047"><a href="#cb31-2047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2048"><a href="#cb31-2048" aria-hidden="true" tabindex="-1"></a>::: callout-caution</span>
<span id="cb31-2049"><a href="#cb31-2049" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: Phantom Trade from Unadjusted Stock Dividend</span></span>
<span id="cb31-2050"><a href="#cb31-2050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2051"><a href="#cb31-2051" aria-hidden="true" tabindex="-1"></a>Vinamilk (VNM) issues a 20% stock dividend with ex-date March 15, 2023.</span>
<span id="cb31-2052"><a href="#cb31-2052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2053"><a href="#cb31-2053" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Q4 2022: Fund X holds 1,000,000 shares of VNM</span>
<span id="cb31-2054"><a href="#cb31-2054" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Q1 2023: Fund X holds 1,200,000 shares of VNM</span>
<span id="cb31-2055"><a href="#cb31-2055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2056"><a href="#cb31-2056" aria-hidden="true" tabindex="-1"></a>**Without adjustment:** Inferred buy of +200,000 shares (BS = +2) **With adjustment:** Prior holdings become 1,200,000 adjusted shares, trade = 0</span>
<span id="cb31-2057"><a href="#cb31-2057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2058"><a href="#cb31-2058" aria-hidden="true" tabindex="-1"></a>This phantom trade inflates measured turnover and creates spurious buying signals.</span>
<span id="cb31-2059"><a href="#cb31-2059" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2060"><a href="#cb31-2060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2061"><a href="#cb31-2061" aria-hidden="true" tabindex="-1"></a><span class="fu">### Disclosure Timing Mismatches</span></span>
<span id="cb31-2062"><a href="#cb31-2062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2063"><a href="#cb31-2063" aria-hidden="true" tabindex="-1"></a>Vietnamese ownership disclosure dates may not align with calendar quarter ends. Our pipeline addresses this by aligning all disclosures to the nearest quarter-end.</span>
<span id="cb31-2064"><a href="#cb31-2064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2065"><a href="#cb31-2065" aria-hidden="true" tabindex="-1"></a><span class="fu">### Name Changes and Entity Mergers</span></span>
<span id="cb31-2066"><a href="#cb31-2066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2067"><a href="#cb31-2067" aria-hidden="true" tabindex="-1"></a>Vietnamese institutions frequently rename. Without a stable identifier, the same entity may appear as two different shareholders, creating phantom entries/exits. We recommend maintaining a master entity mapping table.</span>
<span id="cb31-2068"><a href="#cb31-2068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2069"><a href="#cb31-2069" aria-hidden="true" tabindex="-1"></a><span class="fu">## Validation Checks {#sec-institutionalvalidation}</span></span>
<span id="cb31-2070"><a href="#cb31-2070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2073"><a href="#cb31-2073" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb31-2074"><a href="#cb31-2074" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: validation</span></span>
<span id="cb31-2075"><a href="#cb31-2075" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Data Quality Validation Suite"</span></span>
<span id="cb31-2076"><a href="#cb31-2076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2077"><a href="#cb31-2077" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_pipeline_outputs(</span>
<span id="cb31-2078"><a href="#cb31-2078" aria-hidden="true" tabindex="-1"></a>    results: Dict[<span class="bu">str</span>, pd.DataFrame],</span>
<span id="cb31-2079"><a href="#cb31-2079" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-2080"><a href="#cb31-2080" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run comprehensive validation on pipeline outputs."""</span></span>
<span id="cb31-2081"><a href="#cb31-2081" aria-hidden="true" tabindex="-1"></a>    checks <span class="op">=</span> []</span>
<span id="cb31-2082"><a href="#cb31-2082" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> results[<span class="st">'holdings'</span>]</span>
<span id="cb31-2083"><a href="#cb31-2083" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> results[<span class="st">'trades'</span>]</span>
<span id="cb31-2084"><a href="#cb31-2084" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> results[<span class="st">'aggregates'</span>]</span>
<span id="cb31-2085"><a href="#cb31-2085" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2086"><a href="#cb31-2086" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb31-2087"><a href="#cb31-2087" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'No negative adjusted shares'</span>,</span>
<span id="cb31-2088"><a href="#cb31-2088" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> (h[<span class="st">'shares_adj'</span>] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb31-2089"><a href="#cb31-2089" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Detail'</span>: <span class="ss">f'</span><span class="sc">{</span>(h[<span class="st">"shares_adj"</span>] <span class="op">&lt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> negative obs'</span></span>
<span id="cb31-2090"><a href="#cb31-2090" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2091"><a href="#cb31-2091" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2092"><a href="#cb31-2092" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb31-2093"><a href="#cb31-2093" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'No duplicate holdings'</span>,</span>
<span id="cb31-2094"><a href="#cb31-2094" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> h.duplicated(</span>
<span id="cb31-2095"><a href="#cb31-2095" aria-hidden="true" tabindex="-1"></a>            subset<span class="op">=</span>[<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'rdate'</span>]</span>
<span id="cb31-2096"><a href="#cb31-2096" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb31-2097"><a href="#cb31-2097" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2098"><a href="#cb31-2098" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2099"><a href="#cb31-2099" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb31-2100"><a href="#cb31-2100" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'Valid buysale codes only'</span>,</span>
<span id="cb31-2101"><a href="#cb31-2101" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> t[<span class="st">'buysale'</span>].isin([<span class="dv">1</span>, <span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">2</span>]).<span class="bu">all</span>()</span>
<span id="cb31-2102"><a href="#cb31-2102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb31-2103"><a href="#cb31-2103" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2104"><a href="#cb31-2104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2105"><a href="#cb31-2105" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb31-2106"><a href="#cb31-2106" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'No zero trades'</span>,</span>
<span id="cb31-2107"><a href="#cb31-2107" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> (t[<span class="st">'trade'</span>] <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb31-2108"><a href="#cb31-2108" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2109"><a href="#cb31-2109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2110"><a href="#cb31-2110" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> a[<span class="st">'turnover1'</span>].dropna()</span>
<span id="cb31-2111"><a href="#cb31-2111" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb31-2112"><a href="#cb31-2112" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'Turnover1 in [0, 10]'</span>,</span>
<span id="cb31-2113"><a href="#cb31-2113" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> ((t1 <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">|</span> (t1 <span class="op">&gt;</span> <span class="dv">10</span>)).<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb31-2114"><a href="#cb31-2114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="st">'WARNING'</span>,</span>
<span id="cb31-2115"><a href="#cb31-2115" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Detail'</span>: <span class="ss">f'</span><span class="sc">{</span>((t1<span class="op">&lt;</span><span class="dv">0</span>)<span class="op">|</span>(t1<span class="op">&gt;</span><span class="dv">10</span>))<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> extreme values'</span></span>
<span id="cb31-2116"><a href="#cb31-2116" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2117"><a href="#cb31-2117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2118"><a href="#cb31-2118" aria-hidden="true" tabindex="-1"></a>    first_rpt <span class="op">=</span> a[a[<span class="st">'first_report'</span>]]</span>
<span id="cb31-2119"><a href="#cb31-2119" aria-hidden="true" tabindex="-1"></a>    checks.append({</span>
<span id="cb31-2120"><a href="#cb31-2120" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Check'</span>: <span class="st">'First report -&gt; missing netflows'</span>,</span>
<span id="cb31-2121"><a href="#cb31-2121" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Result'</span>: <span class="st">'PASS'</span> <span class="cf">if</span> first_rpt[<span class="st">'netflows'</span>].isna().<span class="bu">all</span>()</span>
<span id="cb31-2122"><a href="#cb31-2122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="st">'FAIL'</span>,</span>
<span id="cb31-2123"><a href="#cb31-2123" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2124"><a href="#cb31-2124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2125"><a href="#cb31-2125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(checks)</span>
<span id="cb31-2126"><a href="#cb31-2126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2127"><a href="#cb31-2127" aria-hidden="true" tabindex="-1"></a><span class="co"># validate_pipeline_outputs(results)</span></span>
<span id="cb31-2128"><a href="#cb31-2128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2129"><a href="#cb31-2129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2130"><a href="#cb31-2130" aria-hidden="true" tabindex="-1"></a><span class="fu"># Summary {#sec-institutionalsummary}</span></span>
<span id="cb31-2131"><a href="#cb31-2131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2132"><a href="#cb31-2132" aria-hidden="true" tabindex="-1"></a>This chapter developed a framework for computing institutional trades, flows, and turnover ratios in the Vietnamese equity market. The key contributions include:</span>
<span id="cb31-2133"><a href="#cb31-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2134"><a href="#cb31-2134" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Corporate action adjustment** for Vietnam's frequent stock dividends and bonus shares, preventing phantom trades that contaminate standard differencing.</span>
<span id="cb31-2135"><a href="#cb31-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2136"><a href="#cb31-2136" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Four-way ownership taxonomy** (state, foreign institutional, domestic institutional, individual) capturing Vietnam's unique ownership landscape.</span>
<span id="cb31-2137"><a href="#cb31-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2138"><a href="#cb31-2138" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**FOL utilization analytics** for studying foreign ownership constraints absent from developed markets.</span>
<span id="cb31-2139"><a href="#cb31-2139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2140"><a href="#cb31-2140" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Irregular disclosure handling** with correct gap splitting into terminating sales and initiating buys.</span>
<span id="cb31-2141"><a href="#cb31-2141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2142"><a href="#cb31-2142" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Advanced extensions** including herding, demand persistence, and information content decomposition.</span>
<span id="cb31-2143"><a href="#cb31-2143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2144"><a href="#cb31-2144" aria-hidden="true" tabindex="-1"></a>The pipeline produces several output datasets (@tbl-institutional-outputs)</span>
<span id="cb31-2145"><a href="#cb31-2145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2146"><a href="#cb31-2146" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Output <span class="pp">|</span> Grain <span class="pp">|</span> Key Variables <span class="pp">|</span> Use Cases <span class="pp">|</span></span>
<span id="cb31-2147"><a href="#cb31-2147" aria-hidden="true" tabindex="-1"></a><span class="pp">|:-----------------|:-----------------|:------------------|:-----------------|</span></span>
<span id="cb31-2148"><a href="#cb31-2148" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`holdings`</span> <span class="pp">|</span> Shareholder x Ticker x Quarter <span class="pp">|</span> <span class="in">`shares_adj`</span>, <span class="in">`owner_type`</span> <span class="pp">|</span> Cross-sectional ownership <span class="pp">|</span></span>
<span id="cb31-2149"><a href="#cb31-2149" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`io_ratios`</span> <span class="pp">|</span> Ticker x Quarter <span class="pp">|</span> <span class="in">`io_state`</span>, <span class="in">`io_foreign`</span>, etc. <span class="pp">|</span> Governance, liquidity <span class="pp">|</span></span>
<span id="cb31-2150"><a href="#cb31-2150" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`trades`</span> <span class="pp">|</span> Shareholder x Ticker x Quarter <span class="pp">|</span> <span class="in">`trade`</span>, <span class="in">`buysale`</span> <span class="pp">|</span> Informed trading, herding <span class="pp">|</span></span>
<span id="cb31-2151"><a href="#cb31-2151" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`aggregates`</span> <span class="pp">|</span> Shareholder x Quarter <span class="pp">|</span> <span class="in">`assets`</span>, <span class="in">`turnover`</span>, <span class="in">`netflows`</span> <span class="pp">|</span> Fund performance, flows <span class="pp">|</span></span>
<span id="cb31-2152"><a href="#cb31-2152" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`fol_analytics`</span> <span class="pp">|</span> Ticker x Date <span class="pp">|</span> <span class="in">`fol_utilization`</span>, <span class="in">`foreign_room`</span> <span class="pp">|</span> FOL premium, foreign investment <span class="pp">|</span></span>
<span id="cb31-2153"><a href="#cb31-2153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2154"><a href="#cb31-2154" aria-hidden="true" tabindex="-1"></a>: Summary of Pipeline Output Datasets {#tbl-institutional-outputs}</span>
<span id="cb31-2155"><a href="#cb31-2155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2156"><a href="#cb31-2156" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Exercises {#sec-institutionalexercises}</span></span>
<span id="cb31-2157"><a href="#cb31-2157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2158"><a href="#cb31-2158" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Corporate Action Sensitivity.** Download corporate action data for VNM from DataCore.vn and compute the cumulative share adjustment factor from 2010 to 2024. How many phantom trades would be generated without adjustment? Plot the factor.</span></span>
<span id="cb31-2159"><a href="#cb31-2159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2160"><a href="#cb31-2160" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **FOL Binding and Returns.** Construct a long-short portfolio: long FOL-binding stocks ($\text{FOL\_Util} &gt; 0.95$), short non-binding ($&lt; 0.50$). What is the average quarterly return spread? Is it statistically significant?</span></span>
<span id="cb31-2161"><a href="#cb31-2161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2162"><a href="#cb31-2162" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Herding Asymmetry.** Compute LSV herding separately for large-cap (HOSE top 50) and small-cap stocks. Is herding stronger in small caps? Compare buy vs. sell herding.</span></span>
<span id="cb31-2163"><a href="#cb31-2163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2164"><a href="#cb31-2164" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **State Divestment Events.** Identify quarters where SCIC conducted major divestments. What happens to breadth and foreign ownership post-divestment?</span></span>
<span id="cb31-2165"><a href="#cb31-2165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2166"><a href="#cb31-2166" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Turnover Quintile Portfolios.** Sort investors by lagged Carhart turnover into quintiles. Compare returns: is the turnover-performance relation positive (information) or negative (costs) in Vietnam?</span></span>
<span id="cb31-2167"><a href="#cb31-2167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2168"><a href="#cb31-2168" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Replication Exercise.** Replicate @chen2000value: do breadth changes predict future returns in the Vietnamese market? --&gt;</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/52_institutional_trade_flow.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>